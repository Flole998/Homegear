/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
var RED={};RED.events=function(){var e={};return{on:function(t,n){e[t]=e[t]||[],e[t].push(n)},off:function(t,n){var o=e[t];if(o)for(var a=0;a<o.length;a++)if(o[a]===n)return void o.splice(a,1)},emit:function(t,n){if(e[t])for(var o=0;o<e[t].length;o++)try{e[t][o](n)}catch(e){console.log("RED.events.emit error: ["+t+"] "+e.toString()),console.log(e)}}}}(),RED.i18n={init:function(e){i18n.init({resGetPath:"locales/__ns__?lng=__lng__",dynamicLoad:!1,load:"current",ns:{namespaces:["editor","node-red","jsonata","infotips"],defaultNs:"editor"},fallbackLng:["en-US"],fallbackNS:["node-red","editor"],useCookie:!1},function(){e()}),RED._=function(){return i18n.t.apply(null,arguments)}},loadCatalog:function(e,t){i18n.loadNamespace(e,t)},loadNodeCatalogs:function(e){var t=i18n.functions.toLanguages(i18n.detectLanguage()),n=t.length;t.forEach(function(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"locales/nodes?lng="+t,success:function(o){Object.keys(o).forEach(function(e){i18n.addResourceBundle(t,e,o[e])}),0==--n&&e()}})})}},RED.settings=function(){function e(e){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings/user",success:function(t){r(t),e()},error:function(e,t,n){console.log("Unexpected error loading user settings:",e.status,t)}})}function t(){RED.user.hasPermission("settings.write")&&(n&&clearTimeout(n),n=setTimeout(function(){n=null,$.ajax({method:"POST",contentType:"application/json",url:"settings/user",data:JSON.stringify(a),success:function(e){},error:function(e,t,n){console.log("Unexpected error saving user settings:",e.status,t)}})},300))}var n,o={},a={},i=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},s=function(e){for(var t in o)o.hasOwnProperty(t)&&RED.settings.hasOwnProperty(t)&&delete RED.settings[t];for(t in e)e.hasOwnProperty(t)&&(RED.settings[t]=e[t]);o=e},r=function(e){a=e},d=function(t){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(n){s(n),RED.settings.user&&!RED.settings.user.anonymous||RED.settings.remove("auth-tokens"),console.log("Node-BLUE: "+n.version),e(t)},error:function(e,n,o){401===e.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&(window.location.search=""),RED.user.login(function(){d(t)})):console.log("Unexpected error loading settings:",e.status,n)}})};return{init:function(e){var t=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);if(t){var n=t[1];RED.settings.set("auth-tokens",{access_token:n}),window.location.search=""}$.ajaxSetup({beforeSend:function(e,t){if(!/^\s*(https?:|\/|\.)/.test(t.url)){var n=RED.settings.get("auth-tokens");n&&e.setRequestHeader("Authorization","Bearer "+n.access_token),e.setRequestHeader("Node-RED-API-Version","v2")}}}),d(e)},load:d,loadUserSettings:e,set:function(e,n){i()&&("auth-tokens"===e?localStorage.setItem(e,JSON.stringify(n)):(a[e]=n,t()))},get:function(e){if(i())return"auth-tokens"===e?JSON.parse(localStorage.getItem(e)):a[e]},remove:function(e){i()&&("auth-tokens"===e?localStorage.removeItem(e):(delete a[e],t()))},theme:function(e,t){if(!RED.settings.editorTheme)return t;var n=e.split("."),o=RED.settings.editorTheme;try{for(var a=0;a<n.length;a++)o=o[n[a]];return void 0===o?t:o}catch(e){return t}}}}(),RED.user=function(){function e(){$("#btn-usermenu-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("btn-usermenu",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},function(){RED.settings.load(function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),e(),RED.events.emit("login",RED.settings.user.username)})})}}):(RED.menu.addItem("btn-usermenu",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("btn-usermenu",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}function t(e,a){if(""===a)return!0;var i;if(Array.isArray(a)){for(i=0;i<a.length;i++)if(!t(e,a[i]))return!1;return!0}if(Array.isArray(e)){if(0===e.length)return!1;for(i=0;i<e.length;i++)if(t(e[i],a))return!0;return!1}return"*"===e||e===a||("read"===e||"*.read"===e?n.test(a):("write"===e||"*.write"===e)&&o.test(a))}var n=/^((.+)\.)?read$/,o=/^((.+)\.)?write$/;return{init:function(){if(RED.settings.user&&(!RED.settings.editorTheme||!RED.settings.editorTheme.hasOwnProperty("userMenu"))){var t=$('<li><a id="btn-usermenu" class="button hide" data-toggle="dropdown" href="#"></a></li>').prependTo(".header-toolbar");RED.settings.user.image?$('<span class="user-profile"></span>').css({backgroundImage:"url("+RED.settings.user.image+")"}).appendTo(t.find("a")):$('<i class="fa fa-user"></i>').appendTo(t.find("a")),RED.menu.init({id:"btn-usermenu",options:[]}),e()}},login:function(t,n){"function"==typeof t&&(n=t,t={});var o=$('<div id="node-dialog-login" class="hide"><div style="display: inline-block;width: 250px; vertical-align: top; margin-right: 10px; margin-bottom: 20px;"><img id="node-dialog-login-image" src=""/></div><div style="display: inline-block; width: 250px; vertical-align: bottom; margin-left: 10px; margin-bottom: 20px;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px;"></form></div></div>');o.dialog({autoOpen:!1,dialogClass:"ui-dialog-no-close",modal:!0,closeOnEscape:!!t.cancelable,width:600,resizable:!1,draggable:!1}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(a){var i=0;if("credentials"==a.type){for(;i<a.prompts.length;i++){var s=a.prompts[i],r=$("<div/>",{class:"form-row"});$('<label for="node-dialog-login-'+s.id+'">'+RED._(s.label)+":</label><br/>").appendTo(r);var d=$('<input style="width: 100%" id="node-dialog-login-'+s.id+'" type="'+s.type+'" tabIndex="'+(i+1)+'"/>').appendTo(r);i<a.prompts.length-1&&d.keypress(function(){var e=r;return function(t){13==t.keyCode&&(e.next("div").find("input").focus(),t.preventDefault())}}()),r.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(t.cancelable?'<a href="#" id="node-dialog-login-cancel" style="margin-right: 20px;" tabIndex="'+(i+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" style="width: auto;" tabIndex="'+(i+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").submit(function(o){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var i={client_id:"node-red-editor",grant_type:"password",scope:""},s=0;s<a.prompts.length;s++){var r=a.prompts[s];i[r.id]=$("#node-dialog-login-"+r.id).val()}$.ajax({url:"auth/token",type:"POST",data:i}).done(function(o,a,i){RED.settings.set("auth-tokens",o),$("#node-dialog-login").dialog("destroy").remove(),t.updateMenu&&e(),n()}).fail(function(e,t,n){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()}).always(function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()}),o.preventDefault()})}else if("strategy"==a.type)for(i=0;i<a.prompts.length;i++){var s=a.prompts[i],r=$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields"),l=$('<a href="#"></a>',{style:"padding: 10px"}).appendTo(r).click(function(){document.location=s.url});if(s.image)$("<img>",{src:s.image}).appendTo(l);else if(s.label){var c=$("<span></span>").text(s.label);s.icon&&($("<i></i>",{class:"fa fa-2x "+s.icon,style:"vertical-align: middle"}).appendTo(l),c.css({verticalAlign:"middle",marginLeft:"8px"})),c.appendTo(l)}l.button()}t.cancelable&&$("#node-dialog-login-cancel").button().click(function(e){$("#node-dialog-login").dialog("destroy").remove()});var p=a.image||"red/images/node-red-256.png";$("#node-dialog-login-image").load(function(){o.dialog("open")}).attr("src",p)}})},logout:function(){var e=RED.settings.get("auth-tokens"),t=e?e.access_token:"";$.ajax({url:"auth/revoke",type:"POST",data:{token:t}}).done(function(e,t,n){RED.settings.remove("auth-tokens"),e&&e.redirect?document.location.href=e.redirect:document.location.reload(!0)}).fail(function(e,t,n){401===e.status?document.location.reload(!0):console.log(t)})},hasPermission:function(e){return""===e||!RED.settings.user||t(RED.settings.user.permissions||"",e)}}}(),RED.comms=function(){function e(e){var t;return(t=new RegExp("(?:^|; )"+encodeURIComponent(e)+"=([^;]*)").exec(document.cookie))?t[1]:null}function t(e){if("nodeEvent"==e.method){e.params[2].format&&!e.params[2].format.match(/string/g)&&(e.params[2].msg=JSON.stringify(e.params[2].msg));for(var t in a)if(a.hasOwnProperty(t)&&new RegExp("^"+t.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$").test(e.params[1])){var n=a[t];if(n)for(var o=0;o<n.length;o++)n[o](e.params[1],e.params[2])}}}var n=null,o=null,a={};return{homegear:function(){return n},connect:function(){var a="https:"==window.location.protocol,i="",s=a?"443":"80",r=window.location.host.indexOf("]");if(r>-1)part2=window.location.host.substring(r),part2.length>2&&":"==part2.charAt(1)&&(s=part2.substring(2)),i=window.location.host.substring(0,r+1);else{var d=window.location.host.split(":");i=d[0],d.length>1&&(s=d[1])}var l=e("PHPSESSID");(n=new HomegearWS(i,s,"hgflows",a,l)).ready(function(){o&&(o.close(),o=null)}),n.error(function(e){o&&o.close(),o=RED.notify(RED._("notification.error",{message:RED._("notification.errors.lostConnection")}),"error",!0)}),n.event(t),n.connect()},subscribe:function(e,t){null==a[e]&&(a[e]=[]),a[e].push(t)},unsubscribe:function(e,t){if(a[e]){for(var n=0;n<a[e].length;n++)if(a[e][n]===t){a[e].splice(n,1);break}0===a[e].length&&delete a[e]}},getEvents:function(){n.invoke("getNodeEvents",function(e){for(var t in e.result)if(e.result.hasOwnProperty(t)){var n=e.result[t];for(var o in n)if(n.hasOwnProperty(o)){var i=n[o];i.format&&!i.format.match(/string/g)&&(i.msg=JSON.stringify(i.msg));for(var s in a)if(a.hasOwnProperty(s)&&new RegExp("^"+s.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$").test(o)){var r=a[s];if(r)for(var d=0;d<r.length;d++)r[d](o,i)}}}})},getFixedInputs:function(){n.invoke("getNodesWithFixedInputs",function(e){var t=!1;for(var n in e.result)if(e.result.hasOwnProperty(n)){t=!0;var a=RED.nodes.node(n);a&&(a.fixedInputs=e.result[n],a.dirty=!0)}t&&(RED.view.redraw(),o&&o.close(),o=RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.fixed_inputs")}),"warning",!0))})}}}(),RED.text={},RED.text.bidi=function(){function e(e){for(var o=e.length,a=0;a<o;a++){if(t(e.charCodeAt(a)))return!0;if(n(e.charCodeAt(a)))return!1}return!1}function t(e){return e>=1488&&e<=1535||e>=1536&&e<=1631||e>=1642&&e<=1775||e>=1786&&e<=2047||e>=64285&&e<=65023||e>=65136&&e<=65276}function n(e){return e>64&&e<91||e>96&&e<123}function o(t){return"auto"==s?e(t)?"rtl":"ltr":s}function a(){$(this).attr("dir",o($(this).val()))}function i(){$("#workspace").find("span.bidiAware").each(function(){$(this).attr("dir",o($(this).html()))}),$("#sidebar").find("span.bidiAware").each(function(){$(this).attr("dir",o($(this).text()))})}var s="",r="‪",d="‫",l="‬";return{setTextDirection:function(e){s=e,RED.nodes.eachNode(function(e){e.dirty=!0}),RED.view.redraw(),RED.palette.refresh(),i()},enforceTextDirectionWithUCC:function(e){if(e){var t=o(e);if("ltr"==t)return r+e+l;if("rtl"==t)return d+e+l}return e},resolveBaseTextDir:o,prepareInput:function(e){e.on("keyup",a).on("paste",a).on("cut",a),a.call(e)}}}(),RED.text.format=function(){function e(e){switch(e){case"breadcrumb":return l;case"comma":return c;case"email":return p;case"filepath":return u;case"formula":return f;case"sql":return h;case"underscore":return g;case"url":return v;case"word":return m;case"xpath":return b;default:return y}}function t(e){var t=window.navigator.userAgent;if(t.indexOf("MSIE")>=0||t.indexOf("Trident")>=0||t.indexOf("Edge")>=0)return!1;var n=document.createElement(e.tagName);n.contentEditable=!0;var o="oninput"in n;return o||(n.setAttribute("oninput","return;"),o="function"==typeof n.oninput),n=null,o}function n(e,n,a,i,s){if(!e||1!=e.nodeType)return!1;w||(w=document.createEvent("Event")).initEvent("TF",!0,!0),e.setAttribute("data-tf-type",n);var d="undefined"===a?"{}":JSON.stringify(Array.isArray(a)?a[0]:a);e.setAttribute("data-tf-args",d);var l="ltr";if("undefined"===i&&(e.dir?l=e.dir:e.style&&e.style.direction&&(l=e.style.direction),i="rtl"===l.toLowerCase()),e.setAttribute("data-tf-dir",i),e.setAttribute("data-tf-locale",r.getLocaleDetails(s).lang),t(e)){e.oninput;e.oninput=function(e){o(e.target)}}else e.onkeyup=function(t){o(t.target),e.dispatchEvent(w)},e.onmouseup=function(t){o(t.target),e.dispatchEvent(w)};return o(e),!0}function o(t){var n=t.textContent||"",o=document.getSelection();if(0===n.length||!o||o.rangeCount<=0)t.dispatchEvent(w);else{var a,i,s=o.getRangeAt(0),r=s.cloneRange();a=s.startContainer,i=s.startOffset;var d=0;3===a.nodeType&&(d+=i),r.setStart(t,0),r.setEndBefore(a);var l=document.createElement("div");l.appendChild(r.cloneContents()),d+=l.textContent.length,t.innerHTML=e(t.getAttribute("data-tf-type")).format(n,JSON.parse(t.getAttribute("data-tf-args")),"true"===t.getAttribute("data-tf-dir"),!0,t.getAttribute("data-tf-locale"));var c=t,p=t,u=0,f=!1;for(o.removeAllRanges(),s.setStart(t,0),s.setEnd(t,0);p;){if(3===p.nodeType){if(u+p.nodeValue.length>=d){s.setStart(p,d-u);break}u+=p.nodeValue.length,p=p.nextSibling}else{if(p.hasChildNodes()){p=(c=p).firstChild;continue}p=p.nextSibling}for(;!p;){if(c===t){f=!0;break}p=c.nextSibling,c=c.parentNode}if(f)break}o.addRange(s),t.dispatchEvent(w)}}var a=function(e){this.content="",this.actual="",this.textDirection="",this.localGui="",this.isVisible=!0,this.isSeparator=!1,this.isParsed=!1,this.keep=!1,this.inBounds=!1,this.inPoints=!1;var t="";for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},i=function(){function e(e){if(!e)return!1;void 0===e.start&&(e.start=""),void 0===e.end&&(e.end=""),void 0!==e.startAfter?(e.start=e.startAfter,e.after=!0):e.after=!1,void 0!==e.endBefore?(e.end=e.endBefore,e.before=!0):e.before=!1;var t=parseInt(e.startPos,10);isNaN(t)?e.usePos=!1:e.usePos=!0;var n=parseInt(e.length,10);return isNaN(n)?e.useLength=!1:e.useLength=!0,e.loops=void 0===e.loops||!!e.loops,!0}function t(e,t){var n={};for(var o in t)t.hasOwnProperty(o)&&(n[o]=t[o]);var a=e.content,i=n.usePos&&n.startPos<a.length;i&&(n.start="",n.loops=!1),n.bStart=i?n.startPos:n.start.length>0?a.indexOf(n.start):0;var s=n.useLength&&n.length>0&&n.bStart+n.length<a.length;return s&&(n.end=""),n.bEnd=s?n.bStart+n.length:n.end.length>0?a.indexOf(n.end,n.bStart+n.start.length)+1:a.length,n.after||(n.start=""),n.before||(n.end=""),n}return{handleSubcontents:function(e,t,n,o,i){if(!n.content||"string"!=typeof n.content||0===n.content.length)return e;var s=!0;void 0!==n.loops&&(s=!!n.loops);for(var r=0;!0&&!(r>=e.length);r++)if(!(e[r].isParsed||e.keep||e[r].isSeparator)){var d=e[r].content,l=d.indexOf(n.content);if(!(l<0)){var c,p=0;if(n.continued)do{p++,c=d.indexOf(n.content,l+p*n.content.length)}while(0===c);else p=1;if(c=l+p*n.content.length,e.splice(r,1),l>0&&(e.splice(r,0,new a({content:d.substring(0,l),localGui:t.dir,keep:!0})),r++),e.splice(r,0,new a({content:d.substring(l,c),textDirection:n.subDir,localGui:t.dir})),c<d.length&&e.splice(r+1,0,new a({content:d.substring(c,d.length),localGui:t.dir,keep:!0})),!s)break}}},handleBounds:function(n,o,i,s,r){for(var d=0;d<i.length;d++)if(e(i[d]))for(var l=0;!0&&!(l>=n.length);l++)if(!(n[l].isParsed||n[l].inBounds||n.keep||n[l].isSeparator)){var c=t(n[l],i[d]),p=c.bStart,u=c.bEnd;if(!(p<0||u<0)){var f=n[l].content;if(n.splice(l,1),p>0&&(n.splice(l,0,new a({content:f.substring(0,p),localGui:o.dir,keep:!0})),l++),c.start&&(n.splice(l,0,new a({content:c.start,localGui:o.dir,isSeparator:!0})),l++),n.splice(l,0,new a({content:f.substring(p+c.start.length,u-c.end.length),textDirection:c.subDir,localGui:o.dir,inBounds:!0})),c.end&&(l++,n.splice(l,0,new a({content:c.end,localGui:o.dir,isSeparator:!0}))),u+c.end.length<f.length&&n.splice(l+1,0,new a({content:f.substring(u+c.end.length,f.length),localGui:o.dir,keep:!0})),!c.loops)break}}for(d=0;d<n.length;d++)n[d].inBounds=!1;return n},handleCases:function(e,t,n,o,a){if(0===n.length)return e;var i={};for(var s in t)t.hasOwnProperty(s)&&(i[s]=t[s]);for(var r=0;r<n.length;r++)n[r].handler&&"function"==typeof n[r].handler.handle||(n[r].handler=t.commonHandler),n[r].args?(i.cases=n[r].args.cases,i.points=n[r].args.points,i.bounds=n[r].args.bounds,i.subs=n[r].args.subs):(i.cases=[],i.points=[],i.bounds=[],i.subs={}),n[r].handler.handle(o,e,i,a);return e},handlePoints:function(e,t,n,o,i){for(var s=0;s<n.length;s++)for(var r=0;!0&&!(r>=e.length);r++)if(!(e[r].isParsed||e[r].keep||e[r].isSeparator)){var d=e[r].content,l=d.indexOf(n[s]);l>=0&&(e.splice(r,1),l>0&&(e.splice(r,0,new a({content:d.substring(0,l),textDirection:t.subDir,localGui:t.dir,inPoints:!0})),r++),e.splice(r,0,new a({content:n[s],localGui:t.dir,isSeparator:!0})),l+n[s].length+1<=d.length&&e.splice(r+1,0,new a({content:d.substring(l+n[s].length),textDirection:t.subDir,localGui:t.dir,inPoints:!0})))}for(s=0;s<e.length;s++)e[s].keep?e[s].keep=!1:e[s].inPoints&&(e[s].isParsed=!0,e[s].inPoints=!1);return e}}}(),s={handle:function(e,t,n,o){var a=[];Array.isArray(n.cases)&&(a=n.cases);var s=[];void 0!==n.points&&(Array.isArray(n.points)?s=n.points:"string"==typeof n.points&&(s=n.points.split("")));var r={};"object"==typeof n.subs&&(r=n.subs);var d=[];return Array.isArray(n.bounds)&&(d=n.bounds),i.handleBounds(t,n,d,e,o),i.handleSubcontents(t,n,r,e,o),i.handleCases(t,n,a,e,o),i.handlePoints(t,n,s,e,o),t}},r=function(){var e=function(e){var t=e?e.split("-")[0]:"";return!(!t||t.length<2)&&["iw","he","ar","fa","ur"].some(function(e){return e===t})};return{LRE:"‪",RLE:"‫",PDF:"‬",LRM:"‎",RLM:"‏",LRO:"‭",RLO:"‮",getLocaleDetails:function(t){if(t||(t="undefined"==typeof navigator?"":navigator.language||navigator.userLanguage||""),t=t.toLowerCase(),e(t)){var n=t.split("-");return{lang:n[0],country:n[1]?n[1]:""}}return{lang:"not-bidi"}},removeUcc:function(e){return e?e.replace(/[\u200E\u200F\u202A-\u202E]/g,""):e},removeTags:function(e){return e?e.replace(/<[^<]*>/g,""):e},getDirection:function(e,t,n,o){if("auto"!==t&&/^(rtl|ltr)$/i.test(t))return t;n=/^(rtl|ltr)$/i.test(n)?n:"ltr";var a=o?e.split("").reverse().join(""):e,i=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(a);return i?i[0]<="z"?"ltr":"rtl":n},hasArabicChar:function(e){return!!/[\u0600-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e)},showMarks:function(e,t){for(var n="",o=0;o<e.length;o++){var a=""+e.charAt(o);switch(a){case"‎":n+="<LRM>";break;case"‏":n+="<RLM>";break;case"‪":n+="<LRE>";break;case"‫":n+="<RLE>";break;case"‭":n+="<LRO>";break;case"‮":n+="<RLO>";break;case"‬":n+="<PDF>";break;default:n+=a}}var i=void 0!==t&&/^(rtl|ltr)$/i.test(t)?"rtl"===t?"‮":"‭":"";return i+n+(""===i?"":"‬")},hideMarks:function(e){return e.replace(/<LRM>/g,this.LRM).replace(/<RLM>/g,this.RLM).replace(/<LRE>/g,this.LRE).replace(/<RLE>/g,this.RLE).replace(/<LRO>/g,this.LRO).replace(/<RLO>/g,this.RLO).replace(/<PDF>/g,this.PDF)},showTags:function(e){return"<xmp>"+e+"</xmp>"},hideTags:function(e){return e.replace(/<xmp>/g,"").replace(/<\/xmp>/g,"")}}}(),d=function(){function e(e,t){var n=Array.isArray(e)?e[0]:e;return n.guiDir||(n.guiDir="ltr"),n.dir||(n.dir=n.guiDir),t?(void 0===n.points&&(n.points=[]),n.cases||(n.cases=[]),n.bounds||(n.bounds=[]),n.commonHandler=s,n):n}function t(t,n,o){if(!t||!n)return new a({content:""});var i=e(n,!0),r=[new a({content:t,actual:t,localGui:i.dir})],d=s.handle;return i.handler&&"function"==typeof i.handler&&(d=i.handler.handle),d(t,r,i,o),r}function n(t,n,a){var s=e(n,!1);return a?i(t,s):o(t,s)}function o(e,t,n){for(var o="",a="",i=!1,s=0;s<e.length;s++)if(e[s].isVisible){var d=e[s].textDirection,l=e[s].localGui;""!==l&&""===a?o+="rtl"===l?r.RLE:r.LRE:""===a||""!==l&&l===a&&!i||(o+=r.PDF+(s==e.length-1&&""!==l?"":"rtl"===t.dir?r.RLM:r.LRM),""!==l&&(o+="rtl"===l?r.RLE:r.LRE)),"auto"===d&&(d=r.getDirection(e[s].content,d,t.guiDir)),/^(rtl|ltr)$/i.test(d)?(o+=("rtl"===d?r.RLE:r.LRE)+e[s].content+r.PDF,d):(o+=e[s].content,r.getDirection(e[s].content,d,t.guiDir,!0)),s<e.length-1?o+="rtl"===(l&&e[s+1].localGui?l:t.dir)?r.RLM:r.LRM:""!==a&&(o+=r.PDF),a=l,i=!1}else i=!0;var c="auto"===t.dir?r.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;return c!==t.guiDir&&(o=("rtl"===c?r.RLE:r.LRE)+o+r.PDF),o}function i(e,t,n){for(var o="",a="",i=0;i<e.length;i++)if(e[i].isVisible){var s=e[i].textDirection,d=e[i].localGui;""!==d&&""===a?o+="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>":""===a||""!==d&&d===a&&!stop||(o+="</bdi>"+(i==e.length-1&&""!==d?"":"<span style='unicode-bidi: embed; direction: "+("rtl"===t.dir?"rtl":"ltr")+";'></span>"),""!==d&&(o+="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>")),"auto"===s&&(s=r.getDirection(e[i].content,s,t.guiDir)),/^(rtl|ltr)$/i.test(s)?(o+="<bdi dir='"+("rtl"===s?"rtl":"ltr")+"'>"+e[i].content+"</bdi>",s):(o+=e[i].content,r.getDirection(e[i].content,s,t.guiDir,!0)),i<e.length-1?o+="<span style='unicode-bidi: embed; direction: "+("rtl"===(d&&e[i+1].localGui?d:t.dir)?"rtl":"ltr")+";'></span>":""!==a&&(o+="</bdi>"),a=d,stop=!1}else stop=!0;var l="auto"===t.dir?r.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;return l!==t.guiDir&&(o="<bdi dir='"+("rtl"===l?"rtl":"ltr")+"'>"+o+"</bdi>"),o}var d={};return d.parseAndDisplayStructure=function(e,o,a,i){return e&&o?n(t(e,o,i),o,a):e},d.parseStructure=t,d.displayStructure=n,d.restore=function(e,t){return e},d}(),l={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:t.dir?t.dir:n?"rtl":"ltr",subs:{content:">",continued:!0,subDir:n?"rtl":"ltr"},cases:[{args:{subs:{content:"<",continued:!0,subDir:n?"ltr":"rtl"}}}]};return i?d.parseStructure(e,s,!!o,a):d.parseAndDisplayStructure(e,s,!!o,a)}},c={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:"ltr",points:","};return i?d.parseStructure(e,s,!!o,a):d.parseAndDisplayStructure(e,s,!!o,a)}},p=function(){function e(e,t){if("ar"!==r.getLocaleDetails(t).lang)return"ltr";var n=e.indexOf("@");return n>0&&n<e.length-1&&r.hasArabicChar(e.substring(n+1))?"rtl":"ltr"}return{format:function(t,n,o,a,i,r){var l={guiDir:o?"rtl":"ltr",dir:e(t,i),points:"<>.:,;@",cases:[{handler:s,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"(",endBefore:")"}],points:""}}]};return r?d.parseStructure(t,l,!!a,i):d.parseAndDisplayStructure(t,l,!!a,i)}}}(),u={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:"ltr",points:"/\\:."};return i?d.parseStructure(e,s,!!o,a):d.parseAndDisplayStructure(e,s,!!o,a)}},f={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:"ltr",points:" /%^&[]<>=!?~:.,|()+-*{}"};return i?d.parseStructure(e,s,!!o,a):d.parseAndDisplayStructure(e,s,!!o,a)}},h={format:function(e,t,n,o,a,i){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:"\t!#%&()*+,-./:;<=>?|[]{}",cases:[{handler:s,args:{bounds:[{startAfter:"/*",endBefore:"*/"},{startAfter:"--",end:"\n"},{startAfter:"--"}]}},{handler:s,args:{subs:{content:" ",continued:!0}}},{handler:s,args:{bounds:[{startAfter:"'",endBefore:"'"},{startAfter:'"',endBefore:'"'}]}}]};return i?d.parseStructure(e,r,!!o,a):d.parseAndDisplayStructure(e,r,!!o,a)}},g={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:"ltr",points:"_"};return i?d.parseStructure(e,s,!!o,a):d.parseAndDisplayStructure(e,s,!!o,a)}},v={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:"ltr",points:":?#/@.[]="};return i?d.parseStructure(e,s,!!o,a):d.parseAndDisplayStructure(e,s,!!o,a)}},m={format:function(e,t,n,o,a,i){var s={guiDir:n?"rtl":"ltr",dir:t.dir?t.dir:n?"rtl":"ltr",points:" ,.!?;:"};return i?d.parseStructure(e,s,!!o,a):d.parseAndDisplayStructure(e,s,!!o,a)}},b={format:function(e,t,n,o,a,i){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:" /[]<>=!:@.|()+-*",cases:[{handler:s,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"'",endBefore:"'"}],points:""}}]};return i?d.parseStructure(e,r,!!o,a):d.parseAndDisplayStructure(e,r,!!o,a)}},y={format:function(e,t,n,o,a,i){var s={},r="",l=Array.isArray(t)?t[0]:t;for(r in l)l.hasOwnProperty(r)&&(s[r]=l[r]);return s.guiDir=n?"rtl":"ltr",s.dir=s.dir?s.dir:s.guiDir,i?d.parseStructure(e,s,!!o,a):d.parseAndDisplayStructure(e,s,!!o,a)}},w=(function(){function e(e){return"he"===e||"iw"===e||"ar"===e?"rtl":"ltr"}function t(t){0===t.msgDir.length&&(t.msgDir=e(t.msgLang)),t.msgDir="ltr"!==t.msgDir&&"rtl"!==t.msgDir&&"auto"!=t.msgDir?"ltr":t.msgDir,0===t.guiDir.length&&(t.guiDir=t.msgDir),t.guiDir="rtl"!==t.guiDir?"ltr":"rtl",0===t.phDir.length&&(t.phDir=0===t.phLang.length?t.msgDir:e(t.phLang)),t.phDir="ltr"!==t.phDir&&"rtl"!==t.phDir&&"auto"!=t.phDir?"ltr":t.phDir,"string"==typeof t.phPacking&&(t.phPacking=t.phPacking.split("")),t.phPacking.length<2&&(t.phPacking=["{","}"])}var n={msgLang:"en",msgDir:"",phLang:"",phDir:"",phPacking:["{","}"],phStt:{type:"none",args:{}},guiDir:""},o=!1}(),null);return{getHtml:function(t,n,o,a,i){return e(n).format(t,o,a,!0,i)},attach:function(e,t,o,a,i){return n(e,t,o,a,i)}}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8,QUICK_JOINING:9},RED.nodes=function(){function e(e){j=e,RED.events.emit("nodes:change",{dirty:j})}function t(){return(1+4294967295*Math.random()).toString(16)}function o(e){if(0!==e.type.indexOf("subflow")?e._=e._def._:e._=RED._,"config"==e._def.category)x[e.id]=e;else{if(e.inputPorts=[],e.inputs)for(t=0;t<e.inputs;t++)e.inputPorts.push(t);if(e.outputPorts=[],e.wires&&e.wires.length>e.outputs&&(e.outputs=e.wires.length),e.outputs)for(var t=0;t<e.outputs;t++)e.outputPorts.push(t);if(e.dirty=!0,y(e),"subflows"==e._def.category&&void 0===e.i){var n=0;RED.nodes.eachNode(function(e){n=Math.max(n,e.i||0)}),e.i=n+1}E.push(e)}RED.events.emit("nodes:add",e)}function a(e){R.push(e)}function s(e){if(e in x)return x[e];for(var t in E)if(E[t].id==e)return E[t];return null}function r(e){var t,o=[],a=[];if(e in x)t=x[e],delete x[e],RED.events.emit("nodes:remove",t),RED.workspaces.refresh();else if(t=s(e)){E.splice(E.indexOf(t),1),(o=R.filter(function(e){return e.source===t||e.target===t})).forEach(function(e){R.splice(R.indexOf(e),1)});var i=!1;for(var d in t._def.defaults)if(t._def.defaults.hasOwnProperty(d)){var l=t._def.defaults[d];if(l.type){var c=S.getNodeType(l.type);if(c&&"config"==c.category){var p=x[t[d]];if(p)if(i=!0,p._def.exclusive)r(t[d]),a.push(p);else{var u=p.users;u.splice(u.indexOf(t),1)}}}}i&&RED.workspaces.refresh();try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}RED.events.emit("nodes:remove",t)}return t&&t._def.onremove&&(console.log("Deprecated API warning: node type ",t.type," has an onremove function - should be oneditremove - please report"),t._def.onremove.call(n)),{links:o,nodes:a}}function d(e){T[e.id]=e,e._def=RED.nodes.getType("tab"),k.push(e.id)}function l(e,t){if(t){var n=Object.keys(_).map(function(e){return _[e].name});n.sort();var o=1,a=e.name;n.forEach(function(t){a==t&&(o++,a=e.name+" ("+o+")")}),e.name=a}_[e.id]=e,RED.nodes.registerType("subflow:"+e.id,{defaults:{name:{value:""}},info:e.info,icon:function(){return e.icon||"subflow.png"},category:"subflows",inputs:e.in.length,outputs:e.out.length,color:"#da9",label:function(){return this.name||RED.nodes.subflow(e.id).name},labelStyle:function(){return this.name?"node_label_italic":""},paletteLabel:function(){return RED.nodes.subflow(e.id).name},inputLabels:function(t){return e.inputLabels?e.inputLabels[t]:null},outputLabels:function(t){return e.outputLabels?e.outputLabels[t]:null},set:{module:"node-red"}}),e._def=RED.nodes.getType("subflow:"+e.id)}function c(e){return _[e]}function p(e,t){for(var n=0;n<E.length;n++){var o=E[n];if(o.z===e){var a=/^subflow:(.+)$/.exec(o.type);if(a){if(a[1]===t)return!0;if(p(a[1],t))return!0}}}return!1}function u(e){var t={};t.id=e.id,t.type=e.type,t.namespace=e.namespace?e.namespace:e.type;for(var n in e._def.defaults)e._def.defaults.hasOwnProperty(n)&&(t[n]=e[n]);return t}function f(e,t){if("tab"===e.type)return u(e);t=t||!1;var n={};if(n.id=e.id,n.type=e.type,n.namespace=e._def.namespace?e._def.namespace:e.type,n.z=e.z,"unknown"==n.type)for(var o in e._orig)e._orig.hasOwnProperty(o)&&(n[o]=e._orig[o]);else{for(var a in e._def.defaults)e._def.defaults.hasOwnProperty(a)&&(n[a]=e[a]);if(t&&e.credentials){var i={};n.credentials={};for(var s in e._def.credentials)e._def.credentials.hasOwnProperty(s)&&("password"==e._def.credentials[s].type?(!e.credentials._||e.credentials["has_"+s]!=e.credentials._["has_"+s]||e.credentials["has_"+s]&&e.credentials[s])&&(i[s]=e.credentials[s]):null==e.credentials[s]||e.credentials._&&e.credentials[s]==e.credentials._[s]||(i[s]=e.credentials[s]));Object.keys(i).length>0&&(n.credentials=i)}}if("config"!=e._def.category){n.x=e.x,n.y=e.y,n.wires=[];for(var r=0;r<e.outputs;r++)n.wires.push([]);for(var d=R.filter(function(t){return t.source===e}),l=0;l<d.length;l++){var c=d[l];"subflow"!=c.target.type&&c.sourcePort<n.wires.length&&n.wires[c.sourcePort].push({id:c.target.id,port:c.targetPort})}if(e.inputs>0&&e.inputLabels&&!/^\s*$/.test(e.inputLabels.join(""))&&(n.inputLabels=e.inputLabels.slice()),e.outputs>0&&e.outputLabels&&!/^\s*$/.test(e.outputLabels.join(""))&&(n.outputLabels=e.outputLabels.slice()),(!e._def.defaults||!e._def.defaults.hasOwnProperty("icon"))&&e.icon){var p=RED.utils.getDefaultNodeIcon(e._def,e);e.icon!==p.module+"/"+p.file&&(n.icon=e.icon)}}return n}function h(e){var t={};return t.id=e.id,t.type=e.type,t.namespace=e.namespace?e.namespace:e.type,t.name=e.name,t.info=e.info,t.in=[],t.out=[],e.in.forEach(function(e){for(var n={x:e.x,y:e.y,wires:[]},o=R.filter(function(t){return t.source===e}),a=0;a<o.length;a++){var i=o[a];"subflow"!=i.target.type&&n.wires.push({id:i.target.id,port:o[a].targetPort})}t.in.push(n)}),e.out.forEach(function(n,o){var a={x:n.x,y:n.y,wires:[]},s=R.filter(function(e){return e.target===n});for(i=0;i<s.length;i++)"subflow"!=s[i].source.type?a.wires.push({id:s[i].source.id,port:s[i].sourcePort}):a.wires.push({id:e.id,port:s[i].sourcePort});t.out.push(a)}),t.in.length>0&&e.inputLabels&&!/^\s*$/.test(e.inputLabels.join(""))&&(t.inputLabels=e.inputLabels.slice()),t.out.length>0&&e.outputLabels&&!/^\s*$/.test(e.outputLabels.join(""))&&(t.outputLabels=e.outputLabels.slice()),e.icon&&"node-red/subflow.png"!==e.icon&&(t.icon=e.icon),t}function g(e,t,n){var o=[];n=n||{},t=t||{};for(var a=0;a<e.length;a++){var i=e[a];if("subflow:"==i.type.substring(0,8)){var s=i.type.substring(8);if(!t[s]){t[s]=!0;var r=[c(s)];RED.nodes.eachNode(function(e){e.z==s&&r.push(e)}),o=g(r,t,n).concat(o)}}if("subflow"!=i.type){var d=RED.nodes.convertNode(i);for(var l in i._def.defaults)if(i._def.defaults[l].type&&i[l]in x){var p=x[i[l]],u=S.getNodeType(i._def.defaults[l].type).exportable;null==u||u?i[l]in n||(n[i[l]]=!0,e.push(p)):d[l]=""}o.push(d)}else{var f=h(i);o.push(f)}}return o}function v(e,t){var n,o=null;try{RED.nodes.eachSubflow(function(a){if(a.name==e.name&&a.info==e.info&&a.in.length==e.in.length&&a.out.length==e.out.length){var i=RED.nodes.filterNodes({z:a.id});if(i.length==t.length){var s=[e].concat(t),r=[a].concat(i),d=JSON.stringify(s),l=JSON.stringify(g(r));for(n=0;n<i.length;n++)d=d.replace(new RegExp('"'+t[n].id+'"',"g"),'"'+i[n].id+'"');if((d=d.replace(new RegExp('"'+e.id+'"',"g"),'"'+a.id+'"'))===l)throw o=a,new Error}}})}catch(e){console.log(e.stack)}return o}function m(e,t,n){if(n&&e.id!=t.id)return!1;if(e.type!=t.type)return!1;var o=e._def;for(var a in o.defaults)if(o.defaults.hasOwnProperty(a)){var i=e[a],s=t[a];if(typeof i!=typeof s)return!1;if(null===i||"string"==typeof i||"number"==typeof i){if(i!==s)return!1}else if(JSON.stringify(i)!==JSON.stringify(s))return!1}return!0}function b(e,n,i){var s,r,u,f={};if("string"==typeof e){if(""===e)return;try{u=JSON.parse(e)}catch(j){var h=new Error(RED._("clipboard.invalidFlow",{message:j.message}));throw h.code="NODE_RED",h}}else u=e;$.isArray(u)||(u=[u]);var g=!1;D||(g=!0,D=JSON.parse(JSON.stringify(u)));var b=[];for(s=0;s<u.length;s++)"workspace"==(r=u[s]).type||"tab"==r.type||"subflow"==r.type||S.getNodeType(r.type)||"subflow:"==r.type.substring(0,8)||-1!=b.indexOf(r.type)||b.push(r.type),r.z&&(f[r.z]=f[r.z]||[],f[r.z].push(r));if(!g&&b.length>0){var y="<ul><li>"+b.join("</li><li>")+"</li></ul>";b.length;RED.notify("<p>"+RED._("clipboard.importUnrecognised",{count:b.length})+"</p>"+y,"error",!1,1e4)}var E=RED.workspaces.active(),R=c(E);for(s=0;s<u.length;s++){var k=/^subflow:(.+)$/.exec(u[s].type);if(k){var _=k[1],C=c(u[s].z||E);if(C){var j;if(_===C.id&&(j=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),p(_,C.id)&&(j=new Error(RED._("notification.errors.cannotAddCircularReference"))),j)throw j.code="NODE_RED",j}}}var O,P,L,I,N=[],A={},z=[],M={},B={},J={},U=[],G=[],V=null;for(s=0;s<u.length;s++)if("workspace"===(r=u[s]).type||"tab"===r.type)"workspace"===r.type&&(r.type="tab"),null==w&&(w=r),n&&(O=t(),A[r.id]=O,r.id=O),d(r),RED.workspaces.add(r),N.push(r);else if("subflow"===r.type){var F=v(r,f[r.id]);F?B[r.id]=F:(M[r.id]=r,n&&(O=t(),r.id=O),r.in.forEach(function(e,n){e.type="subflow",e.direction="in",e.z=r.id,e.i=n,e.id=t()}),r.out.forEach(function(e,n){e.type="subflow",e.direction="out",e.z=r.id,e.i=n,e.id=t()}),z.push(r),l(r,n))}for(null==w&&(d(w={type:"tab",id:t(),disabled:!1,info:"",label:RED._("workspace.defaultName",{number:1})}),RED.workspaces.add(w),N.push(w),E=RED.workspaces.active()),s=0;s<u.length;s++)if(r=u[s],(P=S.getNodeType(r.type))&&"config"==P.category){var W=null;if(n){if(r.z){if(B[r.z])continue;M[r.z]?r.z=M[r.z].id:(r.z=A[r.z],T[r.z]||(i?(null===V&&(V=RED.workspaces.add(null,!0),N.push(V)),r.z=V.id):r.z=E))}if((W=RED.nodes.node(r.id))&&r.z&&W.z!==r.z){W=null;for(var q in x)if(x.hasOwnProperty(q)&&x[q].z===r.z&&m(x[q],r,!1)){W=x[q],J[r.id]=x[q];break}}}if(!W||W._def.exclusive){L={id:r.id,z:r.z,type:r.type,namespace:r.namespace,users:[],_config:{}};for(I in P.defaults)P.defaults.hasOwnProperty(I)&&(L[I]=r[I],L._config[I]=JSON.stringify(r[I]));if(P.hasOwnProperty("credentials")&&r.hasOwnProperty("credentials")){L.credentials={};for(I in P.credentials)P.credentials.hasOwnProperty(I)&&r.credentials.hasOwnProperty(I)&&(L.credentials[I]=r.credentials[I])}L.label=P.label,L._def=P,n&&(L.id=t()),J[r.id]=L,U.push(L),RED.nodes.add(L)}}for(s=0;s<u.length;s++)if("workspace"!==(r=u[s]).type&&"tab"!==r.type&&"subflow"!==r.type&&(!(P=S.getNodeType(r.type))||"config"!=P.category)){var H={x:r.x,y:r.y,z:r.z,type:0,wires:r.wires,inputLabels:r.inputLabels,outputLabels:r.outputLabels,icon:r.icon,changed:!1,fixedInputs:0,_config:{}};if(n){if(B[r.z])continue;M[H.z]?H.z=M[H.z].id:(H.z=A[H.z],T[H.z]||(i?(null===V&&(V=RED.workspaces.add(null,!0),N.push(V)),H.z=V.id):H.z=E)),H.id=t()}else H.id=r.id,null!=H.z&&(T[H.z]||M[H.z])||(i?(null===V&&(V=RED.workspaces.add(null,!0),N.push(V)),H.z=V.id):H.z=E);if(H.type=r.type,H.namespace=r.namespace?r.namespace:P.namespace?P.namespace:r.type,H._def=P,"subflow"===r.type.substring(0,7)){var K=r.type.split(":")[1],Y=B[K]||M[K]||c(K);n&&(K=Y.id,H.type="subflow:"+K,H.namespace=H.type,H._def=S.getNodeType(H.type),delete H.i),H.name=r.name,H.outputs=Y.out.length,H.inputs=Y.in.length}else{if(!H._def){H.x&&H.y?H._def={color:"#fee",defaults:{},label:"unknown: "+r.type,labelStyle:"node_label_italic",outputs:r.outputs||r.wires.length,set:S.getNodeSet("node-red/unknown")}:(H._def={category:"config",set:S.getNodeSet("node-red/unknown")},H.users=[],delete H.x,delete H.y,delete H.wires,delete H.inputLabels,delete H.outputLabels);var X={};for(var Z in r)r.hasOwnProperty(Z)&&"x"!=Z&&"y"!=Z&&"z"!=Z&&"id"!=Z&&"wires"!=Z&&(X[Z]=r[Z]);H._orig=X,H.name=r.type,H.type="unknown",H.namespace="unknown"}if("config"!=H._def.category){H.inputs=r.inputs||H._def.inputs,H.outputs=r.outputs||H._def.outputs,H.hasOwnProperty("wires")&&H.wires.length>H.outputs&&(console.log("Warning: node.wires longer than node.outputs - trimming wires:",H.id," wires:",H.wires.length," outputs:",H.outputs),H.wires=H.wires.slice(0,H.outputs));for(I in H._def.defaults)H._def.defaults.hasOwnProperty(I)&&(H[I]=r[I],H._config[I]=JSON.stringify(r[I]));if(H._config.x=H.x,H._config.y=H.y,H._def.hasOwnProperty("credentials")&&r.hasOwnProperty("credentials")){H.credentials={};for(I in H._def.credentials)H._def.credentials.hasOwnProperty(I)&&r.credentials.hasOwnProperty(I)&&(H.credentials[I]=r.credentials[I])}}}o(H),RED.editor.validateNode(H),J[r.id]=H,"unknown"!==H.type&&"config"===H._def.category||U.push(H)}var Q={catch:"scope",status:"scope","link-in":"links","link-out":"links"};for(s=0;s<U.length;s++){if((r=U[s]).wires){for(var ee=0;ee<r.wires.length;ee++)for(var te=r.wires[ee]instanceof Array?r.wires[ee]:[r.wires[ee]],ne=0;ne<te.length;ne++)if(J.hasOwnProperty(te[ne].id)&&te[ne].port<J[te[ne].id].inputs)if(r.z===J[te[ne].id].z){var oe={source:r,sourcePort:ee,target:J[te[ne].id],targetPort:te[ne].port};a(oe),G.push(oe)}else console.log("Warning: dropping link that crosses tabs:",r.id,"->",J[te[ne]].id);delete r.wires}for(var ae in r._def.defaults)if(r._def.defaults.hasOwnProperty(ae))if(r._def.defaults[ae].type&&J[r[ae]])r[ae]=J[r[ae]].id,(L=RED.nodes.node(r[ae]))&&-1===L.users.indexOf(r)&&L.users.push(r);else if(Q.hasOwnProperty(r.type)&&Q[r.type]===ae&&void 0!==r[ae]&&null!==r[ae])for(var ie=0;ie<r[ae].length;ie++)J[r[ae][ie]]&&(r[ae][ie]=J[r[ae][ie]].id);R&&/^link /.test(r.type)&&r.links&&(r.links=r.links.filter(function(e){var t=RED.nodes.node(e);return t&&t.z===E})),RED.editor.validateNode(r)}for(s=0;s<z.length;s++)(r=z[s]).in.forEach(function(e){e.wires.forEach(function(t,n){var o={source:e,sourcePort:n,target:J[t.id],targetPort:t.port};a(o),G.push(o)}),delete e.wires}),r.out.forEach(function(e){e.wires.forEach(function(t){var n;a(n=M[t.id]&&M[t.id].id==r.id?{source:r.in[t.port],sourcePort:t.port,target:e}:{source:J[t.id]||M[t.id],sourcePort:t.port,target:e}),G.push(n)}),delete e.wires});return RED.workspaces.refresh(),[U,G,N,z,V]}function y(e){for(var t in e._def.defaults)if(e._def.defaults.hasOwnProperty(t)){var n=e._def.defaults[t];if(n.type){var o=S.getNodeType(n.type);if(o&&"config"==o.category){var a=x[e[t]];a&&-1===a.users.indexOf(e)&&a.users.push(e)}}}}var w,D,E=[],x={},R=[],T={},k=[],_={},C=null,j=!1,S=function(){var e={},t=[],n={},o={},a={},i={};a.tab={defaults:{label:{value:""},disabled:{value:!1},info:{value:""}}};var s={setModulePendingUpdated:function(t,n){e[t].pending_version=n,RED.events.emit("registry:module-updated",{module:t,version:n})},getModule:function(t){return e[t]},getNodeSetForType:function(e){return s.getNodeSet(o[e])},getModuleList:function(){return e},getNodeList:function(){return t},getNodeTypes:function(){return Object.keys(a)},setNodeList:function(e){t=[];for(var n=0;n<e.length;n++){var o=e[n];s.addNodeSet(o)}},addNodeSet:function(a){a.added=!1,n[a.id]=a;for(var i=0;i<a.types.length;i++)o[a.types[i]]=a.id;t.push(a),e[a.module]=e[a.module]||{name:a.module,version:a.version,local:a.local,sets:{}},a.pending_version&&(e[a.module].pending_version=a.pending_version),e[a.module].sets[a.name]=a,RED.events.emit("registry:node-set-added",a)},removeNodeSet:function(a){for(var i=n[a],s=0;s<i.types.length;s++)delete o[i.types[s]];delete n[a];for(var r=0;r<t.length;r++)if(t[r].id===a){t.splice(r,1);break}return delete e[i.module].sets[i.name],0===Object.keys(e[i.module].sets).length&&delete e[i.module],RED.events.emit("registry:node-set-removed",i),i},getNodeSet:function(e){return n[e]},enableNodeSet:function(e){var t=n[e];t.enabled=!0,RED.events.emit("registry:node-set-enabled",t)},disableNodeSet:function(e){var t=n[e];t.enabled=!1,RED.events.emit("registry:node-set-disabled",t)},registerNodeType:function(e,t){if(a[e]=t,t.type=e,"subflows"!=t.category){t.set=n[o[e]],n[o[e]].added=!0,n[o[e]].enabled=!0;var i;i="node-red"===t.set.module?"node-red":t.set.id,t._=function(){var e=Array.prototype.slice.call(arguments,0),t=e[0];-1===e[0].indexOf(":")&&(e[0]=i+":"+e[0]);var n=RED._.apply(null,e);return n===e[0]&&(n=t),n}}RED.events.emit("registry:node-type-added",e)},removeNodeType:function(e){if("subflow:"!=e.substring(0,8))throw new Error("this api is subflow only. called with:",e);delete a[e],RED.events.emit("registry:node-type-removed",e)},getNodeType:function(e){return a[e]},setIconSets:function(e){i=e},getIconSets:function(){return i}};return s}();return{init:function(){RED.events.on("registry:node-type-added",function(e){S.getNodeType(e);var t=[];if(RED.nodes.eachNode(function(n){"unknown"===n.type&&n.name===e&&t.push(n)}),RED.nodes.eachConfig(function(n){"unknown"===n.type&&n.name===e&&t.push(n)}),t.length>0){var n=[];t.forEach(function(e){x.hasOwnProperty(e.id)?delete x[e.id]:E.splice(E.indexOf(e),1),n.push(f(e))}),RED.view.redraw(!0);var o={};b(n,!1)[0].forEach(function(e){o[e.id]=e}),RED.nodes.eachLink(function(e){o.hasOwnProperty(e.source.id)&&(e.source=o[e.source.id]),o.hasOwnProperty(e.target.id)&&(e.target=o[e.target.id])}),RED.view.redraw(!0)}})},registry:S,setNodeList:S.setNodeList,getNodeSet:S.getNodeSet,addNodeSet:S.addNodeSet,removeNodeSet:S.removeNodeSet,enableNodeSet:S.enableNodeSet,disableNodeSet:S.disableNodeSet,setIconSets:S.setIconSets,getIconSets:S.getIconSets,registerType:S.registerNodeType,getType:S.getNodeType,convertNode:f,add:o,remove:r,clear:function(){E=[],R=[],x={},k=[],Object.keys(_).forEach(function(e){RED.subflow.removeSubflow(e)}),Object.keys(T).forEach(function(e){RED.workspaces.remove(T[e])}),w=null,D=null,RED.nodes.dirty(!1),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.sidebar.info.refresh()},addLink:a,removeLink:function(e){var t=R.indexOf(e);-1!=t&&R.splice(t,1)},addWorkspace:d,removeWorkspace:function(e){delete T[e],k.splice(k.indexOf(e),1);var t,n,o=[],a=[];for(t=0;t<E.length;t++)(n=E[t]).z==e&&o.push(n);for(t in x)x.hasOwnProperty(t)&&(n=x[t]).z==e&&o.push(n);for(t=0;t<o.length;t++){var i=r(o[t].id);a=a.concat(i.links)}return{nodes:o,links:a}},getWorkspaceOrder:function(){return k},setWorkspaceOrder:function(e){k=e},workspace:function(e){return T[e]},addSubflow:l,removeSubflow:function(e){delete _[e.id],S.removeNodeType("subflow:"+e.id)},subflow:c,subflowContains:p,eachNode:function(e){for(var t=0;t<E.length;t++)e(E[t])},eachLink:function(e){for(var t=0;t<R.length;t++)e(R[t])},eachConfig:function(e){for(var t in x)x.hasOwnProperty(t)&&e(x[t])},eachSubflow:function(e){for(var t in _)_.hasOwnProperty(t)&&e(_[t])},eachWorkspace:function(e){for(var t=0;t<k.length;t++)e(T[k[t]])},node:s,version:function(e){if(void 0===e)return C;C=e},originalFlow:function(e){if(void 0===e)return D;D=e},filterNodes:function(e){for(var t=[],n=0;n<E.length;n++){var o=E[n];e.hasOwnProperty("z")&&o.z!==e.z||e.hasOwnProperty("type")&&o.type!==e.type||t.push(o)}return t},filterLinks:function(e){for(var t=[],n=0;n<R.length;n++){var o=R[n];if(e.source){if(e.source.hasOwnProperty("id")&&o.source.id!==e.source.id)continue;if(e.source.hasOwnProperty("z")&&o.source.z!==e.source.z)continue}if(e.target){if(e.target.hasOwnProperty("id")&&o.target.id!==e.target.id)continue;if(e.target.hasOwnProperty("z")&&o.target.z!==e.target.z)continue}e.hasOwnProperty("sourcePort")&&o.sourcePort!==e.sourcePort||e.hasOwnProperty("targetPort")&&o.targetPort!==e.targetPort||t.push(o)}return t},import:b,getAllFlowNodes:function(e){var t={};t[e.id]=!0;for(var n=[e],o=[e];0!==o.length;)for(var a=o.shift(),i=R.filter(function(e){return e.source===a||e.target===a}),s=0;s<i.length;s++){var r=i[s].source===a?i[s].target:i[s].source,d=r.id;d||(d=r.direction+":"+r.i),t[d]||(t[d]=!0,n.push(r),o.push(r))}return n},createExportableNodeSet:g,createCompleteNodeSet:function(e){void 0===e&&(e=!0);var t,n=[];for(t=0;t<k.length;t++)"tab"==T[k[t]].type&&n.push(u(T[k[t]]));for(t in _)_.hasOwnProperty(t)&&n.push(h(_[t]));for(t in x)x.hasOwnProperty(t)&&n.push(f(x[t],e));for(t=0;t<E.length;t++){var o=E[t];n.push(f(o,e))}return n},updateConfigNodeUsers:y,id:t,dirty:function(t){if(null==t)return j;e(t)}}}(),RED.history=function(){function e(t){var n,o,a,i={};if(t){if("multi"==t.t)for(n=t.events.length-1;n>=0;n--)e(t.events[n]);else if("replace"==t.t)RED.nodes.clear(),RED.nodes.import(t.config)[0].forEach(function(e){t.changed[e.id]&&(e.changed=!0)}),RED.nodes.version(t.rev);else if("add"==t.t){if(t.nodes)for(n=0;n<t.nodes.length;n++)(o=RED.nodes.node(t.nodes[n])).z&&(i[o.z]=!0),RED.nodes.remove(t.nodes[n]);if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(t.workspaces)for(n=0;n<t.workspaces.length;n++)RED.nodes.removeWorkspace(t.workspaces[n].id),RED.workspaces.remove(t.workspaces[n]);if(t.subflows)for(n=0;n<t.subflows.length;n++)RED.nodes.removeSubflow(t.subflows[n]),RED.workspaces.remove(t.subflows[n]);if(t.subflow&&(t.subflow.instances&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),t.subflow.hasOwnProperty("changed")&&(a=RED.nodes.subflow(t.subflow.id))&&(a.changed=t.subflow.changed)),t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else if("delete"==t.t){if(t.workspaces)for(n=0;n<t.workspaces.length;n++)RED.nodes.addWorkspace(t.workspaces[n]),RED.workspaces.add(t.workspaces[n]);if(t.subflow&&t.subflow.subflow&&RED.nodes.addSubflow(t.subflow.subflow),t.subflowInputs&&t.subflowInputs.length>0&&((a=RED.nodes.subflow(t.subflowInputs[0].z)).in.push(t.subflowInputs[0]),a.in[0].dirty=!0),t.subflowOutputs&&t.subflowOutputs.length>0)for(a=RED.nodes.subflow(t.subflowOutputs[0].z),t.subflowOutputs.sort(function(e,t){return e.i-t.i}),n=0;n<t.subflowOutputs.length;n++){var s=t.subflowOutputs[n];a.out.splice(s.i,0,s);for(var r=s.i+1;r<a.out.length;r++)a.out[r].i++,a.out[r].dirty=!0;RED.nodes.eachLink(function(e){e.source.type=="subflow:"+a.id&&e.sourcePort>=s.i&&e.sourcePort++})}if(t.subflow&&t.subflow.hasOwnProperty("instances")&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),a&&RED.nodes.filterNodes({type:"subflow:"+a.id}).forEach(function(e){for(e.inputs=a.in.length;e.inputs>e.inputPorts.length;)e.inputPorts.push(e.inputPorts.length);for(e.outputs=a.out.length;e.outputs>e.outputPorts.length;)e.outputPorts.push(e.outputPorts.length);e.resize=!0,e.dirty=!0}),t.nodes)for(n=0;n<t.nodes.length;n++)RED.nodes.add(t.nodes[n]),i[t.nodes[n].z]=!0;if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.addLink(t.links[n]);if(t.changes)for(n in t.changes)if(t.changes.hasOwnProperty(n)&&(o=RED.nodes.node(n))){for(var d in t.changes[n])t.changes[n].hasOwnProperty(d)&&(o[d]=t.changes[n][d]);o.dirty=!0}}else if("move"==t.t){for(n=0;n<t.nodes.length;n++){var l=t.nodes[n];l.n.x=l.ox,l.n.y=l.oy,l.n.dirty=!0,l.n.moved=l.moved}if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else if("edit"==t.t){for(n in t.changes)if(t.changes.hasOwnProperty(n)){if(t.node._def.defaults&&t.node._def.defaults[n]&&t.node._def.defaults[n].type){var c=RED.nodes.node(t.node[n]);c&&c.users.splice(c.users.indexOf(t.node),1);var p=RED.nodes.node(t.changes[n]);p&&p.users.push(t.node)}t.node[n]=t.changes[n]}if(t.subflow)t.subflow.hasOwnProperty("inputCount")&&(t.node.in.length>t.subflow.inputCount?t.node.in.splice(t.subflow.inputCount):t.subflow.inputs.length>0&&(t.node.in=t.node.in.concat(t.subflow.inputs))),t.subflow.hasOwnProperty("outputCount")&&(t.node.out.length>t.subflow.outputCount?t.node.out.splice(t.subflow.outputCount):t.subflow.outputs.length>0&&(t.node.out=t.node.out.concat(t.subflow.outputs))),t.subflow.hasOwnProperty("instances")&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),RED.editor.validateNode(t.node),RED.nodes.filterNodes({type:"subflow:"+t.node.id}).forEach(function(e){e.inputs=t.node.in.length,e.outputs=t.node.out.length,RED.editor.updateNodeProperties(e),RED.editor.validateNode(e)});else{var u;if(t.outputMap){u={};for(var f in t.outputMap)t.outputMap.hasOwnProperty(f)&&"-1"!==t.outputMap[f]&&(u[t.outputMap[f]]=f)}RED.editor.updateNodeProperties(t.node,u),RED.editor.validateNode(t.node)}if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.addLink(t.links[n]);t.node.dirty=!0,t.node.changed=t.changed}else if("createSubflow"==t.t){if(t.nodes)for(RED.nodes.filterNodes({z:t.subflow.subflow.id}).forEach(function(e){e.z=t.activeWorkspace,e.dirty=!0}),n=0;n<t.nodes.length;n++)RED.nodes.remove(t.nodes[n]);if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(RED.nodes.removeSubflow(t.subflow.subflow),RED.workspaces.remove(t.subflow.subflow),t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else"reorder"==t.t&&t.order&&RED.workspaces.order(t.order);Object.keys(i).forEach(function(e){var t=RED.nodes.subflow(e);t&&RED.editor.validateNode(t)}),RED.nodes.dirty(t.dirty),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}}var t=[];return{markAllDirty:function(){for(var e=0;e<t.length;e++)t[e].dirty=!0},list:function(){return t},depth:function(){return t.length},push:function(e){t.push(e)},pop:function(){e(t.pop())},peek:function(){return t[t.length-1]},clear:function(){t=[]}}}(),RED.validators={number:function(e){return function(t){return e&&(""===t||void 0===t)||""!==t&&!isNaN(t)}},regex:function(e){return function(t){return e.test(t)}},typedInput:function(e,t){return function(n){var o=$("#node-"+(t?"config-":"")+"input-"+e);return!o||o.typedInput("validate")}}},RED.utils=function(){function e(e){return e.replace(/\r?\n/g,"&crarr;").replace(/\t/g,"&rarr;")}function t(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function n(n){var o;if(Array.isArray(n))o=$('<span class="debug-message-object-value debug-message-type-meta"></span>').text("array["+n.length+"]");else if(null===n)o=$('<span class="debug-message-object-value debug-message-type-null">null</span>');else if("object"==typeof n)o=n.hasOwnProperty("type")&&"Buffer"===n.type&&n.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').text("buffer["+n.length+"]"):n.hasOwnProperty("type")&&"array"===n.type&&n.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').text("array["+n.length+"]"):$('<span class="debug-message-object-value debug-message-type-meta">object</span>');else if("string"==typeof n){var a;a=n.length>30?t(n.substring(0,30))+"&hellip;":t(n),o=$('<span class="debug-message-object-value debug-message-type-string"></span>').html('"'+e(a)+'"')}else o=$('<span class="debug-message-object-value debug-message-type-other"></span>').text(""+n);return o}function o(e,t,n,o){e.addClass("debug-message-expandable"),e.prop("toggle",function(){return function(n){var o=e.parent();if(o.hasClass("collapsed")){if(n)return t&&!o.hasClass("built")&&(t(),o.addClass("built")),o.removeClass("collapsed"),!0}else if(!n)return o.addClass("collapsed"),!0;return!1}}),e.click(function(e){var t=!$(this).parent().hasClass("collapsed");$(this).prop("toggle")(!t)&&n&&n(!t),e.preventDefault()}),o&&e.click()}function a(e,t,n,o,a,i){h.hasOwnProperty(t)||(h[t]={});var s=$('<span class="debug-message-tools"></span>').appendTo(e),r=$('<span class="debug-message-tools-copy button-group"></span>').appendTo(s);if(n)var d=$('<button class="editor-button editor-button-small"><i class="fa fa-terminal"></i></button>').appendTo(r).click(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(n,d,"clipboard.copyMessagePath")});var c=$('<button class="editor-button editor-button-small"><i class="fa fa-clipboard"></i></button>').appendTo(r).click(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(o,c,"clipboard.copyMessageValue")});if(""!==i){var p=h[t].hasOwnProperty(i);$('<button class="editor-button editor-button-small debug-message-tools-pin"><i class="fa fa-map-pin"></i></button>').appendTo(s).click(function(n){if(n.preventDefault(),n.stopPropagation(),h[t].hasOwnProperty(i))delete h[t][i],$(this).removeClass("selected"),e.removeClass("debug-message-row-pinned");else{var o="$"+("["===i[0]?"":".")+i;h[t][i]=l(o),$(this).addClass("selected"),e.addClass("debug-message-row-pinned")}}).toggleClass("selected",p);e.toggleClass("debug-message-row-pinned",p)}}function i(e,t,n,o){if(t&&t.length>0){if(""===e&&void 0===n)return!0;for(var a=0;a<t.length;a++){var i=t[a];if(0===i.indexOf(e)&&("."===i[e.length]||"["===i[e.length])){if(void 0===n||"["!==i[e.length])return!0;var s=i.substring(e.length),r=/\[(\d+)\]/.exec(s);if(r){var d=parseInt(r[1]);return n<=d&&d<=o}}}}return!1}function s(e,t,n,o,a,i){var s=g[n]&&g[n][o]&&g[n][o].number||i||"dec";a?(s="dec"===s?13===t.toString().length&&t<=2147483647e3?"dateMS":10===t.toString().length&&t<=2147483647?"dateS":"hex":"dateMS"===s||"dateS"==s?"hex":"dec",g[n]=g[n]||{},g[n][o]=g[n][o]||{},g[n][o].number=s):void 0!==i&&(g[n]=g[n]||{},g[n][o]=g[n][o]||{},g[n][o].number=s),"dec"===s?e.text(""+t):"dateMS"===s?e.text(new Date(t).toISOString()):"dateS"===s?e.text(new Date(1e3*t).toISOString()):"hex"===s&&e.text("0x"+t.toString(16))}function r(e,t,n,o,a){var i=g[n]&&g[n][o]&&g[n][o].buffer||"raw";a&&(i="raw"===i?"string":"raw",g[n]=g[n]||{},g[n][o]=g[n][o]||{},g[n][o].buffer=i),"raw"===i?(t.text("raw"),e.removeClass("debug-message-buffer-string").addClass("debug-message-buffer-raw")):"string"===i&&(t.text("string"),e.addClass("debug-message-buffer-string").removeClass("debug-message-buffer-raw"))}function d(l,p){var u,f,g,v,m,b,y=(p=p||{}).key,w=p.typeHint,D=p.hideKey,E=p.path,x=p.sourceId,R=p.rootPath,T=p.expandPaths,k=p.ontoggle,_=p.exposeApi,C={};void 0!==E&&void 0!==R?b=E.substring(R.length+("."===E[R.length]?1:0)):(E="",R="");var j=$('<span class="debug-message-element"></span>');if(j.collapse=function(){j.find(".debug-message-expandable").parent().addClass("collapsed")},v=$('<span class="debug-message-row"></span>').appendTo(j),x&&a(v,x,E,l,R,b),y)D||($('<span class="debug-message-object-key"></span>').text(y).appendTo(v),$("<span>: </span>").appendTo(v));else if(j.addClass("debug-message-top-level"),x){var S=h[x];if(T=[],S){for(var O in S)if(S.hasOwnProperty(O))try{void 0!==c({$:l},S[O])&&T.push(O)}catch(e){}T.sort()}j.clearPinned=function(){j.find(".debug-message-row-pinned").removeClass("debug-message-row-pinned"),h[x]={}}}g=$('<span class="debug-message-object-value"></span>').appendTo(v);var P=Array.isArray(l),L=!1;if(l&&"object"==typeof l&&l.hasOwnProperty("type")&&l.hasOwnProperty("data")&&(l.__encoded__&&"array"===l.type||"Buffer"===l.type)&&(P=!0,L=!0),null===l||void 0===l)$('<span class="debug-message-type-null">'+l+"</span>").appendTo(g);else if("string"==typeof l)/[\t\n\r]/.test(l)&&(j.addClass("collapsed"),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(v),o(v,function(){$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').text(w||"string").appendTo(v);var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(j);$('<pre class="debug-message-type-string"></pre>').text(l).appendTo(e)},function(e){k&&k(E,e)},i(b,T))),f=$('<span class="debug-message-type-string debug-message-object-header"></span>').html('"'+e(t(l))+'"').appendTo(g),/^#[0-9a-f]{6}$/i.test(l)&&$('<span class="debug-message-type-string-swatch"></span>').css("backgroundColor",l).appendTo(f);else if("number"==typeof l)f=$('<span class="debug-message-type-number"></span>').appendTo(g),Number.isInteger(l)&&l>=0&&(f.addClass("debug-message-type-number-toggle"),f.click(function(e){e.preventDefault(),s($(this),l,x,E,!0)})),s(f,l,x,E,!1,"hex"===w?"hex":void 0);else if(P){j.addClass("collapsed");var I=l.length;if(w){var N=/\[(\d+)\]/.exec(w);N&&(I=parseInt(N[1]))}var A=l,z="array";L?(A=l.data,void 0===I&&(I=A.length),A.__encoded__&&(A=A.data),z=l.type.toLowerCase()):/buffer/.test(w)&&(z="buffer");var M=A.length;if(I>0){$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(v);var B=$('<div class="debug-message-array-rows"></div>').appendTo(j);j.addClass("debug-message-buffer-raw")}if(y)m=$('<span class="debug-message-type-meta"></span>').text(w||z+"["+I+"]").appendTo(g);else{m=$('<span class="debug-message-object-header"></span>').appendTo(g),$("<span>[ </span>").appendTo(m);var J=Math.min(I,10);for(u=0;u<J;u++)n(A[u]).appendTo(m),u<J-1&&$("<span>, </span>").appendTo(m);I>J&&$("<span> &hellip;</span>").appendTo(m),0===J&&$('<span class="debug-message-type-meta">empty</span>').appendTo(m),$("<span> ]</span>").appendTo(m)}I>0&&o(v,function(){if(y||(m=$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').text(w||z+"["+I+"]").appendTo(v)),"buffer"===z){var e=$('<div class="debug-message-string-rows"></div>').appendTo(j),t=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(e),n="";try{n=String.fromCharCode.apply(null,new Uint16Array(A))}catch(e){console.log(e)}$('<pre class="debug-message-type-string"></pre>').text(n).appendTo(t);var a=$('<span class="debug-message-buffer-opts"></span>').appendTo(m),s=$('<a href="#"></a>').addClass("selected").text("raw").appendTo(a).click(function(e){e.preventDefault(),e.stopPropagation(),r(j,$(this),x,E,!0)});r(j,s,x,E,!1)}var l;if(M<=10)for(u=0;u<M;u++)l=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(B),C[E+"["+u+"]"]=d(A[u],{key:""+u,typeHint:"buffer"===z&&"hex",hideKey:!1,path:E+"["+u+"]",sourceId:x,rootPath:R,expandPaths:T,ontoggle:k,exposeApi:_}).appendTo(l);else{for(u=0;u<M;u+=10){var c=u;l=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(B),v=$("<span></span>").appendTo(l),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').appendTo(v),o(v,function(){var e=c,t=Math.min(M-1,c+9),n=l;return function(){for(var o=e;o<=t;o++){var a=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(n);C[E+"["+o+"]"]=d(A[o],{key:""+o,typeHint:"buffer"===z&&"hex",hideKey:!1,path:E+"["+o+"]",sourceId:x,rootPath:R,expandPaths:T,ontoggle:k,exposeApi:_}).appendTo(a)}}}(),function(){var e=e+"["+u+"]";return function(t){k&&k(e,t)}}(),i(b,T,c,Math.min(M-1,c+9))),$('<span class="debug-message-object-key"></span>').html("["+c+" &hellip; "+Math.min(M-1,c+9)+"]").appendTo(v)}M<I&&$('<div class="debug-message-object-entry collapsed"><span class="debug-message-object-key">['+M+" &hellip; "+I+"]</span></div>").appendTo(B)}},function(e){k&&k(E,e)},i(b,T))}else if("object"==typeof l){j.addClass("collapsed");var U=Object.keys(l);if((y||U.length>0)&&($('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(v),o(v,function(){for(y||$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').text("object").appendTo(v),u=0;u<U.length;u++){var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(j),t=E;void 0!==t&&(/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(U[u])?t+=(t.length>0?".":"")+U[u]:t+='["'+U[u].replace(/"/,'\\"')+'"]'),C[t]=d(l[U[u]],{key:U[u],typeHint:!1,hideKey:!1,path:t,sourceId:x,rootPath:R,expandPaths:T,ontoggle:k,exposeApi:_}).appendTo(e)}0===U.length&&$('<div class="debug-message-object-entry debug-message-type-meta collapsed"></div>').text("empty").appendTo(j)},function(e){k&&k(E,e)},i(b,T))),y)$('<span class="debug-message-type-meta"></span>').text("object").appendTo(g);else{m=$('<span class="debug-message-object-header"></span>').appendTo(g),$("<span>{ </span>").appendTo(m);var G=Math.min(U.length,5);for(u=0;u<G;u++)$('<span class="debug-message-object-key"></span>').text(U[u]).appendTo(m),$("<span>: </span>").appendTo(m),n(l[U[u]]).appendTo(m),u<G-1&&$("<span>, </span>").appendTo(m);U.length>G&&$("<span> &hellip;</span>").appendTo(m),0===G&&$('<span class="debug-message-type-meta">empty</span>').appendTo(m),$("<span> }</span>").appendTo(m)}}else $('<span class="debug-message-type-other"></span>').text(""+l).appendTo(g);return _&&j.prop("expand",function(){return function(e,t){if(E===e)v.prop("toggle")&&v.prop("toggle")(t);else if(C[e]&&C[e].prop("expand"))C[e].prop("expand")(e,t);else for(var n in C)if(C.hasOwnProperty(n)&&0===e.indexOf(n)){C[n].prop("expand")&&C[n].prop("expand")(e,t);break}}}),j}function l(e){var t=e.length;if(0===t)throw new Error("Invalid property expression: zero-length");for(var n,o,a=[],i=0,s=!1,r=!1,d=0;d<t;d++){var l=e[d];if(s){if(l===n){if(d-i==0)throw new Error("Invalid property expression: zero-length string at position "+i);if(a.push(e.substring(i,d)),r&&!/\]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected array expression at position "+i);if(!r&&d+1!==t&&!/[\[\.]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" expression at position "+(d+1));i=d+1,s=!1}}else if("'"===l||'"'===l){if(d!=i)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);s=!0,n=l,i=d+1}else if("."===l){if(0===d)throw new Error("Invalid property expression: unexpected . at position 0");if(i!=d&&(o=e.substring(i,d),/^\d+$/.test(o)?a.push(parseInt(o)):a.push(o)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/[a-z0-9\$\_]/i.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));i=d+1}else if("["===l){if(0===d)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(i!=d&&a.push(e.substring(i,d)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/["'\d]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));i=d+1,r=!0}else if("]"===l){if(!r)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(i!=d){if(o=e.substring(i,d),!/^\d+$/.test(o))throw new Error("Invalid property expression: unexpected array expression at position "+i);a.push(parseInt(o))}i=d+1,r=!1}else if(" "===l)throw new Error("Invalid property expression: unexpected ' ' at position "+d)}if(r||s)throw new Error("Invalid property expression: unterminated expression");return i<t&&a.push(e.substring(i)),a}function c(e,t){var n,o=null;"string"==typeof t?(0===t.indexOf("msg.")&&(t=t.substring(4)),n=l(t)):n=t;return n.reduce(function(e,t){return void 0===(o=void 0!==e[t]?e[t]:void 0)&&e.hasOwnProperty("type")&&e.hasOwnProperty("data")&&e.hasOwnProperty("length")&&(o=void 0!==e.data[t]?e.data[t]:void 0),o},e),o}function p(e){var t={module:"",file:""};if(e){var n=e.indexOf("/");-1!==n?(t.module=e.slice(0,n),t.file=e.slice(n+1)):t.file=e}return t}function u(e,t){var n;if(t&&"subflow"===t.type)n="node-red/subflow.png";else if("function"==typeof e.icon)try{n=e.icon.call(t)}catch(t){console.log("Definition error: "+e.type+".icon",t),n="arrow-in.png"}else n=e.icon;var o=p(n);return o.module||(o.module=e.namespace),o}function f(e){var t=RED.nodes.getIconSets()[e.module];return!(!t||-1===t.indexOf(e.file))}var h={},g={};return{createObjectElement:d,getMessageProperty:c,normalisePropertyExpression:l,validatePropertyExpression:function(e){try{return l(e),!0}catch(e){return!1}},separateIconPath:p,getDefaultNodeIcon:u,getNodeIcon:function(e,t){if("config"===e.category)return"icons/node-red/cog.png";if(t&&"tab"===t.type)return"icons/node-red/subflow.png";if(t&&"unknown"===t.type)return"icons/node-red/alert.png";if(t&&t.icon&&f(n=p(t.icon)))return"icons/"+t.icon;var n=u(e,t);return"subflows"!==e.category||f(n)?"icons/"+n.module+"/"+n.file:"icons/node-red/subflow.png"},getNodeLabel:function(e,t){t=t||"";var n;if("tab"===e.type)n=e.label||t;else{n=e._def.label;try{n=("function"==typeof n?n.call(e):n)||t}catch(o){console.log("Definition error: "+e.type+".label",o),n=t}}return RED.text.bidi.enforceTextDirectionWithUCC(n)},addSpinnerOverlay:function(e,t){var n=$('<div class="projects-dialog-spinner "><img src="red/images/spin.svg"/></div>').appendTo(e);return t&&n.addClass("projects-dialog-spinner-contain"),n}}}(),function(e){e.widget("nodered.editableList",{_create:function(){var t=this;if(this.element.addClass("red-ui-editableList-list"),this.uiWidth=this.element.width(),this.uiContainer=this.element.wrap("<div>").parent(),this.options.header?(this.options.header.addClass("red-ui-editableList-header"),this.borderContainer=this.uiContainer.wrap("<div>").parent(),this.borderContainer.prepend(this.options.header),this.topContainer=this.borderContainer.wrap("<div>").parent()):this.topContainer=this.uiContainer.wrap("<div>").parent(),this.topContainer.addClass("red-ui-editableList"),this.options.class&&this.topContainer.addClass(this.options.class),!1!==this.options.addButton){var n;n="string"==typeof this.options.addButton?this.options.addButton:RED&&RED._?RED._("editableList.add"):"add",e('<a href="#" class="editor-button editor-button-small red-ui-editableList-addButton" style="margin-top: 4px;"><i class="fa fa-plus"></i> '+n+"</a>").appendTo(this.topContainer).click(function(e){e.preventDefault(),t.addItem({})})}"absolute"===this.element.css("position")&&(["top","left","bottom","right"].forEach(function(e){var n=t.element.css(e);"auto"!==n&&""!==n&&(t.topContainer.css(e,n),t.uiContainer.css(e,"0"),t.element.css(e,"auto"))}),this.element.css("position","static"),this.topContainer.css("position","absolute"),this.uiContainer.css("position","absolute")),this.options.header?this.borderContainer.addClass("red-ui-editableList-border"):this.uiContainer.addClass("red-ui-editableList-border"),this.uiContainer.addClass("red-ui-editableList-container"),this.uiHeight=this.element.height(),this.activeFilter=this.options.filter||null,this.activeSort=this.options.sort||null,this.scrollOnAdd=this.options.scrollOnAdd,void 0===this.scrollOnAdd&&(this.scrollOnAdd=!0);var o=this.element.css("minHeight");"0px"!==o&&(this.uiContainer.css("minHeight",o),this.element.css("minHeight",0));var a=this.element.css("maxHeight");"0px"!==a&&(this.uiContainer.css("maxHeight",a),this.element.css("maxHeight",null)),"auto"!==this.options.height&&(this.uiContainer.css("overflow-x","hidden"),this.uiContainer.css("overflow-y","scroll"),isNaN(this.options.height)||(this.uiHeight=this.options.height)),this.element.height("auto");var i,s=this.element.attr("style");if(null!==(i=/width\s*:\s*(\d+%)/i.exec(s))&&(this.element.width("100%"),this.uiContainer.width(i[1])),this.options.sortable){var r={axis:"y",update:function(e,n){t.options.sortItems&&t.options.sortItems(t.items())},handle:"string"==typeof this.options.sortable?this.options.sortable:".red-ui-editableList-item-handle",cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"red-ui-editabelList-item-placeholder",start:function(e,t){t.placeholder.height(t.item.height()-4)}};this.options.connectWith&&(r.connectWith=this.options.connectWith),this.element.sortable(r)}this._resize()},_resize:function(){var t=this.topContainer.height()-this.uiContainer.height();if(0!==this.uiHeight&&this.uiContainer.height(this.uiHeight-t),this.options.resize&&this.options.resize(),this.options.resizeItem){var n=this;this.element.children().each(function(t){n.options.resizeItem(e(this).find(".red-ui-editableList-item-content"),t)})}},_destroy:function(){},_refreshFilter:function(){var e=this,t=0;return this.activeFilter?(this.items().each(function(n,o){var a=o.data("data");try{e.activeFilter(a)?(o.parent().show(),t++):o.parent().hide()}catch(e){console.log(e),o.parent().show(),t++}}),t):this.element.children().show()},_refreshSort:function(){if(this.activeSort){var t=this.element.children(),n=this;t.sort(function(t,o){return n.activeSort(e(t).find(".red-ui-editableList-item-content").data("data"),e(o).find(".red-ui-editableList-item-content").data("data"))}),e.each(t,function(e,t){n.element.append(t)})}},width:function(e){this.uiWidth=e,this._resize()},height:function(e){this.uiHeight=e,this._resize()},addItem:function(t){var n=this;t=t||{};var o=e("<li>"),a=!1;if(this.activeSort){this.items().each(function(e,i){if(!a){var s=i.data("data");n.activeSort(t,s)<0&&(o.insertBefore(i.closest("li")),a=!0)}})}a||o.appendTo(this.element);var i=e("<div/>").addClass("red-ui-editableList-item-content").appendTo(o);if(i.data("data",t),!0===this.options.sortable&&(e('<i class="red-ui-editableList-item-handle fa fa-bars"></i>').appendTo(o),o.addClass("red-ui-editableList-item-sortable")),this.options.removable){var s=e("<a/>",{href:"#",class:"red-ui-editableList-item-remove editor-button editor-button-small"}).appendTo(o);e("<i/>",{class:"fa fa-remove"}).appendTo(s),o.addClass("red-ui-editableList-item-removable"),s.click(function(t){t.preventDefault();var a=i.data("data");o.addClass("red-ui-editableList-item-deleting"),o.fadeOut(300,function(){e(this).remove(),n.options.removeItem&&n.options.removeItem(a)})})}if(this.options.addItem){var r=n.element.children().length-1;setTimeout(function(){if(n.options.addItem(i,r,t),n.activeFilter)try{n.activeFilter(t)||o.hide()}catch(e){}!n.activeSort&&n.scrollOnAdd&&setTimeout(function(){n.uiContainer.scrollTop(n.element.height())},0)},0)}},addItems:function(e){for(var t=0;t<e.length;t++)this.addItem(e[t])},removeItem:function(t){this.element.children().filter(function(n){return t===e(this).find(".red-ui-editableList-item-content").data("data")}).remove(),this.options.removeItem&&this.options.removeItem(t)},items:function(){return this.element.children().map(function(t){return e(this).find(".red-ui-editableList-item-content")})},empty:function(){this.element.empty()},filter:function(e){return void 0!==e&&(this.activeFilter=e),this._refreshFilter()},sort:function(e){return void 0!==e&&(this.activeSort=e),this._refreshSort()},length:function(){return this.element.children().length}})}(jQuery),function(e){e.widget("nodered.checkboxSet",{_create:function(){var t=this;this.uiElement=this.element.wrap("<span>").parent(),this.uiElement.addClass("red-ui-checkboxSet"),this.options.parent&&(this.parent=this.options.parent,this.parent.checkboxSet("addChild",this.element)),this.children=[],this.partialFlag=!1,this.stateValue=0;var n=this.element.prop("checked");this.options=[e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-square-o"></i></span>').appendTo(this.uiElement),e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-check-square-o"></i></span>').appendTo(this.uiElement),e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-minus-square-o"></i></span>').appendTo(this.uiElement)],n?this.options[1].show():this.options[0].show(),this.element.change(function(){this.checked?(t.options[0].hide(),t.options[1].show(),t.options[2].hide()):(t.options[1].hide(),t.options[0].show(),t.options[2].hide());var e=this.checked;t.children.forEach(function(t){t.checkboxSet("state",e,!1,!0)})}),this.uiElement.click(function(e){e.stopPropagation(),t.state(!1===t.state())}),this.parent&&this.parent.checkboxSet("updateChild",this)},_destroy:function(){this.parent&&this.parent.checkboxSet("removeChild",this.element)},addChild:function(e){this.children.push(e)},removeChild:function(e){var t=this.children.indexOf(e);t>-1&&this.children.splice(t,1)},updateChild:function(e){var t=0;this.children.forEach(function(e,n){!0===e.checkboxSet("state")&&t++}),0===t?this.state(!1,!0):t===this.children.length?this.state(!0,!0):this.state(null,!0)},disable:function(){this.uiElement.addClass("disabled")},state:function(e,t,n){if(0===arguments.length)return this.partialFlag?null:this.element.is(":checked");this.partialFlag=null===e;var o=this.partialFlag||e;this.element.prop("checked",o),!0===e?(this.options[0].hide(),this.options[1].show(),this.options[2].hide()):!1===e?(this.options[2].hide(),this.options[1].hide(),this.options[0].show()):null===e&&(this.options[0].hide(),this.options[1].hide(),this.options[2].show()),t||this.element.trigger("change",null),!n&&this.parent&&this.parent.checkboxSet("updateChild",this)}})}(jQuery),RED.menu=function(){function e(i){var s;if(null!==i&&i.id&&!1===RED.settings.theme("menu."+i.id))return null;if(null===i)s=$('<li class="divider"></li>');else{s=$("<li></li>"),i.group&&s.addClass("menu-group-"+i.group);var r="<a "+(i.id?'id="'+i.id+'" ':"")+'tabindex="-1" href="#">';i.toggle&&(r+='<i class="fa fa-square pull-left"></i>',r+='<i class="fa fa-check-square pull-left"></i>'),void 0!==i.icon&&(/\.png/.test(i.icon)?r+='<img src="'+i.icon+'"/> ':r+='<i class="'+(i.icon?i.icon:'" style="display: inline-block;"')+'"></i> '),i.sublabel?r+='<span class="menu-label-container"><span class="menu-label">'+i.label+'</span><span class="menu-sublabel">'+i.sublabel+"</span></span>":r+='<span class="menu-label">'+i.label+"</span>",r+="</a>";var d=$(r).appendTo(s);if(a[i.id]=i,i.onselect?(d.click(function(e){if(e.preventDefault(),!$(this).parent().hasClass("disabled"))if(i.toggle){var s=n(i.id);if("string"==typeof i.toggle){if(!s){for(var r in a)if(a.hasOwnProperty(r)){var d=a[r];d.id!=i.id&&i.toggle==d.toggle&&o(d.id,!1)}o(i.id,!0)}}else o(i.id,!s)}else t(i.id)}),i.toggle&&function(){var e=RED.settings.get("menu-"+i.id);i.setting&&(null!==e?(RED.settings.set(i.setting,e),RED.settings.remove("menu-"+i.id)):e=RED.settings.get(i.setting)),e?(d.addClass("active"),t(i.id,!0)):!1===e?(d.removeClass("active"),t(i.id,!1)):i.hasOwnProperty("selected")&&(i.selected?d.addClass("active"):d.removeClass("active"),t(i.id,i.selected))}()):i.href?d.attr("target","_blank").attr("href",i.href):i.hrefLocal?d.attr("target","_self").attr("href",i.hrefLocal):i.options||(s.addClass("disabled"),d.click(function(e){e.preventDefault()})),i.options){s.addClass("dropdown-submenu pull-left");for(var l=$('<ul id="'+i.id+'-submenu" class="dropdown-menu"></ul>').appendTo(s),c=0;c<i.options.length;c++){var p=e(i.options[c]);p&&p.appendTo(l)}}i.disabled&&s.addClass("disabled")}return s}function t(e,t){var n=a[e],o=n.onselect;"string"==typeof n.onselect&&(o=RED.actions.get(n.onselect)),o?o.call(n,t):console.log("No callback for",e,n.onselect)}function n(e){return $("#"+e).hasClass("active")}function o(e,o){if(n(e)!=o){var i=a[e];o?$("#"+e).addClass("active"):$("#"+e).removeClass("active"),i&&i.onselect&&t(i.id,o),RED.settings.set(i.setting||"menu-"+i.id,o)}}var a={};return{init:function(t){var n=$("#"+t.id),o=$("<ul/>",{id:t.id+"-submenu",class:"dropdown-menu pull-right"});1===n.length&&o.insertAfter(n);for(var a=!1,i=0;i<t.options.length;i++){var s=t.options[i];if(null!==s||!a){var r=e(s);r&&(r.appendTo(o),a=null===s)}}return o},setSelected:o,isSelected:n,toggleSelected:function(e){o(e,!n(e))},setDisabled:function(e,t){t?$("#"+e).parent().addClass("disabled"):$("#"+e).parent().removeClass("disabled")},addItem:function(t,n){var o=e(n);if(n.group){var a=$("#"+t+"-submenu").children(".menu-group-"+n.group);if(0===a.length)o.appendTo("#"+t+"-submenu");else{for(var i=0;i<a.length;i++){var s=a[i],r=$(s).find(".menu-label").html();if(n.label<r){$(s).before(o);break}}i===a.length&&o.appendTo("#"+t+"-submenu")}}else o.appendTo("#"+t+"-submenu")},removeItem:function(e){$("#"+e).parent().remove()},setAction:function(e,t){var n=a[e];n&&(n.onselect=t)}}}(),RED.panels=function(){return{create:function(e){var t=e.container||$("#"+e.id),n=t.children();if(2!==n.length)throw new Error("Container must have exactly two children");t.addClass("red-ui-panels");var o,a,i=[],s=!1;return $('<div class="red-ui-panels-separator"></div>').insertAfter(n[0]).draggable({axis:"y",containment:t,scroll:!1,start:function(e,a){t.height(),o=a.position.top,i=[$(n[0]).height(),$(n[1]).height()]},drag:function(s,r){var d=t.height(),l=r.position.top-o,c=[i[0]+l,i[1]-l];$(n[0]).height(c[0]),$(n[1]).height(c[1]),e.resize&&e.resize(c[0],c[1]),r.position.top-=l,a=c[0]/d},stop:function(e,t){s=!0}}),{resize:function(o){var i=[$(n[0]).height(),$(n[1]).height()];if(t.height(o),s){var r=a*o;i=[r,o-r-48],$(n[0]).height(i[0]),$(n[1]).height(i[1])}e.resize&&e.resize(i[0],i[1])}}}}}(),RED.popover=function(){var e={default:{top:10,leftRight:17,leftLeft:25},small:{top:5,leftRight:17,leftLeft:16}},t=null;return{create:function(n){var o=n.target,a=n.direction||"right",i=n.trigger,s=n.content,r=n.delay,d=n.autoClose,l=n.width||"auto",c=n.size||"default",p=n.offsetX||0,u=n.offsetY||0,f=n.intervalCallback||null,h=n.dialog1||null,g=n.dialog2||null;if(!e[c])throw new Error("Invalid RED.popover size value:",c);var v,m,b=null,y=!1,w=function(n){if(v){t&&clearInterval(t),$(".red-ui-popover").remove(),m=$('<div class="red-ui-popover red-ui-popover-'+a+'"></div>').appendTo("body"),"default"!==c&&m.addClass("red-ui-popover-size-"+c),"function"==typeof s?s.call(E).appendTo(m):m.html(s),"auto"!==l&&m.width(l);var d=o.offset();d.top+=u,d.left+=p;var w=o.width(),x=o.height(),R=m.height(),T=m.width();"right"===a?m.css({top:d.top+x/2-R/2-e[c].top,left:d.left+w+e[c].leftRight}):"left"===a&&m.css({top:d.top+x/2-R/2-e[c].top,left:d.left-e[c].leftLeft-T}),n?m.show():m.fadeIn("fast"),"hover"===i&&(m.on("mouseenter",function(e){b&&clearTimeout(b),y=!0}),m.on("mouseleave",function(e){b&&clearTimeout(b),y=!1,v||(b=setTimeout(D,r.hide))})),h&&$(".popover-dialog1").on("click",function(e){h(),v=!1,D(!1)}),g&&$(".popover-dialog2").on("click",function(e){g(),v=!1,D(!1)}),f&&(t=setInterval(f,1e3))}},D=function(e){v||(t&&clearInterval(t),m&&(e?instant?$(this).remove():m.fadeOut("fast",function(){$(this).remove()}):m.remove(),m=null))};"hover"===i?(o.on("mouseenter",function(e){b&&clearTimeout(b),v=!0,b=setTimeout(w,r.show)}),o.on("mouseleave",function(e){b&&clearTimeout(b),v=!1,y||(b=setTimeout(D,r.hide))})):"click"===i?o.click(function(e){e.preventDefault(),e.stopPropagation(),(v=!v)?w():D()}):d&&setTimeout(function(){v=!1,D()},d);var E={setContent:function(e){return s=e,E},open:function(e){return v=!0,w(e),E},close:function(e){return v=!1,D(e),E}};return E}}}(),function(e){e.widget("nodered.searchBox",{_create:function(){var t=this;this.currentTimeout=null,this.lastSent="",this.element.val(""),this.uiContainer=this.element.wrap("<div>").parent(),this.uiContainer.addClass("red-ui-searchBox-container"),e('<i class="fa fa-search"></i>').prependTo(this.uiContainer),this.clearButton=e('<a href="#"><i class="fa fa-times"></i></a>').appendTo(this.uiContainer),this.clearButton.on("click",function(e){e.preventDefault(),t.element.val(""),t._change("",!0),t.element.focus()}),this.resultCount=e("<span>",{class:"red-ui-searchBox-resultCount hide"}).appendTo(this.uiContainer),this.element.val(""),this.element.on("keydown",function(e){27===e.keyCode&&t.element.val("")}),this.element.on("keyup",function(n){t._change(e(this).val())}),this.element.on("focus",function(){e("body").one("mousedown",function(){t.element.blur()})})},_change:function(e,t){var n=!1;""===e?(this.clearButton.hide(),n=!0):(this.clearButton.show(),n=e.length>=(this.options.minimumLength||0));var o=this.element.val();if(n=n&&o!==this.lastSent)if(!t&&this.options.delay>0){clearTimeout(this.currentTimeout);var a=this;this.currentTimeout=setTimeout(function(){a.lastSent=a.element.val(),a._trigger("change")},this.options.delay)}else this._trigger("change")},value:function(e){if(void 0===e)return this.element.val();this.element.val(e),this._change(e)},count:function(e){void 0===e||null===e||""===e?this.resultCount.text("").hide():this.resultCount.text(e).show()},change:function(){this._trigger("change")}})}(jQuery),RED.tabs=function(){return{create:function(e){function t(e,t){if(e.preventDefault(),!$(this).hasClass("disabled")){var n=f.scrollLeft();f.animate({scrollLeft:t},100);var o=setInterval(function(){var e=f.scrollLeft();e!==n?(n=e,f.animate({scrollLeft:t},100)):clearInterval(o)},100);$(this).one("mouseup",function(){clearInterval(o)})}}function n(){return e.onclick&&e.onclick(l[$(this).attr("href").slice(1)]),i($(this)),!1}function o(){if(0!==p.children().length){var e=f.scrollLeft(),t=f.width(),n=p.width();0===e?h.hide():h.show(),e===n-t?g.hide():g.show()}}function a(){return e.ondblclick&&e.ondblclick(l[$(this).attr("href").slice(1)]),!1}function i(t){if("string"==typeof t&&(t=p.find("a[href='#"+t+"']")),0!==t.length&&!t.parent().hasClass("active")){if(p.children().removeClass("active"),p.children().css({transition:"width 100ms"}),t.parent().addClass("active"),e.scrollable){var n=t.parent().position().left;n-21<0?f.animate({scrollLeft:"+="+(n-50)},300):n+120>f.width()&&f.animate({scrollLeft:"+="+(n+140-f.width())},300)}e.onchange&&e.onchange(l[t.attr("href").slice(1)]),s(),setTimeout(function(){p.children().css({transition:""})},100)}}function s(){if(!e.vertical){var t=p.find("li.red-ui-tab"),n=u.width(),a=t.size(),i=(n-12-6*a)/a;if(d=100*i/n+"%",c=d+"%",e.scrollable){i=Math.max(i,140),d=i+"px",c=0;var s=Math.max(u.width(),12+(i+6)*a);p.width(s),o()}else e.hasOwnProperty("minimumActiveTabWidth")&&(i<e.minimumActiveTabWidth?(a-=1,i=(n-12-e.minimumActiveTabWidth-6*a)/a,d=100*i/n+"%",c=e.minimumActiveTabWidth+"px"):c=0);t.css({width:d}),i<50?(p.find(".red-ui-tab-close").hide(),p.find(".red-ui-tab-icon").hide(),p.find(".red-ui-tab-label").css({paddingLeft:Math.min(12,Math.max(0,i-38))+"px"})):(p.find(".red-ui-tab-close").show(),p.find(".red-ui-tab-icon").show(),p.find(".red-ui-tab-label").css({paddingLeft:""})),0!==c&&(p.find("li.red-ui-tab.active").css({width:e.minimumActiveTabWidth}),p.find("li.red-ui-tab.active .red-ui-tab-close").show(),p.find("li.red-ui-tab.active .red-ui-tab-icon").show(),p.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft:""}))}}function r(t){var n=p.find("a[href='#"+t+"']").parent();if(n.hasClass("active")){var o=n.prev();0===o.size()&&(o=n.next()),i(o.find("a"))}n.remove(),e.onremove&&e.onremove(l[t]),delete l[t],s()}var d,l={},c=0,p=e.element||$("#"+e.id),u=p.wrap("<div>").parent(),f=p.wrap("<div>").parent();u.addClass("red-ui-tabs"),e.vertical&&u.addClass("red-ui-tabs-vertical"),e.addButton&&"function"==typeof e.addButton&&(u.addClass("red-ui-tabs-add"),$('<div class="red-ui-tab-button"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(u).find("a").click(function(t){t.preventDefault(),e.addButton()}));var h,g;return e.scrollable&&(u.addClass("red-ui-tabs-scrollable"),f.addClass("red-ui-tabs-scroll-container"),f.scroll(o),(h=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(u).find("a")).on("mousedown",function(e){t(e,"-=150")}).on("click",function(e){e.preventDefault()}),(g=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(u).find("a")).on("mousedown",function(e){t(e,"+=150")}).on("click",function(e){e.preventDefault()})),p.children().first().addClass("active"),p.children().addClass("red-ui-tab"),p.find("li.red-ui-tab a").on("click",n).on("dblclick",a),setTimeout(function(){s()},0),{addTab:function(t){l[t.id]=t;var o=$("<li/>",{class:"red-ui-tab"}).appendTo(p);o.attr("id","red-ui-tab-"+t.id.replace(".","-")),o.data("tabId",t.id);var d=$("<a/>",{href:"#"+t.id,class:"red-ui-tab-label"}).appendTo(o);if(t.icon&&$('<img src="'+t.icon+'" class="red-ui-tab-icon"/>').appendTo(d),$("<span/>",{class:"bidiAware"}).text(t.label).appendTo(d).attr("dir",RED.text.bidi.resolveBaseTextDir(t.label)),d.on("click",n),d.on("dblclick",a),t.closeable){var c=$("<a/>",{href:"#",class:"red-ui-tab-close"}).appendTo(o);c.append('<i class="fa fa-times" />'),c.on("click",function(e){e.preventDefault(),r(t.id)})}if(s(),e.onadd&&e.onadd(t),d.attr("title",t.label),1==p.find("li.red-ui-tab").size()&&i(d),e.onreorder){var u,h,g,v=[];o.draggable({axis:"x",distance:20,start:function(e,t){u=[],v=[],p.children().each(function(e){v[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width()},$(this).is(o)&&(h=e,g=e),u.push($(this).data("tabId"))}),p.children().each(function(e){e!==h&&$(this).css({position:"absolute",left:v[e].left+"px",width:v[e].width+2,transition:"left 0.3s"})}),o.hasClass("active")||o.css({zIndex:1})},drag:function(e,t){t.position.left+=v[h].left+f.scrollLeft();for(var n=t.position.left+v[h].width/2-f.scrollLeft(),o=0;o<v.length;o++)if(o!==h&&n>v[o].left&&n<v[o].left+v[o].width){o<h?(v[o].left+=v[h].width+8,v[h].el.detach().insertBefore(v[o].el)):(v[o].left-=v[h].width+8,v[h].el.detach().insertAfter(v[o].el)),v[o].el.css({left:v[o].left+"px"}),v.splice(o,0,v.splice(h,1)[0]),h=o;break}},stop:function(t,n){p.children().css({position:"relative",left:"",transition:""}),o.hasClass("active")||o.css({zIndex:""}),s(),g!==h&&e.onreorder(u,$.makeArray(p.children().map(function(){return $(this).data("tabId")}))),i(v[h].el.data("tabId"))}})}},removeTab:r,activateTab:i,nextTab:function(){var e=p.find("li.active").next();e.length>0&&i(e.find("a"))},previousTab:function(){var e=p.find("li.active").prev();e.length>0&&i(e.find("a"))},resize:s,count:function(){return p.find("li.red-ui-tab").size()},contains:function(e){return p.find("a[href='#"+e+"']").length>0},renameTab:function(e,t){l[e].label=t;var n=p.find("a[href='#"+e+"']");n.attr("title",t),n.find("span.bidiAware").text(t).attr("dir",RED.text.bidi.resolveBaseTextDir(t)),s()},order:function(e){var t=$.makeArray(p.children().map(function(){return $(this).data("tabId")}));if(t.length===e.length){var n,o=!0;for(n=0;n<e.length;n++)if(e[n]!==t[n]){o=!1;break}if(!o){var a={};for(p.children().detach().each(function(){a[$(this).data("tabId")]=$(this)}),n=0;n<e.length;n++)a[e[n]].appendTo(p)}}}}}}}(),RED.stack=function(){return{create:function(e){var t=e.container;t.addClass("red-ui-stack");var n=0,o=[],a=!0,i=function(){if(o.length>0){var e=0;o.forEach(function(t){e+=t.header.outerHeight()});var a=t.innerHeight();n=a-e-(o.length-1),o.forEach(function(e){e.contentWrap.height(n)})}};return e.fill&&e.singleExpanded&&($(window).resize(i),$(window).focus(i)),{add:function(s){o.push(s),s.container=$('<div class="palette-category">').appendTo(t),a||s.container.hide();var r=$('<div class="palette-header"></div>').appendTo(s.container);if(s.header=r,s.contentWrap=$("<div></div>",{style:"position:relative"}).appendTo(s.container),e.fill&&s.contentWrap.css("height",n),s.content=$("<div></div>").appendTo(s.contentWrap),!1!==s.collapsible){r.click(function(){if(e.singleExpanded){if(!s.isExpanded()){for(var t=0;t<o.length;t++)o[t].isExpanded()&&o[t].collapse();s.expand()}}else s.toggle()});var d=$('<i class="fa fa-angle-down"></i>').appendTo(r);s.expanded?(s.container.addClass("palette-category-expanded"),d.addClass("expanded")):s.contentWrap.hide()}else $('<i style="opacity: 0.5;" class="fa fa-angle-down expanded"></i>').appendTo(r),r.css("cursor","default");return s.title=$("<span></span>").html(s.title).appendTo(r),s.toggle=function(){return s.isExpanded()?(s.collapse(),!1):(s.expand(),!0)},s.expand=function(){if(!s.isExpanded())return s.onexpand&&s.onexpand.call(s),e.singleExpanded&&o.forEach(function(e){e!==s&&e.collapse()}),d.addClass("expanded"),s.container.addClass("palette-category-expanded"),s.contentWrap.slideDown(200),!0},s.collapse=function(){if(s.isExpanded())return d.removeClass("expanded"),s.container.removeClass("palette-category-expanded"),s.contentWrap.slideUp(200),!0},s.isExpanded=function(){return s.container.hasClass("palette-category-expanded")},e.fill&&e.singleExpanded&&i(),s},hide:function(){return a=!1,o.forEach(function(e){e.container.hide()}),this},show:function(){return a=!0,o.forEach(function(e){e.container.show()}),this},resize:function(){i&&i()}}}}}(),function(e){var t={bool:{value:"bool",label:"bool",icon:"red/images/typedInput/bool.png",options:["true","false"]},string:{value:"string",label:"string",icon:"red/images/typedInput/az.png"},int:{value:"int",label:"int",icon:"red/images/typedInput/09.png",validate:/^[+-]?[0-9]*$/},float:{value:"float",label:"float",icon:"red/images/typedInput/09.png",validate:/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/},suntime:{value:"suntime",label:"sun",icon:"red/images/typedInput/bool.png",options:["sunrise","sunset","sunriseEnd","sunsetStart","dawn","dusk","nauticalDawn","nauticalDusk","nightEnd","night","goldenHourEnd","goldenHour","solarNoon","nadir"]},time:{value:"time",defaultValue:"HH:MM[:SS]",label:"time",icon:"red/images/typedInput/time.png",validate:/^([0-9]|0[0-9]|1[0-9]|2[0-3])(:[0-5][0-9]){1,2}$/},array:{value:"array",label:"array",icon:"red/images/typedInput/array.png",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},expand:function(){var e=this,t=this.value();try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}RED.editor.editJSON({value:t,complete:function(t){var n=t;try{n=JSON.stringify(JSON.parse(t))}catch(e){}e.value(n)}})}},arraySimple:{value:"array",label:"array",icon:"red/images/typedInput/array.png",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}}},struct:{value:"struct",label:"struct",icon:"red/images/typedInput/json.png",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},expand:function(){var e=this,t=this.value();try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}RED.editor.editJSON({value:t,complete:function(t){var n=t;try{n=JSON.stringify(JSON.parse(t))}catch(e){}e.value(n)}})}},structSimple:{value:"struct",label:"struct",icon:"red/images/typedInput/json.png",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}}},bin:{value:"bin",label:"buffer",icon:"red/images/typedInput/bin.png",expand:function(){var e=this;RED.editor.editBuffer({value:this.value(),complete:function(t){e.value(t)}})}},binSimple:{value:"bin",label:"buffer",icon:"red/images/typedInput/bin.png"}},n=!1;e.widget("nodered.typedInput",{_create:function(){if(!n&&RED&&RED._)for(var o in t)t.hasOwnProperty(o)&&(t[o].label=RED._("typedInput.type."+o,{defaultValue:t[o].label}));n=!0;var a=this;this.disarmClick=!1,this.element.addClass("red-ui-typedInput"),this.uiWidth=this.element.outerWidth(),this.elementDiv=this.element.wrap("<div>").parent().addClass("red-ui-typedInput-input"),this.uiSelect=this.elementDiv.wrap("<div>").parent();var i,s=this.element.attr("style");if(null!==(i=/width\s*:\s*(calc\s*\(.*\)|\d+(%|px))/i.exec(s))?(this.element.css("width","100%"),this.uiSelect.width(i[1]),this.uiWidth=null):this.uiSelect.width(this.uiWidth),["Right","Left"].forEach(function(e){var t=a.element.css("margin"+e);a.uiSelect.css("margin"+e,t),a.element.css("margin"+e,0)}),this.uiSelect.addClass("red-ui-typedInput-container"),this.options.types=this.options.types||Object.keys(t),this.selectTrigger=e('<button tabindex="0"></button>').prependTo(this.uiSelect),this.options.types.length>1&&e('<i class="fa fa-sort-desc"></i>').appendTo(this.selectTrigger),this.selectLabel=e("<span></span>").appendTo(this.selectTrigger),this.types(this.options.types),this.options.typeField){this.typeField=e(this.options.typeField).hide();var r=this.typeField.val();r&&this.typeMap[r]&&(this.options.default=r)}else this.typeField=e("<input>",{type:"hidden"}).appendTo(this.uiSelect);this.element.on("focus",function(){a.uiSelect.addClass("red-ui-typedInput-focus")}),this.element.on("blur",function(){a.uiSelect.removeClass("red-ui-typedInput-focus")}),this.element.on("change",function(){a.validate()}),this.selectTrigger.click(function(e){e.preventDefault(),a._showTypeMenu()}),this.selectTrigger.on("keydown",function(e){40===e.keyCode&&a._showTypeMenu()}).on("focus",function(){a.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionSelectTrigger=e('<button tabindex="0" class="red-ui-typedInput-option-trigger" style="display:inline-block"><span class="red-ui-typedInput-option-caret"><i class="fa fa-sort-desc"></i></span></button>').appendTo(this.uiSelect),this.optionSelectLabel=e('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.optionSelectTrigger),this.optionSelectTrigger.click(function(e){e.preventDefault(),a._showOptionSelectMenu()}).on("keydown",function(e){40===e.keyCode&&a._showOptionSelectMenu()}).on("blur",function(){a.uiSelect.removeClass("red-ui-typedInput-focus")}).on("focus",function(){a.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionExpandButton=e('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block"><i class="fa fa-ellipsis-h"></i></button>').appendTo(this.uiSelect),this.type(this.options.default||this.typeList[0].value)},_showTypeMenu:function(){this.typeList.length>1?(this._showMenu(this.menu,this.selectTrigger),this.menu.find("[value='"+this.propertyType+"']").focus()):this.element.focus()},_showOptionSelectMenu:function(){if(this.optionMenu){this.optionMenu.css({minWidth:this.optionSelectLabel.width()}),this._showMenu(this.optionMenu,this.optionSelectLabel);var e=this.optionMenu.find("[value='"+this.value()+"']");0===e.length&&(e=this.optionMenu.children(":first")),e.focus()}},_hideMenu:function(t){e(document).off("mousedown.close-property-select"),t.hide(),this.elementDiv.is(":visible")?this.element.focus():this.optionSelectTrigger.is(":visible")?this.optionSelectTrigger.focus():this.selectTrigger.focus()},_createMenu:function(t,n){var o=this,a=e("<div>").addClass("red-ui-typedInput-options");return t.forEach(function(t){"string"==typeof t&&(t={value:t,label:t});var i=e('<a href="#"></a>').attr("value",t.value).appendTo(a);t.label&&i.text(t.label),t.icon?e("<img>",{src:t.icon,style:"margin-right: 4px; height: 18px;"}).prependTo(i):i.css({paddingLeft:"18px"}),i.click(function(e){e.preventDefault(),n(t.value),o._hideMenu(a)})}),a.css({display:"none"}),a.appendTo(document.body),a.on("keydown",function(t){40===t.keyCode?e(this).children(":focus").next().focus():38===t.keyCode?e(this).children(":focus").prev().focus():27===t.keyCode&&o._hideMenu(a)}),a},_showMenu:function(t,n){if(this.disarmClick)this.disarmClick=!1;else{var o=this,a=n.offset(),i=n.height(),s=t.height(),r=i+a.top-3;r+s>e(window).height()&&(r-=r+s-e(window).height()+5),t.css({top:r+"px",left:2+a.left+"px"}),t.slideDown(100),this._delay(function(){o.uiSelect.addClass("red-ui-typedInput-focus"),e(document).on("mousedown.close-property-select",function(a){e(a.target).closest(t).length||o._hideMenu(t),e(a.target).closest(n).length&&(o.disarmClick=!0,a.preventDefault())})})}},_getLabelWidth:function(t){var n=t.outerWidth();if(0===n){var o=e('<div class="red-ui-typedInput-container"></div>').css({position:"absolute",top:0,left:-1e3}).appendTo(document.body);n=t.clone().appendTo(o).outerWidth(),o.remove()}return n},_resize:function(){if(null!==this.uiWidth&&this.uiSelect.width(this.uiWidth),this.typeMap[this.propertyType]&&!1===this.typeMap[this.propertyType].hasValue)this.selectTrigger.addClass("red-ui-typedInput-full-width");else{this.selectTrigger.removeClass("red-ui-typedInput-full-width");var e=this._getLabelWidth(this.selectTrigger);this.elementDiv.css("left",e+"px"),this.optionExpandButton.is(":visible")?this.elementDiv.css("right","22px"):this.elementDiv.css("right","0"),this.optionSelectTrigger&&this.optionSelectTrigger.css({left:e+"px",width:"calc( 100% - "+e+"px )"})}},_destroy:function(){this.menu.remove()},types:function(e){var n=this,o=this.type();this.typeMap={},this.typeList=e.map(function(e){var o;return o="string"==typeof e?t[e]:e,n.typeMap[o.value]=o,o}),this.selectTrigger.toggleClass("disabled",1===this.typeList.length),this.menu&&this.menu.remove(),this.menu=this._createMenu(this.typeList,function(e){n.type(e)}),o&&!this.typeMap.hasOwnProperty(o)&&this.type(this.typeList[0].value)},width:function(e){this.uiWidth=e,this._resize()},value:function(e){if(!arguments.length)return this.element.val();if(this.typeMap[this.propertyType].options){for(var t,n=!1,o=0;o<this.typeMap[this.propertyType].options.length;o++){var a=this.typeMap[this.propertyType].options[o];if("string"==typeof a){if(a===e){t=e,n=!0;break}}else if(a.value===e){t=a.label||a.value,n=!0;break}}n||(e="",t=""),this.optionSelectLabel.text(t)}this.element.val(e),this.element.trigger("change",this.type(),e)},type:function(t){if(!arguments.length)return this.propertyType;var n=this,o=this.typeMap[t];if(o&&this.propertyType!==t){this.propertyType=t,this.typeField.val(t),this.selectLabel.empty();var a;if(o.icon?((a=new Image).name=o.icon,a.src=o.icon,e("<img>",{src:o.icon,style:"margin-right: 4px;height: 18px;"}).prependTo(this.selectLabel)):this.selectLabel.text(o.label),o.options){if(this.optionExpandButton&&this.optionExpandButton.hide(),this.optionSelectTrigger){this.optionSelectTrigger.show(),this.elementDiv.hide(),this.optionMenu=this._createMenu(o.options,function(e){n.optionSelectLabel.text(e),n.value(e)});for(var i,s=this.element.val(),r=!1,d=0;d<o.options.length;d++)if("string"==typeof(i=o.options[d])){if(i===s){this.optionSelectLabel.text(s),r=!0;break}}else if(i.value===s){this.optionSelectLabel.text(i.label||i.value),r=!0;break}r||("string"==typeof(i=o.options[0])?this.value(i):this.value(i.value)),console.log(r)}}else{if(this.optionMenu&&(this.optionMenu.remove(),this.optionMenu=null),this.optionSelectTrigger&&this.optionSelectTrigger.hide(),!1===o.hasValue)this.oldValue=this.element.val(),this.element.val(""),this.elementDiv.hide();else{if(void 0!==this.oldValue)this.element.val(this.oldValue),delete this.oldValue;else if(o.defaultValue)if(this.element.val()){var l=o.validate;("function"==typeof l?l(this.element.val()):l.test(this.element.val()))||this.element.val(o.defaultValue)}else this.element.val(o.defaultValue);this.elementDiv.show()}o.expand&&"function"==typeof o.expand?(this.optionExpandButton.show(),this.optionExpandButton.off("click"),this.optionExpandButton.on("click",function(e){e.preventDefault(),o.expand.call(n)})):this.optionExpandButton.hide(),this.element.trigger("change",this.propertyType,this.value())}a?(a.onload=function(){n._resize()},a.onerror=function(){n._resize()}):this._resize()}},validate:function(){var e,t=this.value(),n=this.type();if(this.typeMap[n]&&this.typeMap[n].validate){var o=this.typeMap[n].validate;e="function"==typeof o?o(t):o.test(t)}else e=!0;return e?this.uiSelect.removeClass("input-error"):this.uiSelect.addClass("input-error"),e},show:function(){this.uiSelect.show(),this._resize()},hide:function(){this.uiSelect.hide()}})}(jQuery),RED.actions=function(){var e={};return{add:function(t,n){e[t]=n},remove:function(t){delete e[t]},get:function(t){return e[t]},invoke:function(t){e.hasOwnProperty(t)&&e[t]()},list:function(){var t=[];return Object.keys(e).forEach(function(e){var n=RED.keyboard.getShortcut(e);t.push({id:e,scope:n?n.scope:void 0,key:n?n.key:void 0,user:n?n.user:void 0})}),t}}}(),RED.deploy=function(){function e(e){var t="";if(e.z){var n=RED.nodes.workspace(e.z);t=n?n.label:(n=RED.nodes.subflow(e.z)).name}var o=RED.utils.getNodeLabel(e,e.id);return{tab:t,type:e.type,label:o}}function t(e,t){return e.tab<t.tab?-1:e.tab>t.tab?1:e.type<t.type?-1:e.type>t.type?1:e.name<t.name?-1:e.name>t.name?1:0}function n(e,t){var n=$("<div>");$('<p data-i18n="deploy.confirm.conflict"></p>').appendTo(n);var o=$('<div id="node-dialog-confirm-deploy-conflict-checking" class="node-dialog-confirm-conflict-row"><img src="red/images/spin.svg"/><div data-i18n="deploy.confirm.conflictChecking"></div></div>').appendTo(n),i=$('<div class="node-dialog-confirm-conflict-row"><i style="color: #3a3;" class="fa fa-check"></i><div data-i18n="deploy.confirm.conflictAutoMerge"></div></div>').hide().appendTo(n),s=$('<div id="node-dialog-confirm-deploy-conflict-manual-merge" class="node-dialog-confirm-conflict-row"><i style="color: #999;" class="fa fa-exclamation"></i><div data-i18n="deploy.confirm.conflictManualMerge"></div></div>').hide().appendTo(n);n.i18n(),d=null;var r=[{text:RED._("common.label.cancel"),click:function(){l.close()}},{id:"node-dialog-confirm-deploy-review",text:RED._("deploy.confirm.button.review"),class:"primary disabled",click:function(){$("#node-dialog-confirm-deploy-review").hasClass("disabled")||(RED.diff.showRemoteDiff(),l.close())}},{id:"node-dialog-confirm-deploy-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#node-dialog-confirm-deploy-merge").hasClass("disabled")||(RED.diff.mergeDiff(d),l.close())}}];t&&r.push({id:"node-dialog-confirm-deploy-overwrite",text:RED._("deploy.confirm.button.overwrite"),class:"primary",click:function(){a(!0,t),l.close()}});var l=RED.notify(n,{modal:!0,fixed:!0,width:600,buttons:r}),c=Date.now();RED.diff.getRemoteDiff(function(e){var t=Math.max(1e3-(Date.now()-c),0);d=e,setTimeout(function(){o.hide(),0===Object.keys(e.conflicts).length?(i.show(),$("#node-dialog-confirm-deploy-merge").removeClass("disabled")):s.show(),$("#node-dialog-confirm-deploy-review").removeClass("disabled")},t)})}function o(e){if(e.length>5){var t=e.length-5;(e=e.slice(0,5)).push(RED._("deploy.confirm.plusNMore",{count:t}))}return e}function a(d,l){if(!$("#btn-deploy").hasClass("disabled")){if(!RED.user.hasPermission("flows.write"))return void RED.notify(RED._("user.errors.deploy"),"error");if(!d){var c=!1,p=!1,u=!1,f=[],h=[];RED.nodes.eachNode(function(t){p=p||!t.valid,t.valid||h.push(e(t)),"unknown"===t.type&&-1==f.indexOf(t.name)&&f.push(t.name)}),c=f.length>0;var g=[];RED.nodes.eachConfig(function(t){0===t.users.length&&!1!==t._def.hasUsers&&(g.push(e(t)),u=!0)});var v,m,b=!1,y=[];if(c&&!i.unknown?(b=!0,v="<p>"+RED._("deploy.confirm.unknown")+'</p><ul class="node-dialog-configm-deploy-list"><li>'+o(f).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",y=[{id:"node-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){a(!0),m.close()}}]):p&&!i.invalid&&(b=!0,h.sort(t),v="<p>"+RED._("deploy.confirm.improperlyConfigured")+'</p><ul class="node-dialog-configm-deploy-list"><li>'+o(h.map(function(e){return(e.tab?"["+e.tab+"] ":"")+e.label+" ("+e.type+")"})).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",y=[{id:"node-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){a(!0),m.close()}}]),b)return y.unshift({text:RED._("common.label.cancel"),click:function(){m.close()}}),void(m=RED.notify(v,{modal:!0,fixed:!0,buttons:y}))}var w=RED.nodes.createCompleteNodeSet(),D=Date.now();$(".deploy-button-content").css("opacity",0),$(".deploy-button-spinner").show(),$("#btn-deploy").addClass("disabled");var E={flows:w};l||(E.rev=RED.nodes.version()),r=!0,$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$.ajax({url:"flows",type:"POST",data:JSON.stringify(E),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":s}}).done(function(e,t,n){RED.nodes.dirty(!1),RED.nodes.version(e.rev),RED.nodes.originalFlow(w),u?RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p><p>"+RED._("deploy.unusedConfigNodes")+' <a href="#" onclick="RED.sidebar.config.show(true); return false;">'+RED._("deploy.unusedConfigNodesLink")+"</a></p>","success",!1,6e3):RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p>","success"),RED.nodes.eachNode(function(e){e.changed&&(e.dirty=!0,e.changed=!1),e.moved&&(e.dirty=!0,e.moved=!1),e.credentials&&delete e.credentials}),RED.nodes.eachConfig(function(e){e.changed=!1,e.credentials&&delete e.credentials}),RED.nodes.eachSubflow(function(e){e.changed=!1}),RED.nodes.eachWorkspace(function(e){e.changed=!1}),RED.history.markAllDirty(),RED.view.redraw(),RED.events.emit("deploy")}).fail(function(e,t,o){RED.nodes.dirty(!0),$("#btn-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?n(w,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){r=!1;var e=Math.max(0,300-(Date.now()-D));setTimeout(function(){$(".deploy-button-content").css("opacity",1),$(".deploy-button-spinner").hide(),$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide()},e)})}}var i={unknown:!1,unusedConfig:!1,invalid:!1},s="full",r=!1,d=null;return{init:function(e){var t=(e=e||{}).type||"default";if("default"==t)$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content"><img id="btn-deploy-icon" src="red/images/deploy-full-o.png"> <span>'+RED._("deploy.deploy")+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a>').prependTo(".header-toolbar");else if("simple"==t){var o=e.label||RED._("deploy.deploy"),i="red/images/deploy-full-o.png";e.hasOwnProperty("icon")&&(i=e.icon),$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content">'+(i?'<img id="btn-deploy-icon" src="'+i+'"> ':"")+"<span>"+o+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a></span></li>').prependTo(".header-toolbar")}$("#btn-deploy").click(function(e){e.preventDefault(),a()}),RED.actions.add("core:deploy-flows",a),RED.events.on("nodes:change",function(e){e.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#btn-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#btn-deploy").addClass("disabled"))});var s;RED.comms.subscribe("notification/runtime-deploy",function(e,t){if(!s){var o=RED.nodes.version();if(null===o||r||o===t.revision)return;var a=$("<p>").text(RED._("deploy.confirm.backgroundUpdate"));s=RED.notify(a,{modal:!0,fixed:!0,buttons:[{text:RED._("deploy.confirm.button.ignore"),click:function(){s.close(),s=null}},{text:RED._("deploy.confirm.button.review"),class:"primary",click:function(){s.close(),n(RED.nodes.createCompleteNodeSet(),!1),s=null}}]})}})},setDeployInflight:function(e){r=e}}}(),RED.diff=function(){function e(e,t){var n=$('<ol class="node-dialog-view-diff-diff"></ol>').appendTo(e);return n.editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(e,n,a){var d=a.diff,l=a.remoteDiff,c=a.tab.n,p=a.def,u=t.conflicts,f=$("<div>",{class:"node-diff-tab"}).appendTo(e);f.addClass("collapsed");var h,g,v=$("<div>",{class:"node-diff-tab-title"}).appendTo(f),m=$("<div>").appendTo(f),b=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(v),y=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(v);l&&(h=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(v)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(b),o(c,p).appendTo(b);var w=(a.newTab||a.tab).n,D=$("<span>",{class:"node-diff-tab-title-meta"}).appendTo(b);"tab"===w.type?D.text(w.label||w.id):"subflow"===c.type?D.text(w.name||w.id):D.text(RED._("diff.globalNodes"));var E={local:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},remote:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},conflicts:0};if(a.newTab||a.remoteTab){var x,R={node:d.newConfig.all[c.id],all:d.newConfig.all,diff:d};if(l&&(x={node:l.newConfig.all[c.id]||null,all:l.newConfig.all,diff:l}),void 0!==c.type){var T=$("<div>",{class:"node-diff-node-entry node-diff-node-props collapsed"}).appendTo(m),k=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(T),_=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(k),C=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(k);d.newConfig.all[c.id]?d.added[c.id]?(C.addClass("node-diff-node-added"),!0,$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(C)):d.changed[c.id]?(C.addClass("node-diff-node-changed"),!0,$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(C)):(C.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(C)):C.addClass("node-diff-empty");var j;l&&(j=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(k),l.newConfig.all[c.id]?l.added[c.id]?(j.addClass("node-diff-node-added"),!0,$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(j)):l.changed[c.id]?(j.addClass("node-diff-node-changed"),!0,$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(j)):(j.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(j)):(j.addClass("node-diff-empty"),l.deleted[c.id]&&!0)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(_),$("<span>").text(RED._("diff.flowProperties")).appendTo(_),k.click(function(e){e.preventDefault(),$(this).parent().toggleClass("collapsed")}),s(p,c,R,x).appendTo(T),g="",u[c.id]?(E.conflicts++,C.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(C),j.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(j),T.addClass("node-diff-node-entry-conflict")):g=t.resolutions[c.id],r(c,T,C,j,!0,!u[c.id],g,t)}}var S=0,O=0,P={};if(a.tab.nodes.forEach(function(e){P[e.id]=!0,i(e,E,t).appendTo(m)}),a.newTab&&(S=a.newTab.nodes.length,a.newTab.nodes.forEach(function(e){P[e.id]||(P[e.id]=!0,i(e,E,t).appendTo(m))})),a.remoteTab&&(O=a.remoteTab.nodes.length,a.remoteTab.nodes.forEach(function(e){P[e.id]||i(e,E,t).appendTo(m)})),v.click(function(e){v.parent().toggleClass("collapsed"),$(this).parent().hasClass("collapsed")&&($(this).parent().find(".node-diff-node-entry").addClass("collapsed"),$(this).parent().find(".debug-message-element").addClass("collapsed"))}),d.deleted[c.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(y);else if(a.newTab)if(d.added[c.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(y);else{c.id&&(d.changed[c.id]?E.local.changedCount++:E.local.unchangedCount++);var L=$("<span>",{class:"node-diff-tab-stats"}).appendTo(y);$('<span class="node-diff-status"></span>').text(RED._("diff.nodeCount",{count:S})).appendTo(L),E.conflicts+E.local.addedCount+E.local.changedCount+E.local.deletedCount>0&&($('<span class="node-diff-status"> [ </span>').appendTo(L),E.conflicts>0&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+E.conflicts+"</span></span>").appendTo(L),E.local.addedCount>0&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+E.local.addedCount+"</span></span>").appendTo(L),E.local.changedCount>0&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+E.local.changedCount+"</span></span>").appendTo(L),E.local.deletedCount>0&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+E.local.deletedCount+"</span></span>").appendTo(L),$('<span class="node-diff-status"> ] </span>').appendTo(L))}else y.addClass("node-diff-empty");if(l){if(l.deleted[c.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(h);else if(a.remoteTab)if(l.added[c.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(h);else{c.id&&(l.changed[c.id]?E.remote.changedCount++:E.remote.unchangedCount++);var I=$("<span>",{class:"node-diff-tab-stats"}).appendTo(h);$('<span class="node-diff-status"></span>').text(RED._("diff.nodeCount",{count:O})).appendTo(I),E.conflicts+E.remote.addedCount+E.remote.changedCount+E.remote.deletedCount>0&&($('<span class="node-diff-status"> [ </span>').appendTo(I),E.conflicts>0&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+E.conflicts+"</span></span>").appendTo(I),E.remote.addedCount>0&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+E.remote.addedCount+"</span></span>").appendTo(I),E.remote.changedCount>0&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+E.remote.changedCount+"</span></span>").appendTo(I),E.remote.deletedCount>0&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+E.remote.deletedCount+"</span></span>").appendTo(I),$('<span class="node-diff-status"> ] </span>').appendTo(I))}else h.addClass("node-diff-empty");if(g="",E.conflicts>0?v.addClass("node-diff-node-entry-conflict"):g=t.resolutions[c.id],c.id){var N=!(E.conflicts>0&&(d.deleted[c.id]||l.deleted[c.id]));r(c,v,y,h,!1,N,g,t)}}0===f.find(".node-diff-node-entry").length&&f.addClass("node-diff-tab-empty"),e.i18n()}}),n}function t(t,n,o){var a=$('<div class="node-dialog-view-diff-panel"></div>').appendTo(t),i=$('<div class="node-dialog-view-diff-headers"></div>').appendTo(a);"merge"===o.mode&&a.addClass("node-dialog-view-diff-panel-merge");var s=e(a,n),r=n.localDiff,d=n.remoteDiff,l=(n.conflicts,r.currentConfig),c=r.newConfig;if(void 0!==d){a.addClass("node-diff-three-way");var p=o.oldRevTitle||RED._("diff.local"),u=o.newRevTitle||RED._("diff.remote");$("<div></div>").text(p).appendTo(i),$("<div></div>").text(u).appendTo(i)}else a.removeClass("node-diff-three-way");return{list:s,finish:function(){var e={diff:r,def:{category:"config",color:"#f0f0f0"},tab:{n:{},nodes:l.globals},newTab:{n:{},nodes:c.globals}};void 0!==d&&(e.remoteTab={n:{},nodes:d.newConfig.globals},e.remoteDiff=d),s.editableList("addItem",e);var t={};l.tabOrder.forEach(function(e){var n=l.tabs[e],o={diff:r,def:RED.nodes.getType("tab"),tab:n};c.tabs.hasOwnProperty(e)&&(o.newTab=c.tabs[e]),void 0!==d&&(o.remoteTab=d.newConfig.tabs[e],o.remoteDiff=d),t[e]=!0,s.editableList("addItem",o)}),c.tabOrder.forEach(function(e){if(!t[e]){t[e]=!0;var n=c.tabs[e],o={diff:r,def:RED.nodes.getType("tab"),tab:n,newTab:n};void 0!==d&&(o.remoteDiff=d),s.editableList("addItem",o)}}),void 0!==d&&d.newConfig.tabOrder.forEach(function(e){if(!t[e]){var n=d.newConfig.tabs[e],o={diff:r,remoteDiff:d,def:RED.nodes.getType("tab"),tab:n,remoteTab:n};s.editableList("addItem",o)}});var n;for(n in l.subflows)l.subflows.hasOwnProperty(n)&&(t[n]=!0,e={diff:r,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:l.subflows[n]},c.subflows.hasOwnProperty(n)&&(e.newTab=c.subflows[n]),void 0!==d&&(e.remoteTab=d.newConfig.subflows[n],e.remoteDiff=d),s.editableList("addItem",e));for(n in c.subflows)c.subflows.hasOwnProperty(n)&&!t[n]&&(t[n]=!0,e={diff:r,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:c.subflows[n],newTab:c.subflows[n]},void 0!==d&&(e.remoteDiff=d),s.editableList("addItem",e));if(void 0!==d)for(n in d.newConfig.subflows)d.newConfig.subflows.hasOwnProperty(n)&&!t[n]&&(e={diff:r,remoteDiff:d,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:d.newConfig.subflows[n],remoteTab:d.newConfig.subflows[n]},s.editableList("addItem",e))}}}function n(e,t){var n=$("<div>",{class:"node-diff-property-wires"}),o=$("<ol></ol>"),i=0;return e.forEach(function(e,n){var s=$("<li>").appendTo(o);if(e&&e.length>0){$("<span>").text(n+1).appendTo(s);var r=$("<ul>").appendTo(s);e.forEach(function(e){i++;var n=$("<li>").appendTo(r),o=t[e];o?a(o,RED.nodes.getType(o.type)||{}).appendTo(n):n.text(e)})}else s.text("none")}),0===i?n.text("none"):o.appendTo(n),n}function o(e,t){var n=$("<div>",{class:"node-diff-node-entry-node"}),o=t.color,a=RED.utils.getNodeIcon(t,e);"tab"===e.type&&(o="#C0DEED"),n.css("backgroundColor",o);var i=$("<div/>",{class:"palette_icon_container"}).appendTo(n);return $("<div/>",{class:"palette_icon",style:"background-image: url("+a+")"}).appendTo(i),n}function a(e,t){var n=$("<div>",{class:"node-diff-node-entry-title"});o(e,t).appendTo(n);var a=$("<div>",{class:"node-diff-node-description"}).appendTo(n),i=e.label||e.name||e.id;return $("<span>",{class:"node-diff-node-label"}).text(i).appendTo(a),n}function i(e,t,n){var o=n.localDiff,i=n.remoteDiff,d=n.conflicts[e.id],l=!0;o.added[e.id]&&(t.local.addedCount++,l=!1),i&&i.added[e.id]&&(t.remote.addedCount++,l=!1),o.deleted[e.id]&&(t.local.deletedCount++,l=!1),i&&i.deleted[e.id]&&(t.remote.deletedCount++,l=!1),o.changed[e.id]&&(t.local.changedCount++,!0,l=!1),i&&i.changed[e.id]&&(t.remote.changedCount++,!0,l=!1);var c=RED.nodes.getType(e.type);void 0===c&&(c=/^subflow:/.test(e.type)?{icon:"subflow.png",category:"subflows",color:"#da9",defaults:{name:{value:""}}}:{});var p,u=$("<div>",{class:"node-diff-node-entry collapsed"}),f=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(u),h=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(f),g=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(f);if(i&&(p=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(f)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(h),l)t.local.unchangedCount++,a(e,c).appendTo(h),g.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(g),i&&(t.remote.unchangedCount++,p.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(p)),u.addClass("node-diff-node-unchanged");else if(o.added[e.id])g.addClass("node-diff-node-added"),p&&p.addClass("node-diff-empty"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(g),a(e,c).appendTo(h);else if(i&&i.added[e.id])g.addClass("node-diff-empty"),p.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(p),a(e,c).appendTo(h);else{if(a(e,c).appendTo(h),o.moved[e.id]){var v=o.newConfig.all[e.id];if(o.deleted[e.z]||e.z===v.z||""===e.z||o.newConfig.all[e.z]){g.addClass("node-diff-node-moved");var m="";m=e.z===v.z?RED._("diff.type.movedFrom",{id:o.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:v.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+m+"</span>").appendTo(g)}else g.addClass("node-diff-empty");!0}else o.deleted[e.z]?(g.addClass("node-diff-empty"),!0):o.deleted[e.id]?(g.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(g),!0):o.changed[e.id]?o.newConfig.all[e.id].z!==e.z?g.addClass("node-diff-empty"):(g.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(g),!0):o.newConfig.all[e.id].z!==e.z?g.addClass("node-diff-empty"):(t.local.unchangedCount++,g.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(g));if(i)if(i.moved[e.id]){var b=i.newConfig.all[e.id];if(i.deleted[e.z]||e.z===b.z||""===e.z||i.newConfig.all[e.z]){p.addClass("node-diff-node-moved");var y="";y=e.z===b.z?RED._("diff.type.movedFrom",{id:i.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:b.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+y+"</span>").appendTo(p)}else p.addClass("node-diff-empty")}else i.deleted[e.z]?p.addClass("node-diff-empty"):i.deleted[e.id]?(p.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(p)):i.changed[e.id]?i.newConfig.all[e.id].z!==e.z?p.addClass("node-diff-empty"):(p.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(p)):i.newConfig.all[e.id].z!==e.z?p.addClass("node-diff-empty"):(t.remote.unchangedCount++,p.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(p))}var w,D={node:o.newConfig.all[e.id],all:o.newConfig.all,diff:o};i&&(w={node:i.newConfig.all[e.id]||null,all:i.newConfig.all,diff:i}),s(c,e,D,w).appendTo(u);var E="";return d?(t.conflicts++,g.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(g),p.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(p),u.addClass("node-diff-node-entry-conflict")):E=n.resolutions[e.id],r(e,u,g,p,!1,!d,E,n),f.click(function(e){$(this).parent().toggleClass("collapsed")}),u}function s(e,t,o,a){var i,s={},r=o.node;a&&(i=a.node);var d=$("<div>",{class:"node-diff-node-entry-properties"}),l=$("<table>").appendTo(d),c=$("<colgroup><col/><col/></colgroup>").appendTo(l);void 0!==i&&$("<col/>").appendTo(c);var p,u,f,h,g,v,b,y=$("<tbody>").appendTo(l),w=!1,D=!1,E=0,x=0,R=!1;p=$("<tr>").appendTo(y),$("<td>",{class:"node-diff-property-cell-label"}).text("id").appendTo(p),u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(u.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"></span>').appendTo(u),h=$('<span class="node-diff-element"></span>').appendTo(u),s["local.id"]=RED.utils.createObjectElement(r.id).appendTo(h)):u.addClass("node-diff-empty"),void 0!==i&&((f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p)).addClass("node-diff-node-unchanged"),i?($('<span class="node-diff-status"></span>').appendTo(f),h=$('<span class="node-diff-element"></span>').appendTo(f),s["remote.id"]=RED.utils.createObjectElement(i.id).appendTo(h)):f.addClass("node-diff-empty")),t.hasOwnProperty("x")&&(r&&(r.x===t.x&&r.y===t.y||(w=!0,E++)),i&&(i.x===t.x&&i.y===t.y||(D=!0,x++)),(D&&w&&(r.x!==i.x||r.y!==i.y)||!w&&D&&o.diff.deleted[t.id]||w&&!D&&a.diff.deleted[t.id])&&(R=!0),p=$("<tr>").appendTo(y),$("<td>",{class:"node-diff-property-cell-label"}).text("position").appendTo(p),u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(u.addClass("node-diff-node-"+(w?"changed":"unchanged")),$('<span class="node-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u),h=$('<span class="node-diff-element"></span>').appendTo(u),s["local.position"]=RED.utils.createObjectElement({x:r.x,y:r.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){s["remote."+e]&&s["remote."+e].prop("expand")(e,t)}}).appendTo(h)):u.addClass("node-diff-empty"),void 0!==i&&((f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p)).addClass("node-diff-node-"+(D?"changed":"unchanged")),i?($('<span class="node-diff-status">'+(D?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f),h=$('<span class="node-diff-element"></span>').appendTo(f),s["remote.position"]=RED.utils.createObjectElement({x:i.x,y:i.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){s["local."+e]&&s["local."+e].prop("expand")(e,t)}}).appendTo(h)):f.addClass("node-diff-empty"))),w=D=R=!1,t.hasOwnProperty("wires")&&(g=JSON.stringify(t.wires),r&&(v=JSON.stringify(r.wires),g!==v&&(w=!0,E++)),i&&(b=JSON.stringify(i.wires),g!==b&&(D=!0,x++)),(D&&w&&v!==b||!w&&D&&o.diff.deleted[t.id]||w&&!D&&a.diff.deleted[t.id])&&(R=!0),p=$("<tr>").appendTo(y),$("<td>",{class:"node-diff-property-cell-label"}).text("wires").appendTo(p),u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(R?(u.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("node-diff-node-"+(w?"changed":"unchanged")),$('<span class="node-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),n(r.wires,o.all).appendTo(u)):u.addClass("node-diff-empty"),void 0!==i&&(f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p),i?(R?(f.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(f)):(f.addClass("node-diff-node-"+(D?"changed":"unchanged")),$('<span class="node-diff-status">'+(D?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f)),n(i.wires,a.all).appendTo(f)):f.addClass("node-diff-empty")));var T=Object.keys(t).filter(function(t){return!("inputLabels"==t||"outputLabels"==t||"z"==t||"wires"==t||"x"===t||"y"===t||"id"===t||"type"===t||e.defaults&&e.defaults.hasOwnProperty(t))});return e.defaults&&(T=T.concat(Object.keys(e.defaults))),"tab"!==t.type&&(T=T.concat(["inputLabels","outputLabels"])),T.forEach(function(e){w=!1,D=!1,R=!1,g=JSON.stringify(t[e]),r&&(v=JSON.stringify(r[e]),g!==v&&(w=!0,E++)),i&&(b=JSON.stringify(i[e]),g!==b&&(D=!0,x++)),(D&&w&&v!==b||!w&&D&&o.diff.deleted[t.id]||w&&!D&&a.diff.deleted[t.id])&&(R=!0),p=$("<tr>").appendTo(y);var n=$("<td>",{class:"node-diff-property-cell-label"}).text(e).appendTo(p);u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(R?(u.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("node-diff-node-"+(w?"changed":"unchanged")),$('<span class="node-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),h=$('<span class="node-diff-element"></span>').appendTo(u),s["local."+e]=RED.utils.createObjectElement(r[e],{path:e,exposeApi:!0,ontoggle:function(t,n){s["remote."+e]&&s["remote."+e].prop("expand")(t,n)}}).appendTo(h)):u.addClass("node-diff-empty"),void 0!==i&&(f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p),i?(R?(f.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(f)):(f.addClass("node-diff-node-"+(D?"changed":"unchanged")),$('<span class="node-diff-status">'+(D?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f)),h=$('<span class="node-diff-element"></span>').appendTo(f),s["remote."+e]=RED.utils.createObjectElement(i[e],{path:e,exposeApi:!0,ontoggle:function(t,n){s["local."+e]&&s["local."+e].prop("expand")(t,n)}}).appendTo(h)):f.addClass("node-diff-empty")),r&&i&&"string"==typeof r[e]&&(/\n/.test(r[e])||/\n/.test(i[e]))&&$('<button class="editor-button editor-button-small node-diff-text-diff-button"><i class="fa fa-file-o"> <i class="fa fa-caret-left"></i> <i class="fa fa-caret-right"></i> <i class="fa fa-file-o"></i></button>').click(function(){m(r[e],i[e])}).appendTo(n)}),d}function r(e,t,n,o,a,i,s,r){var l="node-diff-selectbox-"+e.id.replace(/\./g,"-")+(a?"-props":""),c="";(e.z||a)&&(c="node-diff-selectbox-tab-"+(a?e.id:e.z).replace(/\./g,"-"));var p=!a&&("tab"===e.type||"subflow"===e.type),u=function(n){var o;if(void 0===e.type);else if(p)o="node-diff-selectbox-tab-"+e.id.replace(/\./g,"-"),$("."+o+"-"+this.value).prop("checked",!0),"local"===this.value?($("."+o+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-local"),$("."+o+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-remote")):($("."+o+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-local"),$("."+o+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-remote"));else{var i="node-diff-selectbox-"+(a?e.id:e.z).replace(/\./g,"-");$("#"+i+"-local").prop("checked",!1),$("#"+i+"-remote").prop("checked",!1);var s=$("#"+i+"-local").closest(".node-diff-tab").find(".node-diff-tab-title");s.removeClass("node-diff-select-local"),s.removeClass("node-diff-select-remote")}"local"===this.value?(t.removeClass("node-diff-select-remote"),t.addClass("node-diff-select-local")):"remote"===this.value&&(t.addClass("node-diff-select-remote"),t.removeClass("node-diff-select-local")),d(r)},f=$("<label>",{class:"node-diff-selectbox",for:l+"-local"}).click(function(e){e.stopPropagation()}).appendTo(n),h=$("<input>",{id:l+"-local",type:"radio",value:"local",name:l,class:c+"-local"+(p?"":" node-diff-select-node")}).data("node-id",e.id).change(u).appendTo(f),g=$("<label>",{class:"node-diff-selectbox",for:l+"-remote"}).click(function(e){e.stopPropagation()}).appendTo(o),v=$("<input>",{id:l+"-remote",type:"radio",value:"remote",name:l,class:c+"-remote"+(p?"":" node-diff-select-node")}).data("node-id",e.id).change(u).appendTo(g);"local"===s?h.prop("checked",!0):"remote"===s&&v.prop("checked",!0),(i||n.hasClass("node-diff-empty")||o.hasClass("node-diff-empty"))&&(f.hide(),g.hide())}function d(e){var t=0;$(".node-diff-selectbox>input:checked").each(function(){e.conflicts[$(this).data("node-id")]&&t++,e.resolutions[$(this).data("node-id")]=$(this).val()});var n=Object.keys(e.conflicts).length;n-t==0?$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-check"></i></span></span> '+RED._("diff.unresolvedCount",{count:n-t})):$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span> '+RED._("diff.unresolvedCount",{count:n-t})),n===t&&($("#node-diff-view-diff-merge").removeClass("disabled"),$("#node-diff-view-resolve-diff").removeClass("disabled"))}function l(e){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(t){var n=RED.nodes.createCompleteNodeSet(),o=RED.nodes.originalFlow(),a=t.flows,i=u(o,n),s=u(o,a);s.rev=t.rev,e(f(i,s))}})}function c(e){void 0===e?l(c):h(e,{mode:"merge"})}function p(e){var t=[],n={},o={},a=[],i={};return e.forEach(function(e){i[e.id]=e,"tab"===e.type?(t.push(e.id),n[e.id]={n:e,nodes:[]}):"subflow"===e.type&&(o[e.id]={n:e,nodes:[]})}),e.forEach(function(e){"tab"!==e.type&&"subflow"!==e.type&&(n[e.z]?n[e.z].nodes.push(e):o[e.z]?o[e.z].nodes.push(e):a.push(e))}),{all:i,tabOrder:t,tabs:n,subflows:o,globals:a}}function u(e,t){var n=p(e),o=p(t),a={},i={},s={},r={};return Object.keys(n.all).forEach(function(e){RED.nodes.workspace(e)||RED.nodes.subflow(e)||RED.nodes.node(e);o.all.hasOwnProperty(e)?JSON.stringify(n.all[e])!==JSON.stringify(o.all[e])&&(s[e]=!0,n.all[e].z!==o.all[e].z&&(r[e]=!0)):i[e]=!0}),Object.keys(o.all).forEach(function(e){n.all.hasOwnProperty(e)||(a[e]=!0)}),{currentConfig:n,newConfig:o,added:a,deleted:i,changed:s,moved:r}}function f(e,t){var n,o,a={},i={},s={localDiff:e,remoteDiff:t,conflicts:a,resolutions:i},r={};for(n in e.currentConfig.all)if(e.currentConfig.all.hasOwnProperty(n)){r[n]=!0;var d=e.newConfig.all[n];if(e.changed[n]&&t.deleted[n])a[n]=!0;else if(e.deleted[n]&&t.changed[n])a[n]=!0;else if(e.changed[n]&&t.changed[n]){var l=t.newConfig.all[n];JSON.stringify(d)!==JSON.stringify(l)&&(a[n]=!0)}a[n]||(t.added[n]||t.changed[n]||t.deleted[n]?i[n]="remote":i[n]="local")}for(n in e.added)e.added.hasOwnProperty(n)&&(o=e.newConfig.all[n],t.deleted[o.z]?a[n]=!0:i[n]="local");for(n in t.added)t.added.hasOwnProperty(n)&&(o=t.newConfig.all[n],e.deleted[o.z]?a[n]=!0:i[n]="remote");return s}function h(e,n){if(!T){n=n||{},e.localDiff;var o=e.remoteDiff,a=e.conflicts,i={title:n.title||"Review Changes",width:1/0,overlay:!0,buttons:[{text:RED._("merge"===n.mode?"common.label.cancel":"common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(i){var s=i.find(".editor-tray-body"),r=($('<div class="node-diff-toolbar"><span><span id="node-diff-toolbar-resolved-conflicts"></span></span> </div>').prependTo(s),t($('<div class="node-diff-container"></div>').appendTo(s),e,n));r.list.hide(),o?($("#node-diff-view-diff-merge").show(),0===Object.keys(a).length?$("#node-diff-view-diff-merge").removeClass("disabled"):$("#node-diff-view-diff-merge").addClass("disabled")):$("#node-diff-view-diff-merge").hide(),d(e),setTimeout(function(){r.finish(),r.list.show()},300),$("#sidebar-shade").show()},close:function(){T=!1,$("#sidebar-shade").hide()},show:function(){}};"merge"===n.mode&&i.buttons.push({id:"node-diff-view-diff-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#node-diff-view-diff-merge").hasClass("disabled")||(d(e),v(e),RED.tray.close())}}),RED.tray.show(i)}}function g(e){e.localDiff.currentConfig;var t,n=e.localDiff,o=e.remoteDiff,a=e.conflicts,i=e.resolutions;for(t in a)if(a.hasOwnProperty(t)&&!i.hasOwnProperty(t))throw console.log(e),new Error("No resolution for conflict on node",t);var s,r=[],d={},l={};for(t in n.newConfig.all)n.newConfig.all.hasOwnProperty(t)&&(s=RED.nodes.node(t),"local"===i[t]?(s&&(d[t]=s.changed),r.push(n.newConfig.all[t])):"remote"===i[t]?!o.deleted[t]&&o.newConfig.all.hasOwnProperty(t)&&(s&&(d[t]=s.changed),l[t]=!0,r.push(o.newConfig.all[t])):console.log("Unresolved",t));for(t in o.added)o.added.hasOwnProperty(t)&&((s=RED.nodes.node(t))&&(d[t]=s.changed),n.added.hasOwnProperty(t)||(l[t]=!0,r.push(o.newConfig.all[t])));return{config:r,nodeChangedStates:d,localChangedStates:l}}function v(e){var t=g(e),n=t.config,o=t.nodeChangedStates,a=t.localChangedStates,i={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:o,dirty:RED.nodes.dirty(),rev:RED.nodes.version()};RED.history.push(i),RED.nodes.clear(),RED.nodes.import(n)[0].forEach(function(e){(o[e.id]||a[e.id])&&(e.changed=!0)}),RED.nodes.version(e.remoteDiff.rev),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}function m(e,t){var n={title:"Compare Changes",width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(n){var o=n.find(".editor-tray-body"),a=$('<div class="node-text-diff"></div>').appendTo(o),i=$("<table>",{class:"node-text-diff-content"}).appendTo(a);$('<colgroup><col width="50"><col width="50%"><col width="50"><col width="50%"></colgroup>').appendTo(i);for(var s,r=$("<tbody>").appendTo(i),d=w(e||"",t||""),l=0,c=0,p=Math.max(d.a.length,d.b.length),u=[],f=[],h=0,g=0,v=0;v<p;v++){d[v];var m=l<d.a.length?d.a[l]:{type:2,line:""},D=c<d.b.length?d.b[c]:{type:2,line:""};0===m.type&&0!==D.type?(m={type:2,line:""},c++):0===D.type&&0!==m.type?(D={type:2,line:""},l++):(l++,c++),u.push({a:m,b:D}),void 0===s?(s={start:v,end:v},h=0,g=0===m.type&&0===D.type?0:1):0===m.type&&0===D.type?0===g?(s.end=v,h++):1===g?(s.end=v,g=2,h=0):2===g&&(s.end=v,8===++h&&(s.end-=5,f.push(s),s={start:v-5,end:v-5},g=0,h=0)):(s.end=v,h++,0===g?(s.end>3&&(s.end-=3,s.empty=!0,f.push(s),s={start:v-3,end:v-3}),g=1):2===g&&(g=1))}0===g&&(s.empty=!0),s.end=p,f.push(s);for(var E=0;E<f.length;E++)if((s=f[E]).empty)b(s.start,s.end,u).appendTo(r);else for(v=s.start;v<s.end;v++){var x=y(u[v]).appendTo(r);v===s.start?x.addClass("start-block"):v===s.end-1&&x.addClass("end-block")}},close:function(){T=!1},show:function(){}};RED.tray.show(n)}function b(e,t,n){diffRow=$('<tr class="node-text-diff-header node-text-diff-expand">');var o=$('<td colspan="4"> <i class="fa fa-arrows-v"></i> </td>').appendTo(diffRow),a=$("<span></span>").appendTo(o);return t<n.length-1&&a.text("@@ -"+(n[t-1].a.i+1)+" +"+(n[t-1].b.i+1)),diffRow.click(function(o){if(t-e>20){var i=$(this).offset();if(e>0){for(r=e;r<e+10;r++)y(n[r]).addClass("unchanged").insertBefore($(this));e+=10}if(t<n.length-1){for(r=t-1;r>t-11;r--)y(n[r]).addClass("unchanged").insertAfter($(this));t-=10}t<n.length-1&&a.text("@@ -"+(n[t-1].a.i+1)+" +"+(n[t-1].b.i+1));var s=$(this).offset().top-i.top;$(".node-text-diff").scrollTop($(".node-text-diff").scrollTop()+s)}else{for(var r=e;r<t;r++)y(n[r]).addClass("unchanged").insertBefore($(this));$(this).remove()}}),diffRow}function y(e){var t=$("<tr>"),n=e.a,o=e.b,a=$('<td class="lineno">').text(2===n.type?"":n.i).appendTo(t),i=$('<td class="linetext">').text(n.line).appendTo(t);return 2===n.type?(a.addClass("blank"),i.addClass("blank")):4===n.type?(a.addClass("added"),i.addClass("added")):1===n.type&&(a.addClass("removed"),i.addClass("removed")),a=$('<td class="lineno">').text(2===o.type?"":o.i).appendTo(t),i=$('<td class="linetext">').text(o.line).appendTo(t),2===o.type?(a.addClass("blank"),i.addClass("blank")):4===o.type?(a.addClass("added"),i.addClass("added")):1===o.type&&(a.addClass("removed"),i.addClass("removed")),t}function w(e,t,n){var o,a,i=e.split(/\r?\n/),s=t.split(/\r?\n/),r=i.length,d=s.length,l={a:[],b:[]},c=[];for(o=0;o<r+1;o++)for(c[o]=[],a=0;a<d+1;a++)c[o][a]=0;var p=0;for(o=r-1;o>=0;o--)for(a=d-1;a>=0;a--)p++,1!==D(i[o],s[a],n)?c[o][a]=c[o+1][a+1]+1:c[o][a]=Math.max(c[o+1][a],c[o][a+1]);for(o=0,a=0;o<r&&a<d;){var u=D(i[o],s[a],n);if(1!==u){var f=0;0===u?f=0:2==u&&(f=3),l.a.push({i:o+1,j:a+1,line:i[o],type:f}),l.b.push({i:a+1,j:o+1,line:s[a],type:f}),o++,a++}else c[o+1][a]>=c[o][a+1]?(l.a.push({i:o+1,line:i[o],type:1}),o++):(l.b.push({i:a+1,line:s[a],type:4}),a++)}for(;o<r||a<d;)o==r?(l.b.push({i:a+1,line:s[a],type:4}),a++):a==d&&(l.a.push({i:o+1,line:i[o],type:1}),o++);return l}function D(e,t,n){return n?e===t?0:e.trim()===t.trime()?2:1:e===t?0:1}function E(e,n){var o=$("<div></div>");return e.forEach(function(e){var a=e.hunks,i=e.binary,s=$("<table>",{class:"node-text-diff-content"}).appendTo(o);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(s);var r=$("<tbody>").appendTo(s),l=$('<tr class="node-text-diff-file-header">').appendTo(r),c=$('<td colspan="3"></td>').appendTo(l);$('<i class="node-diff-chevron fa fa-angle-down"></i>').appendTo(c);l.click(function(e){l.toggleClass("collapsed");var t=l.hasClass("collapsed");l.nextUntil(".node-text-diff-file-header").toggle(!t)});$('<span class="filename"></span>').text(e.file).appendTo(c);var p,h=0,g=0,v={};if(n.project.files&&n.project.files.flow===e.file){n.unmerged&&$('<span style="float: right;"><span id="node-diff-toolbar-resolved-conflicts"></span></span>').appendTo(c);var m=$('<tr class="node-text-diff-header">').appendTo(r),b=$('<td class="flow-diff" colspan="3"></td>').appendTo(m),y=n.project.name,w=n.project.files.flow,D="projects/"+y+"/files/"+n.commonRev+"/"+w,E="projects/"+y+"/files/"+n.oldRev+"/"+w,x="projects/"+y+"/files/"+n.newRev+"/"+w,R=[$.Deferred(),$.Deferred(),$.Deferred()];if(n.commonRev){D="projects/"+y+"/files/"+n.commonRev+"/"+w;$.ajax({dataType:"json",url:D}).then(function(e){R[0].resolve(e)}).fail(function(){R[0].resolve(null)})}else R[0].resolve(null);$.ajax({dataType:"json",url:E}).then(function(e){R[1].resolve(e)}).fail(function(){R[1].resolve({content:"[]"})}),$.ajax({dataType:"json",url:x}).then(function(e){R[2].resolve(e)}).fail(function(){R[2].resolve({content:"[]"})}),$.when.apply($,R).always(function(e,o,a){var i,s,r;if(e)try{i=JSON.parse(e.content||"[]")}catch(e){return console.log("Common Version doesn't contain valid JSON:",D),void console.log(e)}try{s=JSON.parse(o.content||"[]")}catch(e){return console.log("Old Version doesn't contain valid JSON:",E),void console.log(e)}i||(i=s);try{r=JSON.parse(a.content||"[]")}catch(e){return console.log("New Version doesn't contain valid JSON:",r),void console.log(e)}var l=u(i,s),c=u(i,r);n.currentDiff=f(l,c);var p=t(b,n.currentDiff,{title:w,mode:n.commonRev?"merge":"view",oldRevTitle:n.oldRevTitle,newRevTitle:n.newRevTitle});p.list.hide(),d(n.currentDiff),setTimeout(function(){p.finish(),p.list.show()},300)})}else if(i){var T=$('<tr class="node-text-diff-header">').appendTo(r),k=$('<td colspan="3"></td>').appendTo(T);$("<span></span>").text("Cannot show binary file contents").appendTo(k)}else n.unmerged&&(p=$('<span style="float: right;"><span>'+g+"</span> of <span>"+h+"</span> conflicts resolved</span>").appendTo(c)),a.forEach(function(t){var o=$('<tr class="node-text-diff-header">').appendTo(r),a=$('<td colspan="3"></td>').appendTo(o),i=($("<span></span>").text(t.header).appendTo(a),t.conflict),s=t.localStartLine,d=t.remoteStartLine;i&&h++,t.lines.forEach(function(o,a){var l,c=t.diffStart+a,u=i&&/^\+\+(<<<<<<<|=======$|>>>>>>>)/.test(o),f=$("<tr>").appendTo(r),m=$('<td class="lineno">').appendTo(f);u?m.attr("colspan",2):l=$('<td class="lineno">').appendTo(f);var b=$('<td class="linetext">').appendTo(f),y=1;if(i&&(y=2),u)if(f.addClass("mergeHeader"),/^\+\+=======$/.test(o))t.changeSeparator=c,f.addClass("mergeHeader-separator");else{var w=/^..<<<<<<</.test(o);w?($("<span>").text("<<<<<<< Local Changes").appendTo(b),t.localChangeStart=c):(t.remoteChangeEnd=c,$("<span>").text(">>>>>>> Remote Changes").appendTo(b)),f.addClass("mergeHeader-"+(w?"ours":"theirs")),$('<button class="editor-button editor-button-small" style="float: right; margin-right: 20px;"><i class="fa fa-angle-double-'+(w?"down":"up")+'"></i> use '+(w?"local":"remote")+" changes</button>").appendTo(b).click(function(o){o.preventDefault(),g++;var a,i;w?((i=(a=f.nextUntil(".mergeHeader-separator")).last().next()).nextUntil(".mergeHeader").remove(),i.next().remove()):((i=(a=f.prevUntil(".mergeHeader-separator")).last().prev()).prevUntil(".mergeHeader").remove(),i.prev().remove()),i.remove(),f.remove(),a.find(".linetext").addClass("added"),p.empty(),$("<span><span>"+g+"</span> of <span>"+h+"</span> conflicts resolved</span>").appendTo(p),v[e.file]=v[e.file]||{},v[e.file][t.localChangeStart]={changeStart:t.localChangeStart,separator:t.changeSeparator,changeEnd:t.remoteChangeEnd,selection:w?"A":"B"},n.resolveConflict&&n.resolveConflict({conflicts:h,resolved:g,resolutions:v})})}else{var D=o[0];i&&!n.unmerged&&" "===D&&(D=o[1]),$('<span class="prefix">').text(D).appendTo(b);var E=!1;i&&n.unmerged?($('<span class="prefix">').text(o[1]).appendTo(b),"+"===o[0]&&(m.text(s++),E=!0),"+"===o[1]&&(l.text(d++),E=!0)):"+"===o[0]||i&&"+"===o[1]?(m.addClass("added"),l.addClass("added"),b.addClass("added"),l.text(d++),E=!0):("-"===o[0]||i&&"-"===o[1])&&(m.addClass("removed"),l.addClass("removed"),b.addClass("removed"),m.text(s++),E=!0),E||(b.addClass("unchanged"),s>0&&"\\"!==o[0]&&""!==o&&m.text(s++),d>0&&"\\"!==o[0]&&""!==o&&l.text(d++)),$("<span>").text(o.substring(y)).appendTo(b)}})})}),o}function x(e){for(var t={},n=e.split("\n"),o=[],a=0;a<n.length;a++)if(/^commit /.test(n[a]))t.sha=n[a].substring(7);else if(/^Author: /.test(n[a])){t.author=n[a].substring(8);var i=/^(.*) <(.*)>$/.exec(t.author);i&&(t.authorName=i[1],t.authorEmail=i[2])}else if(/^Date: /.test(n[a]))t.date=n[a].substring(8);else if(/^    /.test(n[a]))t.title?(4!==n[a].length||o.length>0)&&o.push(n[a].substring(4)):t.title=n[a].substring(4);else if(/^diff /.test(n[a])){t.files=R(n.slice(a));break}return t.comment=o.join("\n"),t}function R(e){var t;t=Array.isArray(e)?e:e.split("\n");for(var n,o,a=/^diff (?:(?:--git a\/(.*) b\/(.*))|(?:--cc (.*)))$/,i=/^\+\+\+ b\/(.*)\t?/,s=/^Binary files /,r=/^@@ -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @@ ?(.*)$/,d=/^@+ -((\d+)(,(\d+))?) -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @+/,l=[],c=0;c<t.length;c++){var p=t[c],u=a.exec(p);if(u)o&&(n.hunks.push(o),l.push(n)),o=null,n={file:u[1]||u[3],hunks:[]};else if(s.test(p))n&&(n.binary=!0);else{var f=i.exec(p);if(f)n.file=f[1];else{var h=r.exec(p);if(h){o&&n.hunks.push(o),o={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,lines:[],conflict:!1};continue}if(h=d.exec(p)){o&&n.hunks.push(o),o={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,diffStart:parseInt(h[10]),lines:[],conflict:!0};continue}o&&o.lines.push(p)}}}return o&&n.hunks.push(o),l.push(n),l}var T=!1;return{init:function(){RED.actions.add("core:show-remote-diff",c)},getRemoteDiff:l,showRemoteDiff:c,showUnifiedDiff:function(e){var t,n=e.diff,o=e.title,a=R(n);e.unmerged&&(e.resolveConflict=function(e){t=e,e.conflicts===e.resolved&&$("#node-diff-view-resolve-diff").removeClass("disabled")});var i={title:o||"Compare Changes",width:1/0,overlay:!0,buttons:[{text:RED._(e.unmerged?"common.label.cancel":"common.label.close"),click:function(){e.oncancel&&e.oncancel(),RED.tray.close()}}],resize:function(e){},open:function(t){var n=t.find(".editor-tray-body"),o=$('<div class="node-text-diff"></div>').appendTo(n);E(a,e).appendTo(o)},close:function(){T=!1},show:function(){}};e.unmerged&&i.buttons.push({id:"node-diff-view-resolve-diff",text:"Save conflict resolution",class:"primary disabled",click:function(){if(!$("#node-diff-view-resolve-diff").hasClass("disabled")){if(e.currentDiff){var n=g(e.currentDiff);(t={resolutions:{}}).resolutions[e.project.files.flow]=JSON.stringify(n.config,"",4)}e.onresolve&&e.onresolve(t),RED.tray.close()}}}),RED.tray.show(i)},showCommitDiff:function(e){var t=x(e.commit),n={title:"View Commit Changes",width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(n){var o=n.find(".editor-tray-body"),a=$('<div class="node-text-diff"></div>').appendTo(o),i=$("<table>",{class:"node-text-diff-content"}).appendTo(a);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(i);var s=$("<tbody>").appendTo(i),r=$('<tr class="node-text-diff-commit-header">').appendTo(s),d=$('<td colspan="3"></td>').appendTo(r);$("<h3>").text(t.title).appendTo(d),$('<div class="commit-body"></div>').text(t.comment).appendTo(d);var l=$('<div class="commit-summary"></div>').appendTo(d);$('<div style="float: right">').text("Commit "+t.sha).appendTo(l),$("<div>").text((t.authorName||t.author)+" - "+e.date).appendTo(l),t.files&&E(t.files,e).appendTo(a)},close:function(){T=!1},show:function(){}};RED.tray.show(n)},mergeDiff:v}}(),RED.keyboard=function(){function e(){if("localStorage"in window&&null!==window.localStorage){var e=localStorage.getItem("keymap");if(null!==e){localStorage.removeItem("keymap");var t=RED.settings.get("editor")||{};t.keymap=JSON.parse(e),RED.settings.set("editor",t)}}}function t(e){for(var t,n=e.toLowerCase().split("-"),o={},a=0,i=0;i<n.length;i++)switch(n[i]){case"ctrl":case"cmd":o.ctrl=!0,o.meta=!0;break;case"alt":o.alt=!0;break;case"shift":o.shift=!0;break;case"":a++,t=f["-"];break;default:if(f.hasOwnProperty(n[i]))t=f[n[i]];else{if(n[i].length>1)return null;t=n[i].toUpperCase().charCodeAt(0)}}return[t,o]}function n(e){var t=c||u;(e.ctrlKey||e.metaKey)&&(t=t.ctrl),t&&e.shiftKey&&(t=t.shift),t&&e.altKey&&(t=t.alt);var o=m[e.keyCode]||e.keyCode;if(t&&t[o]){var a=t[o];if(!a.scope)return c?(c=null,n(e)):Object.keys(a).length>0?(c=a,e.preventDefault(),null):null;if(a.scope&&"*"!==a.scope){for(var i=e.target;"BODY"!==i.nodeName&&i.id!==a.scope;)i=i.parentElement;"BODY"===i.nodeName&&(a=null)}return c=null,a}if(c)return c=null,n(e)}function o(e,n,o,a){var i=o,s=a;"function"!=typeof o&&"string"!=typeof o||(i={},s=o);var r=[],d=0;if("string"==typeof n){"string"==typeof s&&(g[s]={scope:e,key:n},"boolean"==typeof a&&(g[s].user=a));var l=n.split(" ");for(d=0;d<l.length;d++){var c=t(l[d]);if(!c)return;r.push(c)}}else r.push([n,i]);var p=u;for(d=0;d<r.length;d++)n=r[d][0],(i=r[d][1]).ctrl&&(p.ctrl=p.ctrl||{},p=p.ctrl),i.shift&&(p.shift=p.shift||{},p=p.shift),i.alt&&(p.alt=p.alt||{},p=p.alt),p[n]=p[n]||{},p=p[n];p.scope=e,p.ondown=s}function a(e,n){var o=n||{},a=[],i=0;if("string"==typeof e){var s=e.split(" ");for(i=0;i<s.length;i++){var r=t(s[i]);if(!r)return void console.log("Unrecognised key specifier:",e);a.push(r)}}else a.push([e,o]);var d=u;for(i=0;i<a.length;i++){if(e=a[i][0],(o=a[i][1]).ctrl&&(d=d.ctrl),d&&o.shift&&(d=d.shift),d&&o.alt&&(d=d.alt),!d[e])return;d=d[e]}"string"==typeof d.ondown&&("boolean"==typeof n&&n?g[d.ondown]={user:n}:delete g[d.ondown]),delete d.scope,delete d.ondown}function s(e){e.preventDefault();var t=$(this),n=t.data("data");if(!t.hasClass("keyboard-shortcut-entry-expanded")){r();var o=t.find(".keyboard-shortcut-entry-key"),a=t.find(".keyboard-shortcut-entry-scope");t.addClass("keyboard-shortcut-entry-expanded");var i=$('<input type="text">').attr("placeholder",RED._("keyboard.unassigned")).val(n.key||"").appendTo(o);i.on("keyup",function(e){if(13===e.keyCode)return r();var t=$(this).val(),n=""===(t=t.trim())||RED.keyboard.validateKey(t);$(this).toggleClass("input-error",!n)});var s=$('<select><option value="*" data-i18n="keyboard.global"></option><option value="workspace" data-i18n="keyboard.workspace"></option></select>').appendTo(a);s.i18n(),s.val(n.scope||"*");var l=$('<div class="keyboard-shortcut-edit button-group-vertical"></div>').appendTo(a),c=$('<button class="editor-button editor-button-small"><i class="fa fa-check"></i></button>').appendTo(l),p=$('<button class="editor-button editor-button-small"><i class="fa fa-reply"></i></button>').appendTo(l);c.click(function(e){e.stopPropagation(),r()}),p.click(function(e){e.stopPropagation(),RED.keyboard.revertToDefault(n.id),t.empty(),t.removeClass("keyboard-shortcut-entry-expanded");var o=RED.keyboard.getShortcut(n.id),a=RED.settings.get("keymap")||{},i=RED.settings.get("editor")||{};(a=i.keymap||{})[n.id]=null,i.keymap=a,RED.settings.set("editor",i);var s={id:n.id,scope:o?o.scope:void 0,key:o?o.key:void 0,user:o?o.user:void 0};d(t,s)}),i.focus()}}function r(e){var t=$(".keyboard-shortcut-entry-expanded");if(1===t.length){var n=t.data("data"),o=t.find(".keyboard-shortcut-entry-key input"),a=t.find(".keyboard-shortcut-entry-scope select");if(!e){var i=o.val().trim(),s=a.val();if(""===i||RED.keyboard.validateKey(i)){var r=RED.keyboard.getShortcut(n.id);if(!r&&i||r&&(r.scope!==s||r.key!==i)){var d=t.find(".keyboard-shortcut-entry-key"),l=t.find(".keyboard-shortcut-entry-scope");d.empty(),l.empty(),n.key&&RED.keyboard.remove(n.key,!0),t.find(".keyboard-shortcut-entry-text i").css("opacity",1),""===i?(d.parent().addClass("keyboard-shortcut-entry-unassigned"),d.append($("<span>").text(RED._("keyboard.unassigned"))),delete n.key,delete n.scope):(d.parent().removeClass("keyboard-shortcut-entry-unassigned"),d.append(RED.keyboard.formatKey(i)),$("<span>").text(s).appendTo(l),n.key=i,n.scope=s,RED.keyboard.add(n.scope,n.key,n.id,!0));var c=RED.settings.get("editor")||{},p=c.keymap||{};p[n.id]=RED.keyboard.getShortcut(n.id),c.keymap=p,RED.settings.set("editor",c)}}}o.remove(),a.remove(),$(".keyboard-shortcut-edit").remove(),t.removeClass("keyboard-shortcut-entry-expanded")}}function d(e,t){var n=$('<div class="keyboard-shortcut-entry">').appendTo(e);e.data("data",t);var o=t.id.replace(/(^.+:([a-z]))|(-([a-z]))/g,function(){return 0===arguments[5]?arguments[2].toUpperCase():" "+arguments[4].toUpperCase()}),a=$("<div>").addClass("keyboard-shortcut-entry-text").text(o).appendTo(n),i=$('<i class="fa fa-user"></i>').prependTo(a);t.user||i.css("opacity",0);var r=$('<div class="keyboard-shortcut-entry-key">').appendTo(n);t.key?r.append(RED.keyboard.formatKey(t.key)):(n.addClass("keyboard-shortcut-entry-unassigned"),r.append($("<span>").text(RED._("keyboard.unassigned"))));var d=$('<div class="keyboard-shortcut-entry-scope">').appendTo(n);$("<span>").text("*"===t.scope?"global":t.scope||"").appendTo(d),e.click(s)}function l(){var e=$('<div id="user-settings-tab-keyboard"></div>');$('<div class="keyboard-shortcut-entry keyboard-shortcut-list-header"><div class="keyboard-shortcut-entry-key keyboard-shortcut-entry-text"><input id="user-settings-tab-keyboard-filter" type="text" data-i18n="[placeholder]keyboard.filterActions"></div><div class="keyboard-shortcut-entry-key" data-i18n="keyboard.shortcut"></div><div class="keyboard-shortcut-entry-scope" data-i18n="keyboard.scope"></div></div>').appendTo(e),e.find("input").searchBox({delay:100,change:function(){var e=$(this).val().trim();""===e?t.editableList("filter",null):(e=e.replace(/\s/g,""),t.editableList("filter",function(t){return t.id.toLowerCase().replace(/^.*:/,"").replace("-","").indexOf(e)>-1}))}});var t=$('<ol class="keyboard-shortcut-list"></ol>').css({position:"absolute",top:"32px",bottom:"0",left:"0",right:"0"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){d(e,n)}}),n=RED.actions.list();return n.sort(function(e,t){var n=e.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase(),o=t.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase();return n.localeCompare(o)}),n.forEach(function(e){t.editableList("addItem",e)}),e}var c,p=/Mac/i.test(window.navigator.platform),u={},f={left:37,up:38,right:39,down:40,escape:27,enter:13,backspace:8,delete:46,space:32,";":186,"=":187,",":188,"-":189,".":190,"/":191,"\\":220,"'":222,"?":191},h={16:!0,17:!0,18:!0,91:!0,93:!0},g={},v={},m={59:186,61:187,173:189};d3.select(window).on("keydown",function(){if(!h[d3.event.keyCode]){var e=n(d3.event);e&&e.ondown&&("string"==typeof e.ondown?RED.actions.invoke(e.ondown):e.ondown(),d3.event.preventDefault())}});return{init:function(){e();var t=(RED.settings.get("editor")||{}).keymap||{};$.getJSON("red/keymap.json",function(e){for(var n in e)if(e.hasOwnProperty(n)){var a=e[n];for(var i in a)a.hasOwnProperty(i)&&(t.hasOwnProperty(a[i])||o(n,i,a[i],!1),v[a[i]]={scope:n,key:i,user:!1})}for(var s in t)if(t.hasOwnProperty(s)){var r=t[s];r.hasOwnProperty("key")&&o(r.scope,r.key,s,!0)}}),RED.userSettings.add({id:"keyboard",title:RED._("keyboard.keyboard"),get:l,focus:function(){setTimeout(function(){$("#user-settings-tab-keyboard-filter").focus()},200)}})},add:o,remove:a,getShortcut:function(e){return g[e]},revertToDefault:function(e){var t=g[e];if(t&&a(t.key),v.hasOwnProperty(e)){var n=v[e];o(n.scope,n.key,e,!1)}},formatKey:function(e){var t=p?e.replace(/ctrl-?/,"&#8984;"):e;return t=p?t.replace(/alt-?/,"&#8997;"):e,t=t.replace(/shift-?/,"&#8679;"),t=t.replace(/left/,"&#x2190;"),t=t.replace(/up/,"&#x2191;"),t=t.replace(/right/,"&#x2192;"),'<span class="help-key-block"><span class="help-key">'+(t=t.replace(/down/,"&#x2193;")).split(" ").join('</span> <span class="help-key">')+"</span></span>"},validateKey:function(e){var n=(e=e.trim()).split(" ");for(i=0;i<n.length;i++)if(!t(n[i]))return!1;return!0}}}(),RED.workspaces=function(){function e(e,t){if(e)l.addTab(e),l.resize();else{var n=RED.nodes.id();do{p+=1}while(0!==$("#workspace-tabs a[title='"+RED._("workspace.defaultName",{number:p})+"']").size());e={type:"tab",id:n,disabled:!1,info:"",label:RED._("workspace.defaultName",{number:p})},RED.nodes.addWorkspace(e),l.addTab(e),l.activateTab(n),t||(RED.history.push({t:"add",workspaces:[e],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}return RED.view.focus(),e}function t(e){if(1!==u){r(e);var t=RED.nodes.removeWorkspace(e.id);t.t="delete",t.dirty=RED.nodes.dirty(),t.workspaces=[e],RED.history.push(t),RED.nodes.dirty(!0),RED.sidebar.config.refresh()}}function n(e){var n=RED.nodes.workspace(e);RED.view.state(RED.state.EDITING);var o,a={title:RED._("workspace.editFlow",{name:n.label}),buttons:[{id:"node-dialog-delete",class:"leftButton"+(1===u?" disabled":""),text:RED._("common.label.delete"),click:function(){t(n),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e=$("#node-input-name").val(),t=!1,a={};n.label!=e&&(a.label=n.label,t=!0,n.label=e,l.renameTab(n.id,e));var i=$("#node-input-disabled").prop("checked");n.disabled!==i&&(a.disabled=n.disabled,t=!0,n.disabled=i);var s=o.getValue();if(n.info!==s&&(a.info=n.info,t=!0,n.info=s),$("#red-ui-tab-"+n.id.replace(".","-")).toggleClass("workspace-disabled",n.disabled),t){var r={t:"edit",changes:a,node:n,dirty:RED.nodes.dirty()};n.changed=!0,RED.history.push(r),RED.nodes.dirty(!0),RED.sidebar.config.refresh();var d=RED.view.selection();d.nodes||d.links||RED.sidebar.info.refresh(n)}RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),n=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),a=0;a<t.size();a++)n-=$(t[a]).outerHeight(!0);n-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),n-=28,$(".node-text-editor").css("height",n+"px"),o.resize()},open:function(e){var t=e.find(".editor-tray-body"),a=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(t);$('<div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name"></div>').appendTo(a),$('<div class="form-row"><label for="node-input-disabled-btn" data-i18n="editor:workspace.status"></label><button id="node-input-disabled-btn" class="editor-button"><i class="fa fa-toggle-on"></i> <span id="node-input-disabled-label"></span></button> <input type="checkbox" id="node-input-disabled" style="display: none;"/></div>').appendTo(a),$('<div class="form-row node-text-editor-row"><label for="node-input-info" data-i18n="editor:workspace.info" style="width:300px;"></label><div style="height:250px;" class="node-text-editor" id="node-input-info"></div></div>').appendTo(a),o=RED.editor.createEditor({id:"node-input-info",mode:"ace/mode/markdown",value:""}),$('<div class="form-tips" data-i18n="editor:workspace.tip"></div>').appendTo(a),a.find("#node-input-disabled-btn").on("click",function(e){var t=$(this).find("i");t.hasClass("fa-toggle-off")?(t.addClass("fa-toggle-on"),t.removeClass("fa-toggle-off"),$("#node-input-disabled").prop("checked",!1),$("#node-input-disabled-label").text(RED._("editor:workspace.enabled"))):(t.addClass("fa-toggle-off"),t.removeClass("fa-toggle-on"),$("#node-input-disabled").prop("checked",!0),$("#node-input-disabled-label").text(RED._("editor:workspace.disabled")))}),n.hasOwnProperty("disabled")?($("#node-input-disabled").prop("checked",n.disabled),n.disabled?(a.find("#node-input-disabled-btn i").removeClass("fa-toggle-on").addClass("fa-toggle-off"),$("#node-input-disabled-label").text(RED._("editor:workspace.disabled"))):$("#node-input-disabled-label").text(RED._("editor:workspace.enabled"))):(n.disabled=!1,$("#node-input-disabled-label").text(RED._("editor:workspace.enabled"))),$('<input type="text" style="display: none;" />').prependTo(a),a.submit(function(e){e.preventDefault()}),$("#node-input-name").val(n.label),RED.text.bidi.prepareInput($("#node-input-name")),o.getSession().setValue(n.info||"",-1),a.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(n),o.destroy()}};RED.tray.show(a)}function o(){l=RED.tabs.create({id:"workspace-tabs",onchange:function(e){RED.comms.homegear().invoke("setNodeVariable",null,e.id,"enableEvents",!0);var t={old:c};c=e.id,t.workspace=c,RED.events.emit("workspace:change",t),window.location.hash="flow/"+e.id,RED.sidebar.config.refresh(),RED.view.focus()},onclick:function(e){RED.view.focus()},ondblclick:function(e){"subflow"!=e.type?n(e.id):RED.editor.editSubflow(RED.nodes.subflow(e.id))},onadd:function(e){"tab"===e.type&&u++,$('<span class="workspace-disabled-icon"><i class="fa fa-ban"></i> </span>').prependTo("#red-ui-tab-"+e.id.replace(".","-")+" .red-ui-tab-label"),e.disabled&&$("#red-ui-tab-"+e.id.replace(".","-")).addClass("workspace-disabled"),RED.menu.setDisabled("menu-item-workspace-delete",u<=1),1===u&&a()},onremove:function(e){"tab"===e.type&&u--,RED.menu.setDisabled("menu-item-workspace-delete",u<=1),0===u&&i()},onreorder:function(e,t){RED.history.push({t:"reorder",order:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),d(t)},minimumActiveTabWidth:150,scrollable:!0,addButton:function(){e()}}),u=0}function a(){$("#workspace .red-ui-tabs").show(),$("#chart").show(),$("#workspace-footer").children().show()}function i(){$("#workspace .red-ui-tabs").hide(),$("#chart").hide(),$("#workspace-footer").children().hide()}function s(e){n(e||c)}function r(e){e?l.contains(e.id)&&l.removeTab(e.id):t(RED.nodes.workspace(c)),e.id===c&&(c=0)}function d(e){RED.nodes.setWorkspaceOrder(e.filter(function(e){return void 0!==RED.nodes.workspace(e)})),l.order(e)}var l,c=0,p=0,u=0;return{init:function(){o(),RED.events.on("sidebar:resize",l.resize),RED.actions.add("core:show-next-tab",l.nextTab),RED.actions.add("core:show-previous-tab",l.previousTab),RED.menu.setAction("menu-item-workspace-delete",function(){t(RED.nodes.workspace(c))}),$(window).resize(function(){l.resize()}),RED.actions.add("core:add-flow",e),RED.actions.add("core:edit-flow",s),RED.actions.add("core:remove-flow",r),i()},add:e,remove:r,order:d,edit:s,contains:function(e){return l.contains(e)},count:function(){return u},active:function(){return c},show:function(t){if(!l.contains(t)){var n=RED.nodes.subflow(t);if(!n)return;e({type:"subflow",id:t,icon:"red/images/subflow_tab.png",label:n.name,closeable:!0})}l.activateTab(t)},refresh:function(){RED.nodes.eachWorkspace(function(e){l.renameTab(e.id,e.label)}),RED.nodes.eachSubflow(function(e){l.contains(e.id)&&l.renameTab(e.id,e.name)}),RED.sidebar.config.refresh()},resize:function(){l.resize()}}}(),RED.view=function(){function e(){for(var e=[],t=0;t<J;t+=+Q)e.push(t);Ce.selectAll("line.horizontal").remove(),Ce.selectAll("line.horizontal").data(e).enter().append("line").attr({class:"horizontal",x1:0,x2:J,y1:function(e){return e},y2:function(e){return e},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"}),Ce.selectAll("line.vertical").remove(),Ce.selectAll("line.vertical").data(e).enter().append("line").attr({class:"vertical",y1:0,y2:J,x1:function(e){return e},x2:function(e){return e},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"})}function t(e){for(var t=0;t<e.length;t++){var n=e[t];n.el=je.append("svg:path").attr("class","drag_line"),Se.push(n)}}function n(){for(;Se.length;){var e=Se.pop();e.el&&e.el.remove()}}function o(){var e=RED.workspaces.active();oe=RED.nodes.filterNodes({z:e}),ae=RED.nodes.filterLinks({source:{z:e},target:{z:e}})}function a(e,t,n){var o=/^subflow:(.+)$/.exec(e);if(ne&&o){if(o[1]===ne.id)return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}),"error");if(RED.nodes.subflowContains(o[1],ne.id))return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}),"error")}var a={id:RED.nodes.id(),z:RED.workspaces.active()};if(a.type=e,a._def=RED.nodes.getType(a.type),a.namespace=a._def.namespace?a._def.namespace:a.type,o){var i=RED.nodes.subflow(o[1]);a.name="",a.inputs=i.in.length,a.outputs=i.out.length}else{a.inputs=a._def.inputs||0,a.outputs=a._def.outputs;for(var s in a._def.defaults)a._def.defaults.hasOwnProperty(s)&&void 0!==a._def.defaults[s].value&&(a[s]=JSON.parse(JSON.stringify(a._def.defaults[s].value)));if(a._def.onadd)try{a._def.onadd.call(a)}catch(e){console.log("Definition error: "+a.type+".onadd:",e)}}a.changed=!0,a.moved=!0,a.w=F,a.h=Math.max(Math.max(W,20*(a.outputs||0)),20*(a.inputs||0));var r={t:"add",nodes:[a.id],dirty:RED.nodes.dirty()};if(ne){var d=RED.subflow.refresh(!0);d&&(r.subflow={id:ne.id,changed:ne.changed,instances:d.instances})}return{node:a,historyEvent:r}}function s(){var e,n;if(fe=d3.touches(this)[0]||d3.mouse(this),ve){var a,i,s=parseInt(ve.attr("ox")),r=parseInt(ve.attr("oy")),d=parseInt(ve.attr("x")),l=parseInt(ve.attr("y"));return a=fe[0]<s?s-(d=fe[0]):fe[0]-d,i=fe[1]<r?r-(l=fe[1]):fe[1]-l,void ve.attr("x",d).attr("y",l).attr("width",a).attr("height",i)}if(he==RED.state.QUICK_JOINING||he==RED.state.IMPORT_DRAGGING||de||null!=se){var c;if(he==RED.state.JOINING||he===RED.state.QUICK_JOINING){if(0===Se.length&&null!==le){if(d3.event.shiftKey){var p=[],u=[];if(se&&(le===Re&&se.source===de&&se.sourcePort===ce||le===xe&&se.target===de&&se.targetPort===ce))u=[se];else{var f;f=le===Re?{source:de,sourcePort:ce}:{target:de,targetPort:ce},u=RED.nodes.filterLinks(f)}for(e=0;e<u.length;e++){var h=u[e];RED.nodes.removeLink(h),p.push({link:h,node:le===Re?h.target:h.source,port:le===Re?h.targetPort:h.sourcePort,portType:le===Re?xe:Re})}0===p.length?(D(),P()):(t(p),he=0,o(),P(),he=RED.state.JOINING)}else de&&t([{node:de,port:ce,portType:le}]);se=null}for(c=fe,e=0;e<Se.length;e++){var g=Se[e],v=g.portType===Re?g.node.outputs||1:g.node.inputs||1,m=g.port;"subflow"==g.node.type&&(v=1,m=0);var b=-(v-1)/2*18+18*m,y=g.portType===Re?1:-1,w=c[1]-(g.node.y+b),$=c[0]-(g.node.x+y*g.node.w/2),E=Math.sqrt(w*w+$*$),x=G,R=0;E<F&&(x=.75-(F-E)/F*.75),$*y<0&&(x+=Math.min(5*F,Math.abs($))/(5*F)*2,Math.abs(w)<3*W&&(R=(w>0?.5:-.5)*((3*W-Math.abs(w))/(3*W))*(Math.min(F,Math.abs($))/F))),g.el.attr("d","M "+(g.node.x+y*g.node.w/2)+" "+(g.node.y+b)+" C "+(g.node.x+y*(g.node.w/2+F*x))+" "+(g.node.y+b+R*W)+" "+(c[0]-y*x*F)+" "+(c[1]-R*W)+" "+c[0]+" "+c[1])}d3.event.preventDefault()}else if(he==RED.state.MOVING)c=d3.mouse(document.body),isNaN(c[0])&&(c=d3.touches(document.body)[0]),(ue[0]-c[0])*(ue[0]-c[0])+(ue[1]-c[1])*(ue[1]-c[1])>3&&(he=RED.state.MOVING_ACTIVE,De=0,te=!1,1===ge.length&&(n=ge[0],te=n.n.hasOwnProperty("_def")&&n.n._def.inputs>0&&n.n._def.outputs>0&&0===RED.nodes.filterLinks({source:n.n}).length&&0===RED.nodes.filterLinks({target:n.n}).length));else if(he==RED.state.MOVING_ACTIVE||he==RED.state.IMPORT_DRAGGING){c=fe;for(var T=0,k=0,_=J,C=U,j=0;j<ge.length;j++)n=ge[j],d3.event.shiftKey&&(n.n.ox=n.n.x,n.n.oy=n.n.y),n.n.x=c[0]+n.dx,n.n.y=c[1]+n.dy,n.n.dirty=!0,T=Math.min(n.n.x-n.n.w/2-5,T),k=Math.min(n.n.y-n.n.h/2-5,k),_=Math.max(n.n.x+n.n.w/2+5,_),C=Math.max(n.n.y+n.n.h/2+5,C);if(0!==T||0!==k)for(e=0;e<ge.length;e++)(n=ge[e]).n.x-=T,n.n.y-=k;if(_!==J||C!==U)for(e=0;e<ge.length;e++)(n=ge[e]).n.x-=_-J,n.n.y-=C-U;if(ee!=d3.event.shiftKey&&ge.length>0){var S=[0,0];if(n=ge[0],S[0]=n.n.x-(Q*Math.floor((n.n.x-n.n.w/2)/Q)+n.n.w/2),S[1]=n.n.y-Q*Math.floor(n.n.y/Q),0!==S[0]||0!==S[1])for(e=0;e<ge.length;e++)(n=ge[e]).n.x-=S[0],n.n.y-=S[1],n.n.x==n.n.ox&&n.n.y==n.n.oy&&(n.dirty=!1)}he!=RED.state.MOVING_ACTIVE&&he!=RED.state.IMPORT_DRAGGING||1!==ge.length||(n=ge[0],te&&(B||(B=setTimeout(function(){var e=[],t=1/0,o=null,a=n.n.x,i=n.n.y;if(Te[0][0].getIntersectionList){var s=Te[0][0].createSVGRect();s.x=a,s.y=i,s.width=1,s.height=1,e=Te[0][0].getIntersectionList(s,Te[0][0])}else e=RED.view.getLinksAtPoint(a,i);for(var r=0;r<e.length;r++)if(d3.select(e[r]).classed("link_background"))for(var d=e[r].getTotalLength(),l=0;l<d;l+=10){var c=e[r].getPointAtLength(l),p=(c.x-a)*(c.x-a)+(c.y-i)*(c.y-i);p<200&&p<t&&(t=p,o=e[r])}M&&M!==o&&d3.select(M.parentNode).classed("link_splice",!1),o?d3.select(o.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),M=o,B=null},100))))}0!==he&&P()}}function r(){var e,t;if(he!==RED.state.QUICK_JOINING){if(de&&he==RED.state.JOINING){var a=[];for(e=0;e<Se.length;e++)Se[e].link&&a.push(Se[e].link);t={t:"delete",links:a,dirty:RED.nodes.dirty()},RED.history.push(t),n()}if(ve){var i=parseInt(ve.attr("x")),s=parseInt(ve.attr("y")),r=i+parseInt(ve.attr("width")),d=s+parseInt(ve.attr("height"));d3.event.ctrlKey||u(),RED.nodes.eachNode(function(e){e.z!=RED.workspaces.active()||e.selected||(e.selected=e.x>i&&e.x<r&&e.y>s&&e.y<d,e.selected&&(e.dirty=!0,ge.push({n:e})))}),ne&&(ne.in.forEach(function(e){e.selected=e.x>i&&e.x<r&&e.y>s&&e.y<d,e.selected&&(e.dirty=!0,ge.push({n:e}))}),ne.out.forEach(function(e){e.selected=e.x>i&&e.x<r&&e.y>s&&e.y<d,e.selected&&(e.dirty=!0,ge.push({n:e}))})),f(),ve.remove(),ve=null}else he!=RED.state.DEFAULT||null!=re||d3.event.ctrlKey||d3.event.metaKey||(u(),f());if(he==RED.state.MOVING_ACTIVE&&ge.length>0){for(var l=[],c=0;c<ge.length;c++){var p=ge[c];p.ox===p.n.x&&p.oy===p.n.y||(l.push({n:p.n,ox:p.ox,oy:p.oy,moved:p.n.moved}),p.n.dirty=!0,p.n.moved=!0)}if(l.length>0){if(t={t:"move",nodes:l,dirty:RED.nodes.dirty()},M){var h=d3.select(M).data()[0];RED.nodes.removeLink(h);var g={source:h.source,sourcePort:h.sourcePort,target:ge[0].n,targetPort:0},v={source:ge[0].n,sourcePort:0,target:h.target,targetPort:h.targetPort};RED.nodes.addLink(g),RED.nodes.addLink(v),t.links=[g,v],t.removedLinks=[h],o()}RED.nodes.dirty(!0),RED.history.push(t)}}if(he==RED.state.MOVING||he==RED.state.MOVING_ACTIVE)for(e=0;e<ge.length;e++)delete ge[e].ox,delete ge[e].oy;he==RED.state.IMPORT_DRAGGING&&(RED.keyboard.remove("escape"),o(),RED.nodes.dirty(!0)),D(),P()}}function d(){V<2&&(V+=.1,P())}function l(){V>.3&&(V-=.1,P())}function c(){V=1,P()}function p(){RED.nodes.eachNode(function(e){e.z==RED.workspaces.active()&&(e.selected||(e.selected=!0,e.dirty=!0,ge.push({n:e})))}),ne&&(ne.in.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,ge.push({n:e}))}),ne.out.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,ge.push({n:e}))})),se=null,f(),P()}function u(){for(var e=0;e<ge.length;e++){var t=ge[e];t.n.dirty=!0,t.n.selected=!1}ge=[],se=null}function f(){var e={};ge.length>0&&(e.nodes=ge.map(function(e){return e.n})),null!=se&&(e.link=se);var t=RED.workspaces.active();ae=RED.nodes.filterLinks({source:{z:t},target:{z:t}});RED.nodes.getWorkspaceOrder();var n={};ie=[];for(var o=0;o<ge.length;o++)if("link-out"===ge[o].n.type||"link-in"===ge[o].n.type){var a=ge[o].n,i={};a.links.forEach(function(e){var t=RED.nodes.node(e);t&&("link-out"===a.type?t.z===a.z?n[a.id+":"+t.id]||(ae.push({source:a,sourcePort:0,target:t,link:!0}),n[a.id+":"+t.id]=!0):(i[t.z]=i[t.z]||[],i[t.z].push(t)):t.z===a.z?n[t.id+":"+a.id]||(ae.push({source:t,sourcePort:0,target:a,link:!0}),n[t.id+":"+a.id]=!0):(i[t.z]=i[t.z]||[],i[t.z].push(t)))}),Object.keys(i).length>0&&ie.push({refresh:Math.floor(1e4*Math.random()),node:a,links:i})}var s=t+":"+JSON.stringify(e,function(e,t){return"nodes"===e?t.map(function(e){return e.id}):"link"===e?t.source.id+":"+t.sourcePort+":"+t.target.id:t});s!==Oe&&(Oe=s,RED.events.emit("view:selection-changed",e))}function h(){if(Pe=!1,ge.length>0){for(var e=[],t=0;t<ge.length;t++)e.push({n:ge[t].n,ox:ge[t].ox,oy:ge[t].oy,moved:ge[t].n.moved}),ge[t].n.moved=!0,ge[t].n.dirty=!0,delete ge[t].ox,delete ge[t].oy;P(),RED.history.push({t:"move",nodes:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)}}function g(e,t){if(ge.length>0){Pe||($(document).one("keyup",h),Pe=!0);for(var n,o=0,a=0,i=0;i<ge.length;i++)(n=ge[i]).n.moved=!0,n.n.dirty=!0,null==n.ox&&null==n.oy&&(n.ox=n.n.x,n.oy=n.n.y),n.n.x+=e,n.n.y+=t,n.n.dirty=!0,o=Math.min(n.n.x-n.n.w/2-5,o),a=Math.min(n.n.y-n.n.h/2-5,a);if(0!==o||0!==a)for(var s=0;s<ge.length;s++)(n=ge[s]).n.x-=o,n.n.y-=a;P()}}function v(){if(ge.length>0){var e=ge[0].n;"subflow"===e.type?RED.editor.editSubflow(ne):RED.editor.edit(e)}}function m(){if(ge.length>0||null!=se){var e,t=[],n=[],a=[],i=[],s=[],r=RED.nodes.dirty();if(ge.length>0){for(var d=0;d<ge.length;d++){var l=ge[d].n;if(l.selected=!1,"subflow"!=l.type){l.x<0&&(l.x=25);var c=RED.nodes.remove(l.id);t.push(l),t=t.concat(c.nodes),n=n.concat(c.links)}else"out"===l.direction?a.push(l):"in"===l.direction&&i.push(l),l.dirty=!0}a.length>0&&(e=RED.subflow.removeOutput(a))&&(n=n.concat(e.links)),1==i.length&&(e=RED.subflow.removeInput())&&(n=n.concat(e.links));var p=RED.subflow.refresh(!0);p&&(s=p.instances),ge=[],(t.length>0||a.length>0||i.length>0)&&RED.nodes.dirty(!0)}se&&(RED.nodes.removeLink(se),n.push(se),RED.nodes.dirty(!0));var u={t:"delete",nodes:t,links:n,subflowOutputs:a,subflowInputs:i,subflow:{instances:s},dirty:r};RED.history.push(u),se=null,o(),f(),P()}}function b(){if(ge.length>0){for(var e=[],t=0;t<ge.length;t++){var n=ge[t].n;if("subflow"!=n.type){for(var o in n._def.defaults)if(n._def.defaults.hasOwnProperty(o)&&n._def.defaults[o].type){var a=RED.nodes.node(n[o]);a&&a._def.exclusive&&e.push(RED.nodes.convertNode(a))}e.push(RED.nodes.convertNode(n))}}$e=JSON.stringify(e),RED.notify(RED._("clipboard.nodeCopied",{count:e.length}))}}function y(e,t,n){return w(e,t,n,0)[0]}function w(e,t,n,o){var a=document.createElement("span");a.className=t,a.style.position="absolute",a.style.top="-1000px",a.textContent=e||"",document.body.appendChild(a);var i=a.offsetWidth,s=a.offsetHeight;return document.body.removeChild(a),[n+i,o+s]}function D(){de=null,pe=null,re=null,he=0,le=null,M=null,te=!1,d3.select(".link_splice").classed("link_splice",!1),B&&(clearTimeout(B),B=null)}function E(e){17!==e.keyCode&&"Meta"!==e.key&&91!==e.keyCode||(D(),n(),P(),$(window).off("keyup",E))}function x(e,n,o){de=e,le=n,ce=o||0,he!==RED.state.QUICK_JOINING&&(he=RED.state.JOINING,document.body.style.cursor="crosshair",(d3.event.ctrlKey||d3.event.metaKey)&&(he=RED.state.QUICK_JOINING,t([{node:de,port:ce,portType:le}]),$(window).on("keyup",E))),d3.event.stopPropagation(),d3.event.preventDefault()}function R(e,a,i){var s;if(!(he===RED.state.QUICK_JOINING&&Se.length>0&&Se[0].node===e)&&(document.body.style.cursor="",he==RED.state.JOINING||he==RED.state.QUICK_JOINING)){"undefined"!=typeof TouchEvent&&d3.event instanceof TouchEvent?RED.nodes.eachNode(function(e){if(e.z==RED.workspaces.active()){var t=e.w/2,n=e.h/2;e.x-t<fe[0]&&e.x+t>fe[0]&&e.y-n<fe[1]&&e.y+n>fe[1]&&(a=(pe=e).inputs>0?xe:Re,i=0)}}):pe=e;var r=[],d=[];for(s=0;s<Se.length;s++)Se[s].link&&d.push(Se[s].link);for(s=0;s<Se.length;s++)if(a!=Se[s].portType&&pe!==Se[s].node){var l,c,p,u=Se[s];if(u.portType===Re?(l=u.node,p=u.port,c=pe,dst_port=i):u.portType==xe&&(l=pe,p=i,c=u.node,dst_port=u.port),!(0!==RED.nodes.filterLinks({source:l,target:c,sourcePort:p,targetPort:dst_port}).length)){var f={source:l,sourcePort:p,target:c,targetPort:dst_port};RED.nodes.addLink(f),r.push(f)}}if(r.length>0||d.length>0){var h={t:"add",links:r,removedLinks:d,dirty:RED.nodes.dirty()};if(ne){var g=RED.subflow.refresh(!0);g&&(h.subflow={id:ne.id,changed:ne.changed,instances:g.instances})}RED.history.push(h),o(),RED.nodes.dirty(!0)}if(he===RED.state.QUICK_JOINING)return r.length>0&&(n(),a===xe&&e.outputs>0?t([{node:e,port:0,portType:Re}]):a===Re&&e.inputs>0?t([{node:e,port:0,portType:xe}]):D()),void P();D(),n(),se=null,P()}}function T(e,t,n,o){var a=he!=RED.state.JOINING||Se.length>0&&Se[0].portType!==n;e.classed("port_hovered",a)}function k(e,t,n,o){e.classed("port_hovered",!1)}function _(e){if(ye&&de==e&&De>0&&De<750)return he=RED.state.DEFAULT,"subflow"!=e.type?RED.editor.edit(e):RED.editor.editSubflow(ne),De=0,void d3.event.stopPropagation();e._def?e.inputs:e.direction}function C(e){if(L(),he==RED.state.IMPORT_DRAGGING){if(RED.keyboard.remove("escape"),M){var t=d3.select(M).data()[0];RED.nodes.removeLink(t);var n={source:t.source,sourcePort:t.sourcePort,target:ge[0].n,targetPort:0},a={source:ge[0].n,sourcePort:0,target:t.target,targetPort:0};RED.nodes.addLink(n),RED.nodes.addLink(a);var i=RED.history.peek();i.links=[n,a],i.removedLinks=[t],o()}return f(),RED.nodes.dirty(!0),P(),D(),void d3.event.stopPropagation()}if(he!=RED.state.QUICK_JOINING){de=e;var s=Date.now();De=s-we,we=s,ye=be==de,be=de;var r;if(e.selected&&(d3.event.ctrlKey||d3.event.metaKey)){for(de.selected=!1,r=0;r<ge.length;r+=1)if(ge[r].n===de){ge.splice(r,1);break}}else{if(d3.event.shiftKey){u();for(var d=RED.nodes.getAllFlowNodes(de),l=0;l<d.length;l++)d[l].selected=!0,d[l].dirty=!0,ge.push({n:d[l]})}else e.selected||(d3.event.ctrlKey||d3.event.metaKey||u(),de.selected=!0,ge.push({n:de}));if(se=null,2!=d3.event.button){he=RED.state.MOVING;var c=d3.touches(this)[0]||d3.mouse(this);for(c[0]+=e.x-e.w/2,c[1]+=e.y-e.h/2,r=0;r<ge.length;r++)ge[r].ox=ge[r].n.x,ge[r].oy=ge[r].n.y,ge[r].dx=ge[r].n.x-c[0],ge[r].dy=ge[r].n.y-c[1];ue=d3.mouse(document.body),isNaN(ue[0])&&(ue=d3.touches(document.body)[0])}}e.dirty=!0,f(),P(),d3.event.stopPropagation()}else d3.event.stopPropagation()}function j(e){var t=!0;return e._def.button.hasOwnProperty("enabled")&&(t="function"==typeof e._def.button.enabled?e._def.button.enabled.call(e):e._def.button.enabled),t}function S(e){if(ne)RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning");else{if(e._def.button.toggle&&(e[e._def.button.toggle]=!e[e._def.button.toggle],e.dirty=!0),e._def.button.onclick)try{e._def.button.onclick.call(e)}catch(t){console.log("Definition error: "+e.type+".onclick",t)}e.dirty&&P()}d3.event.preventDefault()}function O(e,t){var n=de,o=[];o.push({name:"delete",disabled:0===ge.length&&null===se,onselect:function(){m()}}),o.push({name:"cut",disabled:0===ge.length,onselect:function(){b(),m()}}),o.push({name:"copy",disabled:0===ge.length,onselect:function(){b()}}),o.push({name:"paste",disabled:0===$e.length,onselect:function(){I($e,!1,!0)}}),o.push({name:"edit",disabled:1!=ge.length,onselect:function(){RED.editor.edit(n)}}),o.push({name:"select",onselect:function(){p()}}),o.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),RED.touch.radialMenu.show(e,t,o),D()}function P(){if(ke.attr("transform","scale("+V+")"),Te.attr("width",J*V).attr("height",U*V),he!=RED.state.JOINING){var e={};if(ne){var t=ke.selectAll(".subflowoutput").data(ne.out,function(e,t){return e.id});t.exit().remove();var n=t.enter().insert("svg:g").attr("class","node subflowoutput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});n.each(function(e,t){e.w=40,e.h=40}),n.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",_).on("mousedown",C).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];K=[n.pageX,n.pageY],H=0,X=setTimeout(function(){O(t,o)},q),C.call(this,e)}).on("touchend",function(e){clearTimeout(X),X=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():_.call(this,e)}),n.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){x(e,xe,t)}).on("touchstart",function(e,t){x(e,xe,t)}).on("mouseup",function(e,t){R(e,xe,t)}).on("touchend",function(e,t){R(e,xe,t)}).on("mouseover",function(e){T(d3.select(this),e,xe,i)}).on("mouseout",function(e){k(d3.select(this),e,xe,i)}),n.append("svg:text").attr("class","port_label").attr("x",20).attr("y",8).style("font-size","10px").text("output"),n.append("svg:text").attr("class","port_label port_index").attr("x",20).attr("y",24).text(function(e,t){return t+1});var o=ke.selectAll(".subflowinput").data(ne.in,function(e,t){return e.id});o.exit().remove();var a=o.enter().insert("svg:g").attr("class","node subflowinput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});a.each(function(e,t){e.w=40,e.h=40}),a.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",_).on("mousedown",C).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];K=[n.pageX,n.pageY],H=0,X=setTimeout(function(){O(t,o)},q),C.call(this,e)}).on("touchend",function(e){clearTimeout(X),X=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():_.call(this,e)}),a.append("g").attr("transform","translate(35,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){x(e,Re,t)}).on("touchstart",function(e,t){x(e,Re,t)}).on("mouseup",function(e,t){R(e,Re,t)}).on("touchend",function(e,t){R(e,Re,t)}).on("mouseover",function(e){T(d3.select(this),e,Re,i)}).on("mouseout",function(e){k(d3.select(this),e,Re,i)}),a.append("svg:text").attr("class","port_label").attr("x",20).attr("y",8).style("font-size","10px").text("input"),a.append("svg:text").attr("class","port_label port_index").attr("x",20).attr("y",24).text(function(e,t){return t+1}),t.each(function(t,n){if(t.dirty){var o=d3.select(this);o.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),o.selectAll(".subflowport").classed("node_working",function(e){return e.working}),o.selectAll(".port_index").text(function(e){return e.i+1}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),e[t.id]=t,t.dirty=!1}}),o.each(function(t,n){if(t.dirty){var o=d3.select(this);o.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),o.selectAll(".subflowport").classed("node_working",function(e){return e.working}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),e[t.id]=t,t.dirty=!1}})}else ke.selectAll(".subflowoutput").remove(),ke.selectAll(".subflowinput").remove();var s=ke.selectAll(".nodegroup").data(oe,function(e){return e.id});s.exit().remove(),s.enter().insert("svg:g").attr("class","node nodegroup").classed("node_subflow",function(e){return null!=ne}).classed("node_link",function(e){return"link-in"===e.type||"link-out"===e.type}).each(function(e,t){var n=d3.select(this),o="link-in"===e.type||"link-out"===e.type;n.attr("id",e.id);var a=RED.utils.getNodeLabel(e);if(e.w=o?W:Math.max(F,20*Math.ceil((y(a,"node_label",50)+(e._def.inputs>0?7:0))/20)),e.h=Math.max(Math.max(W,20*(e.outputs||0)),20*(e.inputs||0)),e._def.badge){var i=n.append("svg:g").attr("class","node_badge_group"),s=i.append("rect").attr("class","node_badge").attr("rx",5).attr("ry",5).attr("width",40).attr("height",15);i.append("svg:text").attr("class","node_badge_label").attr("x",35).attr("y",11).attr("text-anchor","end").text(e._def.badge()),e._def.onbadgeclick&&s.attr("cursor","pointer").on("click",function(e){e._def.onbadgeclick.call(e),d3.event.preventDefault()})}if(e._def.button){var r=n.append("svg:g").attr("transform",function(e){return"translate("+("right"==e._def.align?94:-25)+",2)"}).attr("class",function(e){return"node_button "+("right"==e._def.align?"node_right_button":"node_left_button")});r.append("rect").attr("rx",5).attr("ry",5).attr("width",32).attr("height",W-4).attr("fill","#eee"),r.append("rect").attr("class","node_button_button").attr("x",function(e){return"right"==e._def.align?11:5}).attr("y",4).attr("rx",4).attr("ry",4).attr("width",16).attr("height",W-12).attr("fill",function(e){return e._def.color}).attr("cursor","pointer").on("mousedown",function(e){!ve&&j(e)&&(L(),d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseup",function(e){!ve&&j(e)&&(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseover",function(e){!ve&&j(e)&&d3.select(this).attr("fill-opacity",.4)}).on("mouseout",function(e){if(!ve&&j(e)){var t=1;e._def.button.toggle&&(t=e[e._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",t)}}).on("click",S).on("touchstart",S)}n.append("rect").attr("class","node").classed("node_unknown",function(e){return"unknown"==e.type}).attr("rx",5).attr("ry",5).attr("fill",function(e){return e._def.color}).on("mouseup",_).on("mousedown",C).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];K=[n.pageX,n.pageY],H=0,X=setTimeout(function(){O(t,o)},q),C.call(this,e)}).on("touchend",function(e){clearTimeout(X),X=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():_.call(this,e)}).on("mouseover",function(e){0===he&&d3.select(this).classed("node_hovered",!0)}).on("mouseout",function(e){d3.select(this).classed("node_hovered",!1)});if(e._def.icon){var d=RED.utils.getNodeIcon(e._def,e),l=n.append("g").attr("class","node_icon_group").attr("x",0).attr("y",0),c=(l.append("rect").attr("x",0).attr("y",0).attr("class","node_icon_shade").attr("width","30").attr("stroke","none").attr("fill","#000").attr("fill-opacity","0.05").attr("height",function(e){return Math.min(50,e.h-4)}),l.append("image").attr("xlink:href",d).attr("class","node_icon").attr("x",0).attr("width","30").attr("height","30")),p=l.append("path").attr("d",function(e){return"M 30 1 l 0 "+(e.h-2)}).attr("class","node_icon_shade_border").attr("stroke-opacity","0.1").attr("stroke","#000").attr("stroke-width","1");"right"==e._def.align&&(l.attr("class","node_icon_group node_icon_group_"+e._def.align),p.attr("d",function(e){return"M 0 1 l 0 "+(e.h-2)}));var u=new Image;u.src=d,u.onload=function(){c.attr("width",Math.min(u.width,30)),c.attr("height",Math.min(u.height,30)),c.attr("x",15-Math.min(u.width,30)/2)},l.style("pointer-events","none")}if(!o){var f=n.append("svg:text").attr("class","node_label").attr("x",38).attr("dy",".40em").attr("text-anchor","start");e._def.align&&(f.attr("class","node_label node_label_"+e._def.align),"right"===e._def.align&&f.attr("text-anchor","end"));n.append("svg:text").attr("class","node_status_label_top").attr("x",7).attr("y",-3);var h=n.append("svg:g").attr("class","node_status_group_bottom").style("display","none");h.append("rect").attr("class","node_status_bottom").attr("x",6).attr("y",1).attr("width",9).attr("height",9).attr("rx",2).attr("ry",2).attr("stroke-width","3"),h.append("svg:text").attr("class","node_status_label_bottom").attr("x",20).attr("y",9)}n.append("image").attr("class","node_fixed_input hidden").attr("xlink:href","icons/node-red/node-fixed-input.svg").attr("x",0).attr("y",-6).attr("width",10).attr("height",10),n.append("image").attr("class","node_error hidden").attr("xlink:href","icons/node-red/node-error.svg").attr("x",12).attr("y",-6).attr("width",10).attr("height",10),n.append("image").attr("class","node_changed hidden").attr("xlink:href","icons/node-red/node-changed.svg").attr("x",24).attr("y",-6).attr("width",10).attr("height",10)}),s.each(function(t,n){if(t.dirty){var o="link-in"===t.type||"link-out"===t.type;if(e[t.id]=t,!o&&t.resize){var a=RED.utils.getNodeLabel(t),i=t.w;t.w=Math.max(F,Q*Math.ceil((y(a,"node_label",50)+(t._def.inputs>0?7:0))/Q)),t.h=Math.max(Math.max(W,20*(t.outputs||0)),20*(t.inputs||0)),t.x+=(t.w-i)/2,t.resize=!1}var s=d3.select(this);if(s.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),he!=RED.state.MOVING_ACTIVE){t.hasOwnProperty("fixedInputs")||(t.fixedInputs=0),s.selectAll(".node").attr("width",function(e){return e.w}).attr("height",function(e){return e.h}).classed("node_selected",function(e){return e.selected}).classed("node_working",function(e){return e.working}).classed("node_highlighted",function(e){return e.highlighted}),s.selectAll(".node_icon_group_right").attr("transform",function(e){return"translate("+(e.w-30)+",0)"}),s.selectAll(".node_label_right").attr("x",function(e){return e.w-38});var r=t.inputs,d=t.h/2-(r-1)/2*18;t.inputPorts=t.inputPorts||d3.range(r),t._inputPorts=s.selectAll(".port_input").data(t.inputPorts);var l=t._inputPorts.enter().append("g").attr("class","port_input");if(l.append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(){var e=t;return function(t,n){x(e,xe,n)}}()).on("touchstart",function(){var e=t;return function(t,n){x(e,xe,n)}}()).on("mouseup",function(){var e=t;return function(t,n){R(e,xe,n)}}()).on("touchend",function(){var e=t;return function(t,n){R(e,xe,n)}}()).on("mouseover",function(){var e=t;return function(t,n){T(d3.select(this),e,xe,n)}}()).on("mouseout",function(){var e=t;return function(t,n){k(d3.select(this),e,xe,n)}}()),l.each(function(e){var n="",o="",a="";if(t._def&&t._def.inputInfo&&e<t._def.inputInfo.length){var i=t._def.inputInfo[e],s=i18n.t(t.namespace+"/"+t.type+".hni:"+t.type+".input"+(e+1)+"Description");if(i.types){n=i.label?"<p><b>"+i.label+"</b></p>":"",o="<p><b>Types:</b> <i>";for(var r=0;r<i.types.length;r++)0!=r&&(o+=", "),o+=i.types[r];o+="</i></p>",a=s}}var d=t.id,l="inputValue"+e,c="inputHistory"+e,p="fixedInput"+e;dynamicContent=function(){return RED.comms.homegear().invoke("getNodeVariable",function(e){setTimeout(function(){$(".red-ui-popover .last_value").text(JSON.stringify(e.result))},100)},d,l),$('<div style="float: right"><a class="popover-dialog1" href="#">History</a>&nbsp;&nbsp;<a class="popover-dialog2" href="#">Set</a></div>'+n+o+'<p><b>Last value:</b> <span class="last_value">-</span></p><div style="clear: both">'+a+"</div>")};openDialog1=function(){$('<div id="popover-dialog" class="hide node-red-dialog"><div class="history-values"></div></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,height:450,resizable:!1,buttons:[{id:"popover-dialog-close",class:"primary",text:RED._("common.label.close"),click:function(){$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide(),RED.comms.homegear().invoke("getNodeVariable",function(e){if(e.result){var t="";$.each(e.result,function(e,n){var o=new Date(n[0]);t+='<p><span class="value-history-date">'+o.toLocaleDateString(void 0,{year:"numeric",day:"2-digit",month:"2-digit"})+" "+o.toLocaleTimeString(void 0,{hour12:!1})+"."+("000"+n[0]%1e3).slice(-3)+": </span><span>"+n[1]+"</span></p>"}),$("#popover-dialog .history-values").html(t)}},d,c);var t=setInterval(function(){RED.comms.homegear().invoke("getNodeVariable",function(e){if(e.result){var t="";$.each(e.result,function(e,n){var o=new Date(n[0]);t+='<p><span class="value-history-date">'+o.toLocaleDateString(void 0,{year:"numeric",day:"2-digit",month:"2-digit"})+" "+o.toLocaleTimeString(void 0,{hour12:!1})+"."+("000"+n[0]%1e3).slice(-3)+": </span><span>"+n[1]+"</span></p>"}),$("#popover-dialog .history-values").html(t)}},d,c)},1e3);$(this).dialog("option","interval",t)},close:function(e){var t=$(this).dialog("option","interval");t&&clearInterval(t),$(this).remove()}}).dialog("option","title","History").dialog("open")},openDialog2=function(){$('<div id="popover-dialog" class="hide node-red-dialog"><div class="fixed-input"><p>You can set the input to a fixed value here. The fixed input is reset upon restart of Homegear.</p><form><input type="text" id="fixed-input-payload" style="width:100%"/><input type="hidden" id="fixed-input-payloadType"/></form></div></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:400,resizable:!1,buttons:[{id:"popover-dialog-cancel",class:"primary",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"popover-dialog-clear",class:"primary",text:RED._("common.label.clear"),click:function(){RED.comms.homegear().invoke("setNodeVariable",null,d,p,!1),t.fixedInputs>0&&(t.fixedInputs-=1),t.dirty=!0,$(this).dialog("close"),P()}},{id:"popover-dialog-set",class:"primary",text:RED._("common.label.set"),click:function(){var e=$("#fixed-input-payload");RED.comms.homegear().invoke("setNodeVariable",null,d,p,[e.typedInput("type"),e.typedInput("value")]),$("#fixed-input-payload").data("oldPayload")||(t.fixedInputs+=1),t.dirty=!0,$(this).dialog("close"),P()}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide(),RED.comms.homegear().invoke("getNodeVariable",function(e){var t=e.result?e.result[0]:"int",n=e.result?e.result[1]:"";oldPayload=!!e.result,$("#fixed-input-payloadType").val(t),$("#fixed-input-payload").typedInput({default:"int",typeField:$("#fixed-input-payloadType"),types:["bool","int","float","string","arraySimple","structSimple","binSimple"]}),$("#fixed-input-payload").typedInput("type",t),$("#fixed-input-payload").typedInput("value",n),$("#fixed-input-payload").data("oldPayload",oldPayload)},d,p)},close:function(e){$(this).remove()}}).dialog("option","title","Set fixed input").dialog("open")};var u=RED.popover.create({target:$(this),trigger:"hover",width:"250px",content:dynamicContent,direction:"left",offsetX:-13,offsetY:4,delay:{show:750,hide:300},dialog1:openDialog1,dialog2:openDialog2,intervalCallback:function(){RED.comms.homegear().invoke("getNodeVariable",function(e){$(".red-ui-popover .last_value").text(JSON.stringify(e.result))},d,l)}});$(this).data("popover",u)}),t._inputPorts.exit().remove(),t._inputPorts){r=t.inputs||1,d=t.h/2-(r-1)/2*18;c=-5;t._inputPorts.each(function(e,t){d3.select(this).attr("transform",function(e){return"translate("+c+","+(d+18*t-5)+")"})})}if(r=t.inputs,d=t.h/2-(r-1)/2*18,t.inputPortLabels&&t.inputPortLabels.length!=r&&(t.inputPortLabels=null),t.inputPortLabels=t.inputPortLabels||d3.range(r),t._inputPortLabels=s.selectAll(".port_input_label").data(t.inputPortLabels),t._inputPortLabels.enter().append("g").attr("class","port_input_label").append("svg:text").attr("class","input_label").attr("rx",0).attr("ry",0).attr("width",50).attr("height",10),t._inputPortLabels.exit().remove(),t._inputPortLabels){r=t.inputs||1,d=t.h/2-(r-1)/2*18;var c=-5,p=t;t._inputPortLabels.each(function(e,t){var n=d3.select(this);n.attr("transform",function(e){return"translate("+c+","+(d+18*t-5)+")"}),p._def&&p._def.inputInfo&&t<p._def.inputInfo.length&&p._def.inputInfo[t].label?n.selectAll(".input_label").text(p._def.inputInfo[t].label):r>1?n.selectAll(".input_label").text(t):n.selectAll(".input_label").text("")})}var u=t.outputs;d=t.h/2-(u-1)/2*18,t.outputPorts=t.outputPorts||d3.range(u),t._outputPorts=s.selectAll(".port_output").data(t.outputPorts);var f=t._outputPorts.enter().append("g").attr("class","port_output");if(f.append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(){var e=t;return function(t,n){x(e,Re,n)}}()).on("touchstart",function(){var e=t;return function(t,n){x(e,Re,n)}}()).on("mouseup",function(){var e=t;return function(t,n){R(e,Re,n)}}()).on("touchend",function(){var e=t;return function(t,n){R(e,Re,n)}}()).on("mouseover",function(){var e=t;return function(t,n){T(d3.select(this),e,Re,n)}}()).on("mouseout",function(){var e=t;return function(t,n){k(d3.select(this),e,Re,n)}}()),f.each(function(e){if(t._def&&t._def.outputInfo&&e<t._def.outputInfo.length){var n=t._def.outputInfo[e],o=i18n.t(t.namespace+"/"+t.type+".hni:"+t.type+".output"+(e+1)+"Description");if(n.types){var a=n.label?"<p><b>"+n.label+"</b></p>":"";a+="<p><i>";for(var e=0;e<n.types.length;e++)0!=e&&(a+=", "),a+=n.types[e];a+="</i></p>"+o;var i=RED.popover.create({target:$(this),trigger:"hover",width:"250px",content:a,offsetX:10,offsetY:4,delay:{show:750,hide:50}});$(this).data("popover",i)}}}),t._outputPorts.exit().remove(),t._outputPorts){u=t.outputs||1,d=t.h/2-(u-1)/2*18;c=t.w-5;t._outputPorts.each(function(e,t){d3.select(this).attr("transform",function(e){return"translate("+c+","+(d+18*t-5)+")"})})}if(u=t.outputs,d=t.h/2-(u-1)/2*18,t.outputPortLabels&&t.outputPortLabels.length!=u&&(t.outputPortLabels=null),t.outputPortLabels=t.outputPortLabels||d3.range(u),t._outputPortLabels=s.selectAll(".port_output_label").data(t.outputPortLabels),t._outputPortLabels.enter().append("g").attr("class","port_output_label").append("svg:text").attr("class","output_label").attr("rx",0).attr("ry",0).attr("width",50).attr("height",10),t._outputPortLabels.exit().remove(),t._outputPortLabels){u=t.outputs||1,d=t.h/2-(u-1)/2*18;var c=t.w+5,p=t;t._outputPortLabels.each(function(e,t){var n=d3.select(this);n.attr("transform",function(e){return"translate("+c+","+(d+18*t-5)+")"}),p._def&&p._def.outputInfo&&t<p._def.outputInfo.length&&p._def.outputInfo[t].label?n.selectAll(".output_label").text(p._def.outputInfo[t].label):u>1?n.selectAll(".output_label").text(t):n.selectAll(".output_label").text("")})}if(s.selectAll("text.node_label").text(function(e,t){var n="";if(e._def.label){n=e._def.label;try{n=("function"==typeof n?n.call(e):n)||"",n=RED.text.bidi.enforceTextDirectionWithUCC(n)}catch(t){console.log("Definition error: "+e.type+".label",t),n=e.type}}return n}).attr("y",function(e){return e.h/2-1}).attr("class",function(e){var t="";if(e._def.labelStyle){t=e._def.labelStyle;try{t=("function"==typeof t?t.call(e):t)||""}catch(n){console.log("Definition error: "+e.type+".labelStyle",n),t=""}t=" "+t}return"node_label"+(e._def.align?" node_label_"+e._def.align:"")+t}),t._def.icon){icon=s.select(".node_icon");var h=icon.attr("xlink:href"),g=RED.utils.getNodeIcon(t._def,t);if(g!==h){icon.attr("xlink:href",g);var v=new Image;v.src=g,v.onload=function(){icon.attr("width",Math.min(v.width,30)),icon.attr("height",Math.min(v.height,30)),icon.attr("x",15-Math.min(v.width,30)/2)}}}s.selectAll(".node_tools").attr("x",function(e){return e.w-35}).attr("y",function(e){return e.h-20}),s.selectAll(".node_changed").attr("x",function(e){return e.w-10}).classed("hidden",function(e){return!(e.changed||e.moved)}),s.selectAll(".node_error").attr("x",function(e){return e.w-10-(e.changed||e.moved?13:0)}).classed("hidden",function(e){return e.valid}),s.selectAll(".node_fixed_input").attr("x",function(e){return e.w-10-(e.changed||e.moved?13:0)-(e.valid?0:13)}).classed("hidden",function(e){return 0==e.fixedInputs}),s.selectAll(".node_icon").attr("y",function(e){return(e.h-d3.select(this).attr("height"))/2}),s.selectAll(".node_icon_shade").attr("height",function(e){return e.h}),s.selectAll(".node_icon_shade_border").attr("d",function(e){return"M "+("right"==e._def.align?0:30)+" 1 l 0 "+(e.h-2)}),s.selectAll(".node_button").attr("opacity",function(e){return ne||!j(e)?.4:1}),s.selectAll(".node_button_button").attr("cursor",function(e){return ne||!j(e)?"":"pointer"}),s.selectAll(".node_right_button").attr("transform",function(e){var t=e.w-6;return e._def.button.toggle&&!e[e._def.button.toggle]&&(t-=8),"translate("+t+",2)"}),s.selectAll(".node_right_button rect").attr("fill-opacity",function(e){return e._def.button.toggle?e[e._def.button.toggle]?1:.2:1}),s.selectAll(".node_badge_group").attr("transform",function(e){return"translate("+(e.w-40)+","+(e.h+3)+")"}),s.selectAll("text.node_badge_label").text(function(e,t){if(e._def.badge){if("function"!=typeof e._def.badge)return e._def.badge;try{return e._def.badge.call(e)}catch(t){return console.log("Definition error: "+e.type+".badge",t),""}}return""})}if(me&&t.statusTop?t.statusTop.text&&s.selectAll(".node_status_label_top").style("display","inline").text(t.statusTop.text):s.selectAll(".node_status_label_top").style("display","none"),me&&t.statusBottom){s.selectAll(".node_status_group_bottom").style("display","inline").attr("transform","translate(3,"+(t.h+3)+")");var m=Ee[t.statusBottom.fill];if(null==t.statusBottom.shape&&null==m)s.selectAll(".node_status_bottom").style("display","none");else{var b;null==t.statusBottom.shape||"dot"==t.statusBottom.shape?b={display:"inline",fill:m,stroke:m}:"ring"==t.statusBottom.shape&&(b={display:"inline",fill:"#fff",stroke:m}),s.selectAll(".node_status_bottom").style(b)}t.statusBottom.text?(s.selectAll(".node_status_label_bottom").text(t.statusBottom.text),null==t.statusBottom.shape&&null==m?s.selectAll(".node_status_label_bottom").attr("x",0):s.selectAll(".node_status_label_bottom").attr("x",20)):s.selectAll(".node_status_label_bottom").text("")}else s.selectAll(".node_status_group_bottom").style("display","none");t.dirty=!1}});var r=ke.selectAll(".link").data(ae,function(e){e.target.id;return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.targetPort+":"+e.target.i});r.enter().insert("g",".node").attr("class","link").each(function(e,t){var n=d3.select(this);e.added=!0,n.append("svg:path").attr("class","link_background link_path").on("mousedown",function(e){re=e,u(),se=re,f(),P(),L(),d3.event.stopPropagation()}).on("touchstart",function(e){re=e,u(),se=re,f(),P(),L(),d3.event.stopPropagation();var t=d3.select(document.body),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];X=setTimeout(function(){X=null,O(t,o)},q)}),n.append("svg:path").attr("class","link_outline link_path"),n.append("svg:path").attr("class","link_line link_path").classed("link_link",function(e){return e.link}).classed("link_subflow",function(e){return!e.link&&ne})}),r.exit().remove(),ke.selectAll(".link_path").each(function(t){var n=d3.select(this);(t.added||t===se||t.selected||e[t.source.id]||e[t.target.id])&&n.attr("d",function(e){var t=e.source.outputs||1,n=e.target.inputs||1,o=e.sourcePort||0,a=e.targetPort||0;"subflow"==e.source.type&&(t=1,o=0),"subflow"==e.target.type&&(n=1,a=0);var i=-(t-1)/2*18+18*o,s=-(n-1)/2*18+18*a,r=e.target.y-(e.source.y+i),d=e.target.x-e.target.w/2-(e.source.x+e.source.w/2),l=Math.sqrt(r*r+d*d),c=G,p=0;return l<F&&(c=.75-(F-l)/F*.75),d<0&&(c+=Math.min(5*F,Math.abs(d))/(5*F)*2,Math.abs(r)<3*W&&(p=(r>0?.5:-.5)*((3*W-Math.abs(r))/(3*W))*(Math.min(F,Math.abs(d))/F))),e.x1=e.source.x+e.source.w/2,e.y1=e.source.y+i,e.x2=e.target.x-e.target.w/2,e.y2=e.target.y+s,"M "+e.x1+" "+e.y1+" C "+(e.x1+c*F)+" "+(e.y1+p*W)+" "+(e.x2-c*F)+" "+(e.y2-p*W)+" "+e.x2+" "+e.y2})}),r.classed("link_selected",function(e){return e===se||e.selected}),r.classed("link_working",function(e){return e.working}),r.classed("link_unknown",function(e){return delete e.added,"unknown"==e.target.type||"unknown"==e.source.type});var d=ke.selectAll(".link_flow_link_g").data(ie,function(e){return e.node.id+":"+e.refresh});d.enter().insert("g",".node").attr("class","link_flow_link_g").each(function(e,t){var n=d3.select(this),o=1,a="start";"link-in"===e.node.type&&(o=-1,a="end");var i=30*o,s=20*o,r=(n.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M 0 0 h "+i),e.links),d=Object.keys(r),l=RED.nodes.getWorkspaceOrder();d.sort(function(e,t){return l.indexOf(e)-l.indexOf(t)});var c=W,p=-(d.length-1)*c/2,u=n.selectAll(".link_group").data(d);u.enter().append("g").attr("class","link_group").on("mouseover",function(){d3.select(this).classed("link_group_active",!0)}).on("mouseout",function(){d3.select(this).classed("link_group_active",!1)}).on("mousedown",function(){d3.event.preventDefault(),d3.event.stopPropagation()}).on("mouseup",function(t){d3.event.stopPropagation();var n=e.links[t];RED.workspaces.show(t),n.forEach(function(e){e.selected=!0,e.dirty=!0,ge.push({n:e})}),f(),P()}).each(function(e){var t=d3.select(this);t.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M "+i+" 0 C "+(i+1.7*s)+" 0 "+(i+.1*s)+" "+p+" "+(i+1.5*s)+" "+p+" "),t.append("svg:path").attr("class","link_port").attr("d","M "+(i+1.5*s+17*o)+" "+(p-12)+" h "+10*-o+" a 3 3 45 0 "+(1===o?"0":"1")+" "+-3*o+" 3 v 18 a 3 3 45 0 "+(1===o?"0":"1")+" "+3*o+" 3 h "+10*o),t.append("svg:path").attr("class","link_port").attr("d","M "+(i+1.5*s+20*o)+" "+(p-12)+" h "+30*o+" M "+(i+1.5*s+20*o)+" "+(p+12)+" h "+30*o).style("stroke-dasharray","12 3 8 4 3"),t.append("rect").attr("class","port link_port").attr("x",i+1.5*s-4+4*o).attr("y",p-4).attr("rx",2).attr("ry",2).attr("width",8).attr("height",8),t.append("rect").attr("x",i+1.5*s-(-1===o?F:0)).attr("y",p-12).attr("width",F).attr("height",24).style("stroke","none").style("fill","transparent");var n,r=RED.nodes.workspace(e);r&&(n=r.label||r.id),t.append("svg:text").attr("class","port_label").attr("x",i+1.5*s+15*o).attr("y",p+1).style("font-size","10px").style("text-anchor",a).text(n),p+=c}),u.exit().remove()}),d.exit().remove(),(d=ke.selectAll(".link_flow_link_g")).each(function(e){var t=1;"link-in"===e.node.type&&(t=-1),d3.select(this).attr("transform",function(e){return"translate("+(e.node.x+t*e.node.w/2)+","+e.node.y+")"})})}else ke.selectAll(".link_selected").data(ae,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.targetPort+":"+e.target.i}).classed("link_selected",!1);d3.event&&d3.event.preventDefault()}function L(){try{var e=window.parent.window.scrollX,t=window.parent.window.scrollY;$("#chart").focus(),window.parent.window.scrollTo(e,t)}catch(e){$("#chart").focus()}}function I(e,t,n){try{var a;ne&&(a=ne.changed);var i=RED.nodes.import(e,!0,t);if(i){var s=i[0],r=i[1],d=i[2],l=i[3],c=i[4];t&&c&&RED.workspaces.show(c.id);var p=s.filter(function(e){return e.hasOwnProperty("x")&&e.hasOwnProperty("y")&&e.z==RED.workspaces.active()}).map(function(e){return{n:e}}),f=s.map(function(e){return e.id});if(p.length>0){var h=p[0].n,g=h.x,v=h.y;null==fe&&(fe=[0,0]);var m,b,y=0,w=0;for(m=0;m<p.length;m++)(b=p[m]).n.selected=!0,b.n.changed=!0,b.n.moved=!0,b.n.x-=g-fe[0],b.n.y-=v-fe[1],b.dx=b.n.x-fe[0],b.dy=b.n.y-fe[1],y=Math.min(b.n.x-F/2-5,y),w=Math.min(b.n.y-W/2-5,w);for(m=0;m<p.length;m++)if(b=p[m],b.n.x-=y,b.n.y-=w,b.dx-=y,b.dy-=w,b.n._def.onadd)try{b.n._def.onadd.call(b.n)}catch(e){console.log("Definition error: "+b.n.type+".onadd:",e)}n||(he=RED.state.IMPORT_DRAGGING,te=!1,1===p.length&&(b=p[0],te=b.n.hasOwnProperty("_def")&&b.n._def.inputs>0&&b.n._def.outputs>0)),RED.keyboard.add("*","escape",function(){RED.keyboard.remove("escape"),u(),RED.history.pop(),he=0}),u(),ge=p}var D={t:"add",nodes:f,links:r,workspaces:d,subflows:l,dirty:RED.nodes.dirty()};if(0===p.length&&RED.nodes.dirty(!0),ne){var $=RED.subflow.refresh(!0);$&&(D.subflow={id:ne.id,changed:a,instances:$.instances})}RED.history.push(D),o(),P()}}catch(e){"NODE_RED"!=e.code?(console.log(e.stack),RED.notify(RED._("notification.error",{message:e.toString()}),"error")):RED.notify(RED._("notification.error",{message:e.message}),"error")}}function N(e){e?Ce.style("visibility","visible"):Ce.style("visibility","hidden")}function A(e){ee=e,P()}function z(e){me=e,RED.nodes.eachNode(function(e){e.dirty=!0}),P()}var M,B,J=5e3,U=5e3,G=.75,V=1,F=100,W=30,q=1e3,H=0,K=[],Y=[],X=0,Z={},Q=10,ee=!1,te=!1,ne=null,oe=[],ae=[],ie=[],se=null,re=null,de=null,le=null,ce=0,pe=null,ue=[0,0],fe=null,he=0,ge=[],ve=null,me=!1,be=null,ye=null,we=0,De=0,$e="",Ee={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3"},xe=1,Re=0,Te=d3.select("#chart").append("svg:svg").attr("width",J).attr("height",U).attr("pointer-events","all").style("cursor","crosshair").on("mousedown",function(){L()}).on("contextmenu",function(){d3.event.preventDefault()}),ke=Te.append("svg:g").on("dblclick.zoom",null).append("svg:g").attr("class","innerCanvas").on("mousemove",s).on("mousedown",function(){var e;if(de||re||(se=null,f()),0===he&&ve&&(ve.remove(),ve=null),(0===he||he===RED.state.QUICK_JOINING)&&(d3.event.metaKey||d3.event.ctrlKey)){e=d3.mouse(this),d3.event.stopPropagation();var i=$("#main-container").position();he!==RED.state.QUICK_JOINING&&(he=RED.state.QUICK_JOINING,$(window).on("keyup",E)),RED.typeSearch.show({x:d3.event.clientX-i.left-F/2,y:d3.event.clientY-i.top-W/2,cancel:function(){D()},add:function(i){var s=a(i);if(s){var r=s.node,d=s.historyEvent;if(r.x=e[0],r.y=e[1],he===RED.state.QUICK_JOINING)if(Se.length>0){var l,c,p=Se[0],h=null;if(p.portType===Re&&r.inputs>0?(h=p.node,c=p.port,l=r):p.portType===xe&&r.outputs>0&&(h=r,l=p.node,c=0),null!==h){var g={source:h,sourcePort:c,target:l};RED.nodes.addLink(g),d.links=[g],n(),p.portType===Re&&r.outputs>0?t([{node:r,port:0,portType:Re}]):p.portType===xe&&r.inputs>0?t([{node:r,port:0,portType:xe}]):D()}else n(),D()}else r.outputs>0?t([{node:r,port:0,portType:Re}]):r.inputs>0?t([{node:r,port:0,portType:xe}]):D();RED.history.push(d),RED.nodes.add(r),RED.editor.validateNode(r),RED.nodes.dirty(!0),u(),r.selected=!0,ge.push({n:r}),o(),f(),P()}}}),o(),f(),P()}0!==he||d3.event.metaKey||d3.event.ctrlKey||X||(e=d3.mouse(this),ve=ke.append("rect").attr("ox",e[0]).attr("oy",e[1]).attr("rx",1).attr("ry",1).attr("x",e[0]).attr("y",e[1]).attr("width",0).attr("height",0).attr("class","lasso"),d3.event.preventDefault())}).on("mouseup",r).on("touchend",function(){clearTimeout(X),X=null,RED.touch.radialMenu.active()||(ve&&_e.attr("fill","#fff"),r.call(this))}).on("touchcancel",r).on("touchstart",function(){var e;if(d3.event.touches.length>1){clearTimeout(X),X=null,d3.event.preventDefault(),e=d3.event.touches.item(0);var t=d3.event.touches.item(1),n=e.pageY-t.pageY,o=e.pageX-t.pageX,a=$("#chart").offset(),i=[$("#chart").scrollLeft(),$("#chart").scrollTop()];K=[(t.pageX+o/2-a.left+i[0])/V,(t.pageY+n/2-a.top+i[1])/V],Y=[t.pageX+o/2,t.pageY+n/2],H=Math.sqrt(n*n+o*o)}else{var s=d3.select(document.body),r=[(e=d3.event.touches.item(0)).pageX,e.pageY];K=[e.pageX,e.pageY],H=0;d3.touches(this)[0];X=setTimeout(function(){X=null,O(s,r)},q)}}).on("touchmove",function(){if(RED.touch.radialMenu.active())d3.event.preventDefault();else{var e;if(d3.event.touches.length<2){if(X){var t=(e=d3.event.touches.item(0)).pageX-K[0],n=e.pageY-K[1];Math.abs(t*t+n*n)>64&&(clearTimeout(X),X=null)}else ve&&d3.event.preventDefault();s.call(this)}else{e=d3.event.touches.item(0);var o=d3.event.touches.item(1),a=e.pageY-o.pageY,i=e.pageX-o.pageX,r=($("#chart").offset(),[$("#chart").scrollLeft(),$("#chart").scrollTop()]),d=Math.sqrt(a*a+i*i),l=[o.pageX+i/2,o.pageY+a/2];if(!isNaN(d)){oldScaleFactor=V,V=Math.min(2,Math.max(.3,V+Math.floor(100*d-100*H)/1e4));var c=[K[0]*(V-oldScaleFactor),K[1]*(V-oldScaleFactor)];H=d,Y=l,$("#chart").scrollLeft(r[0]+c[0]),$("#chart").scrollTop(r[1]+c[1]),P()}}}}),_e=ke.append("svg:rect").attr("width",J).attr("height",U).attr("fill","#fff"),Ce=ke.append("g");e();var je=ke.append("g"),Se=[],Oe=null,Pe=!1;return{init:function(){RED.events.on("workspace:change",function(e){var t=$("#chart");0!==e.old&&(Z[e.old]={left:t.scrollLeft(),top:t.scrollTop()});var n=t.scrollLeft(),a=t.scrollTop();ne=RED.nodes.subflow(e.workspace),RED.menu.setDisabled("menu-item-workspace-edit",ne),RED.menu.setDisabled("menu-item-workspace-delete",1==RED.workspaces.count()||ne),Z[e.workspace]?(t.scrollLeft(Z[e.workspace].left),t.scrollTop(Z[e.workspace].top)):(t.scrollLeft(0),t.scrollTop(0));var i=t.scrollLeft()-n,s=t.scrollTop()-a;null!=fe&&(fe[0]+=i,fe[1]+=s),u(),RED.nodes.eachNode(function(e){e.dirty=!0}),f(),o(),P()}),$("#btn-zoom-out").click(function(){l()}),$("#btn-zoom-zero").click(function(){c()}),$("#btn-zoom-in").click(function(){d()}),$("#chart").on("DOMMouseScroll mousewheel",function(e){e.altKey&&(e.preventDefault(),e.stopPropagation(),(-e.originalEvent.detail||e.originalEvent.wheelDelta)<=0?l():d())}),$("#chart").droppable({accept:".palette_node",drop:function(e,t){d3.event=e;var n=a(t.draggable[0].type);if(n){var i=n.historyEvent,s=n.node,r=d3.touches(t.helper.get(0))[0]||d3.mouse(t.helper.get(0)),d=d3.touches(this)[0]||d3.mouse(this);d[1]+=this.scrollTop+(s.h/2-r[1]),d[0]+=this.scrollLeft+(s.w/2-r[0]),d[1]/=V,d[0]/=V,ee&&(d[0]=Q*Math.ceil(d[0]/Q),d[1]=Q*Math.ceil(d[1]/Q)),s.x=d[0],s.y=d[1];var l=$(t.helper).data("splice");if(l){RED.nodes.removeLink(l);var c={source:l.source,sourcePort:l.sourcePort,target:s,targetPort:0},p={source:s,sourcePort:0,target:l.target,targetPort:l.targetPort};RED.nodes.addLink(c),RED.nodes.addLink(p),i.links=[c,p],i.removedLinks=[l]}RED.history.push(i),RED.nodes.add(s),RED.editor.validateNode(s),RED.nodes.dirty(!0),u(),s.selected=!0,ge.push({n:s}),o(),f(),P(),s._def.autoedit&&RED.editor.edit(s)}}}),$("#chart").focus(function(){$("#workspace-tabs").addClass("workspace-focussed")}),$("#chart").blur(function(){$("#workspace-tabs").removeClass("workspace-focussed")}),RED.actions.add("core:copy-selection-to-internal-clipboard",b),RED.actions.add("core:cut-selection-to-internal-clipboard",function(){b(),m()}),RED.actions.add("core:paste-from-internal-clipboard",function(){I($e)}),RED.actions.add("core:delete-selection",m),RED.actions.add("core:edit-selected-node",v),RED.actions.add("core:undo",RED.history.pop),RED.actions.add("core:select-all-nodes",p),RED.actions.add("core:zoom-in",d),RED.actions.add("core:zoom-out",l),RED.actions.add("core:zoom-reset",c),RED.actions.add("core:toggle-show-grid",function(e){void 0===e?RED.userSettings.toggle("view-show-grid"):N(e)}),RED.actions.add("core:toggle-snap-grid",function(e){void 0===e?RED.userSettings.toggle("view-snap-grid"):A(e)}),RED.actions.add("core:toggle-status",function(e){void 0===e?RED.userSettings.toggle("view-node-status"):z(e)}),RED.actions.add("core:move-selection-up",function(){g(0,-1)}),RED.actions.add("core:step-selection-up",function(){g(0,-20)}),RED.actions.add("core:move-selection-right",function(){g(1,0)}),RED.actions.add("core:step-selection-right",function(){g(20,0)}),RED.actions.add("core:move-selection-down",function(){g(0,1)}),RED.actions.add("core:step-selection-down",function(){g(0,20)}),RED.actions.add("core:move-selection-left",function(){g(-1,0)}),RED.actions.add("core:step-selection-left",function(){g(-20,0)})},state:function(e){if(null==e)return he;he=e},redraw:function(e){e&&(o(),f()),P()},focus:L,importNodes:I,calculateTextWidth:y,select:function(e){if(void 0!==e&&(u(),"string"==typeof e)){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,ge=[{n:t}])}f(),P()},selection:function(){var e={};return ge.length>0&&(e.nodes=ge.map(function(e){return e.n})),null!=se&&(e.link=se),e},scale:function(){return V},getLinksAtPoint:function(e,t){for(var n=[],o=Te.selectAll(".link_background")[0],a=0;a<o.length;a++){var i=o[a].getBBox();e>=i.x&&t>=i.y&&e<=i.x+i.width&&t<=i.y+i.height&&n.push(o[a])}return n},reveal:function(e){if(RED.nodes.workspace(e)||RED.nodes.subflow(e))RED.workspaces.show(e);else{var t=RED.nodes.node(e);if("config"!==t._def.category&&t.z){t.highlighted=!0,t.dirty=!0,RED.workspaces.show(t.z);var n=[$("#chart").width(),$("#chart").height()],o=[$("#chart").scrollLeft(),$("#chart").scrollTop()];if(t.x<o[0]||t.y<o[1]||t.x>n[0]+o[0]||t.y>n[1]+o[1]){var a="-="+(o[0]-t.x+n[0]/2),i="-="+(o[1]-t.y+n[1]/2);$("#chart").animate({scrollLeft:a,scrollTop:i},200)}if(!t._flashing){t._flashing=!0;var s=22,r=function(){s--,t.dirty=!0,s>=0?(t.highlighted=!t.highlighted,setTimeout(r,100)):(t.highlighted=!1,delete t._flashing),RED.view.redraw()};r()}}else"config"===t._def.category&&RED.sidebar.config.show(e)}},gridSize:function(t){if(void 0===t)return Q;Q=Math.max(5,t),e()}}}(),RED.sidebar=function(){function e(e){e?($("#main-container").removeClass("sidebar-closed"),o.resize()):$("#main-container").addClass("sidebar-closed"),RED.events.emit("sidebar:resize")}function t(e){e&&(n(e)||o.addTab(a[e]),o.activateTab(e),RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function n(e){return o.contains(e)}var o=RED.tabs.create({id:"sidebar-tabs",onchange:function(e){$("#sidebar-content").children().hide(),$("#sidebar-footer").children().hide(),e.onchange&&e.onchange.call(e),$(e.wrapper).show(),e.toolbar&&$(e.toolbar).show()},onremove:function(e){$(e.wrapper).hide(),e.onremove&&e.onremove.call(e)},minimumActiveTabWidth:70}),a={},i={};return $("#sidebar-separator").draggable({axis:"x",start:function(e,t){i.closing=!1,i.opening=!1;var n=$(window).width();if(i.start=t.position.left,i.chartWidth=$("#workspace").width(),i.chartRight=n-$("#workspace").width()-$("#workspace").offset().left-2,!RED.menu.isSelected("menu-item-sidebar")){i.opening=!0;$("#sidebar").addClass("closing"),$("#workspace").css("right",7),$("#editor-stack").css("right",8),$("#sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")}i.width=$("#sidebar").width()},drag:function(e,t){var n=t.position.left-i.start,a=i.width-n;i.opening&&(a-=3),a>150&&i.chartWidth+n<200&&(t.position.left=200+i.start-i.chartWidth,n=t.position.left-i.start,a=i.width-n),a<150?(i.closing||($("#sidebar").addClass("closing"),i.closing=!0),i.opening||(a=150,t.position.left=i.width-(150-i.start),n=t.position.left-i.start)):a>150&&(i.closing||i.opening)&&(i.closing=!1,$("#sidebar").removeClass("closing"));var s=i.chartRight-n;$("#workspace").css("right",s),$("#editor-stack").css("right",s+1),$("#sidebar").width(a),o.resize(),RED.events.emit("sidebar:resize")},stop:function(e,t){i.closing&&($("#sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#sidebar").width()<180&&($("#sidebar").width(180),$("#workspace").css("right",187),$("#editor-stack").css("right",188))),$("#sidebar-separator").css("left","auto"),$("#sidebar-separator").css("right",$("#sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}}),{init:function(){RED.actions.add("core:toggle-sidebar",function(t){void 0===t?RED.menu.toggleSelected("menu-item-sidebar"):e(t)}),t(),RED.sidebar.info.init(),RED.sidebar.config.init(),$(window).width()<600&&RED.menu.setSelected("menu-item-sidebar",!1)},addTab:function(e,n,i,s){var r;"string"==typeof e?r={id:n.id,label:e,name:e,content:n,closeable:i,visible:s}:"object"==typeof e&&(r=e),r.wrapper=$("<div>",{style:"height:100%"}).appendTo("#sidebar-content"),r.wrapper.append(r.content),r.wrapper.hide(),r.enableOnEdit||(r.shade=$("<div>",{class:"sidebar-shade hide"}).appendTo(r.wrapper)),r.toolbar&&($("#sidebar-footer").append(r.toolbar),$(r.toolbar).hide());r.id;RED.menu.addItem("menu-item-view-menu",{id:"menu-item-view-menu-"+r.id,label:r.name,onselect:function(){t(r.id)},group:"sidebar-tabs"}),a[r.id]=r,!1!==r.visible&&o.addTab(a[r.id])},removeTab:function(e){o.removeTab(e),$(a[e].wrapper).remove(),a[e].footer&&a[e].footer.remove(),delete a[e],RED.menu.removeItem("menu-item-view-menu-"+e)},show:t,containsTab:n,toggleSidebar:e}}(),RED.palette=function(){function e(e,t){t=(t||e).replace(/_/g," ");var n=$('<div id="palette-container-'+e+'" class="palette-category palette-close hide"><div id="palette-header-'+e+'" class="palette-header"><i class="expanded fa fa-angle-down"></i><span>'+t+'</span></div><div class="palette-content" id="palette-base-category-'+e+'"><div id="palette-'+e+'-input"></div><div id="palette-'+e+'-output"></div><div id="palette-'+e+'-function"></div></div></div>').appendTo("#palette-container");p[e]={container:n,close:function(){n.removeClass("palette-open"),n.addClass("palette-closed"),$("#palette-base-category-"+e).slideUp(),$("#palette-header-"+e+" i").removeClass("expanded")},open:function(){n.addClass("palette-open"),n.removeClass("palette-closed"),$("#palette-base-category-"+e).slideDown(),$("#palette-header-"+e+" i").addClass("expanded")},toggle:function(){n.hasClass("palette-open")?p[e].close():p[e].open()}},$("#palette-header-"+e).on("click",function(t){p[e].toggle()})}function t(e,t,n,o,a){for(var i=n.split(/[ -]/),s=[],r=i[0],d=(RED.view.calculateTextWidth(r,"palette_label",0),1);d<i.length;d++){var l=RED.view.calculateTextWidth(r+" "+i[d],"palette_label",0);l<82?(r+=" "+i[d],l):(s.push(r),r=i[d],RED.view.calculateTextWidth(r,"palette_label",0))}s.push(r);var c=s.join("<br/>"),p=8+20*s.length;t.css({height:p+"px"}),t.find(".palette_label").html(c).attr("dir",RED.text.bidi.resolveBaseTextDir(c)),t.find(".palette_port").css({top:p/2-5+"px"});var u;try{var f="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(n)+"</b></p>";n!=e&&(f="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(n)+"</b><br/><i>"+e+"</i></p>");var h=i18n.t(a+"/"+e+".hni:"+e+".paletteHelp");u=$(f+(o||(h||"<p>"+RED._("palette.noInfo")+"</p>")).trim())}catch(t){console.log("Error generating pop-over label for ",e),console.log(t.toString()),u="<p><b>"+n+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}t.data("popover").setContent(u)}function n(e,t){var n=e.find(".palette_icon"),o=RED.utils.getNodeIcon(t._def,t);n.attr("style","background-image: url("+o+")")}function o(e){return e.replace(" ","_").replace(".","_").replace(":","_")}function a(n,a){var i=o(n);if(!$("#palette_node_"+i).length&&-1===l.indexOf(a.category)){var s=a.category.replace(/ /g,"_"),r=s.split("-")[0],d=document.createElement("div");d.id="palette_node_"+i,d.type=n,d.namespace=a.namespace?a.namespace:n;var u=/^(.*?)([ -]in|[ -]out)?$/.exec(n)[1];if(void 0!==a.paletteLabel)try{u=("function"==typeof a.paletteLabel?a.paletteLabel.call(a):a.paletteLabel)||""}catch(e){console.log("Definition error: "+n+".paletteLabel",e)}if($("<div/>",{class:"palette_label"+("right"==a.align?" palette_label_right":"")}).appendTo(d),d.className="palette_node",a.icon){var f=RED.utils.getNodeIcon(a),h=$("<div/>",{class:"palette_icon_container"+("right"==a.align?" palette_icon_container_right":"")}).appendTo(d);$("<div/>",{class:"palette_icon",style:"background-image: url("+f+")"}).appendTo(h)}if(d.style.backgroundColor=a.color,a.outputs>0){var g=document.createElement("div");g.className="palette_port palette_port_output",d.appendChild(g)}if(a.inputs>0){var v=document.createElement("div");v.className="palette_port palette_port_input",d.appendChild(v)}if(0===$("#palette-base-category-"+r).length)if(-1!==c.indexOf(r))e(r,RED._("node-red:palette.label."+r,{defaultValue:r}));else{var m=a.set.id;e(r,RED._(m+":palette.label."+r,{defaultValue:r}))}$("#palette-container-"+r).show(),0===$("#palette-"+s).length&&$("#palette-base-category-"+r).append('<div id="palette-'+s+'"></div>'),$("#palette-"+s).append(d),d.onmousedown=function(e){e.preventDefault()};var b=RED.popover.create({target:$(d),trigger:"hover",width:"300px",content:"hi",delay:{show:750,hide:50}});$(d).data("popover",b),$(d).click(function(){RED.view.focus();var e;e=0===n.indexOf("subflow:")?marked(RED.nodes.subflow(n.substring(8)).info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>":i18n.t((a.namespace?a.namespace:n)+"/"+n+".hni:"+n+".help")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>",RED.sidebar.info.set(e,RED._("sidebar.info.nodeHelp"))});var y,w,D,E,x,R,T=$("#chart"),k=T.offset(),_=$("#chart>svg").get(0);$(d).draggable({helper:"clone",appendTo:"body",revert:!0,revertDuration:50,containment:"#main-container",start:function(){x=$("#palette").width(),R=$("#palette").parent().position().top+$("#palette-container").position().top,RED.view.focus()},stop:function(){d3.select(".link_splice").classed("link_splice",!1),E&&(clearTimeout(E),E=null)},drag:function(e,t){t.position.left+=17.5,a.inputs>0&&a.outputs>0&&(w=t.position.left-x+t.helper.width()/2-k.left+T.scrollLeft(),D=t.position.top-R+t.helper.height()/2-k.top+T.scrollTop(),E||(E=setTimeout(function(){var e=[],n=1/0,o=null;if(_.getIntersectionList){var a=_.createSVGRect();a.x=w,a.y=D,a.width=1,a.height=1,e=_.getIntersectionList(a,_),w/=RED.view.scale(),D/=RED.view.scale()}else w/=RED.view.scale(),D/=RED.view.scale(),e=RED.view.getLinksAtPoint(w,D);for(var i=0;i<e.length;i++)if(d3.select(e[i]).classed("link_background"))for(var s=e[i].getTotalLength(),r=0;r<s;r+=10){var d=e[i].getPointAtLength(r),l=(d.x-w)*(d.x-w)+(d.y-D)*(d.y-D);l<200&&l<n&&(n=l,o=e[i])}y&&y!==o&&d3.select(y.parentNode).classed("link_splice",!1),o?d3.select(o.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),y!==o&&(o?$(t.helper).data("splice",d3.select(o).data()[0]):$(t.helper).removeData("splice")),y=o,E=null},200)))}});var C=null;"subflows"==a.category&&($(d).dblclick(function(e){RED.workspaces.show(n.substring(8)),e.preventDefault()}),C=marked(a.info||"")),t(n,$(d),u,C,a.namespace?a.namespace:n),1===$("#palette-container-"+s).find(".palette_node").length&&p[s].close()}}function i(e){var t=o(e),n=$("#palette_node_"+t),a=n.closest(".palette-category");n.remove(),0===a.find(".palette_node").length&&a.find("i").hasClass("expanded")&&(a.find(".palette-content").slideToggle(),a.find("i").toggleClass("expanded"))}function s(e){var t=o(e),n=$("#palette_node_"+t);n.hide();for(var a=n.closest(".palette-category"),i=a.find(".palette_node"),s=0,r=0;r<i.length;r++)"none"===$(i[r]).css("display")&&(s+=1);s===i.length&&a.hide()}function r(e){var t=o(e),n=$("#palette_node_"+t);n.closest(".palette-category").show(),n.show()}function d(e){var t=new RegExp(e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i");$("#palette-container .palette_node").each(function(n,o){var a=$(o).find(".palette_label").text();""===e||t.test(o.id)||t.test(a)?$(this).show():$(this).hide()});for(var n in p)p.hasOwnProperty(n)&&(0===p[n].container.find(".palette_node").filter(function(){return"none"!==$(this).css("display")}).length?p[n].close():p[n].open())}var l=["config","unknown","deprecated"],c=["subflows","input","output","function","social","mobile","storage","analysis","advanced"],p={};return{init:function(){RED.events.on("registry:node-type-added",function(e){var t=RED.nodes.getType(e);a(e,t),t.onpaletteadd&&"function"==typeof t.onpaletteadd&&t.onpaletteadd.call(t)}),RED.events.on("registry:node-type-removed",function(e){i(e)}),RED.events.on("registry:node-set-enabled",function(e){for(var t=0;t<e.types.length;t++){r(e.types[t]);var n=RED.nodes.getType(e.types[t]);n&&n.onpaletteadd&&"function"==typeof n.onpaletteadd&&n.onpaletteadd.call(n)}}),RED.events.on("registry:node-set-disabled",function(e){console.log(e);for(var t=0;t<e.types.length;t++){s(e.types[t]);var n=RED.nodes.getType(e.types[t]);n&&n.onpaletteremove&&"function"==typeof n.onpaletteremove&&n.onpaletteremove.call(n)}}),RED.events.on("registry:node-set-removed",function(e){if(e.added)for(var t=0;t<e.types.length;t++){i(e.types[t]);var n=RED.nodes.getType(e.types[t]);n&&n.onpaletteremove&&"function"==typeof n.onpaletteremove&&n.onpaletteremove.call(n)}}),$("#palette > .palette-spinner").show(),$("#palette-search input").searchBox({delay:100,change:function(){d($(this).val())}});var t=c;RED.settings.paletteCategories?t=RED.settings.paletteCategories:RED.settings.theme("palette.categories")&&(t=RED.settings.theme("palette.categories")),Array.isArray(t)||(t=c),t.forEach(function(t){e(t,RED._("palette.label."+t,{defaultValue:t}))}),$("#palette-collapse-all").on("click",function(e){e.preventDefault();for(var t in p)p.hasOwnProperty(t)&&p[t].close()}),$("#palette-expand-all").on("click",function(e){e.preventDefault();for(var t in p)p.hasOwnProperty(t)&&p[t].open()})},add:a,remove:i,hide:s,show:r,refresh:function(){RED.nodes.eachSubflow(function(e){var o=$("#palette_node_subflow_"+e.id.replace(".","_")),a=o.find(".palette_port_input"),i=o.find(".palette_port_output");if(0===a.length&&e.in.length>0){var s=document.createElement("div");s.className="palette_port palette_port_input",o.append(s)}else 0!==a.length&&0===e.in.length&&a.remove();if(0===i.length&&e.out.length>0){var r=document.createElement("div");r.className="palette_port palette_port_output",o.append(r)}else 0!==i.length&&0===e.out.length&&i.remove();t(e.type+":"+e.id,o,e.name,marked(e.info||""),e.type+":"+e.id),n(o,e)})}}}(),RED.sidebar.info=function(){function e(){RED.sidebar.show("info")}function t(e){return $(e).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),e}function n(e){if(void 0!==e){s.show(),$(r.content).empty(),$(d.content).empty();var t,n,i,l=$('<table class="node-info"></table>').appendTo(r.content),p=$("<tbody>").appendTo(l),u=RED.projects.getActiveProject();if(u&&(t=$('<tr class="node-info-node-row"><td>Project</td><td></td></tr>').appendTo(p),$(t.children()[1]).text(u.name||""),$('<tr class="node-info-property-expand blank"><td colspan="2"></td></tr>').appendTo(p),$('<button class="editor-button editor-button-small" style="position:absolute;right:2px;"><i class="fa fa-ellipsis-h"></i></button>').appendTo(t.children()[1]).click(function(e){e.preventDefault(),RED.projects.editProject()})),d.container.show(),null!==e)if(Array.isArray(e))d.container.hide(),t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.selection")+"</td><td></td></tr>").appendTo(p),$(t.children()[1]).text(RED._("sidebar.info.nodes",{count:e.length}));else{var f=/^subflow(:(.+))?$/.exec(e.type);if(f){n=f[2]?RED.nodes.subflow(f[2]):e,i=0;var h="subflow:"+n.id;RED.nodes.eachNode(function(e){e.type===h&&i++})}if("tab"===e.type||"subflow"===e.type)t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info."+("tab"===e.type?"flow":"subflow"))+"</td><td></td></tr>").appendTo(p),RED.utils.createObjectElement(e.id).appendTo(t.children()[1]),t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.tabName")+"</td><td></td></tr>").appendTo(p),$(t.children()[1]).text(e.label||e.name||""),"tab"===e.type&&(t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.status")+"</td><td></td></tr>").appendTo(p),$(t.children()[1]).text(e.disabled?RED._("sidebar.info.disabled"):RED._("sidebar.info.enabled")));else{if(t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.node")+"</td><td></td></tr>").appendTo(p),RED.utils.createObjectElement(e.id).appendTo(t.children()[1]),"subflow"!==e.type&&e.name&&(t=$('<tr class="node-info-node-row"><td>'+RED._("common.label.name")+"</td><td></td></tr>").appendTo(p),$('<span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e.name)+'"></span>').text(e.name).appendTo(t.children()[1])),f||(t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.type")+"</td><td></td></tr>").appendTo(p),$(t.children()[1]).text(e.type)),!f&&"subflow"!=e.type&&"comment"!=e.type&&e._def){var g=0,v=e._def.defaults;for(var m in v)if("name"!=m&&v.hasOwnProperty(m)){var b=e[m];if(g++,t=$('<tr class="node-info-property-row'+(c.property?"":" hide")+'"><td>'+m+"</td><td></td></tr>").appendTo(p),v[m].type){var y=RED.nodes.node(b);if(y){var w=RED.utils.getNodeLabel(y,b),D=t.children()[1],E=$("<span>",{class:""}).appendTo(D),x=$("<div>",{class:"palette_node palette_node_small"}).appendTo(E),R=y._def.color,T=RED.utils.getNodeIcon(y._def);x.css({backgroundColor:R,cursor:"pointer"});var k=$("<div/>",{class:"palette_icon_container"}).appendTo(x);$("<div/>",{class:"palette_icon",style:"background-image: url("+T+")"}).appendTo(k);$("<span></span>").css({verticalAlign:"top",marginLeft:"6px"}).text(w).appendTo(D);x.on("dblclick",function(){RED.editor.editConfig("",y.type,y.id)})}else RED.utils.createObjectElement(void 0).appendTo(t.children()[1])}else RED.utils.createObjectElement(b).appendTo(t.children()[1])}g>0&&$('<tr class="node-info-property-expand blank"><td colspan="2"><a href="#" class=" node-info-property-header'+(c.property?" expanded":"")+'"><span class="node-info-property-show-more">'+RED._("sidebar.info.showMore")+'</span><span class="node-info-property-show-less">'+RED._("sidebar.info.showLess")+'</span> <i class="fa fa-caret-down"></i></a></td></tr>').appendTo(p)}"tab"!==e.type&&f&&($('<tr class="blank"><th colspan="2">'+RED._("sidebar.info.subflow")+"</th></tr>").appendTo(p),$('<tr class="node-info-subflow-row"><td>'+RED._("common.label.name")+'</td><td><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(n.name)+'">'+n.name+"</span></td></tr>").appendTo(p))}f&&$('<tr class="node-info-subflow-row"><td>'+RED._("sidebar.info.instances")+"</td><td>"+i+"</td></tr>").appendTo(p);var _="";if(n||"comment"===e.type||"tab"===e.type?"tab"===e.type&&(d.title.text(RED._("sidebar.info.flowDesc")),_=marked(e.info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>"):(d.title.html(RED._("sidebar.info.nodeHelp")),_=i18n.t((e._def.namespace?e._def.namespace:e.type)+"/"+e.type+".hni:"+e.type+".help")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>"),n)_+=marked(n.info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>",d.title.text(RED._("sidebar.info.subflowDesc"));else if(e._def&&e._def.info){d.title.text(RED._("sidebar.info.nodeHelp"));var C=e._def.info,j="function"==typeof C?C.call(e):C;_+=marked(j)}_&&o(_),$(".node-info-property-header").click(function(e){e.preventDefault(),c.property=!c.property,$(this).toggleClass("expanded",c.property),$(".node-info-property-row").toggle(c.property)})}}else a()}function o(e){var n=t($('<div class="node-help"><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e)+'">'+e+"</span></div>")).appendTo(d.content);n.find(".bidiAware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>");n.find("H3").wrapInner('<a class="node-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').click(function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),n=$(this).parent().next();1===n.length&&"H3"!==n[0].nodeName;)n.toggle(!t),n=n.next();$(this).toggleClass("expanded",!t)})}function a(e){if(void 0===e&&(e=RED.view.selection()),e.nodes)if(1==e.nodes.length){var t=e.nodes[0];n("subflow"===t.type&&t.direction?RED.nodes.subflow(t.z):t)}else n(e.nodes);else{var o=RED.workspaces.active(),a=RED.nodes.workspace(o)||RED.nodes.subflow(o);if(a)n(a);else{var i=RED.nodes.workspace(RED.workspaces.active());n(i&&i.info?i:null)}}}marked.setOptions({renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1});var i,s,r,d,l,c={property:!1},p=function(){function e(){for(var e,n=Math.floor(Math.random()*c),o=RED._("infotips:info.tip"+n);e=/({{(.*?)}})/.exec(o);){var s=RED.keyboard.getShortcut(e[2]);if(!s)return;o=o.replace(e[1],RED.keyboard.formatKey(s.key))}for(;e=/(\[(.*?)\])/.exec(o);)o=o.replace(e[1],RED.keyboard.formatKey(e[2]));l.html(o).fadeIn(200),a&&(a=null,i=setInterval(t,d))}function t(){l.fadeOut(300,function(){e()})}function n(){if($(".sidebar-node-info").addClass("show-tips"),s&&!a&&!i){if(-1===c)do{c++}while(RED._("infotips:info.tip"+c)!=="infotips:info.tip"+c);a=setTimeout(e,r)}}function o(){$(".sidebar-node-info").removeClass("show-tips"),clearInterval(i),clearTimeout(a),i=null,a=null}var a,i,s=!0,r=1e3,d=15e3,c=-1;return RED.actions.add("core:toggle-show-tips",function(e){void 0===e?RED.userSettings.toggle("view-show-tips"):(s=e)?n():o()}),{start:n,stop:o,next:function(){clearInterval(i),a=!0,e()},enabled:function(){return s}}}();return RED.events.on("view:selection-changed",a),{init:function(){(i=document.createElement("div")).className="sidebar-node-info",RED.actions.add("core:show-info-tab",e);var t=$("<div>",{class:"sidebar-node-info-stack"}).appendTo(i);s=RED.stack.create({container:t}).hide(),(r=s.add({title:RED._("sidebar.info.info"),collapsible:!0})).expand(),(d=s.add({title:RED._("sidebar.info.nodeHelp"),collapsible:!0})).expand(),d.content.css("padding","6px"),d.container.css("border-bottom","none");var n=$('<div class="node-info-tips"></div>').appendTo(i);l=$('<div class="node-info-tip"></div>').appendTo(n);var o=$('<div class="node-info-tips-buttons"></div>').appendTo(n);$('<a href="#" class="workspace-footer-button"><i class="fa fa-refresh"></a>').appendTo(o).click(function(e){e.preventDefault(),p.next()}),$('<a href="#" class="workspace-footer-button"><i class="fa fa-times"></a>').appendTo(o).click(function(e){e.preventDefault(),RED.actions.invoke("core:toggle-show-tips"),RED.notify(RED._("sidebar.info.showTips"))}),RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),content:i,enableOnEdit:!0}),p.enabled()?p.start():p.stop()},show:e,refresh:n,clear:function(){n(null)},set:function(e,t){d.title.text(t||""),n(null),$(d.content).empty(),o(e),$(".sidebar-node-info-stack").scrollTop(0)}}}(),RED.sidebar.config=function(){function e(e,t,n){if(e=e.replace(/\./i,"-"),l[e])l[e].label!==n&&(l[e].list.parent().find(".config-node-label").text(n),l[e].label=n);else{var o=$('<div class="palette-category workspace-config-node-category" id="workspace-config-node-category-'+e+'"></div>').appendTo(t),a=$('<div class="workspace-config-node-tray-header palette-header"><i class="fa fa-angle-down expanded"></i></div>').appendTo(o);n?$('<span class="config-node-label"/>').text(n).appendTo(a):$('<span class="config-node-label" data-i18n="sidebar.config.'+e+'">').appendTo(a),$('<span class="config-node-filter-info"></span>').appendTo(a),category=$('<ul class="palette-content config-node-list"></ul>').appendTo(o),o.i18n();var i=a.find("i"),s={label:n,list:category,size:function(){return s.list.find("li:not(.config_node_none)").length},open:function(e){i.hasClass("expanded")||(i.addClass("expanded"),e?s.list.show():s.list.slideDown())},close:function(e){i.hasClass("expanded")&&(i.removeClass("expanded"),e?s.list.hide():s.list.slideUp())},isOpen:function(){return i.hasClass("expanded")}};a.on("click",function(e){s.isOpen()?s.close():s.open()}),l[e]=s}return l[e]}function t(t,n){var o=e(t.replace(/\./i,"-")),a=o.list;if(n.sort(function(e,t){return e.type<t.type?-1:e.type>t.type?1:0}),d){var i=n.length;(i-=(n=n.filter(function(e){return!1!==e._def.hasUsers&&0===e.users.length})).length)>0?a.parent().find(".config-node-filter-info").text(RED._("sidebar.config.filtered",{count:i})).show():a.parent().find(".config-node-filter-info").hide()}else a.parent().find(".config-node-filter-info").hide();if(a.empty(),0===n.length)$('<li class="config_node_none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(a),o.close(!0);else{var s="";n.forEach(function(e){var t=RED.utils.getNodeLabel(e,e.id);e.type!=s&&($('<li class="config_node_type">'+e.type+"</li>").appendTo(a),s=e.type);var n=$('<li class="palette_node config_node palette_node_id_'+e.id.replace(/\./g,"-")+'"></li>').appendTo(a);if($('<div class="palette_label"></div>').text(t).appendTo(n),!1!==e._def.hasUsers){$("<div/>",{class:"palette_icon_container  palette_icon_container_right"}).text(e.users.length).appendTo(n);0===e.users.length&&n.addClass("config_node_unused")}n.on("click",function(t){RED.sidebar.info.refresh(e)}),n.on("dblclick",function(t){RED.editor.editConfig("",e.type,e.id)});var o=e.users.map(function(e){return e.id});n.on("mouseover",function(e){RED.nodes.eachNode(function(e){-1!=o.indexOf(e.id)&&(e.highlighted=!0,e.dirty=!0)}),RED.view.redraw()}),n.on("mouseout",function(e){RED.nodes.eachNode(function(e){e.highlighted&&(e.highlighted=!1,e.dirty=!0)}),RED.view.redraw()})}),o.open(!0)}}function n(){var n={global:!0};e("global",i),RED.nodes.eachWorkspace(function(t){n[t.id.replace(/\./g,"-")]=!0,e(t.id,s,t.label)}),RED.nodes.eachSubflow(function(t){n[t.id.replace(/\./g,"-")]=!0,e(t.id,r,t.name)}),$(".workspace-config-node-category").each(function(){var e=$(this).attr("id").substring("workspace-config-node-category-".length);n[e]||($(this).remove(),delete l[e])});var o=[],a={};RED.nodes.eachConfig(function(e){e.z?(a[e.z.replace(/\./g,"-")]=a[e.z.replace(/\./g,"-")]||[],a[e.z.replace(/\./g,"-")].push(e)):e.z||o.push(e)});for(var d in n)n.hasOwnProperty(d)&&t(d,a[d]||[]);t("global",o)}var o=document.createElement("div");o.className="sidebar-node-config",$('<div class="button-group sidebar-header"><a class="sidebar-header-button-toggle selected" id="workspace-config-node-filter-all" href="#"><span data-i18n="sidebar.config.filterAll"></span></a><a class="sidebar-header-button-toggle" id="workspace-config-node-filter-unused" href="#"><span data-i18n="sidebar.config.filterUnused"></span></a> </div>').appendTo(o);var a=$('<div><a class="sidebar-footer-button" id="workspace-config-node-collapse-all" href="#"><i class="fa fa-angle-double-up"></i></a> <a class="sidebar-footer-button" id="workspace-config-node-expand-all" href="#"><i class="fa fa-angle-double-down"></i></a></div>'),i=$("<div>").appendTo(o),s=$("<div>").appendTo(o),r=$("<div>").appendTo(o),d=!1,l={};return{init:function(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:o,toolbar:a,closeable:!0,visible:!1,onchange:function(){n()}}),RED.actions.add("core:show-config-tab",function(){RED.sidebar.show("config")}),$("#workspace-config-node-collapse-all").on("click",function(e){e.preventDefault();for(var t in l)l.hasOwnProperty(t)&&l[t].close()}),$("#workspace-config-node-expand-all").on("click",function(e){e.preventDefault();for(var t in l)l.hasOwnProperty(t)&&l[t].size()>0&&l[t].open()}),$("#workspace-config-node-filter-all").on("click",function(e){e.preventDefault(),d&&($(this).addClass("selected"),$("#workspace-config-node-filter-unused").removeClass("selected"),d=!d,n())}),$("#workspace-config-node-filter-unused").on("click",function(e){e.preventDefault(),d||($(this).addClass("selected"),$("#workspace-config-node-filter-all").removeClass("selected"),d=!d,n())})},show:function(e){"boolean"==typeof e&&(e?$("#workspace-config-node-filter-unused").click():$("#workspace-config-node-filter-all").click()),n(),"string"==typeof e&&($("#workspace-config-node-filter-all").click(),e=e.replace(/\./g,"-"),setTimeout(function(){var t=$(".palette_node_id_"+e),n=t.position().top,o=t.height(),a=$(".sidebar-node-config"),i=a.height();n+o>i?a.animate({scrollTop:"-="+(i-(n+o)-30)},150):n<0&&a.animate({scrollTop:"+="+(n-10)},150);var s=21,r=function(){s%2==0?t.removeClass("node_highlighted"):t.addClass("node_highlighted"),--s>=0&&setTimeout(r,100)};r()},100)),RED.sidebar.show("config")},refresh:n}}(),RED.palette.editor=function(){function e(e,t){for(var n=e.split(".").map(function(e){return parseInt(e)}),o=t.split(".").map(function(e){return parseInt(e)}),a=0;a<3;a++){var i=n[a]-o[a];if(i<0)return-1;if(i>0)return 1}return 0}function t(e,t,n){var o={module:e};t&&(o.version=t),$.ajax({url:"nodes",type:"POST",data:JSON.stringify(o),contentType:"application/json; charset=utf-8"}).done(function(e,t,o){n()}).fail(function(e,t,o){n(e)})}function n(e,t){$.ajax({url:"nodes/"+e,type:"DELETE"}).done(function(e,n,o){t()}).fail(function(e,n,o){t(e)})}function o(){for(var e in O)O.hasOwnProperty(e)&&r(e)}function a(e){P.hasOwnProperty(e)||(P[e]=setTimeout(function(){delete P[e],r(e)},100))}function i(e){var t=/^rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)[,)]/.exec(e);if(t){var n=parseInt(t[1]),o=parseInt(t[2]),a=parseInt(t[3]);if((299*n+587*o+114*a)/1e3>160)return n=Math.floor(.8*n),o=Math.floor(.8*o),a=Math.floor(.8*a),"rgb("+n+","+o+","+a+")"}return e}function s(e){new Date,new Date(e);var t=(Date.now()-new Date(e).getTime())/1e3;if(t<60)return RED._("palette.editor.times.seconds");if((t=Math.floor(t/60))<10)return RED._("palette.editor.times.minutes");if(t<60)return RED._("palette.editor.times.minutesV",{count:t});if((t=Math.floor(t/60))<24)return RED._("palette.editor.times.hoursV",{count:t});if((t=Math.floor(t/24))<7)return RED._("palette.editor.times.daysV",{count:t});var n=Math.floor(t/7);if(n<4)return RED._("palette.editor.times.weeksV",{count:n});var o=Math.floor(n/4);if(n%=4,o<12)return RED._("palette.editor.times.monthsV",{count:o});var a=Math.floor(o/12);return 0===(o%=12)?RED._("palette.editor.times.yearsV",{count:a}):RED._("palette.editor.times.year"+(a>1?"s":"")+"MonthsV",{y:a,count:o})}function r(t){if(O.hasOwnProperty(t)){var n=O[t].info,o=O[t].elements;if(o){var a=0,s=0,r=0;o.errorList.empty(),O[t].totalUseCount=0,O[t].setUseCount={};for(var d in n.sets)if(n.sets.hasOwnProperty(d)){var l=0,c=n.sets[d],p=o.sets[d];c.err&&(r++,$("<li>").text(c.err).appendTo(o.errorList)),c.enabled&&(a+=c.types.length),s+=c.types.length;for(var u=0;u<n.sets[d].types.length;u++){var f=n.sets[d].types[u];l+=S[f]||0;var h=p.swatches[f];if(c.enabled){var g=RED.nodes.getType(f);g&&g.color?(h.css({background:g.color}),h.css({border:"1px solid "+i(h.css("backgroundColor"))})):h.css({background:"#eee",border:"1px dashed #999"})}else h.css({background:"#eee",border:"1px dashed #999"})}O[t].setUseCount[d]=l,O[t].totalUseCount+=l,p.setRow.toggleClass("palette-module-set-disabled",!c.enabled)}0===r?o.errorRow.hide():o.errorRow.show();var v=a===s?s:a+" / "+s;o.setCount.text(RED._("palette.editor.nodeCount",{count:s,label:v})),O[t].totalUseCount>0?o.removeButton.hide():(n.local&&o.removeButton.css("display","inline-block"),o.container.toggleClass("disabled",0===a))}n.pending_version?(o.versionSpan.html(n.version+' <i class="fa fa-long-arrow-right"></i> '+n.pending_version).appendTo(o.metaRow),o.updateButton.text(RED._("palette.editor.updated")).addClass("disabled").show()):j.hasOwnProperty(t)&&1===e(j[t].version,n.version)?(o.updateButton.show(),o.updateButton.text(RED._("palette.editor.update",{version:j[t].version}))):o.updateButton.hide()}else{O[t]={info:RED.nodes.registry.getModule(t)};var m=[t];for(var b in O[t].info.sets)O[t].info.sets.hasOwnProperty(b)&&(m.push(b),m=m.concat(O[t].info.sets[b].types));O[t].index=m.join(",").toLowerCase(),E.editableList("addItem",O[t])}}function d(e){L=e.toLowerCase();var t=E.editableList("filter"),n=E.editableList("length");""===e?w.searchBox("count"):w.searchBox("count",t+" / "+n)}function l(e,t,n,o){if(I.push(e||o),e?N=!0:(o.modules&&(o.modules.forEach(function(e){j[e.id]=e,e.index=[e.id],e.keywords&&(e.index=e.index.concat(e.keywords)),e.updated_at?e.timestamp=new Date(e.updated_at).getTime():e.timestamp=0,e.index=e.index.join(",").toLowerCase()}),_=_.concat(o.modules)),D.searchBox("count",_.length)),R>1&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>"+I.length+"/"+R),I.length===R){N&&RED.notify(RED._("palette.editor.errors.catalogLoadFailed",{url:t}),"error",!1,8e3);var a=250-(Date.now()-T);setTimeout(function(){$("#palette-module-install-shade").hide()},Math.max(a,0))}}function c(){if(0===_.length){_=[],j={},x.editableList("empty"),$(".palette-module-shade-status").html(RED._("palette.editor.loading"));var e=RED.settings.theme("palette.catalogues")||["https://apt.node-blue.com/catalog.json"];I=[],N=!1,R=e.length,e.length>1&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>0/"+e.length),$("#palette-module-install-shade").show(),T=Date.now();var t=0;e.forEach(function(e,n){$.getJSON(e,{_:(new Date).getTime()},function(t){l(null,e,n,t),o()}).fail(function(t,o,a){l(t,e,n)}).always(function(){++t===R&&D.searchBox("change")})})}}function p(){if(x.editableList("empty"),""!==D.searchBox("value").trim()){C.sort(A);for(var e=0;e<Math.min(10,C.length);e++)x.editableList("addItem",C[e]);0===C.length&&x.editableList("addItem",{}),C.length>10&&x.editableList("addItem",{start:10,more:C.length-10})}else x.editableList("addItem",{count:_.length})}function u(e,t){return e.info.id.localeCompare(t.info.id)}function f(e,t){return-1*(e.info.timestamp-t.info.timestamp)}function h(){return c(),y.activateTab("nodes"),k}function g(){k=$('<div id="user-settings-tab-palette"></div>');var e=$('<div id="palette-editor"><ul id="palette-editor-tabs"></ul></div>').appendTo(k);y=RED.tabs.create({element:k.find("#palette-editor-tabs"),onchange:function(t){e.find(".palette-editor-tab").hide(),t.content.show(),w&&w.searchBox("value",""),D&&D.searchBox("value",""),"install"===t.id?D&&D.focus():w&&w.focus()},minimumActiveTabWidth:110});var t=$("<div>",{class:"palette-editor-tab"}).appendTo(e);y.addTab({id:"nodes",label:RED._("palette.editor.tab-nodes"),content:t});var n=$("<div>",{class:"palette-search"}).appendTo(t);w=$('<input type="text" data-i18n="[placeholder]palette.filter"></input>').appendTo(n).searchBox({delay:200,change:function(){d($(this).val())}}),E=$("<ol>",{id:"palette-module-list",style:"position: absolute;top: 35px;bottom: 0;left: 0;right: 0px;"}).appendTo(t).editableList({addButton:!1,scrollOnAdd:!1,sort:function(e,t){return e.info.name.localeCompare(t.info.name)},filter:function(e){return""===L||(""===L||e.index.indexOf(L)>-1)},addItem:function(e,t,n){var o=n.info;if(o){var i=$("<div>",{class:"palette-module-header"}).appendTo(e),s=$('<div class="palette-module-meta palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(i);$("<span>").text(o.name).appendTo(s);var r=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(i),d=$("<span>").text(o.version).appendTo(r),l=$('<div class="palette-module-meta palette-module-errors"><i class="fa fa-warning"></i></div>').hide().appendTo(i),c=$('<ul class="palette-module-error-list"></ul>').appendTo(l),p=$("<div>",{class:"palette-module-meta"}).appendTo(i),u=$('<a href="#" class="editor-button editor-button-small palette-module-set-button"><i class="fa fa-angle-right palette-module-node-chevron"></i> </a>').appendTo(p),f=$("<span>").appendTo(u),h=$("<div>",{class:"palette-module-button-group"}).appendTo(p),g=$('<a href="#" class="editor-button editor-button-small"></a>').text(RED._("palette.editor.update")).appendTo(h);g.attr("id","up_"+Math.floor(1e9*Math.random())),g.click(function(t){t.preventDefault(),$(this).hasClass("disabled")||v(o,j[o.name].version,e,function(e){})});var b=$('<a href="#" class="editor-button editor-button-small"></a>').text(RED._("palette.editor.remove")).appendTo(h);b.attr("id","up_"+Math.floor(1e9*Math.random())),b.click(function(t){t.preventDefault(),m(o,e,function(e){})}),o.local||b.hide();var y=$("<div>",{class:"palette-module-content"}).appendTo(e),w=$('<div class="palette-module-shade hide"><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(e);n.elements={updateButton:g,removeButton:b,errorRow:l,errorList:c,setCount:f,container:e,shade:w,versionSpan:d,sets:{}},u.click(function(t){t.preventDefault(),e.hasClass("expanded")?(e.removeClass("expanded"),y.slideUp()):(e.addClass("expanded"),y.slideDown())});var D=Object.keys(o.sets);D.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),D.forEach(function(e){var t=o.sets[e],a=$("<div>",{class:"palette-module-set"}).appendTo(y),i=($("<div>",{class:"palette-module-set-button-group"}).appendTo(a),{});t.types.forEach(function(e){var t=$("<div>",{class:"palette-module-type"}).appendTo(a);i[e]=$("<span>",{class:"palette-module-type-swatch"}).appendTo(t),$("<span>",{class:"palette-module-type-node"}).text(e).appendTo(t)}),n.elements.sets[t.name]={setRow:a,swatches:i}}),a(o.name)}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e)}});var o=$("<div>",{class:"palette-editor-tab hide"}).appendTo(e);y.addTab({id:"install",label:RED._("palette.editor.tab-install"),content:o});var i=$("<div>",{class:"palette-editor-toolbar"}).appendTo(o),r=$("<div>",{class:"palette-search"}).appendTo(o);D=$('<input type="text" data-i18n="[placeholder]palette.search"></input>').appendTo(r).searchBox({delay:300,change:function(){var e=$(this).val().trim().toLowerCase();e.length>0?(C=_.filter(function(t){return t.index.indexOf(e)>-1}).map(function(e){return{info:e}}),p(),D.searchBox("count",C.length+" / "+_.length)):(D.searchBox("count",_.length),x.editableList("empty"),x.editableList("addItem",{count:_.length}))}}),$("<span>").text(RED._("palette.editor.sort")+" ").appendTo(i);var l=$('<span class="button-group"></span>').appendTo(i),h=$('<a href="#" class="sidebar-header-button-toggle selected" data-i18n="palette.editor.sortAZ"></a>').appendTo(l),g=$('<a href="#" class="sidebar-header-button-toggle" data-i18n="palette.editor.sortRecent"></a>').appendTo(l);h.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),g.removeClass("selected"),A=u,p())}),g.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),h.removeClass("selected"),A=f,p())});var R=$("<span>").appendTo(i);$('<a href="#" class="sidebar-header-button"><i class="fa fa-refresh"></i></a>').appendTo(R).click(function(e){e.preventDefault(),_=[],j={},c()}),x=$("<ol>",{style:"position: absolute;top: 78px;bottom: 0;left: 0;right: 0px;"}).appendTo(o).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){if(n.count)$("<div>",{class:"red-ui-search-empty"}).text(RED._("palette.editor.moduleCount",{count:n.count})).appendTo(e);else if(n.more){e.addClass("palette-module-more");var o=$("<div>",{class:"palette-module-header palette-module"}).appendTo(e);$('<a href="#"></a>').text(RED._("palette.editor.more",{count:n.more})).appendTo(o).click(function(e){e.preventDefault(),x.editableList("removeItem",n);for(var t=n.start;t<Math.min(n.start+10,n.start+n.more);t++)x.editableList("addItem",C[t]);n.more>10&&x.editableList("addItem",{start:n.start+10,more:n.more-10})})}else if(n.info){var a=n.info,i=$("<div>",{class:"palette-module-header"}).appendTo(e),r=$('<div class="palette-module-meta"><i class="fa fa-cube"></i></div>').appendTo(i);$("<span>",{class:"palette-module-name"}).text(a.name||a.id).appendTo(r),$('<a target="_blank" class="palette-module-link"><i class="fa fa-external-link"></i></a>').attr("href",a.url).appendTo(r);var d=$('<div class="palette-module-meta"></div>').appendTo(i);$("<div>",{class:"palette-module-description"}).text(a.description).appendTo(d);var l=$('<div class="palette-module-meta"></div>').appendTo(i);$('<span class="palette-module-version"><i class="fa fa-tag"></i> '+a.version+"</span>").appendTo(l),$('<span class="palette-module-updated"><i class="fa fa-calendar"></i> '+s(a.updated_at)+"</span>").appendTo(l);var c=$("<div>",{class:"palette-module-meta"}).appendTo(i),p=$("<div>",{class:"palette-module-button-group"}).appendTo(c),u=$('<a href="#" class="editor-button editor-button-small"></a>').text(RED._("palette.editor.install")).appendTo(p);u.click(function(t){t.preventDefault(),$(this).hasClass("disabled")||b(a,e,function(e){})}),O.hasOwnProperty(a.id)&&(u.addClass("disabled"),u.text(RED._("palette.editor.installed"))),n.elements={installButton:u}}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e)}}),$('<div id="palette-module-install-shade" class="palette-module-shade hide"><div class="palette-module-shade-status"></div><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(o)}function v(e,n,o,a){if(!1!==RED.settings.theme("palette.editable"))var i=RED.notify(RED._("palette.editor.confirm.update.body",{module:e.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.close()}},{text:RED._("palette.editor.confirm.button.update"),class:"primary palette-module-install-confirm-button-update",click:function(){var s=RED.utils.addSpinnerOverlay(o,!0);t(e.name,n,function(t){s.remove(),t&&t.responseJSON&&RED.notify(RED._("palette.editor.errors.updateFailed",{module:e.name,message:t.responseJSON.message})),a(t)}),i.close()}}]});else a(new Error("Palette not editable"))}function m(e,t,o){if(!1!==RED.settings.theme("palette.editable"))var a=RED.notify(RED._("palette.editor.confirm.remove.body",{module:e.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.close()}},{text:RED._("palette.editor.confirm.button.remove"),class:"primary palette-module-install-confirm-button-remove",click:function(){var o=RED.utils.addSpinnerOverlay(t,!0);n(e.name,function(t){o.remove(),t&&t.responseJSON&&RED.notify(RED._("palette.editor.errors.removeFailed",{module:e.name,message:t.responseJSON.message}))}),a.close()}}]});else o(new Error("Palette not editable"))}function b(e,n,o){if(!1!==RED.settings.theme("palette.editable")){var a=[{text:RED._("common.label.cancel"),click:function(){i.close()}}];e.url&&a.push({text:RED._("palette.editor.confirm.button.review"),class:"primary palette-module-install-confirm-button-install",click:function(){var t=e.url||"";window.open(t)}}),a.push({text:RED._("palette.editor.confirm.button.install"),class:"primary palette-module-install-confirm-button-install",click:function(){var a=RED.utils.addSpinnerOverlay(n,!0);t(e.id,e.version,function(t){a.remove(),t&&t.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:e.id,message:t.responseJSON.message})),o(t)}),i.close()}});var i=RED.notify(RED._("palette.editor.confirm.install.body",{module:e.id}),{modal:!0,fixed:!0,buttons:a})}else o(new Error("Palette not editable"))}var y,w,D,E,x,R,T,k,_=[],C=[],j={},S={},O={},P={},L="",I=[],N=!1,A=u;return{init:function(){!1!==RED.settings.theme("palette.editable")&&(g(),RED.userSettings.add({id:"palette",title:RED._("palette.editor.palette"),get:h,close:function(){k.detach()},focus:function(){y.resize(),setTimeout(function(){w.focus()},200)}}),RED.actions.add("core:manage-palette",function(){RED.userSettings.show("palette")}),RED.events.on("registry:module-updated",function(e){a(e.module)}),RED.events.on("registry:node-set-enabled",function(e){a(e.module)}),RED.events.on("registry:node-set-disabled",function(e){a(e.module)}),RED.events.on("registry:node-type-added",function(e){/^subflow:/.test(e)||a(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-type-removed",function(e){/^subflow:/.test(e)||a(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-set-added",function(e){a(e.module);for(var t=0;t<C.length;t++)if(C[t].info.id===e.module){var n=C[t].elements.installButton;n.addClass("disabled"),n.text(RED._("palette.editor.installed"));break}}),RED.events.on("registry:node-set-removed",function(e){if(!RED.nodes.registry.getModule(e.module)){var t=O[e.module];if(t){E.editableList("removeItem",t),delete O[e.module];for(var n=0;n<C.length;n++)if(C[n].info.id===e.module){var o=C[n].elements.installButton;o.removeClass("disabled"),o.text(RED._("palette.editor.install"));break}}}}),RED.events.on("nodes:add",function(e){/^subflow:/.test(e.type)||(S[e.type]=(S[e.type]||0)+1,1===S[e.type]&&a(RED.nodes.registry.getNodeSetForType(e.type).module))}),RED.events.on("nodes:remove",function(e){S.hasOwnProperty(e.type)&&(S[e.type]--,0===S[e.type]&&(delete S[e.type],a(RED.nodes.registry.getNodeSetForType(e.type).module)))}))},install:b}}(),RED.editor=function(){function e(e,t){return"credentials/"+e.replace(/\s+/g,"-")+"/"+t}function t(e){var o=e.valid,a=e.changed;e.valid=!0;var i,s,r;if(0===e.type.indexOf("subflow:"))s=(i=RED.nodes.subflow(e.type.substring(8))).valid,r=i.changed,void 0===s&&(s=t(i),r=i.changed),e.valid=s&&n(e,e._def.defaults,e),e.changed=e.changed||r;else if(e._def)e.valid=n(e,e._def.defaults,e),e._def._creds&&(e.valid=e.valid&&n(e,e._def.credentials,e._def._creds));else if("subflow"==e.type){for(var d=RED.nodes.filterNodes({z:e.id}),l=0;l<d.length;l++)s=d[l].valid,r=d[l].changed,void 0===s&&(s=t(d[l]),r=d[l].changed),e.valid=e.valid&&s,e.changed=e.changed||r;var c=RED.nodes.filterNodes({type:"subflow:"+e.id}),p={};for(l=0;l<c.length;l++)c[l].valid=e.valid,c[l].changed=c[l].changed||e.changed,c[l].dirty=!0,p[c[l].z]=!0;Object.keys(p).forEach(function(e){var n=RED.nodes.subflow(e);n&&t(n)})}return o===e.valid&&a===e.changed||(e.dirty=!0,(i=RED.nodes.subflow(e.z))&&t(i)),e.valid}function n(e,t,n){var a=!0;for(var i in t)t.hasOwnProperty(i)&&(o(e,t,i,n[i])||(a=!1));if(e.icon){var s=RED.utils.separateIconPath(e.icon);if(!s.module)return a;var r=RED.nodes.getIconSets()[s.module];r&&-1!==r.indexOf(s.file)||(a=!1)}return a}function o(e,t,n,o){var a=!0;if(/^\$\([a-zA-Z_][a-zA-Z0-9_]*\)$/.test(o))return!0;if("required"in t[n]&&t[n].required&&(a=""!==o),a&&"validate"in t[n])try{a=t[n].validate.call(e,o)}catch(t){console.log("Validation error:",e.type,e.id,"property: "+n,"value:",o,t)}if(a&&t[n].type&&RED.nodes.getType(t[n].type)&&!("validate"in t[n]))if(o&&"_ADD_"!=o){var i=RED.nodes.node(o);a=null!==i&&(null==i.valid||i.valid)}else a=t[n].hasOwnProperty("required")&&!t[n].required;return a}function a(e,t){for(var n in e._def.defaults)e._def.defaults.hasOwnProperty(n)&&s(e,e._def.defaults,n,t);if(e._def.credentials)for(n in e._def.credentials)e._def.credentials.hasOwnProperty(n)&&s(e,e._def.credentials,n,t);i(e)}function i(e){if(e._def.hasOwnProperty("defaults")&&!e._def.defaults.hasOwnProperty("icon")&&e.icon){var t=RED.utils.separateIconPath(e.icon),n=RED.nodes.getIconSets()[t.module],o=$("#node-settings-icon-module"),a=$("#node-settings-icon-file");n?-1===n.indexOf(t.file)?(o.removeClass("input-error"),a.addClass("input-error")):(o.removeClass("input-error"),a.removeClass("input-error")):(o.addClass("input-error"),a.removeClass("input-error"))}}function s(e,t,n,a){var i=$("#"+a+"-"+n);if(i.length>0){var s=i.val();t[n].hasOwnProperty("format")&&""!==t[n].format&&"DIV"===i[0].nodeName&&(s=i.text()),o(e,t,n,s)?i.removeClass("input-error"):i.addClass("input-error")}}function r(e,t){e.resize=!0,e.dirty=!0;var n=[];if(e.inputPorts)if(e.inputs<e.inputPorts.length){for(;e.inputs<e.inputPorts.length;)e.inputPorts.pop();RED.nodes.eachLink(function(t){t.target===e&&t.targetPort>=e.inputs&&-1===n.indexOf(t)&&n.push(t)})}else if(e.inputs>e.inputPorts.length)for(;e.inputs>e.inputPorts.length;)e.inputPorts.push(e.inputPorts.length);if(e.outputPorts)if(t&&RED.nodes.eachLink(function(o){o.source===e&&t.hasOwnProperty(o.sourcePort)&&("-1"===t[o.sourcePort]?n.push(o):o.sourcePort=t[o.sourcePort])}),e.outputs<e.outputPorts.length){for(;e.outputs<e.outputPorts.length;)e.outputPorts.pop();RED.nodes.eachLink(function(t){t.source===e&&t.sourcePort>=e.outputs&&-1===n.indexOf(t)&&n.push(t)})}else if(e.outputs>e.outputPorts.length)for(;e.outputs>e.outputPorts.length;)e.outputPorts.push(e.outputPorts.length);for(var o=0;o<n.length;o++)RED.nodes.removeLink(n[o]);return n}function d(e,t,n,o){var a=$("#"+o+"-"+t);if(0!==a.length){var i,s=a.width(),r=a.attr("style");s=null!==(i=/width\s*:\s*(\d+(%|[a-z]+))/i.exec(r))?i[1]:"70%";var d=$("<div></div>").css({display:"inline-block",position:"relative"}),l=$("<div></div>").css({position:"absolute",left:0,right:"40px"}).appendTo(d),c=$('<select id="'+o+"-"+t+'"></select>').appendTo(l);d.width(s).height(a.height()),0===d.width()&&d.width("70%"),a.replaceWith(d),c.attr("style","width:100%"),w(t,n,e[t],o),$('<a id="'+o+"-lookup-"+t+'" class="editor-button"><i class="fa fa-pencil"></i></a>').css({position:"absolute",right:0,top:0}).appendTo(d),$("#"+o+"-lookup-"+t).click(function(e){b(t,n,c.find(":selected").val(),o),e.preventDefault()});var p="",u=RED.nodes.node(e[t]);RED.nodes.getType(n);u&&(p=RED.utils.getNodeLabel(u,u.id)),a.val(p)}}function l(e,t,n,o){var a=$("#"+o+"-"+t);a.val(e[t]),a.attr("type","hidden");var i=$("<a>",{id:o+"-edit-"+t,class:"editor-button"});a.after(i),e[t]?i.text(RED._("editor.configEdit")):i.text(RED._("editor.configAdd")),i.click(function(e){b(t,n,a.val()||"_ADD_",o),e.preventDefault()})}function c(e,t,n,o){var a=$("#"+n+"-"+t);if(0!==a.length)if("checkbox"===a.attr("type"))a.prop("checked",e[t]);else{var i=e[t];null==i&&(i=""),void 0!==o&&o[t].hasOwnProperty("format")&&""!==o[t].format&&"DIV"===a[0].nodeName?(a.html(RED.text.format.getHtml(i,o[t].format,{},!1,"en")),RED.text.format.attach(a[0],o[t].format,{},!1,"en")):(a.val(i),"INPUT"!==a[0].nodeName&&"TEXTAREA"!==a[0].nodeName||RED.text.bidi.prepareInput(a))}}function p(e,t,n,o){var i=$("#"+o+"-"+n);void 0!==t&&"format"in t[n]&&""!==t[n].format&&"DIV"===i[0].nodeName?$("#"+o+"-"+n).on("change keyup",function(t,n){n||a(e,o)}):$("#"+o+"-"+n).change(function(t,n){n||a(e,o)})}function u(e,t,n,o){var a;for(a in t)t.hasOwnProperty(a)&&("password"==t[a].type?n[a]?$("#"+o+"-"+a).val(n[a]):n["has_"+a]?$("#"+o+"-"+a).val("__PWRD__"):$("#"+o+"-"+a).val(""):c(n,a,o,t),p(e,t,a,o))}function f(e,t,n){var o=!1;e.credentials||(e.credentials={_:{}});for(var a in t)if(t.hasOwnProperty(a)){var i=$("#"+n+"-"+a).val();if("password"==t[a].type){if(e.credentials["has_"+a]=""!==i,"__PWRD__"==i)continue;o=!0}e.credentials[a]=i,i!=e.credentials._[a]&&(o=!0)}return o}function h(t,n,o,i){for(var s in n.defaults)if(n.defaults.hasOwnProperty(s)){if(n.defaults[s].type){var r=RED.nodes.getType(n.defaults[s].type);r?r.exclusive?l(t,s,n.defaults[s].type,o):d(t,s,n.defaults[s].type,o):(console.log("Unknown type:",n.defaults[s].type),c(t,s,o,n.defaults))}else c(t,s,o,n.defaults);p(t,n.defaults,s,o)}var f=function(){if(n.oneditprepare)try{n.oneditprepare.call(t)}catch(e){console.log("oneditprepare",t.id,t.type,e.toString())}for(var e in n.defaults)n.defaults.hasOwnProperty(e)&&$("#"+o+"-"+e).trigger("change",[!0]);if(n.credentials)for(e in n.credentials)n.credentials.hasOwnProperty(e)&&$("#"+o+"-"+e).trigger("change",[!0]);a(t,o),i&&i()};n.credentials?t.credentials?(u(t,n.credentials,t.credentials,o),f()):$.getJSON(e(t.type,t.id),function(e){t.credentials=e,t.credentials._=$.extend(!0,{},e),u(t,n.credentials,t.credentials,o),f()}):f()}function g(){for(var e,t='<ul class="editor-tray-breadcrumbs">',n=E.length-1;n<E.length;n++){var o=E[n];if(e=o.type,"_expression"===o.type)e=RED._("expressionEditor.title");else if("_json"===o.type)e=RED._("jsonEditor.title");else if("_markdown"===o.type)e=RED._("markdownEditor.title");else if("_buffer"===o.type)e=RED._("bufferEditor.title");else if("subflow"===o.type)e=RED._("subflow.editSubflow",{name:o.name});else if(0===o.type.indexOf("subflow:")){var a=RED.nodes.subflow(o.type.substring(8));e=RED._("subflow.editSubflow",{name:a.name})}else{if(void 0!==o._def.paletteLabel)try{e=("function"==typeof o._def.paletteLabel?o._def.paletteLabel.call(o._def):o._def.paletteLabel)||""}catch(e){console.log("Definition error: "+o.type+".paletteLabel",e)}n===E.length-1&&(e=RED.nodes.node(o.id)?RED._("editor.editNode",{type:e}):RED._("editor.addNewConfig",{type:e}))}t+="<li>"+e+"</li>"}return t+="</ul>",e}function v(e,t,n,o){var a=$('<form id="'+t+'" class="form-horizontal" autocomplete="off"></form>').appendTo(e);return a.html($("script[data-template-name='"+n+"']").html()),o=o||"node-red",a.find("[data-i18n]").each(function(){for(var e=$(this).attr("data-i18n").split(";"),t=0;t<e.length;t++){var n=e[t];if(-1===n.indexOf(":")){var a="";if(0===n.indexOf("[")){var i=n.split("]");a=i[0]+"]",n=i[1]}e[t]=a+o+":"+n}}$(this).attr("data-i18n",e.join(";"))}),$('<input type="password" style="display: none;" />').prependTo(a),$('<input type="text" style="display: none;" />').prependTo(a),a.submit(function(e){e.preventDefault()}),a}function m(e,t,n){var o=$("#node-label-form-inputs").children().find("input"),a=$("#node-label-form-outputs").children().find("input"),i=!1,s=!1,r=o.map(function(){var e=$(this).val();return i=i||""!==e,e}).toArray().slice(0,e.inputs);return(void 0===e.inputLabels&&i||void 0!==e.inputLabels&&JSON.stringify(r)!==JSON.stringify(e.inputLabels))&&(t.inputLabels=e.inputLabels,e.inputLabels=r,s=!0),i=!1,r=new Array(e.outputs),a.each(function(){var e=$(this).attr("id").substring(23);if(!n||!n.hasOwnProperty(e)||-1!==(e=parseInt(n[e]))){var t=$(this).val();i=i||""!==t,r[e]=t}}),(void 0===e.outputLabels&&i||void 0!==e.outputLabels&&JSON.stringify(r)!==JSON.stringify(e.outputLabels))&&(t.outputLabels=e.outputLabels,e.outputLabels=r,s=!0),s}function b(e,n,o,a){var i,s="_ADD_"==o,r=RED.nodes.getType(n),d=RED.nodes.node(o);i="node-red"===r.set.module?"node-red":r.set.id;var l="",c=RED.nodes.subflow(RED.workspaces.active());if(c&&(l=c.id),null==d){d={id:RED.nodes.id(),_def:r,type:n,z:l,users:[]};for(var p in r.defaults)r.defaults[p].value&&(d[p]=JSON.parse(JSON.stringify(r.defaults[p].value)));d._=r._}E.push(d),RED.view.state(RED.state.EDITING);var u={title:g(),resize:function(){if(d&&d._def.oneditresize){var e=$("#node-config-dialog-edit-form");try{d._def.oneditresize.call(d,{width:e.width(),height:e.height()})}catch(e){console.log("oneditresize",d.id,d.type,e.toString())}}},open:function(e,t){e.find(".editor-tray-header");var o=e.find(".editor-tray-footer");!1!==r.hasUsers&&o.prepend('<div id="node-config-dialog-user-count"><i class="fa fa-info-circle"></i> <span></span></div>'),o.append('<span id="node-config-dialog-scope-container"><span id="node-config-dialog-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="node-config-dialog-scope"></select></span>');var a=v(e.find(".editor-tray-body"),"node-config-dialog-edit-form",n,i);h(d,r,"node-config-input",function(){d._def.exclusive?$("#node-config-dialog-scope").hide():$("#node-config-dialog-scope").show(),$("#node-config-dialog-scope-warning").hide();var e={};d.users.forEach(function(t){e[t.z]=!0});var n=Object.keys(e).length,o=$("#node-config-dialog-scope").empty();o.off("change"),o.append('<option value=""'+(d.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),o.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace(function(t){var n=t.label;e[t.id]&&(n="* "+n),o.append('<option value="'+t.id+'"'+(t.id==d.z?" selected":"")+">"+n+"</option>")}),o.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow(function(t){var n=t.name;e[t.id]&&(n="* "+n),o.append('<option value="'+t.id+'"'+(t.id==d.z?" selected":"")+">"+n+"</option>")}),n>0&&o.on("change",function(){var t=$(this).val();""===t?$("#node-config-dialog-scope-warning").hide():!e[t]||n>1?$("#node-config-dialog-scope-warning").show():$("#node-config-dialog-scope-warning").hide()}),o.i18n(),a.i18n(),!1!==r.hasUsers&&$("#node-config-dialog-user-count").find("span").text(RED._("editor.nodesUse",{count:d.users.length})).parent().show(),t()})},close:function(){RED.workspaces.refresh(),E.pop()},show:function(){d&&RED.sidebar.info.refresh(d)}};u.buttons=[{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var e=n,t=d.id,o=RED.nodes.getType(e);if(o.oneditcancel&&o.oneditcancel){var a=RED.nodes.node(t);if(a)try{o.oneditcancel.call(a,!1)}catch(e){console.log("oneditcancel",a.id,a.type,e.toString())}else try{o.oneditcancel.call({id:t},!0)}catch(n){console.log("oneditcancel",t,e,n.toString())}}RED.tray.close()}},{id:"node-config-dialog-ok",text:s?RED._("editor.configAdd"):RED._("editor.configUpdate"),class:"primary",click:function(){var o,i,r=e,l=(d.id,n),c=s,p=RED.nodes.getType(l),u=$("#node-config-dialog-scope").val();if(p.oneditsave)try{p.oneditsave.call(d)}catch(e){console.log("oneditsave",d.id,d.type,e.toString())}for(o in p.defaults)if(p.defaults.hasOwnProperty(o)){var h;if(i=$("#node-config-input-"+o),null!=(h="checkbox"===i.attr("type")?i.prop("checked"):"format"in p.defaults[o]&&""!==p.defaults[o].format&&"DIV"===i[0].nodeName?i.text():i.val())&&h!==d[o]){if(d._def.defaults[o].type){"_ADD_"==h&&(h="");var g=RED.nodes.node(d[o]);if(g){var v=g.users;v.splice(v.indexOf(d),1)}(g=RED.nodes.node(h))&&g.users.push(d)}d[o]=h}}d.label=p.label,d.z=u,u&&(d.users=d.users.filter(function(e){var n=!0;for(var o in e._def.defaults)e._def.defaults.hasOwnProperty(o)&&e._def.defaults[o].type===d.type&&e[o]===d.id&&e.z!==u&&(n=!1,e[o]=null,e.dirty=!0,e.changed=!0,t(e));return n})),c&&RED.nodes.add(d),p.credentials&&f(d,p.credentials,"node-config-input"),t(d);var m={};m[d.id]=!0;for(var b=d.users.slice();b.length>0;){var y=b.pop();m[y.id]||(m[y.id]=!0,y.users&&(b=b.concat(y.users)),t(y))}RED.nodes.dirty(!0),RED.view.redraw(!0),c||RED.events.emit("editor:save",d),RED.tray.close(function(){w(r,l,d.id,a)})}}],s||u.buttons.unshift({class:"leftButton",text:RED._("editor.configDelete"),click:function(){var o=e,i=d.id,s=n,r=RED.nodes.getType(s);try{r.ondelete&&(console.log("Deprecated API warning: config node type ",s," has an ondelete function - should be oneditdelete"),r.ondelete.call(d)),r.oneditdelete&&r.oneditdelete.call(d)}catch(e){console.log("oneditdelete",d.id,d.type,e.toString())}for(var l={t:"delete",nodes:[d],changes:{},dirty:RED.nodes.dirty()},c=0;c<d.users.length;c++){var p=d.users[c];l.changes[p.id]={changed:p.changed,valid:p.valid};for(var u in p._def.defaults)p._def.defaults.hasOwnProperty(u)&&p[u]==i&&(l.changes[p.id][u]=i,p[u]="",p.changed=!0,p.dirty=!0);t(p)}RED.nodes.remove(i),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(l),RED.tray.close(function(){w(o,s,"",a)})}}),RED.tray.show(u)}function y(e,t){return e.__label__<t.__label__?-1:e.__label__>t.__label__?1:0}function w(e,t,n,o){if(o){var a=$("#"+o+"-edit-"+e);if(a.length)n?a.text(RED._("editor.configEdit")):a.text(RED._("editor.configAdd")),$("#"+o+"-"+e).val(n);else{var i=$("#"+o+"-"+e),s=RED.nodes.getType(t);i.children().remove();var r=RED.nodes.workspace(RED.workspaces.active());r||(r=RED.nodes.subflow(RED.workspaces.active()));var d=[];RED.nodes.eachConfig(function(e){if(e.type==t&&(!e.z||e.z===r.id)){var n=RED.utils.getNodeLabel(e,e.id);e.__label__=n,d.push(e)}});var l=y;"function"==typeof s.sort&&(l=s.sort);try{d.sort(l)}catch(e){console.log("Definition error: "+s.type+".sort",e)}d.forEach(function(e){i.append('<option value="'+e.id+'"'+(n==e.id?" selected":"")+">"+RED.text.bidi.enforceTextDirectionWithUCC(e.__label__)+"</option>"),delete e.__label__}),i.append('<option value="_ADD_"'+(""===n?" selected":"")+">"+RED._("editor.addNewType",{type:t})+"</option>"),window.setTimeout(function(){i.change()},50)}}}function D(e){var t=[],n=0,o=e.length;for(n=0;n<o;n++){var a=e.charCodeAt(n);a<128?t.push(a):a<2048?(t.push(192|a>>6),t.push(128|63&a)):a<55296||a>=57344?(t.push(224|a>>12),t.push(128|a>>6&63),t.push(128|63&a)):(n++,a=65536+((1023&a)<<10|1023&e.charAt(n)),t.push(240|a>>18),t.push(128|a>>12&63),t.push(128|a>>6&63),t.push(128|63&a))}return t}var E=[],x={},R={};return{init:function(){RED.tray.init(),RED.actions.add("core:confirm-edit-tray",function(){$("#node-dialog-ok").click(),$("#node-config-dialog-ok").click()}),RED.actions.add("core:cancel-edit-tray",function(){$("#node-dialog-cancel").click(),$("#node-config-dialog-cancel").click()})},edit:function(e){var n,o,a=e;E.push(e),RED.view.state(RED.state.EDITING);var i=e.type;"subflow:"==e.type.substring(0,8)&&(i="subflow");var s={title:g(),buttons:[{id:"node-dialog-delete",class:"leftButton",text:RED._("common.label.delete"),click:function(){var e=RED.nodes.dirty(),t=[],n=[],o=RED.nodes.remove(a.id);t.push(a);var i={t:"delete",nodes:t=t.concat(o.nodes),links:n=n.concat(o.links),changes:{},dirty:e};RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(i),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(a._def){if(a._def.oneditcancel)try{a._def.oneditcancel.call(a)}catch(e){console.log("oneditcancel",a.id,a.type,e.toString())}for(var e in a._def.defaults)if(a._def.defaults.hasOwnProperty(e)){var t=a._def.defaults[e];if(t.type){var n=RED.nodes.getType(t.type);if(n&&n.exclusive){var o=$("#node-input-"+e).val()||"";""===o||a[e]||RED.nodes.remove(o)}}}}RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e,i,s={},d=!1,l=RED.nodes.dirty();if(a._def.oneditsave){var c={};for(e in a._def.defaults)a._def.defaults.hasOwnProperty(e)&&("string"==typeof a[e]||"number"==typeof a[e]?c[e]=a[e]:c[e]=$.extend(!0,{},{v:a[e]}).v);try{!0===a._def.oneditsave.call(a)&&(d=!0)}catch(e){console.log("oneditsave",a.id,a.type,e.toString())}for(e in a._def.defaults)a._def.defaults.hasOwnProperty(e)&&(null===c[e]||"string"==typeof c[e]||"number"==typeof c[e]?c[e]!==a[e]&&(s[e]=c[e],d=!0):JSON.stringify(c[e])!==JSON.stringify(a[e])&&(s[e]=c[e],d=!0))}var p;if(a._def.defaults)for(e in a._def.defaults)if(a._def.defaults.hasOwnProperty(e)){var u=$("#node-input-"+e);if(null!=(p="checkbox"===u.attr("type")?u.prop("checked"):"format"in a._def.defaults[e]&&""!==a._def.defaults[e].format&&"DIV"===u[0].nodeName?u.text():u.val())){if("inputs"===e){if(""===p.trim())continue;if(isNaN(p)){inputMap=JSON.parse(p);var h=0,g=!1;(y=Object.keys(inputMap)).forEach(function(e){isNaN(e)?(h++,delete inputMap[e]):(inputMap[e]=inputMap[e]+"","-1"!==inputMap[e]?(h++,inputMap[e]!==e?g=!0:delete inputMap[e]):g=!0)}),p=h,g&&(d=!0)}}if("outputs"===e){if(""===p.trim())continue;if(isNaN(p)){i=JSON.parse(p);var v=0,b=!1,y=Object.keys(i);y.forEach(function(e){isNaN(e)?(v++,delete i[e]):(i[e]=i[e]+"","-1"!==i[e]?(v++,i[e]!==e?b=!0:delete i[e]):b=!0)}),p=v,b&&(d=!0)}else p=parseInt(p)}if(a[e]!=p){if(a._def.defaults[e].type){"_ADD_"==p&&(p="");var w=RED.nodes.node(a[e]);if(w){var D=w.users;D.splice(D.indexOf(a),1)}(w=RED.nodes.node(p))&&w.users.push(a)}s[e]=a[e],a[e]=p,d=!0}}}if(a._def.credentials){var E=a._def.credentials,x=f(a,E,"node-input");d=d||x}var R=r(a,i);if(m(a,s,i)&&(d=!0),!a._def.defaults||!a._def.defaults.hasOwnProperty("icon")){var T=$("#node-settings-icon-module-hidden").val(),k=$("#node-settings-icon-file-hidden").val(),_=T&&k?T+"/"+k:"";if(n)if(_!==o)s.icon=a.icon,a.icon=_,d=!0;else{var C=RED.utils.getDefaultNodeIcon(a._def,a),j=C.module+"/"+C.file;o!==j&&(s.icon=a.icon,a.icon=j,d=!0)}else _!==a.icon&&(s.icon=a.icon,a.icon=_,d=!0)}if(d){var S=a.changed;a.changed=!0,RED.nodes.dirty(!0);var O=null;RED.nodes.subflow(RED.workspaces.active())&&(O=[],RED.nodes.eachNode(function(e){e.type=="subflow:"+RED.workspaces.active()&&(O.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,r(e))}));var P={t:"edit",node:a,changes:s,links:R,dirty:l,changed:S};i&&(P.outputMap=i),O&&(P.subflow={instances:O}),RED.history.push(P)}a.dirty=!0,t(a),RED.events.emit("editor:save",a),RED.tray.close()}}],resize:function(e){x[i]=e.width,$(".editor-tray-content").height(e.height-78);var t=$(".editor-tray-content form").height(e.height-78-40);if(a&&a._def.oneditresize)try{a._def.oneditresize.call(a,{width:t.width(),height:t.height()})}catch(e){console.log("oneditresize",a.id,a.type,e.toString())}},open:function(t,s){t.find(".editor-tray-footer");var r=t.find(".editor-tray-body");r.parent().css("overflow","hidden");var d=RED.stack.create({container:r,singleExpanded:!0}).add({title:RED._("editor.nodeProperties"),expanded:!0});d.content.addClass("editor-tray-content"),a&&RED.sidebar.info.refresh(a);var l;l="node-red"===e._def.set.module?"node-red":e._def.set.id;var c=RED.utils.getDefaultNodeIcon(e._def,e);o=c.module+"/"+c.file,n=!e.icon||e.icon===o,v(d.content,"dialog-form",i,l),h(e,e._def,"node-input",function(){r.i18n(),s()})},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),a&&RED.sidebar.info.refresh(a),RED.workspaces.refresh(),RED.view.redraw(!0),E.pop()},show:function(){a&&RED.sidebar.info.refresh(a)}};if(x.hasOwnProperty(i)&&(s.width=x[i]),"subflow"===i){var d=a.type.substring(8);s.buttons.unshift({class:"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(d),$("#node-dialog-ok").click()}})}RED.tray.show(s)},editConfig:b,editSubflow:function(e){var n=e;E.push(e),RED.view.state(RED.state.EDITING);var o,a={title:g(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e={},a=!1,i=RED.nodes.dirty(),s=$("#subflow-input-name").val();s!=n.name&&(e.name=n.name,n.name=s,a=!0);var d=o.getValue();d!=n.info&&(e.info=n.info,n.info=d,a=!0),m(n,e,null)&&(a=!0);var l=$("#node-settings-icon-module-hidden").val(),c=$("#node-settings-icon-file-hidden").val(),p=l&&c?l+"/"+c:"";if((void 0===n.icon&&"node-red/subflow.png"!==p||void 0!==n.icon&&n.icon!==p)&&(e.icon=n.icon,n.icon=p,a=!0),RED.palette.refresh(),a){var u=n.changed;n.changed=!0,t(n);var f=[];RED.nodes.eachNode(function(e){e.type=="subflow:"+n.id&&(f.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,r(e),t(e))}),RED.nodes.dirty(!0);var h={t:"edit",node:n,changes:e,dirty:i,changed:u,subflow:{instances:f}};RED.history.push(h)}n.dirty=!0,RED.tray.close()}}],resize:function(e){$(".editor-tray-content").height(e.height-78),$(".editor-tray-content form").height(e.height-78-40);for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),n=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),a=0;a<t.size();a++)n-=$(t[a]).outerHeight(!0);n-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",n+"px"),o.resize()},open:function(t){t.find(".editor-tray-footer");var a=t.find(".editor-tray-body");a.parent().css("overflow","hidden");var s=RED.stack.create({container:a,singleExpanded:!0}).add({title:RED._("editor.nodeProperties"),expanded:!0});s.content.addClass("editor-tray-content"),n&&RED.sidebar.info.refresh(n),v(s.content,"dialog-form","subflow-template"),o=RED.editor.createEditor({id:"subflow-input-info-editor",mode:"ace/mode/markdown",value:""}),$("#subflow-input-name").val(e.name),RED.text.bidi.prepareInput($("#subflow-input-name")),o.getSession().setValue(e.info||"",-1);var r=0,d="subflow:"+n.id;RED.nodes.eachNode(function(e){e.type===d&&r++}),$("#subflow-dialog-user-count").text(RED._("subflow.subflowInstances",{count:r})).show(),i(e),a.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(n),RED.workspaces.refresh(),o.destroy(),E.pop(),n=null},show:function(){}};RED.tray.show(a)},editExpression:function(e){var t="_";E.length>0&&(t=E[E.length-1].id);var n=e.value,o=e.complete;E.push({type:"_expression"}),RED.view.state(RED.state.EDITING);var a,i,s,r,d={title:g(),width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){$("#node-input-expression-help").text(""),o(a.getValue()),RED.tray.close()}}],resize:function(e){e&&(x._expression=e.width);var t=$("#dialog-form").height();r&&r.resize(t)},open:function(e){e.find(".editor-tray-body").addClass("node-input-expression-editor");var o=v(e.find(".editor-tray-body"),"dialog-form","_expression","editor"),l=$("#node-input-expression-func");Object.keys(jsonata.functions).forEach(function(e){l.append($("<option></option>").val(e).text(e))}),l.change(function(e){var t=$(this).val(),n="<h5>"+t+"("+RED._("jsonata:"+t+".args",{defaultValue:""})+")</h5>",o=marked(RED._("jsonata:"+t+".desc",{defaultValue:""}));$("#node-input-expression-help").html(n+"<p>"+o+"</p>")});var c=null,p=-1;(a=RED.editor.createEditor({id:"node-input-expression",value:"",mode:"ace/mode/jsonata",options:{enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}})).getSession().setValue(n||"",-1),a.on("changeSelection",function(){var e=a.getCursorPosition(),t=a.getSession().getTokenAt(e.row,e.column);if(t!==c||t&&/paren/.test(t.type)&&e.column!==p){c=t;var n,o,i=null;if(t&&"keyword"===t.type)n=e.row,i=t;else{var s=0,r=!1;for(t?("paren.rparen"===t.type&&(p=e.column,s=e.column-(t.start+t.value.length)),n=e.row,o=t.index):(n=e.row-1,o=-1);null===i&&n>-1;){var d=a.getSession().getTokens(n);for(-1===o&&(o=d.length-1);o>-1;){var u=d[o].type;if(r){if("keyword"===u){i=d[o];break}r=!1}"paren.lparen"===u?s-=d[o].value.length:"paren.rparen"===u&&(s+=d[o].value.length),s<0&&(r=!0,s=0),o--}i||n--}}a.session.removeMarker(null),i&&l.val(i.value).change()}}),o.i18n(),$("#node-input-expression-func-insert").click(function(e){e.preventDefault(),a.getCursorPosition();var t=l.val(),n=jsonata.getFunctionSnippet(t);a.insertSnippet(n),a.focus()}),$("#node-input-expression-reformat").click(function(e){e.preventDefault();var t=a.getValue()||"";try{t=jsonata.format(t)}catch(e){}a.getSession().setValue(t||"",-1)});var u=RED.tabs.create({element:$("#node-input-expression-tabs"),onchange:function(e){$(".node-input-expression-tab-content").hide(),e.content.show(),d.resize()}});u.addTab({id:"expression-help",label:RED._("expressionEditor.functionReference"),content:$("#node-input-expression-tab-help")}),u.addTab({id:"expression-tests",label:RED._("expressionEditor.test"),content:$("#node-input-expression-tab-test")}),i=RED.editor.createEditor({id:"node-input-expression-test-data",value:R[t]||'{\n    "payload": "hello world"\n}',mode:"ace/mode/json",lineNumbers:!1});var f;$(".node-input-expression-legacy").click(function(e){e.preventDefault(),RED.sidebar.info.set(RED._("expressionEditor.compatModeDesc")),RED.sidebar.info.show()});var h=function(){var e,t,n=i.getValue(),o=a.getValue(),r=!1,d=/(^|[^a-zA-Z0-9_'"])msg([^a-zA-Z0-9_'"]|$)/.test(o);$(".node-input-expression-legacy").toggle(d);try{(t=jsonata(o)).assign("flowContext",function(e){return r=!0,null}),t.assign("globalContext",function(e){return r=!0,null})}catch(e){return void s.setValue(RED._("expressionEditor.errors.invalid-expr",{message:e.message}),-1)}try{e=JSON.parse(n)}catch(e){return void s.setValue(RED._("expressionEditor.errors.invalid-msg",{message:e.toString()}))}try{var l=t.evaluate(d?{msg:e}:e);if(r)return void s.setValue(RED._("expressionEditor.errors.context-unsupported"),-1);var c;c=void 0!==l?JSON.stringify(l,null,4):RED._("expressionEditor.noMatch"),s.setValue(c,-1)}catch(e){s.setValue(RED._("expressionEditor.errors.eval",{message:e.message}),-1)}};i.getSession().on("change",function(){clearTimeout(f),f=setTimeout(h,200),R[t]=i.getValue()}),a.getSession().on("change",function(){clearTimeout(f),f=setTimeout(h,200)}),s=RED.editor.createEditor({id:"node-input-expression-test-result",value:"",mode:"ace/mode/json",lineNumbers:!1,readOnly:!0}),r=RED.panels.create({id:"node-input-expression-panels",resize:function(e,t){var n=$("#node-input-expression-panel-expr");e-=$(n.children()[0]).outerHeight(!0);var o=$(n.children()[1]);e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-expression").css("height",e-5+"px"),a.resize(),t-=$("#node-input-expression-panel-info > .form-row > div:first-child").outerHeight(!0)+20,$(".node-input-expression-tab-content").height(t),$("#node-input-expression-test-data").css("height",t-5+"px"),i.resize(),$("#node-input-expression-test-result").css("height",t-5+"px"),s.resize()}}),$("#node-input-example-reformat").click(function(e){e.preventDefault();var t=i.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}i.getSession().setValue(t||"",-1)}),h()},close:function(){E.pop(),a.destroy(),i.destroy()},show:function(){}};RED.tray.show(d)},editJSON:function(e){var t=e.value,n=e.complete;E.push({type:"_json"}),RED.view.state(RED.state.EDITING);var o,a,i=function(){var e=o.getValue();try{return JSON.parse(e),$("#node-dialog-ok").removeClass("disabled"),!0}catch(e){return $("#node-dialog-ok").addClass("disabled"),!1}},s={title:e.title||g(),width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){e.requireValid&&!i()||(n(o.getValue()),RED.tray.close())}}],resize:function(e){x._json=e.width;for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),n=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),a=0;a<t.size();a++)n-=$(t[a]).outerHeight(!0);n-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",n+"px"),o.resize()},open:function(n){n.find(".editor-tray-body");var s=v(n.find(".editor-tray-body"),"dialog-form","_json","editor");(o=RED.editor.createEditor({id:"node-input-json",value:"",mode:"ace/mode/json"})).getSession().setValue(t||"",-1),e.requireValid&&(o.getSession().on("change",function(){clearTimeout(a),a=setTimeout(i,200)}),i()),$("#node-input-json-reformat").click(function(e){e.preventDefault();var t=o.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}o.getSession().setValue(t||"",-1)}),s.i18n()},close:function(){E.pop(),o.destroy()},show:function(){}};RED.tray.show(s)},editMarkdown:function(e){var t=e.value,n=e.complete,o="_markdown";E.push({type:o}),RED.view.state(RED.state.EDITING);var a,i={title:e.title||g(),width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){n(a.getValue()),RED.tray.close()}}],resize:function(e){x[o]=e.width;for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),n=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),i=0;i<t.size();i++)n-=$(t[i]).outerHeight(!0);n-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",n+"px"),a.resize()},open:function(n){n.find(".editor-tray-body");var i=v(n.find(".editor-tray-body"),"dialog-form",o,"editor");a=RED.editor.createEditor({id:"node-input-markdown",value:t,mode:"ace/mode/markdown"}),e.header&&e.header.appendTo(n.find("#node-input-markdown-title")),i.i18n()},close:function(){E.pop(),a.destroy()},show:function(){}};RED.tray.show(i)},editBuffer:function(e){var t=e.value,n=e.complete;E.push({type:"_buffer"}),RED.view.state(RED.state.EDITING);var o,a,i=[],s={title:g(),width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){n(JSON.stringify(o)),RED.tray.close()}}],resize:function(e){e&&(x._buffer=e.width);var t=$("#dialog-form").height();a&&a.resize(t)},open:function(e){e.find(".editor-tray-body");var n=v(e.find(".editor-tray-body"),"dialog-form","_buffer","editor");(i=RED.editor.createEditor({id:"node-input-buffer-str",value:"",mode:"ace/mode/text"})).getSession().setValue(t||"",-1),bufferBinEditor=RED.editor.createEditor({id:"node-input-buffer-bin",value:"",mode:"ace/mode/text",readOnly:!0});var s,r=function(e){var t=!0,n="string"==typeof e,a=[],i=0,s=(o=n?D(e):e).length;for(i=0;i<s;i++){var r=parseInt(o[i]);if(!n&&(isNaN(r)||r<0||r>255)){t=!1;break}i>0&&(i%8==0?i%16==0?a.push("\n"):a.push("  "):a.push(" ")),a.push((r<16?"0":"")+r.toString(16).toUpperCase())}return t&&($("#node-input-buffer-type-string").toggle(n),$("#node-input-buffer-type-array").toggle(!n),bufferBinEditor.setValue(a.join(""),1)),t},d=function(){var e=i.getValue(),t=!1;if(/^[\s]*\[[\s\S]*\][\s]*$/.test(e)){t=!0;try{var n=JSON.parse(e);t=r(n)}catch(e){t=!1}}t||r(e)};i.getSession().on("change",function(){clearTimeout(s),s=setTimeout(d,200)}),d(),n.i18n(),a=RED.panels.create({id:"node-input-buffer-panels",resize:function(e,t){var n=$("#node-input-buffer-panel-str");e-=$(n.children()[0]).outerHeight(!0);var o=$(n.children()[1]);e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-buffer-str").css("height",e-5+"px"),i.resize();var a=$("#node-input-buffer-panel-bin");o=$(a.children()[0]),t-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-buffer-bin").css("height",t-5+"px"),bufferBinEditor.resize()}}),$(".node-input-buffer-type").click(function(e){e.preventDefault(),RED.sidebar.info.set(RED._("bufferEditor.modeDesc")),RED.sidebar.info.show()})},close:function(){E.pop(),i.destroy(),bufferBinEditor.destroy()},show:function(){}};RED.tray.show(s)},validateNode:t,updateNodeProperties:r,createEditor:function(e){var t=ace.edit(e.id||e.element);t.setTheme("ace/theme/tomorrow");var n=t.getSession();return n.on("changeAnnotation",function(){for(var e=n.getAnnotations()||[],t=e.length,o=e.length;t--;)/doctype first\. Expected/.test(e[t].text)?e.splice(t,1):/Unexpected End of file\. Expected/.test(e[t].text)&&e.splice(t,1);o>e.length&&n.setAnnotations(e)}),e.mode&&n.setMode(e.mode),e.foldStyle?n.setFoldStyle(e.foldStyle):n.setFoldStyle("markbeginend"),e.options?t.setOptions(e.options):t.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),e.readOnly&&(t.setOption("readOnly",e.readOnly),t.container.classList.add("ace_read-only")),e.hasOwnProperty("lineNumbers")&&t.renderer.setOption("showGutter",e.lineNumbers),t.$blockScrolling=1/0,e.value&&n.setValue(e.value,-1),e.globals&&setTimeout(function(){n.$worker&&n.$worker.send("setOptions",[{globals:e.globals,esversion:6,sub:!0,asi:!0,maxerr:1e3}])},100),t}}}(),RED.tray=function(){function e(e){function i(){$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$(".sidebar-shade").show(),y.preferredWidth=Math.max(s.width(),500),e.maximized||l.css({minWidth:y.preferredWidth-40}),e.width?(e.width>$("#editor-stack").position().left-8&&(e.width=$("#editor-stack").position().left-8),s.width(e.width)):s.width(y.preferredWidth),y.width=s.width(),y.width>$("#editor-stack").position().left-8&&(y.width=Math.max(0,$("#editor-stack").position().left-8),s.width(y.width)),s.css({right:-(s.width()+10)+"px",transition:"right 0.25s ease"}),$("#workspace").scrollLeft(0),t(),a=!0,setTimeout(function(){setTimeout(function(){e.width||s.width(Math.min(y.preferredWidth,$("#editor-stack").position().left-8)),e.resize&&e.resize({width:s.width()}),e.show&&e.show(),setTimeout(function(){a=!1},200),l.find(":focusable:first").focus()},150),s.css({right:0})},0)}var s=$('<div class="editor-tray"></div>'),r=$('<div class="editor-tray-header"></div>').appendTo(s),d=$('<div class="editor-tray-body-wrapper"></div>').appendTo(s),l=$('<div class="editor-tray-body"></div>').appendTo(d),c=$('<div class="editor-tray-footer"></div>').appendTo(s),p=$('<div class="editor-tray-resize-handle"></div>').appendTo(s);if(e.title){var u=n.map(function(e){return e.options.title});u.push(e.title);var f='<ul class="editor-tray-breadcrumbs"><li>'+u.join("</li><li>")+"</li></ul>";$('<div class="editor-tray-titlebar">'+f+"</div>").appendTo(r)}e.width===1/0&&(e.maximized=!0,p.addClass("editor-tray-resize-maximised"));var h,g=$('<div class="editor-tray-toolbar"></div>').appendTo(r);if(e.buttons)for(var v=0;v<e.buttons.length;v++){var m=e.buttons[v],b=$("<button>").button().appendTo(g);m.id&&b.attr("id",m.id),m.text&&b.text(m.text),m.click&&b.click(function(e){return function(t){$(this).hasClass("disabled")||e(t)}}(m.click)),m.class&&(b.addClass(m.class),"primary"===m.class&&(h=m))}s.appendTo(o);var y={tray:s,header:r,body:l,footer:c,options:e,primaryButton:h};n.push(y),e.maximized||s.draggable({handle:p,axis:"x",start:function(e,t){s.width("auto")},drag:function(e,t){var n=o.position().left+t.position.left;n<7?t.position.left+=7-n:t.position.left>-y.preferredWidth-1&&(t.position.left=-Math.min(o.position().left-7,y.preferredWidth-1)),y.options.resize&&setTimeout(function(){y.options.resize({width:-t.position.left})},0),y.width=-t.position.left},stop:function(e,t){s.width(-t.position.left),s.css({left:""}),y.options.resize&&y.options.resize({width:-t.position.left}),y.width=-t.position.left}}),e.open?1===e.open.length?(e.open(s),i()):e.open(s,i):i()}function t(){if(n.length>0){var e=n[n.length-1],t=e.tray.height()-e.header.outerHeight()-e.footer.outerHeight();e.body.height(t),e.options.maximized||e.width>$("#editor-stack").position().left-8?(e.width=$("#editor-stack").position().left-8,e.tray.width(e.width)):e.width<e.preferredWidth&&(e.width=Math.min($("#editor-stack").position().left-8,e.preferredWidth),e.tray.width(e.width)),e.options.resize&&e.options.resize({width:e.width,height:t})}}var n=[],o=$("#editor-stack"),a=!1;return{init:function(){$(window).resize(t),RED.events.on("sidebar:resize",t),$("#editor-shade").click(function(){if(!a){var e=n[n.length-1];e&&e.primaryButton&&e.primaryButton.click()}})},show:function(t){if(n.length>0&&!t.overlay){var o=n[n.length-1];"inherit"===t.width&&(t.width=o.tray.width()),o.tray.css({right:-(o.tray.width()+10)+"px"}),setTimeout(function(){o.tray.detach(),e(t)},250)}else RED.events.emit("editor:open"),e(t)},close:function(e){if(n.length>0){var o=n.pop();o.tray.css({right:-(o.tray.width()+10)+"px"}),setTimeout(function(){if(o.options.close&&o.options.close(),o.tray.remove(),n.length>0){var a=n[n.length-1];a.options.overlay?(t(),a.options.show&&a.options.show()):(a.tray.appendTo("#editor-stack"),setTimeout(function(){t(),a.tray.css({right:0}),a.options.show&&a.options.show()},0))}e&&e(),0===n.length&&($("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$(".sidebar-shade").hide(),RED.events.emit("editor:close"),RED.view.focus())},250)}}}}(),RED.clipboard=function(){function e(){i=$('<div id="clipboard-dialog" class="hide node-red-dialog"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,buttons:[{id:"clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-close",class:"primary",text:RED._("common.label.close"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-copy",class:"primary",text:RED._("clipboard.export.copy"),click:function(){$("#clipboard-export").select(),document.execCommand("copy"),document.getSelection().removeAllRanges(),RED.notify(RED._("clipboard.nodesExported")),$(this).dialog("close")}},{id:"clipboard-dialog-ok",class:"primary",text:RED._("common.label.import"),click:function(){RED.view.importNodes($("#clipboard-import").val(),"import-tab-new"===$("#import-tab > a.selected").attr("id")),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}}),s=i.children(".dialog-form"),r='<div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.export.copy"></label><span id="export-range-group" class="button-group"><a id="export-range-selected" class="editor-button toggle" href="#" data-i18n="clipboard.export.selected"></a><a id="export-range-flow" class="editor-button toggle" href="#" data-i18n="clipboard.export.current"></a><a id="export-range-full" class="editor-button toggle" href="#" data-i18n="clipboard.export.all"></a></span></div><div class="form-row"><textarea readonly style="resize: none; width: 100%; border-radius: 4px;font-family: monospace; font-size: 12px; background:#f3f3f3; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-export" rows="5"></textarea></div><div class="form-row" style="text-align: right;"><span id="export-format-group" class="button-group"><a id="export-format-mini" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.compact"></a><a id="export-format-full" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.formatted"></a></span></div>',d='<div class="form-row"><textarea style="resize: none; width: 100%; border-radius: 0px;font-family: monospace; font-size: 12px; background:#eee; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-import" rows="5" placeholder="'+RED._("clipboard.pasteNodes")+'"></textarea></div><div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.import.import"></label><span id="import-tab" class="button-group"><a id="import-tab-current" class="editor-button toggle selected" href="#" data-i18n="clipboard.export.current"></a><a id="import-tab-new" class="editor-button toggle" href="#" data-i18n="clipboard.import.newFlow"></a></span></div>'}function t(){var e=$("#clipboard-import"),t=e.val();t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1);try{JSON.parse(t),e.removeClass("input-error"),e.val(t),$("#clipboard-dialog-ok").button("enable")}catch(n){""!==t&&e.addClass("input-error"),$("#clipboard-dialog-ok").button("disable")}}function n(){l||(s.empty(),s.append($(d)),s.i18n(),$("#clipboard-dialog-ok").show(),$("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-close").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-ok").button("disable"),$("#clipboard-import").keyup(t),$("#clipboard-import").on("paste",function(){setTimeout(t,10)}),$("#import-tab > a").click(function(e){e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"))}),i.dialog("option","title",RED._("clipboard.importNodes")).dialog("open"))}function o(){if(!l){s.empty(),s.append($(r)),s.i18n();var e=RED.settings.flowFilePretty?"export-format-full":"export-format-mini";$("#export-format-group > a").click(function(t){if(t.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#clipboard-export").focus();else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var n=$("#clipboard-export").val();if(n.length>0){var o=JSON.parse(n);n="export-format-full"===(e=$(this).attr("id"))?JSON.stringify(o,null,4):JSON.stringify(o),$("#clipboard-export").val(n),$("#clipboard-export").focus()}}}),$("#export-range-group > a").click(function(t){if(t.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#clipboard-export").focus();else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var n=$(this).attr("id"),o="",a=null;if("export-range-selected"===n){var i=RED.view.selection();a=RED.nodes.createExportableNodeSet(i.nodes.filter(function(e){return"subflow"!==e.type}))}else if("export-range-flow"===n){var s=RED.workspaces.active();a=RED.nodes.filterNodes({z:s});var r=RED.nodes.workspace(s)||RED.nodes.subflow(s);a.unshift(r),a=RED.nodes.createExportableNodeSet(a)}else"export-range-full"===n&&(a=RED.nodes.createCompleteNodeSet(!1));null!==a&&(o="export-format-full"===e?JSON.stringify(a,null,4):JSON.stringify(a)),o.length>0?$("#export-copy").removeClass("disabled"):$("#export-copy").addClass("disabled"),$("#clipboard-export").val(o),$("#clipboard-export").focus()}}),$("#clipboard-dialog-ok").hide(),$("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-close").hide(),RED.view.selection().nodes?$("#export-range-selected").click():($("#export-range-selected").addClass("disabled").removeClass("selected"),$("#export-range-flow").click()),"export-format-full"===e?$("#export-format-full").click():$("#export-format-mini").click(),$("#clipboard-export").focus(function(){var e=$(this);e.select(),e.mouseup(function(){return e.unbind("mouseup"),!1})}),i.dialog("option","title",RED._("clipboard.exportNodes")).dialog("open"),$("#clipboard-export").focus(),document.queryCommandSupported("copy")?($("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-copy").show()):($("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-close").show())}}function a(){$("#dropTarget").hide(),RED.keyboard.remove("escape")}var i,s,r,d,l=!1;return{init:function(){e(),$('<input type="text" id="clipboard-hidden">').appendTo("body"),RED.events.on("view:selection-changed",function(e){e.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),RED.actions.add("core:show-export-dialog",o),RED.actions.add("core:show-import-dialog",n),RED.events.on("editor:open",function(){l=!0}),RED.events.on("editor:close",function(){l=!1}),RED.events.on("search:open",function(){l=!0}),RED.events.on("search:close",function(){l=!1}),RED.events.on("type-search:open",function(){l=!0}),RED.events.on("type-search:close",function(){l=!1}),$("#chart").on("dragenter",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||($("#dropTarget").css({display:"table"}),RED.keyboard.add("*","escape",a))}),$("#dropTarget").on("dragover",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||e.preventDefault()}).on("dragleave",function(e){a()}).on("drop",function(e){if(-1!=$.inArray("text/plain",e.originalEvent.dataTransfer.types)){var t=e.originalEvent.dataTransfer.getData("text/plain");t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1),RED.view.importNodes(t)}else if(-1!=$.inArray("Files",e.originalEvent.dataTransfer.types)){var n=e.originalEvent.dataTransfer.files;if(1===n.length){var o=n[0],i=new FileReader;i.onload=function(e){RED.view.importNodes(e.target.result)},i.readAsText(o)}}a(),e.preventDefault()})},import:n,export:o,copyText:function(e,t,n){var o=!1;"string"!=typeof e&&(e=JSON.stringify(e,function(e,t){return null!==t&&"object"==typeof t&&t.__encoded__&&t.hasOwnProperty("data")&&t.hasOwnProperty("length")?(o=t.data.length!==t.length,t.data):t})),o&&(n+="_truncated"),$("#clipboard-hidden").val(e).select();var a=document.execCommand("copy");if(a&&t){var i=RED.popover.create({target:t,direction:"left",size:"small",content:RED._(n)});setTimeout(function(){i.close()},1e3),i.open()}return a}}}(),RED.library=function(){function e(){$.getJSON("library/flows",function(e){var t,n=function(e,t){var o,a,i,s=document.createElement("ul");if(""===t&&(s.id="menu-item-import-library-submenu"),s.className="dropdown-menu",e.d)for(o in e.d)if(e.d.hasOwnProperty(o)){(a=document.createElement("li")).className="dropdown-submenu pull-left",(i=document.createElement("a")).href="#";var r=o.replace(/^@.*\//,"").replace(/^node-red-contrib-/,"").replace(/^node-red-node-/,"").replace(/-/," ").replace(/_/," ");i.innerHTML=r,a.appendChild(i),a.appendChild(n(e.d[o],t+(""!==t?"/":"")+o)),s.appendChild(a)}if(e.f)for(o in e.f)e.f.hasOwnProperty(o)&&(a=document.createElement("li"),(i=document.createElement("a")).href="#",i.innerHTML=e.f[o],i.flowName=t+(""!==t?"/":"")+e.f[o],i.onclick=function(){$.get("library/flows/"+this.flowName,function(e){RED.view.importNodes(e)})},a.appendChild(i),s.appendChild(a));return s};e.d&&e.d._examples_&&(t=e.d._examples_,delete e.d._examples_);var o=n(e,"");$("#menu-item-import-examples").remove(),t&&(RED.menu.addItem("menu-item-import",{id:"menu-item-import-examples",label:RED._("menu.label.examples"),options:[]}),$("#menu-item-import-examples-submenu").replaceWith(n(t,"_examples_"))),$("#menu-item-import-library-submenu").replaceWith(o)})}function t(){var e=RED.nodes.createExportableNodeSet(RED.view.selection().nodes);$("#node-input-library-filename").attr("nodes",JSON.stringify(e)),n.dialog("open")}var n,o="node-input-";return{init:function(){RED.actions.add("core:library-export",t),RED.events.on("view:selection-changed",function(e){e.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),!1!==RED.settings.theme("menu.menu-item-import-library")&&e(),(n=$('<div id="library-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,title:RED._("library.exportToLibrary"),buttons:[{id:"library-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"library-dialog-ok",class:"primary",text:RED._("common.label.export"),click:function(){var e=$("#node-input-library-filename").val();/^\s*$/.test(e)||$.ajax({url:"library/flows/"+e,type:"POST",data:$("#node-input-library-filename").attr("nodes"),contentType:"application/json; charset=utf-8"}).done(function(){RED.library.loadFlowLibrary(),RED.notify(RED._("library.savedNodes"),"success")}).fail(function(e,t,n){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")}),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}})).children(".dialog-form").append($('<div class="form-row"><label for="node-input-library-filename" data-i18n="[append]editor:library.filename"><i class="fa fa-file"></i> </label><input type="text" id="node-input-library-filename" data-i18n="[placeholder]editor:library.fullFilenamePlaceholder"><input type="text" style="display: none;" /></div>'))},create:function(e){function t(e){var t=document.createElement("li");return t.onmouseover=function(e){$(this).addClass("list-hover")},t.onmouseout=function(e){$(this).removeClass("list-hover")},t}function n(o,a){for(var r,d=document.createElement("ul"),l=0;l<a.length;l++){var c=a[l];"string"==typeof c?((r=t(c)).onclick=function(){var t=c;return function(a){var i=$('<li class="active"><span class="divider">/</span> <a href="#">'+t+"</a></li>");$("a",i).click(function(a){$(this).parent().nextAll().remove(),$.getJSON("library/"+e.url+o+t,function(e){$("#node-select-library").children().first().replaceWith(n(o+t+"/",e))}),a.stopPropagation()});var s=$("#node-dialog-library-breadcrumbs");$(".active",s).removeClass("active"),s.append(i),$.getJSON("library/"+e.url+o+t,function(e){$("#node-select-library").children().first().replaceWith(n(o+t+"/",e))})}}(),r.innerHTML='<i class="fa fa-folder"></i> '+c+"</i>",d.appendChild(r)):((r=t(c)).innerHTML=c.name,r.onclick=function(){var t=c;return function(n){$(".list-selected",d).removeClass("list-selected"),$(this).addClass("list-selected"),$.get("library/"+e.url+o+t.fn,function(e){i=t,s.setValue(e,-1)})}}(),d.appendChild(r))}return d}function a(t){var n=$("#"+o+"name").val().replace(/(^\s*)|(\s*$)/g,"");""===n&&(n=RED._("library.unnamedType",{type:e.type}));var a=$("#node-dialog-library-save-filename").val().replace(/(^\s*)|(\s*$)/g,""),i=$("#node-dialog-library-save-folder").val().replace(/(^\s*)|(\s*$)/g,"");if(""!==a&&/.+\.js$/.test(a)){for(var s=i+(""===i?"":"/")+a,r={},d=0;d<e.fields.length;d++){var l=e.fields[d];"name"==l?r.name=n:r[l]=$("#"+o+l).val()}r.text=e.editor.getValue(),$.ajax({url:"library/"+e.url+"/"+s,type:"POST",data:JSON.stringify(r),contentType:"application/json; charset=utf-8"}).done(function(t,n,o){RED.notify(RED._("library.savedType",{type:e.type}),"success")}).fail(function(e,t,n){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")})}else RED.notify(RED._("library.invalidFilename"),"warning")}var i=null,s=null;o=e.elementPrefix||"node-input-",e.editor.setText&&(e.editor.setValue=function(t,n){e.editor.setText.call(e.editor,t)}),e.editor.getText&&(e.editor.getValue=e.editor.getText),$("#"+o+"name").css("width","calc(100% - 52px)").after('<div class="btn-group" style="margin-left:5px;"><a id="node-input-'+e.type+'-lookup" class="editor-button" data-toggle="dropdown"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a><ul class="dropdown-menu pull-right" role="menu"><li><a id="node-input-'+e.type+'-menu-open-library" tabindex="-1" href="#">'+RED._("library.openLibrary")+'</a></li><li><a id="node-input-'+e.type+'-menu-save-library" tabindex="-1" href="#">'+RED._("library.saveToLibrary")+"</a></li></ul></div>"),$("#node-input-"+e.type+"-menu-open-library").click(function(t){$("#node-select-library").children().remove(),$("#node-dialog-library-breadcrumbs").children().first().nextAll().remove(),s.setValue("",-1),$.getJSON("library/"+e.url,function(e){$("#node-select-library").append(n("/",e)),$("#node-dialog-library-breadcrumbs a").click(function(t){$(this).parent().nextAll().remove(),$("#node-select-library").children().first().replaceWith(n("/",e)),t.stopPropagation()}),$("#node-dialog-library-lookup").dialog("open")}),t.preventDefault()}),$("#node-input-"+e.type+"-menu-save-library").click(function(t){var n=$("#"+o+"name").val().replace(/(^\s*)|(\s*$)/g,"");$("#node-dialog-library-save-folder").attr("value","");var a=n.replace(/[^\w-]/g,"-");""===a&&(a="unnamed-"+e.type),$("#node-dialog-library-save-filename").attr("value",a+".js"),$("#node-dialog-library-save").dialog("open"),t.preventDefault()}),(s=ace.edit("node-select-library-text")).setTheme("ace/theme/tomorrow"),e.mode&&s.getSession().setMode(e.mode),s.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),s.renderer.$cursorLayer.element.style.opacity=0,s.$blockScrolling=1/0,$("#node-dialog-library-lookup").dialog({title:RED._("library.typeLibrary",{type:e.type}),modal:!0,autoOpen:!1,width:800,height:450,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.load"),class:"primary",click:function(){if(i){for(var t=0;t<e.fields.length;t++){var n=e.fields[t];$("#"+o+n).val(i[n])}e.editor.setValue(s.getValue(),-1)}$(this).dialog("close")}}],open:function(e){var t=$("form",this);t.height(t.parent().height()-30),$("#node-select-library-text").height("100%"),$(".form-row:last-child",t).children().height(t.height()-60)},resize:function(e){var t=$("form",this);t.height(t.parent().height()-30),$(".form-row:last-child",t).children().height(t.height()-60)}}),$("#node-dialog-library-save-confirm").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){a(),$(this).dialog("close")}}]}),$("#node-dialog-library-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){a(),$(this).dialog("close")}}]})},loadFlowLibrary:e,export:t}}(),RED.notifications=function(){function e(e,t,s,r){var d={};if(null!==t&&"object"==typeof t&&(s=(d=t).fixed,r=d.timeout,t=d.type),d.modal&&$("#full-shade").show(),o.length>4)for(var l=o.length,c=0;l>4&&c<o.length;c+=1){var p=o[c];p.fixed||(window.clearTimeout(p.timeoutid),p.close(),l-=1)}var u=document.createElement("div");if(u.id="red-notification-"+a,u.className="notification",u.fixed=s,t&&(u.className="notification notification-"+t),d.width){var f=$("#notifications").width();if(d.width>f){var h=-(d.width-f)/2;$(u).css({width:d.width+"px",marginLeft:h+"px"})}}if(u.style.display="none","string"==typeof e?(/<p>/i.test(e)||(e="<p>"+e+"</p>"),u.innerHTML=e):$(u).append(e),d.buttons){var g=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(u);d.buttons.forEach(function(e){var t=$("<button>").text(e.text).click(e.click).appendTo(g);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})}return $("#notifications").append(u),$(u).slideDown(300),u.close=function(){var e=u;return function(){e.closed||(e.closed=!0,o.splice(o.indexOf(e),1),d.id&&(delete n[d.id],0===Object.keys(n).length&&i.hide()),$(e).slideUp(300,function(){e.parentNode.removeChild(e)}),d.modal&&$("#full-shade").hide())}}(),u.hideNotification=function(){var e=u;return function(){e.closed||(e.hidden=!0,$(e).slideUp(300))}}(),u.showNotification=function(){var e=u;return function(){!e.closed&&e.hidden&&(e.hidden=!1,$(e).slideDown(300))}}(),u.update=function(){var e=u;return function(t,n){"string"==typeof t?(/<p>/i.test(t)||(t="<p>"+t+"</p>"),e.innerHTML=t):$(e).empty().append(t);var o;if("number"==typeof n)o=n;else if(void 0!==n&&(o=n.timeout,n.buttons)){var a=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(e);n.buttons.forEach(function(e){var t=$("<button>").text(e.text).click(e.click).appendTo(a);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})}void 0!==o&&o>0?(window.clearTimeout(e.timeoutid),e.timeoutid=window.setTimeout(e.close,o)):window.clearTimeout(e.timeoutid),e.hidden&&e.showNotification()}}(),s||($(u).click(function(){var e=u;return function(){e.close(),window.clearTimeout(e.timeoutid)}}()),u.timeoutid=window.setTimeout(u.close,r||5e3)),o.push(u),d.id&&(n[d.id]=u,i.show()),a+=1,u}function t(){for(var e in n)n.hasOwnProperty(e)&&n[e].showNotification()}var n={},o=[],a=0;RED.notify=e;var i;return{init:function(){i=$('<li><a id="btn-notifications" class="button" href="#"><i class="fa fa-warning"></i></a></li>').prependTo(".header-toolbar").hide(),$("#btn-notifications").click(function(){t()})},notify:e}}(),RED.search=function(){function e(e){var t=RED.utils.getNodeLabel(e);t&&(t=(""+t).toLowerCase(),h[t]=h[t]||{},h[t][e.id]={node:e,label:t}),t=t||e.label||e.name||e.id||"";var n=["id","type","name","label","info"];e._def&&e._def.defaults&&(n=n.concat(Object.keys(e._def.defaults)));for(var o=0;o<n.length;o++)if(e.hasOwnProperty(n[o])){var a=e[n[o]];"string"!=typeof a&&"number"!=typeof a||(a=(""+a).toLowerCase(),h[a]=h[a]||{},h[a][e.id]={node:e,label:t})}}function t(){h={},RED.nodes.eachWorkspace(e),RED.nodes.eachSubflow(e),RED.nodes.eachConfig(e),RED.nodes.eachNode(e),(g=Object.keys(h)).sort(),g.forEach(function(e){h[e]=Object.keys(h[e]).map(function(t){return h[e][t]})})}function n(e){if(l.editableList("empty"),u=-1,v=[],e.length>0){e=e.toLowerCase();var t,n,o=[],a={};for(t=0;t<g.length;t++){var i=g[t],s=g[t].indexOf(e);if(s>-1)for(n=0;n<h[i].length;n++){var r=h[i][n];a[r.node.id]=a[r.node.id]=r,a[r.node.id].index=Math.min(a[r.node.id].index||1/0,s)}}for((o=Object.keys(a)).sort(function(e,t){return a[e].index-a[t].index}),t=0;t<o.length;t++)v.push(a[o[t]]);if(v.length>0)for(t=0;t<Math.min(v.length,25);t++)l.editableList("addItem",v[t]);else l.editableList("addItem",{})}}function o(){var e=l.find("li.selected");if(1===e.length){var t=l.parent(),n=t.height(),o=(t.scrollTop(),e.position().top),a=e.height();o+a>n?t.animate({scrollTop:"-="+(n-(o+a)-10)},50):o<0&&t.animate({scrollTop:"+="+(o-10)},50)}}function a(){p=$("<div>",{id:"red-ui-search",class:"red-ui-search"}).appendTo("#main-container");var e=$("<div>",{class:"red-ui-search-container"}).appendTo(p);(d=$('<input type="text" data-i18n="[placeholder]menu.label.searchInput">').appendTo(e).searchBox({delay:200,change:function(){n($(this).val())}})).on("keydown",function(e){var t;v.length>0&&(40===e.keyCode?(t=l.children(),u<t.length-1&&(u>-1&&$(t[u]).removeClass("selected"),u++),$(t[u]).addClass("selected"),o(),e.preventDefault()):38===e.keyCode?(t=l.children(),u>0&&(u<t.length&&$(t[u]).removeClass("selected"),u--),$(t[u]).addClass("selected"),o(),e.preventDefault()):13===e.keyCode&&v.length>0&&i(v[Math.max(0,u)].node))}),d.i18n();var t=$("<div>",{class:"red-ui-search-results-container"}).appendTo(p);l=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(t).editableList({addButton:!1,addItem:function(e,t,n){var o=n.node;if(void 0===o)$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e);else{var a=o._def,s=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),r=$("<div>",{class:"red-ui-search-result-node"}).appendTo(s),d=a.color,l=RED.utils.getNodeIcon(a,o);"tab"===o.type&&(d="#C0DEED"),r.css("backgroundColor",d);var c=$("<div/>",{class:"palette_icon_container"}).appendTo(r);$("<div/>",{class:"palette_icon",style:"background-image: url("+l+")"}).appendTo(c);var p=$("<div>",{class:"red-ui-search-result-description"}).appendTo(s);if(o.z){var u=RED.nodes.workspace(o.z);u=u?"flow:"+u.label:"subflow:"+(u=RED.nodes.subflow(o.z)).name,$("<div>",{class:"red-ui-search-result-node-flow"}).text(u).appendTo(p)}$("<div>",{class:"red-ui-search-result-node-label"}).text(n.label||o.id).appendTo(p),$("<div>",{class:"red-ui-search-result-node-type"}).text(o.type).appendTo(p),$("<div>",{class:"red-ui-search-result-node-id"}).text(o.id).appendTo(p),s.click(function(e){e.preventDefault(),i(o)})}},scrollOnAdd:!1})}function i(e){r(),RED.view.reveal(e.id)}function s(){c||(f||(RED.keyboard.add("*","escape",function(){r()}),$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$("#sidebar-separator").hide(),t(),null===p&&a(),p.slideDown(300),RED.events.emit("search:open"),f=!0),d.focus())}function r(){f&&(RED.keyboard.remove("escape"),f=!1,$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide(),$("#sidebar-separator").show(),null!==p&&p.slideUp(200,function(){d.searchBox("value","")}),RED.events.emit("search:close"))}var d,l,c=!1,p=null,u=-1,f=!1,h={},g=[],v=[];return{init:function(){RED.actions.add("core:search",s),RED.events.on("editor:open",function(){c=!0}),RED.events.on("editor:close",function(){c=!1}),RED.events.on("type-search:open",function(){c=!0}),RED.events.on("type-search:close",function(){c=!1}),$("#header-shade").on("mousedown",r),$("#editor-shade").on("mousedown",r),$("#palette-shade").on("mousedown",r),$("#sidebar-shade").on("mousedown",r)},show:s,hide:r}}(),RED.typeSearch=function(){function e(e){m=e.toLowerCase();c.editableList("filter");c.editableList("sort"),setTimeout(function(){g=0,c.children().removeClass("selected"),c.children(":visible:first").addClass("selected")},100)}function t(){var e=c.find("li.selected");if(1===e.length){var t=c.parent(),n=t.height(),o=(t.scrollTop(),e.position().top),a=e.height();o+a>n?t.animate({scrollTop:"-="+(n-(o+a)-10)},50):o<0&&t.animate({scrollTop:"+="+(o-10)},50)}}function n(){h=$("<div>",{id:"red-ui-type-search",class:"red-ui-search red-ui-type-search"}).appendTo("#main-container");var n=$("<div>",{class:"red-ui-search-container"}).appendTo(h);(l=$('<input type="text">').attr("placeholder",RED._("search.addNode")).appendTo(n).searchBox({delay:50,change:function(){e($(this).val())}})).on("keydown",function(e){var n=c.children(":visible");if(n.length>0)if(40===e.keyCode)g<n.length-1&&(g>-1&&$(n[g]).removeClass("selected"),g++),$(n[g]).addClass("selected"),t(),e.preventDefault();else if(38===e.keyCode)g>0&&(g<n.length&&$(n[g]).removeClass("selected"),g--),$(n[g]).addClass("selected"),t(),e.preventDefault();else if(13===e.keyCode){var a=Math.max(0,g);a<n.length&&o($(n[a]).find(".red-ui-editableList-item-content").data("data"))}}),p=$("<div>",{class:"red-ui-search-results-container"}).appendTo(h),c=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 0;bottom: 0;left: 0;right: 0;"}).appendTo(p).editableList({addButton:!1,filter:function(e){return""===m||!e.recent&&!e.common&&(""===m||e.index.indexOf(m)>-1)},sort:function(e,t){if(""===m)return e.i-t.i;var n=e.index.indexOf(m),o=t.index.indexOf(m);return-1===n?1:-1===o?-1:n===o?r(e,t):n-o},addItem:function(e,t,n){var a=n.def;n.index=n.type.toLowerCase(),n.separator&&e.addClass("red-ui-search-result-separator");var i=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),s=$("<div>",{class:"red-ui-search-result-node"}).appendTo(i),r=a.color,d=RED.utils.getNodeIcon(a);s.css("backgroundColor",r);var l=$("<div/>",{class:"palette_icon_container"}).appendTo(s);$("<div/>",{class:"palette_icon",style:"background-image: url("+d+")"}).appendTo(l),a.inputs>0&&$("<div/>",{class:"red-ui-search-result-node-port"}).appendTo(s),a.outputs>0&&$("<div/>",{class:"red-ui-search-result-node-port red-ui-search-result-node-output"}).appendTo(s);var c=$("<div>",{class:"red-ui-search-result-description"}).appendTo(i),p=n.label;n.index+="|"+p.toLowerCase(),$("<div>",{class:"red-ui-search-result-node-label"}).text(p).appendTo(c),i.click(function(e){e.preventDefault(),o(n)})},scrollOnAdd:!1})}function o(e){i(),b[e.type]=Date.now(),u(e.type)}function a(e){if(v){for(var t=$(e.target);"body"!==t.prop("nodeName").toLowerCase();){if("red-ui-type-search"===t.attr("id"))return;t=t.parent()}i(!0),f&&f()}}function i(e){v&&(RED.keyboard.remove("escape"),v=!1,null!==h&&p.slideUp(e?50:200,function(){h.hide(),l.searchBox("value","")}),RED.events.emit("type-search:close"),RED.view.focus(),$(document).off("mousedown.type-search"),$(document).off("mouseup.type-search"),$(document).off("click.type-search"))}function s(e,t){var n=e;if(void 0!==t.paletteLabel)try{n=("function"==typeof t.paletteLabel?t.paletteLabel.call(t):t.paletteLabel)||"",n+=" ("+e+")"}catch(t){console.log("Definition error: "+e+".paletteLabel",t)}return n}function r(e,t){var n=e.label.toLowerCase(),o=t.label.toLowerCase();return n<o?-1:n===o?0:1}function d(){var e;c.editableList("empty"),l.searchBox("value",""),g=-1;var t=["inject","debug","function","change","switch"],n=Object.keys(b);n.sort(function(e,t){return b[t]-b[e]}),n=n.filter(function(e){return-1===t.indexOf(e)});var o=[];RED.nodes.registry.getNodeTypes().forEach(function(e){var t=RED.nodes.getType(e);"config"!==t.category&&"unknown"!==e&&"tab"!==e&&o.push({type:e,def:t,label:s(e,t)})}),o.sort(r);var a,i=0;for(e=0;e<t.length;e++){var d=RED.nodes.getType(t[e]);d&&((a={type:t[e],common:!0,def:d,i:i++}).label=s(a.type,a.def),e===t.length-1&&(a.separator=!0),c.editableList("addItem",a))}for(e=0;e<Math.min(5,n.length);e++)(a={type:n[e],def:RED.nodes.getType(n[e]),recent:!0,i:i++}).label=s(a.type,a.def),e===n.length-1&&(a.separator=!0),c.editableList("addItem",a);for(e=0;e<o.length;e++)o[e].i=i++,c.editableList("addItem",o[e]);setTimeout(function(){g=0,c.children(":first").addClass("selected")},100)}var l,c,p,u,f,h=null,g=-1,v=!1,m="",b={};return{show:function(e){v?(h.hide(),p.hide()):(RED.keyboard.add("*","escape",function(){i(),f&&f()}),null===h&&n(),v=!0,setTimeout(function(){$(document).on("mousedown.type-search",a),$(document).on("mouseup.type-search",a),$(document).on("click.type-search",a)},200)),d(),u=e.add,closeCallback=e.close,RED.events.emit("type-search:open"),h.css({left:e.x+"px",top:e.y+"px"}).show(),p.slideDown(300),setTimeout(function(){p.find(".red-ui-editableList-container").scrollTop(0),l.focus()},100)},hide:i}}(),RED.subflow=function(){function e(e,t){var n={x:50,y:30};t||(n.x+=110);for(var o=0;o<e.out.length+e.in.length;o++){var a;(a=o<e.out.length?e.out[o]:e.in[o-e.out.length]).x==n.x&&a.y==n.y&&(n.x+=55,o=0)}return n}function t(){var t=RED.nodes.subflow(RED.workspaces.active()),n=e(t,!0),o={type:"subflow",direction:"in",z:t.id,i:t.in.length,x:n.x,y:n.y,id:RED.nodes.id()},a=t.in.length;t.in.push(o),t.dirty=!0;var i=RED.nodes.dirty(),r=t.changed;t.changed=!0;var d={t:"edit",node:t,dirty:i,changed:r,subflow:{inputCount:a,instances:s(!0).instances}};RED.history.push(d),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-input .spinner-value").html(t.in.length)}function n(){var e=RED.nodes.subflow(RED.workspaces.active());if(0!==e.in.length){"undefined"==typeof removedSubflowInputs&&(removedSubflowInputs=[e.in[e.in.length-1]]);var t=[];for(removedSubflowInputs.sort(function(e,t){return t.i-e.i}),i=0;i<removedSubflowInputs.length;i++){var n=removedSubflowInputs[i];e.in.splice(n.i,1);var o=[],a=[];RED.nodes.eachLink(function(t){"subflow"==t.source.type&&t.source.z==e.id&&t.source.i==n.i&&o.push(t),t.source.type=="subflow:"+e.id&&(t.sourcePort==output.i?o.push(t):t.targetPort>n.i&&a.push(t))}),o.forEach(function(e){RED.nodes.removeLink(e)}),a.forEach(function(e){e.targetPort--}),t=t.concat(o);for(var s=n.i;s<e.in.length;s++)e.in[s].i--,e.in[s].dirty=!0}return e.changed=!0,{subflowInputs:removedSubflowInputs,links:t}}}function o(t){var n=RED.nodes.subflow(RED.workspaces.active()),o=e(n,!1),a={type:"subflow",direction:"out",z:n.id,i:n.out.length,x:o.x,y:o.y,id:RED.nodes.id()},i=n.out.length;n.out.push(a),n.dirty=!0;var r=RED.nodes.dirty(),d=n.changed;n.changed=!0;var l={t:"edit",node:n,dirty:r,changed:d,subflow:{outputCount:i,instances:s(!0).instances}};RED.history.push(l),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-output .spinner-value").text(n.out.length)}function a(e){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.out.length){void 0===e&&(e=[t.out[t.out.length-1]]);var n=[];for(e.sort(function(e,t){return t.i-e.i}),i=0;i<e.length;i++){var o=e[i];t.out.splice(o.i,1);var a=[],s=[];RED.nodes.eachLink(function(e){"subflow"==e.target.type&&e.target.z==t.id&&e.target.i==o.i&&a.push(e),e.source.type=="subflow:"+t.id&&(e.sourcePort==o.i?a.push(e):e.sourcePort>o.i&&s.push(e))}),a.forEach(function(e){RED.nodes.removeLink(e)}),s.forEach(function(e){e.sourcePort--}),n=n.concat(a);for(var r=o.i;r<t.out.length;r++)t.out[r].i--,t.out[r].dirty=!0}return t.changed=!0,{subflowOutputs:e,links:n}}}function s(e){var t=RED.nodes.subflow(RED.workspaces.active());r(t);var n=[];if(t)return RED.nodes.filterNodes({type:"subflow:"+t.id}).forEach(function(o){for(n.push({id:o.id,changed:o.changed}),e&&(o.changed=!0),o.inputs=t.in.length;o.inputs<o.inputPorts.length;)o.inputPorts.pop();for(o.outputs=t.out.length;o.outputs<o.outputPorts.length;)o.outputPorts.pop();o.resize=!0,o.dirty=!0,RED.editor.updateNodeProperties(o)}),RED.editor.validateNode(t),{instances:n}}function r(e){e&&($("#workspace-subflow-input-add").toggleClass("active",0!==e.in.length),$("#workspace-subflow-input-remove").toggleClass("active",0===e.in.length),$("#workspace-subflow-input .spinner-value").html(e.in.length),$("#workspace-subflow-output .spinner-value").html(e.out.length))}function d(e){var i=$("#workspace-toolbar");i.empty(),$('<a class="button" id="workspace-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(i),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div id="workspace-subflow-input" style="display: inline-block;" class="button-group spinner-group"><a id="workspace-subflow-input-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="workspace-subflow-input-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(i),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="workspace-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="workspace-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="workspace-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(i),$('<a class="button" id="workspace-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(i),i.i18n(),$("#workspace-subflow-output-remove").click(function(t){t.preventDefault();var n=RED.nodes.dirty(),o=e.changed,i=a();if(i){var r=s(!0);RED.history.push({t:"delete",links:i.links,subflowOutputs:i.subflowOutputs,changed:o,dirty:n,subflow:{instances:r.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-output-add").click(function(e){e.preventDefault(),o()}),$("#workspace-subflow-input-add").click(function(e){e.preventDefault(),t()}),$("#workspace-subflow-input-remove").click(function(t){t.preventDefault();var o=RED.nodes.dirty(),a=e.changed;e.changed=!0;var i=n();if(i){var r=s(!0);RED.history.push({t:"delete",links:i.links,changed:a,subflowInputs:i.subflowInputs,dirty:o,subflow:{instances:r.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-edit").click(function(e){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),e.preventDefault()}),$("#workspace-subflow-delete").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),n=c(RED.workspaces.active());n.t="delete",n.dirty=t,RED.history.push(n)}),r(e),$("#chart").css({"margin-top":"40px"}),$("#workspace-toolbar").show()}function l(){$("#workspace-toolbar").hide().empty(),$("#chart").css({"margin-top":"0"})}function c(e){var t=[],n=[],o=RED.nodes.subflow(e);RED.nodes.eachNode(function(e){e.type=="subflow:"+o.id&&t.push(e),e.z==o.id&&t.push(e)}),RED.nodes.eachConfig(function(e){e.z==o.id&&t.push(e)});for(var a=[],i=0;i<t.length;i++){var s=RED.nodes.remove(t[i].id);n=n.concat(s.links),a=a.concat(s.nodes)}return t=t.concat(a),RED.nodes.removeSubflow(o),RED.workspaces.remove(o),RED.nodes.dirty(!0),RED.view.redraw(),{nodes:t,links:n,subflow:{subflow:o}}}function p(){var e=0;RED.nodes.eachSubflow(function(t){var n=new RegExp("^Subflow (\\d+)$").exec(t.name);n&&(e=Math.max(e,n[1]))});var t="Subflow "+(e+1),n=RED.nodes.id(),o={type:"subflow",id:n,name:t,info:"",in:[],out:[]};RED.nodes.addSubflow(o),RED.history.push({t:"createSubflow",subflow:{subflow:o},dirty:RED.nodes.dirty()}),RED.workspaces.show(n),RED.nodes.dirty(!0)}return{init:function(){RED.events.on("workspace:change",function(e){var t=RED.nodes.subflow(e.workspace);t?d(t):l()}),RED.actions.add("core:create-subflow",p)},createSubflow:p,removeSubflow:c,refresh:s,removeInput:n,removeOutput:a}}(),RED.userSettings=function(){function e(e){s.push(e)}function t(e){if(!i)if(RED.user.hasPermission("settings.write")){i=!0;var t={title:RED._("menu.label.userSettings"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){a=e.width},open:function(t){var n=t.find(".editor-tray-body"),o=$("<div></div>").appendTo(n),a=$("<div></div>",{id:"user-settings-tabs-container"}).appendTo(o);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(a);var i=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){$("#user-settings-tabs-content").children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),r=$("<div></div>",{id:"user-settings-tabs-content"}).appendTo(o);s.forEach(function(e){i.addTab({id:"user-settings-tab-"+e.id,label:e.title,pane:e}),e.get().hide().appendTo(r)}),o.i18n(),i.activateTab("user-settings-tab-"+(e||"view")),$("#sidebar-shade").show()},close:function(){i=!1,s.forEach(function(e){e.close&&e.close()}),$("#sidebar-shade").hide()},show:function(){}};null!==a&&(t.width=a),RED.tray.show(t)}else RED.notify(RED._("user.errors.settings"),"error")}function n(){var e=$('<div id="user-settings-tab-view" class="node-help"></div>'),t=RED.settings.get("editor")||{};return t.view=t.view||{},r.forEach(function(n){$("<h3></h3>").text(RED._(n.title)).appendTo(e),n.options.forEach(function(n){var o=t.view[n.setting],a=$('<div class="user-settings-row"></div>').appendTo(e);n.toggle?$('<label for="user-settings-'+n.setting+'"><input id="user-settings-'+n.setting+'" type="checkbox"> '+RED._(n.label)+"</label>").appendTo(a).find("input").prop("checked",o):($('<label for="user-settings-'+n.setting+'">'+RED._(n.label)+"</label>").appendTo(a),$('<input id="user-settings-'+n.setting+'" type="'+(n.type||"text")+'">').appendTo(a).val(o))})}),e}function o(e,t){var n=d[e],o=RED.settings.get("editor")||{};o.view=o.view||{},o.view[n.setting]=t,RED.settings.set("editor",o);var a=n.onchange;"string"==typeof a&&(a=RED.actions.get(a)),a&&a.call(n,t)}var a=700,i=!1,s=[],r=[{title:"menu.label.view.grid",options:[{setting:"view-show-grid",label:"menu.label.view.showGrid",default:!0,toggle:!0,onchange:"core:toggle-show-grid"},{setting:"view-snap-grid",label:"menu.label.view.snapGrid",default:!0,toggle:!0,onchange:"core:toggle-snap-grid"},{setting:"view-grid-size",label:"menu.label.view.gridSize",type:"number",default:10,onchange:RED.view.gridSize}]},{title:"menu.label.nodes",options:[{setting:"view-node-status",oldSetting:"menu-menu-item-status",label:"menu.label.displayStatus",default:!0,toggle:!0,onchange:"core:toggle-status"}]},{title:"menu.label.other",options:[{setting:"view-show-tips",oldSettings:"menu-menu-item-show-tips",label:"menu.label.showTips",toggle:!0,default:!0,onchange:"core:toggle-show-tips"}]}],d={};return{init:function(){RED.actions.add("core:show-user-settings",t),RED.actions.add("core:show-help",function(){t("keyboard")}),e({id:"view",title:RED._("menu.label.view.view"),get:n,close:function(){r.forEach(function(e){e.options.forEach(function(e){var t=$("#user-settings-"+e.setting);e.toggle?o(e.setting,t.prop("checked")):o(e.setting,t.val())})})}});var a=RED.settings.get("editor")||{};a.view=a.view||{};var i=!1;r.forEach(function(e){e.options.forEach(function(e){if(e.oldSetting){var t=RED.settings.get(e.oldSetting);void 0!==t&&null!==t&&(a.view[e.setting]=t,i=!0,RED.settings.remove(e.oldSetting))}if(d[e.setting]=e,e.onchange){var n=a.view[e.setting];null!==n&&void 0!==n||!e.hasOwnProperty("default")||(n=e.default,a.view[e.setting]=n,i=!0);var o=e.onchange;"string"==typeof o&&(o=RED.actions.get(o)),o&&o.call(e,n)}})}),i&&RED.settings.set("editor",a)},toggle:function(e){var t=d[e],n=RED.settings.get("editor")||{};n.view=n.view||{},o(e,!n.view[t.setting])},show:t,add:e}}(),RED.projects=function(){function e(e){var t;"git_missing_user"===e.error?t=RED.notify("<p>You Git client is not configured with a username/email.</p>",{fixed:!0,type:"error",buttons:[{text:"Cancel",click:function(){t.close()}},{text:"Configure Git client",click:function(){RED.userSettings.show("gitconfig"),t.close()}}]}):(console.log(e),t=RED.notify("<p>An unexpected error occurred:</p><p>"+e.message+"</p><small>code: "+e.error+"</small>",{fixed:!0,modal:!0,type:"error",buttons:[{text:"Close",click:function(){t.close()}}]}))}function t(){var t=$('<div class="projects-dialog-screen-start-hero"></div>');$('<span><i class="fa fa-files-o fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-long-arrow-right fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-archive fa-2x"></i></span>').appendTo(t),$("<hr>").appendTo(t);var o={};h={welcome:{content:function(e){var n=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(n);var i=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(n);$("<p>").text("Hello! We have introduced 'projects' to Node-RED.").appendTo(i),$("<p>").text("This is a new way for you to manage your flow files and includes version control of your flows.").appendTo(i),$("<p>").text("To get started you can create your first project or clone an existing project from a git repository.").appendTo(i),$("<p>").text("If you are not sure, you can skip this for now. You will still be able to create your first project from the 'Projects' menu at any time.").appendTo(i);var s=$('<div style="text-align: center"></div>').appendTo(i),r=$('<button data-type="empty" class="editor-button projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>Create Project</button>').appendTo(s),d=$('<button data-type="clone" class="editor-button projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>Clone Repository</button>').appendTo(s);return r.click(function(e){e.preventDefault(),o={action:"create"},a("git-config")}),d.click(function(e){e.preventDefault(),o={action:"clone"},a("git-config")}),n},buttons:[{text:"Not right now",click:function(){o={},$(this).dialog("close")}}]},"git-config":function(){var e,n;return{content:function(o){var a=!1,i=RED.settings.get("git");i&&i.user?i=i.user:RED.settings.git&&RED.settings.git.globalUser&&(a=!0,i=RED.settings.git.globalUser);var s=function(){var t=e.val().trim(),o=n.val().trim(),a=t.length>0&&o.length>0;$("#projects-dialog-git-config").prop("disabled",!a).toggleClass("disabled ui-button-disabled ui-state-disabled",!a)},r=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(r);var d=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(r);$("<p>").text("Setup your version control client").appendTo(d),$("<p>").text("Node-RED uses the open source tool Git for version control. It tracks changes to your project files and lets you push them to remote repositories.").appendTo(d),$("<p>").text("When you commit a set of changes, Git records who made the changes with a username and email address. The Username can be anything you want - it does not need to be your real name.").appendTo(d),a&&$("<p>").text("Your Git client is already configured with the details below.").appendTo(d),$("<p>").text("You can change these settings later under the 'Git config' tab of the settings dialog.").appendTo(d);var l=$('<div class="form-row"></div>').appendTo(d);return $('<label for="">Username</label>').appendTo(l),(e=$('<input type="text">').val(i&&i.name||"").appendTo(l)).on("change keyup paste",s),l=$('<div class="form-row"></div>').appendTo(d),$('<label for="">Email</label>').appendTo(l),(n=$('<input type="text">').val(i&&i.email||"").appendTo(l)).on("change keyup paste",s),setTimeout(function(){e.focus(),s()},50),r},buttons:[{text:"Back",click:function(){a("welcome")}},{id:"projects-dialog-git-config",text:"Next",class:"primary",click:function(){var t=RED.settings.get("git")||{};t.user=t.user||{},t.user.name=e.val(),t.user.email=n.val(),RED.settings.set("git",t),"create"===o.action?a("project-details"):"clone"===o.action&&a("clone-project")}}]}}(),"project-details":function(){var e,n;return{content:function(a){var i=null,s=!1;$.getJSON("projects",function(e){i={},e.projects.forEach(function(e){i[e]=!0,s&&(s=!1,l())})});var r=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(r);var d=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(r);$("<p>").text("Create your project").appendTo(d),$("<p>").text("A project is maintained as a Git repository. It makes it much easier to share your flows with others and to collaborate on them.").appendTo(d),$("<p>").text("You can create multiple projects and quickly switch between them from the editor.").appendTo(d),$("<p>").text("To begin, your project needs a name and an optional description.").appendTo(d);var l=function(){var t=e.val(),n=!0;if(g){if(null===i)return void(s=!0);h.empty(),!/^[a-zA-Z0-9\-_]+$/.test(t)||i[t]?(e.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(h),u=!1,n=!1,i[t]?projectNameSublabel.text("Project already exists"):projectNameSublabel.text("Must contain only A-Z 0-9 _ -")):(e.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(h),projectNameSublabel.text("Must contain only A-Z 0-9 _ -"),u=!0),v=t}n=u,$("#projects-dialog-create-name").prop("disabled",!n).toggleClass("disabled ui-button-disabled ui-state-disabled",!n)},c=$('<div class="form-row"></div>').appendTo(d);$('<label for="projects-dialog-screen-create-project-name">Project name</label>').appendTo(c);var p=$('<div style="position:relative;"></div>').appendTo(c);e=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').val(o.name||"").appendTo(p);var u,f,h=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(p),g=!1,v="";return e.on("change keyup paste",function(){if(g=e.val()!==v,f)clearTimeout(f);else if(g&&(h.empty(),$('<img src="red/images/spin.svg"/>').appendTo(h),""===e.val()))return void l();f=setTimeout(function(){l(),f=null},300)}),projectNameSublabel=$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(c).find("small"),c=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(d),$('<label for="projects-dialog-screen-create-project-desc">Description</label>').appendTo(c),n=$('<input id="projects-dialog-screen-create-project-desc" type="text">').val(o.summary||"").appendTo(c),$('<label class="projects-edit-form-sublabel"><small>Optional</small></label>').appendTo(c),setTimeout(function(){e.focus(),e.change()},50),r},buttons:function(t){return[{text:"Back",click:function(){a("git-config")}},{id:"projects-dialog-create-name",disabled:!0,text:"Next",class:"primary disabled",click:function(){o.name=e.val(),o.summary=n.val(),a("default-files",t)}}]}}}(),"clone-project":function(){var n,o,i,s,d,l,c,u;return{content:function(e){var a=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(a);var r=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(a);$("<p>").text("Clone a project").appendTo(r),$("<p>").text("If you already have a git repository containing a project, you can clone it to get started.").appendTo(r);var p=null,f=!1;$.getJSON("projects",function(e){p={},e.projects.forEach(function(e){p[e]=!0,f&&(f=!1,g())})});var h,g=function(){var e=n.val(),t=!0;if(y){if(null===p)return void(f=!0);b.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||p[e]?(n.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(b),v=!1,t=!1,p[e]?l.text("Project already exists"):l.text("Must contain only A-Z 0-9 _ -")):(n.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(b),l.text("Must contain only A-Z 0-9 _ -"),v=!0),w=e}t=v;var o=i.val(),a=o.length>0&&!/\s/.test(o);/^https?:\/\/[^/]+@/i.test(o)&&($("#projects-dialog-screen-create-project-repo-label small").text("Do not include the username/password in the url"),a=!1),a?i.removeClass("input-error"):(E&&i.addClass("input-error"),t=!1),/^https?:\/\//.test(o)?($(".projects-dialog-screen-create-row-creds").show(),$(".projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(o)?($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").show()):($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").hide()),$("#projects-dialog-clone-project").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)};h=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty projects-dialog-screen-create-row-clone"></div>').appendTo(r),$('<label for="projects-dialog-screen-create-project-name">Project name</label>').appendTo(h);T=$('<div style="position:relative;"></div>').appendTo(h);n=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').appendTo(T);var v,m,b=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(T),y=!1,w="",D="";n.on("change keyup paste",function(){if(y=n.val()!==w,m)clearTimeout(m);else if(y&&(b.empty(),$('<img src="red/images/spin.svg"/>').appendTo(b),""===n.val()))return void g();m=setTimeout(function(){g(),m=null},300)}),l=$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(h).find("small"),h=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(r),$('<label for="projects-dialog-screen-create-project-repo">Git repository URL</label>').appendTo(h),i=$('<input id="projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(h),$('<label id="projects-dialog-screen-create-project-repo-label" class="projects-edit-form-sublabel"><small>https://, ssh:// or file://</small></label>').appendTo(h);var E=!1,x="";i.on("change keyup paste",function(){E=!0;var e=$(this).val();x!==e&&$("#projects-dialog-screen-create-project-repo-label small").text("https://, ssh:// or file://"),x=e;var t=/\/([^/]+?)(?:\.git)?$/.exec(e);if(t){var o=n.val();""!==o&&o!==D||(D=t[1],n.val(D),n.change())}g()});var R=$('<div class="projects-dialog-screen-create-row"></div>').appendTo(r);h=$('<div class="form-row projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(R),$('<div><i class="fa fa-warning"></i> Authentication failed</div>').appendTo(h),h=$('<div class="hide form-row projects-dialog-screen-create-row-creds"></div>').hide().appendTo(R);var T=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(h);$('<label for="projects-dialog-screen-create-project-repo-user">Username</label>').appendTo(T),s=$('<input id="projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(T),T=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(h),$('<label for="projects-dialog-screen-create-project-repo-pass">Password</label>').appendTo(T),d=$('<input id="projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(T),h=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(R),T=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(h),$('<label for="projects-dialog-screen-create-project-repo-passphrase">SSH Key</label>').appendTo(T),c=$("<select>",{style:"width: 100%"}).appendTo(T),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){c.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(c.addClass("input-error"),c.attr("disabled",!0),k.show()):(c.removeClass("input-error"),c.attr("disabled",!1),k.hide())}),T=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(h),$('<label for="projects-dialog-screen-create-project-repo-passphrase">Passphrase</label>').appendTo(T),u=$('<input id="projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(T),T=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').appendTo(R);var k=$('<div class="projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(T);return $('<div class="form-row"><i class="fa fa-warning"></i> Before you can clone a repository over ssh you must add an SSH key to access it.</div>').appendTo(k),T=$('<div style="text-align: center">').appendTo(k),$('<button class="editor-button">Add an ssh key</button>').appendTo(T).click(function(e){e.preventDefault(),$("#projects-dialog-cancel").click(),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").click()},500)}),h=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(r),$("<label>Credentials encryption key</label>").appendTo(h),o=$('<input type="password"></input>').appendTo(h),a},buttons:function(t){return[{text:"Back",click:function(){a("git-config")}},{id:"projects-dialog-clone-project",disabled:!0,text:"Clone project",class:"primary disabled",click:function(){$(".projects-dialog-screen-create-type.selected").data("type");var t={name:n.val()};t.credentialSecret=o.val();var a=i.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(a)){var l=c.val();if(!l)return void console.log("Error! Can't get selected SSH key path.");t.git={remotes:{origin:{url:a,keyFile:l,passphrase:u.val()}}}}else t.git={remotes:{origin:{url:a,username:s.val(),password:d.val()}}};$(".projects-dialog-screen-create-row-auth-error").hide(),$("#projects-dialog-screen-create-project-repo-label small").text("https://, ssh:// or file://"),s.removeClass("input-error"),d.removeClass("input-error"),c.removeClass("input-error"),u.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(t.name),r({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(e){p.dialog("close")},400:{project_exists:function(e){console.log("already exists")},git_error:function(e){console.log("git error",e)},git_connection_failed:function(e){i.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Connection failed")},git_not_a_repository:function(e){i.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Not a git repository")},git_repository_not_found:function(e){i.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Repository not found")},git_auth_failed:function(e){$(".projects-dialog-screen-create-row-auth-error").show(),s.addClass("input-error"),d.addClass("input-error"),c.addClass("input-error"),u.addClass("input-error")},missing_flow_file:function(e){p.dialog("close")},project_empty:function(e){p.dialog("close")},credentials_load_failed:function(e){p.dialog("close")},"*":function(t){e(t),$(p).dialog("close")}}}},t).then(function(){RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}}}(),"default-files":function(){var e,n;return{content:function(a){var i=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(i);var s=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(i);$("<p>").text("Create your project files").appendTo(s),$("<p>").text("A project contains your flow files, a README file and a package.json file.").appendTo(s),$("<p>").text("It can contain any other files you want to maintain in the Git repository.").appendTo(s),!a.existingProject&&RED.settings.files&&$("<p>").text("Your existing flow and credential files will be copied into the project.").appendTo(s);var r=function(){var t=!0,o=e.val();""!==o&&/\.json$/.test(o)?(e.hasClass("input-error")&&(e.removeClass("input-error"),e.next().empty()),n.hasClass("input-error")&&(n.removeClass("input-error"),n.next().empty()),n.text(o.substring(0,o.length-5)+"_cred.json")):(t=!1,e.hasClass("input-error")||(e.addClass("input-error"),e.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>')),n.text(""),n.hasClass("input-error")||(n.addClass("input-error"),n.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),$("#projects-dialog-create-default-files").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)},d=$('<div class="form-row"></div>').appendTo(s);$('<label for="projects-dialog-screen-create-project-file">Flow file</label>').appendTo(d);var l=$('<div style="position:relative;"></div>').appendTo(d),c=o.files&&o.files.flow||RED.settings.files&&RED.settings.files.flow||"flow.json";e=$('<input id="projects-dialog-screen-create-project-file" type="text">').val(c).on("change keyup paste",r).appendTo(l),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(l),$('<label class="projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(d);var p=o.files&&o.files.credentials||RED.settings.files&&RED.settings.files.credentials||"flow_cred.json";return d=$('<div class="form-row"></div>').appendTo(s),$('<label for="projects-dialog-screen-create-project-credfile">Credentials file</label>').appendTo(d),l=$('<div style="position:relative;"></div>').appendTo(d),n=$('<div style="width: 100%" class="uneditable-input" id="projects-dialog-screen-create-project-credentials">').text(p).appendTo(l),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(l),setTimeout(function(){e.focus(),r()},50),i},buttons:function(t){return[{text:t.existingProject?"Cancel":"Back",click:function(){t.existingProject?$(this).dialog("close"):a("project-details",t)}},{id:"projects-dialog-create-default-files",text:"Next",class:"primary",click:function(){o.files={flow:e.val(),credentials:n.text()},t.existingProject||(o.migrateFiles=!0),a("encryption-config",t)}}]}}}(),"encryption-config":function(){var n;return{content:function(e){var o=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(o);var a=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(o);$("<p>").text("Setup encryption of your credentials file").appendTo(a),e.existingProject?($("<p>").text("Your flow credentials file can be encrypted to keep its contents secure.").appendTo(a),$("<p>").text("If you want to store these credentials in a public Git repository, you must encrypt them by providing a secret key phrase.").appendTo(a)):"disabled"===RED.settings.flowEncryptionType?($("<p>").text("Your flow credentials file is not currently encrypted.").appendTo(a),$("<p>").text("That means its contents, such as passwords and access tokens, can be read by anyone with access to the file.").appendTo(a),$("<p>").text("If you want to store these credentials in a public Git repository, you must encrypt them by providing a secret key phrase.").appendTo(a)):("user"===RED.settings.flowEncryptionType?$("<p>").text("Your flow credentials file is currently encrypted using the credentialSecret property from your settings file as the key.").appendTo(a):"system"===RED.settings.flowEncryptionType&&$("<p>").text("Your flow credentials file is currently encrypted using a system-generated key. You should provide a new secret key for this project.").appendTo(a),$("<p>").text("The key will be stored separately from your project files. You will need to provide the key to use this project in another instance of Node-RED.").appendTo(a));var i=function(){var e=!0;"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(e=e&&""!==n.val()),$("#projects-dialog-create-encryption").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},s=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(a);$("<label>Credentials</label>").appendTo(s);var r=$('<div style="width: 550px">').appendTo(s),d=$('<div style="min-height:150px; box-sizing: border-box; float: right; vertical-align: top; width: 331px; margin-left: -1px; padding: 15px; margin-top: -15px; border: 1px solid #ccc; border-radius: 3px;  display: inline-block">').appendTo(r),l=$('<div style="vertical-align: top; width: 220px;  display: inline-block">').appendTo(r),c=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid #ccc;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: white;"></div>').appendTo(l);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="enabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-lock"></i> <span style="vertical-align: middle;">Enable encryption</span></label>').appendTo(c);var p=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid white;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: #ccc; "></div>').appendTo(l);return $('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="disabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-unlock"></i> <span style="vertical-align: middle;">Disable encryption</span></label>').appendTo(p),l.find("input[name=projects-encryption-type]").click(function(e){var t,o;"enabled"===$(this).val()?(t=c,o=p,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&n.focus()):(o=c,t=p,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.css({borderColor:"#ccc",borderRightColor:"white"}),o.css({borderColor:"white",borderRightColor:"#ccc"}),i()}),s=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(d),$('<label class="projects-edit-form-inline-label '+("user"!==RED.settings.flowEncryptionType?"disabled":"")+'" style="margin-left: 5px"><input '+("user"!==RED.settings.flowEncryptionType?"disabled":"")+' type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="default" name="projects-encryption-key"> <span style="vertical-align: middle;">Copy over existing key</span></label>').appendTo(s),s=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(d),$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="custom" name="projects-encryption-key"> <span style="vertical-align: middle;">Use custom key</span></label>').appendTo(s),s=$('<div class="projects-encryption-enabled-row"></div>').appendTo(d),(n=$('<input disabled type="password" style="margin-left: 25px; width: calc(100% - 30px);"></input>').appendTo(s)).on("change keyup paste",i),s=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(d),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> The credentials file will not be encrypted and its contents easily read</div>').appendTo(s),d.find("input[name=projects-encryption-key]").click(function(){var e=$(this).val();n.attr("disabled","default"===e),"custom"===e&&n.focus(),i()}),setTimeout(function(){l.find("input[name=projects-encryption-type][value=enabled]").click(),"user"!==RED.settings.flowEncryptionType?d.find("input[name=projects-encryption-key][value=custom]").click():d.find("input[name=projects-encryption-key][value=default]").click(),i()},100),o},buttons:function(t){return[{text:"Back",click:function(){a("default-files",t)}},{id:"projects-dialog-create-encryption",text:t.existingProject?"Create project files":"Create project",class:"primary disabled",disabled:!0,click:function(){"enabled"===$("input[name=projects-encryption-type]:checked").val()?"custom"===$("input[name=projects-encryption-key]:checked").val()&&(o.credentialSecret=n.val()):o.credentialSecret=!1,RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(o.name);var i="POST",s="projects";t.existingProject&&(o.initialise=!0,i="PUT",s="projects/"+f.name);var d=this;r({url:s,type:i,requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){o={},t.existingProject?$(d).dialog("close"):(a("create-success"),RED.menu.setDisabled("menu-item-projects-open",!1),RED.menu.setDisabled("menu-item-projects-settings",!1))},400:{project_exists:function(e){console.log("already exists")},git_error:function(e){console.log("git error",e)},git_connection_failed:function(e){projectRepoInput.addClass("input-error")},git_auth_failed:function(e){projectRepoUserInput.addClass("input-error"),projectRepoPasswordInput.addClass("input-error"),console.log("git auth error",e)},"*":function(t){e(t),$(p).dialog("close")}}}},o).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}}}(),"create-success":{content:function(e){var n=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(n);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(n);return $("<p>").text("You have successfully created your first project!").appendTo(o),$("<p>").text("You can now continue to use Node-RED just as you always have.").appendTo(o),$("<p>").text("The 'info' tab in the sidebar shows you what your current active project is. The button next to the name can be used to access the project settings view.").appendTo(o),$("<p>").text("The 'history' tab in the sidebar can be used to view files that have changed in your project and to commit them. It shows you a complete history of your commits and allows you to push your changes to a remote repository.").appendTo(o),n},buttons:[{text:"Done",click:function(){$(this).dialog("close")}}]},create:function(){var t,o,a,s,d,l,c,u,f,h,g,v;return{title:"Projects",content:function(e){var n=null;v=null;var r=!1;$.getJSON("projects",function(e){n={},e.projects.forEach(function(e){n[e]=!0,r&&(r=!1,b())})});var p,m=$('<div class="projects-dialog-screen-create"></div>'),b=function(){var e=t.val(),o=!0;if(T){if(null===n)return void(r=!0);R.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||n[e]?(t.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(R),E=!1,o=!1,n[e]?f.text("Project already exists"):f.text("Must contain only A-Z 0-9 _ -")):(t.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(R),f.text("Must contain only A-Z 0-9 _ -"),E=!0),k=e}o=E;var i=$(".projects-dialog-screen-create-type.selected").data("type");if("copy"===i)o=!1;else if("clone"===i){var s=d.val(),c=s.length>0&&!/\s/.test(s);/^https?:\/\/[^/]+@/i.test(s)&&($("#projects-dialog-screen-create-project-repo-label small").text("Do not include the username/password in the url"),c=!1),c?d.removeClass("input-error"):(L&&d.addClass("input-error"),o=!1),/^https?:\/\//.test(s)?($(".projects-dialog-screen-create-row-creds").show(),$(".projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(s)?($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").show()):($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").hide())}else if("empty"===i){var p=a.val();""!==p&&/\.json$/.test(p)?a.hasClass("input-error")&&(a.removeClass("input-error"),a.next().empty()):(o=!1,a.hasClass("input-error")||(a.addClass("input-error"),a.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(o=o&&""!==l.val())}else"open"===i&&(o=!!v);$("#projects-dialog-create").prop("disabled",!o).toggleClass("disabled ui-button-disabled ui-state-disabled",!o)};p=$('<div class="form-row button-group"></div>').appendTo(m);var y=$('<button data-type="open" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-folder-open"></i><br/>Open Project</button>').appendTo(p),w=$('<button data-type="empty" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>Create Project</button>').appendTo(p),D=$('<button data-type="clone" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>Clone Repository</button>').appendTo(p);p.find(".projects-dialog-screen-create-type").click(function(e){switch(e.preventDefault(),m.find(".projects-dialog-screen-create-type").removeClass("selected"),$(this).addClass("selected"),m.find(".projects-dialog-screen-create-row").hide(),m.find(".projects-dialog-screen-create-row-"+$(this).data("type")).show(),b(),t.focus(),$(this).data("type")){case"open":$("#projects-dialog-create").text("Open project");break;case"empty":$("#projects-dialog-create").text("Create project");break;case"clone":$("#projects-dialog-create").text("Clone project")}}),p=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-open"></div>').hide().appendTo(m),i({canSelectActive:!1,dblclick:function(e){v=e,$("#projects-dialog-create").click()},select:function(e){v=e,b()},delete:function(e){n&&delete n[e.name],v=null,b()}}).appendTo(p),p=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty projects-dialog-screen-create-row-clone"></div>').appendTo(m),$('<label for="projects-dialog-screen-create-project-name">Project name</label>').appendTo(p);A=$('<div style="position:relative;"></div>').appendTo(p);t=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').appendTo(A);var E,x,R=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(A),T=!1,k="",_="";t.on("change keyup paste",function(){if(T=t.val()!==k,x)clearTimeout(x);else if(T&&(R.empty(),$('<img src="red/images/spin.svg"/>').appendTo(R),""===t.val()))return void b();x=setTimeout(function(){b(),x=null},300)}),f=$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(p).find("small"),p=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(m),$('<label for="projects-dialog-screen-create-project-desc">Description</label>').appendTo(p),o=$('<input id="projects-dialog-screen-create-project-desc" type="text">').appendTo(p),$('<label class="projects-edit-form-sublabel"><small>Optional</small></label>').appendTo(p),p=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(m),$('<label for="projects-dialog-screen-create-project-file">Flow file</label>').appendTo(p),A=$('<div style="position:relative;"></div>').appendTo(p),a=$('<input id="projects-dialog-screen-create-project-file" type="text">').val("flow.json").on("change keyup paste",b).appendTo(A),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(A),$('<label class="projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(p),p=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(m),$("<label>Credentials</label>").appendTo(p);var C=$('<div style="width: 550px">').appendTo(p),j=$('<div style="min-height:150px; box-sizing: border-box; float: right; vertical-align: top; width: 331px; margin-left: -1px; padding: 15px; margin-top: -15px; border: 1px solid #ccc; border-radius: 3px;  display: inline-block">').appendTo(C),S=$('<div style="vertical-align: top; width: 220px;  display: inline-block">').appendTo(C),O=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid #ccc;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: white;"></div>').appendTo(S);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" checked style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="enabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-lock"></i> <span style="vertical-align: middle;">Enable encryption</span></label>').appendTo(O);var P=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid white;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: #ccc; "></div>').appendTo(S);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="disabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-unlock"></i> <span style="vertical-align: middle;">Disable encryption</span></label>').appendTo(P),S.find("input[name=projects-encryption-type]").click(function(e){var t,n;"enabled"===$(this).val()?(t=O,n=P,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&l.focus()):(n=O,t=P,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.css({borderColor:"#ccc",borderRightColor:"white"}),n.css({borderColor:"white",borderRightColor:"#ccc"}),b()}),p=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(j),$('<label class="projects-edit-form-inline-label">Encryption key</label>').appendTo(p),(l=$('<input type="password"></input>').appendTo(p)).on("change keyup paste",b),$('<label class="projects-edit-form-sublabel"><small>A phrase to secure your credentials with</small></label>').appendTo(p),p=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(j),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> The credentials file will not be encrypted and its contents easily read</div>').appendTo(p),j.find("input[name=projects-encryption-key]").click(function(){var e=$(this).val();l.attr("disabled","default"===e),"custom"===e&&l.focus(),b()}),p=$('<div class="hide form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(m),$('<label for="projects-dialog-screen-create-project-repo">Git repository URL</label>').appendTo(p),d=$('<input id="projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(p),$('<label id="projects-dialog-screen-create-project-repo-label" class="projects-edit-form-sublabel"><small>https://, ssh:// or file://</small></label>').appendTo(p);var L=!1,I="";d.on("change keyup paste",function(){L=!0;var e=$(this).val();I!==e&&$("#projects-dialog-screen-create-project-repo-label small").text("https://, ssh:// or file://"),I=e;var n=/\/([^/]+?)(?:\.git)?$/.exec(e);if(n){var o=t.val();""!==o&&o!==_||(_=n[1],t.val(_),t.change())}b()});var N=$('<div class="hide projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').hide().appendTo(m);p=$('<div class="form-row projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(N),$('<div><i class="fa fa-warning"></i> Authentication failed</div>').appendTo(p),p=$('<div class="hide form-row projects-dialog-screen-create-row-creds"></div>').hide().appendTo(N);var A=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(p);$('<label for="projects-dialog-screen-create-project-repo-user">Username</label>').appendTo(A),c=$('<input id="projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(A),A=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(p),$('<label for="projects-dialog-screen-create-project-repo-pass">Password</label>').appendTo(A),u=$('<input id="projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(A),p=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(N),A=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(p),$('<label for="projects-dialog-screen-create-project-repo-passphrase">SSH Key</label>').appendTo(A),h=$("<select>",{style:"width: 100%"}).appendTo(A),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){h.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(h.addClass("input-error"),h.attr("disabled",!0),z.show()):(h.removeClass("input-error"),h.attr("disabled",!1),z.hide())}),A=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(p),$('<label for="projects-dialog-screen-create-project-repo-passphrase">Passphrase</label>').appendTo(A),g=$('<input id="projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(A),A=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').appendTo(N);var z=$('<div class="projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(A);switch($('<div class="form-row"><i class="fa fa-warning"></i> Before you can clone a repository over ssh you must add an SSH key to access it.</div>').appendTo(z),A=$('<div style="text-align: center">').appendTo(z),$('<button class="editor-button">Add an ssh key</button>').appendTo(A).click(function(e){e.preventDefault(),$("#projects-dialog-cancel").click(),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").click()},500)}),p=$('<div class="hide form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(m),$("<label>Credentials encryption key</label>").appendTo(p),s=$('<input type="password"></input>').appendTo(p),e.screen||"empty"){case"empty":w.click();break;case"open":y.click();break;case"clone":D.click()}return setTimeout(function(){"open"!==(e.screen||"empty")?t.focus():$("#projects-dialog-project-list-search").focus()},50),m},buttons:function(i){var f;switch(i.screen||"empty"){case"open":f="Open project";break;case"empty":f="Create project";break;case"clone":f="Clone project"}return[{id:"projects-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"projects-dialog-create",text:f,class:"primary disabled",disabled:!0,click:function(){var i=$(".projects-dialog-screen-create-type.selected").data("type"),f={name:t.val()};if("empty"===i){f.summary=o.val(),f.files={flow:a.val()};var m=$("input[name=projects-encryption-type]:checked").val();f.credentialSecret="enabled"===m&&l.val()}else if("copy"===i)f.copy=(void 0).name;else if("clone"===i){f.credentialSecret=s.val();var b=d.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(b)){var y=h.val();if(!y)return void console.log("Error! Can't get selected SSH key path.");f.git={remotes:{origin:{url:b,keyFile:y,passphrase:g.val()}}}}else f.git={remotes:{origin:{url:b,username:c.val(),password:u.val()}}}}else if("open"===i)return n(v.name,function(e,t){p.dialog("close"),e&&"credentials_load_failed"!==e.error&&console.log("unexpected_error",e)});$(".projects-dialog-screen-create-row-auth-error").hide(),$("#projects-dialog-screen-create-project-repo-label small").text("https://, ssh:// or file://"),c.removeClass("input-error"),u.removeClass("input-error"),h.removeClass("input-error"),g.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(f.name),r({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(e){p.dialog("close")},400:{project_exists:function(e){console.log("already exists")},git_error:function(e){console.log("git error",e)},git_connection_failed:function(e){d.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Connection failed")},git_not_a_repository:function(e){d.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Not a git repository")},git_repository_not_found:function(e){d.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Repository not found")},git_auth_failed:function(e){$(".projects-dialog-screen-create-row-auth-error").show(),c.addClass("input-error"),u.addClass("input-error"),h.addClass("input-error"),g.addClass("input-error")},missing_flow_file:function(e){p.dialog("close")},project_empty:function(e){p.dialog("close")},credentials_load_failed:function(e){p.dialog("close")},"*":function(t){e(t),$(p).dialog("close")}}}},f).then(function(){RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}}}()}}function n(e,t){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(e),r({url:"projects/"+e,type:"PUT",requireCleanWorkspace:!0,responses:{200:function(e){t(null,e)},400:{"*":t}}},{active:!0}).then(function(){RED.events.emit("project:change",{name:e})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}function o(e,t,n){var o=$("<div>").css({background:"white",position:"absolute",top:0,right:0,bottom:0,left:"100%",overflow:"hidden",padding:"5px 20px",transition:"left 0.4s",whitespace:"nowrap",width:"1000px"}).click(function(e){e.stopPropagation()}).appendTo(e);$("<span>").css({lineHeight:"40px"}).text("Are you sure you want to delete this project?").appendTo(o),$('<button style="margin-left:20px" class="editor-button">Cancel</button>').appendTo(o).click(function(e){e.stopPropagation(),o.remove(),n(!0)}),$('<button style="margin-left:20px" class="editor-button primary">Delete</button>').appendTo(o).click(function(e){e.stopPropagation(),o.remove(),r({url:"projects/"+t,type:"DELETE",responses:{200:function(e){n(!1)},400:{unexpected_error:function(e){o.remove(),n(!0)}}}})}),setTimeout(function(){o.css("left",0)},50)}function a(e,t){p||RED.projects.init();var n=h[e],o=n.content(t||{});u.empty();var a=n.buttons;"function"==typeof a&&(a=a(t||{})),p.dialog("option","buttons",a),u.append(o),p.dialog("option","title",n.title||""),p.dialog("open"),p.dialog({position:{my:"center top",at:"center top+10%",of:window}})}function i(e){e=e||{};var t,n=$("<div></div>",{class:"projects-dialog-project-list-container"}),a="",i=$("<div>",{class:"red-ui-search-container"}).appendTo(n),s=$('<input id="projects-dialog-project-list-search" type="text" placeholder="search your projects">').appendTo(i).searchBox({delay:200,change:function(){a=$(this).val().toLowerCase(),l.editableList("filter"),t&&!t.is(":visible")?(t.children().children().removeClass("selected"),(t=l.children(":visible").first()).children().children().addClass("selected"),e.select&&e.select(t.children().data("data"))):((t=l.children(":visible").first()).children().children().addClass("selected"),e.select&&e.select(t.children().data("data"))),r()}});s.on("keydown",function(n){if(40===n.keyCode){n.preventDefault();var o=t;if(t){do{o=o.next()}while(0!==o.length&&!o.is(":visible"));if(0===o.length)return;t.children().children().removeClass("selected")}else o=l.children(":visible").first();(t=o).children().children().addClass("selected"),e.select&&e.select(t.children().data("data")),r()}else if(38===n.keyCode){n.preventDefault();var a=t;if(t){do{a=a.prev()}while(0!==a.length&&!a.is(":visible"));if(0===a.length)return;t.children().children().removeClass("selected")}else a=l.children(":visible").first();(t=a).children().children().addClass("selected"),e.select&&e.select(t.children().data("data")),r()}else 13===n.keyCode&&(n.preventDefault(),t&&e.dblclick&&e.dblclick(t.children().data("data")))}),s.i18n();var r=function(){var e=l.find(".projects-dialog-project-list-entry.selected").parent().parent();if(1===e.length){var t=d,n=t.height(),o=(t.scrollTop(),e.position().top),a=e.height();o+a>n?t.animate({scrollTop:"-="+(n-o-a)},50):o<0&&t.animate({scrollTop:"+="+o},50)}},d=$("<div></div>",{class:"projects-dialog-project-list-inner-container"}).appendTo(n),l=$("<ol>",{class:"projects-dialog-project-list"}).appendTo(d).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(n,a,i){var d=$("<div></div>",{class:"projects-dialog-project-list-entry"}).appendTo(n);if($('<span class="projects-dialog-project-list-entry-icon"><i class="fa fa-archive"></i></span>').appendTo(d),$('<span class="projects-dialog-project-list-entry-name" style=""></span>').text(i.name).appendTo(d),!f||f.name!==i.name||(d.addClass("projects-list-entry-current"),$('<span class="projects-dialog-project-list-entry-current">current</span>').appendTo(d),!1!==e.canSelectActive)){d.addClass("selectable");var c=$('<div class="projects-dialog-project-list-entry-tools"></div>').appendTo(d);$('<button class="editor-button editor-button-small" style="float: right;"><i class="fa fa-trash"></i></button>').appendTo(c).click(function(t){t.stopPropagation(),t.preventDefault(),o(n,i.name,function(t){t||n.fadeOut(300,function(){l.editableList("removeItem",i),e.delete&&e.delete(i)})})}),n.click(function(o){$(".projects-dialog-project-list-entry").removeClass("selected"),d.addClass("selected"),t=n.parent(),e.select&&e.select(i),r(),s.focus()}),e.dblclick&&n.dblclick(function(t){t.preventDefault(),e.dblclick(i)})}},filter:function(e){return""===a||-1!==e.name.toLowerCase().indexOf(a)}});return $.getJSON("projects",function(e){e.projects.forEach(function(e){l.editableList("addItem",{name:e})})}),n}function s(e){if(RED.nodes.dirty())var t=RED.notify("<p>You have undeployed changes that will be lost.</p><p>Do you want to continue?</p>",{type:"info",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.close(),e(!0)}},{text:"Continue",click:function(){t.close(),e(!1)}}]})}function r(e,t){if(e.requireCleanWorkspace&&RED.nodes.dirty()){var n,o;return s(function(a){a?e.cancel&&(e.cancel(),o&&o()):(delete e.requireCleanWorkspace,r(e,t).then(function(){n&&n()}).always(function(){o&&o()}))}),{then:function(e){return n=e,{always:function(e){o=e}}},always:function(e){o=e}}}var a=Date.now();$(".projects-dialog-spinner").show(),$("#projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility","hidden"),t&&(e.data=JSON.stringify(t),e.contentType="application/json; charset=utf-8");var i,d;return $.ajax(e).done(function(t,n,o){e.responses&&e.responses[200]&&(i=e.responses[200],d=t)}).fail(function(n,o,a){if(e.responses&&e.responses[n.status]){var s=e.responses[n.status];if("function"==typeof s)return i=s,void(d={error:s.statusText});if(!1!==e.handleAuthFail&&"git_auth_failed"===n.responseJSON.error){var l=f.git.remotes[n.responseJSON.remote||e.remote||"origin"].fetch,c=$('<div><div class="form-row">Authentication required for repository:</div><div class="form-row"><div style="margin-left: 20px;">'+l+"</div></div></div>"),p=!1;if(/^https?:\/\//.test(l))$('<div class="form-row"><label for="projects-user-auth-username">Username</label><input id="projects-user-auth-username" type="text"></input></div><div class="form-row"><label for=projects-user-auth-password">Password</label><input id="projects-user-auth-password" type="password"></input></div>').appendTo(c);else if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(l)){p=!0;var u=$('<div class="form-row"></div>').appendTo(c);$('<label for="projects-user-auth-key">SSH Key</label>').appendTo(u);var h=$('<select id="projects-user-auth-key">').width("70%").appendTo(u);$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){h.append($("<option></option>").val(e.name).text(e.name)),t++})}),u=$('<div class="form-row"></div>').appendTo(c),$('<label for="projects-user-auth-passphrase">Passphrase</label>').appendTo(u),$('<input id="projects-user-auth-passphrase" type="password"></input>').appendTo(u)}var g=RED.notify(c,{type:"error",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){g.close()}},{text:$('<span><i class="fa fa-refresh"></i> Retry</span>'),click:function(){t=t||{};var o={};p?(o.keyFile=$("#projects-user-auth-key").val(),o.passphrase=$("#projects-user-auth-passphrase").val()):(o.username=$("#projects-user-auth-username").val(),o.password=$("#projects-user-auth-password").val());var a=function(n){n?(console.log("Failed to update auth"),console.log(n)):(r(e,t),g.close())};r({url:"projects/"+f.name+"/remotes/"+(n.responseJSON.remote||e.remote||"origin"),type:"PUT",responses:{0:function(e){a(e)},200:function(e){a(null)},400:{unexpected_error:function(e){a(e)}}}},{auth:o})}}]});return}if(s[n.responseJSON.error])return i=s[n.responseJSON.error],void(d=n.responseJSON);if(s["*"])return i=s["*"],void(d=n.responseJSON)}console.log("Unhandled error response:"),console.log(n),console.log(o),console.log(a)}).always(function(){var e=Date.now()-a;e=Math.max(0,500-e),setTimeout(function(){$(".projects-dialog-spinner").hide(),$("#projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility",""),i&&i(d)},e)})}function d(t){var n,o="",a=[],i="",s=$('<div class="projects-branch-list">').appendTo(t.container),d=$('<input type="text">').attr("placeholder",t.placeholder).appendTo(s).searchBox({delay:200,change:function(){o=$(this).val(),/(\.\.|\/\.|[?*[~^: \\]|\/\/|\/.$|\/$)/.test(o)?(n.hasClass("input-error")||(n.addClass("input-error"),n.find("i").addClass("fa-warning").removeClass("fa-code-fork")),n.find("span").text("Invalid branch: "+i+o)):(n.hasClass("input-error")&&(n.removeClass("input-error"),n.find("i").removeClass("fa-warning").addClass("fa-code-fork")),n.find(".sidebar-version-control-branch-list-entry-create-name").text(i+o)),c.editableList("filter")}}),c=$("<ol>",{style:"height: 130px;"}).appendTo(s);return c.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,o,a){var i=$('<div class="sidebar-version-control-branch-list-entry">').appendTo(e);a.hasOwnProperty("commit")?($('<i class="fa fa-code-fork"></i>').appendTo(i),$("<span>").text(a.name).appendTo(i),a.current&&(i.addClass("selected"),$('<span class="current"></span>').text(t.currentLabel||"current").appendTo(i))):(n=i,$('<i class="fa fa-code-fork"></i>').appendTo(i),$("<span>").text("Create branch:").appendTo(i),$('<div class="sidebar-version-control-branch-list-entry-create-name" style="margin-left: 10px;">').text(a.name).appendTo(i)),i.click(function(e){if(e.preventDefault(),!$(this).hasClass("input-error")){var n={};a.hasOwnProperty("commit")?($(this).hasClass("selected")&&(n.current=!0),n.name=a.name):(n.name=d.val(),n.create=!0,t.remote&&(n.name=t.remote()+"/"+n.name)),t.onselect&&t.onselect(n)}})},filter:function(e){var t=!e.hasOwnProperty("commit");return t&&""!==o&&-1===a.indexOf(i+o)||!t&&-1!==e.name.indexOf(o)}}),{refresh:function(n){d.searchBox("value",""),c.editableList("empty");var o=Date.now(),p=l(s).addClass("projects-dialog-spinner-contain");i=t.remote?t.remote()+"/":"",r({url:n,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){a=e.branches,e.branches.forEach(function(e){c.editableList("addItem",e)}),c.editableList("addItem",{}),setTimeout(function(){p.remove()},Math.max(300-(Date.now()-o),0))},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(t){e(t)}}}})},filter:function(){c.editableList("filter")},focus:function(){d.focus()}}}function l(e){return $('<div class="projects-dialog-spinner"><img src="red/images/spin.svg"/></div>').appendTo(e)}function c(){createProjectOptions={},f?a("create",{screen:"empty"}):a("welcome")}var p,u,f,h={};return{init:function(){p=$('<div id="projects-dialog" class="hide node-red-dialog projects-edit-form"><form class="form-horizontal"></form><div class="projects-dialog-spinner hide"><img src="red/images/spin.svg"/></div></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:600,resizable:!1,open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}}),u=p.find("form"),RED.actions.add("core:new-project",RED.projects.newProject),RED.actions.add("core:open-project",RED.projects.selectProject),RED.actions.add("core:show-project-settings",RED.projects.settings.show);var n={sendRequest:r,createBranchList:d,addSpinnerOverlay:l,reportUnexpectedError:e};RED.projects.settings.init(n),RED.projects.userSettings.init(n),RED.sidebar.versionControl.init(n),t()},showStartup:function(){RED.user.hasPermission("projects.write")?a("welcome"):RED.notify(RED._("user.errors.notAuthorized"),"error")},newProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?s(function(e){e||c()}):void c();RED.notify(RED._("user.errors.notAuthorized"),"error")},selectProject:function(){RED.user.hasPermission("projects.write")?a("create",{screen:"open"}):RED.notify(RED._("user.errors.notAuthorized"),"error")},showCredentialsPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showFilesPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showProjectDependencies:function(){RED.projects.settings.show("deps")},createDefaultFileSet:function(){if(!f)throw new Error("Cannot create default file set without an active project");if(!f.empty)throw new Error("Cannot create default file set on a non-empty project");RED.user.hasPermission("projects.write")?(createProjectOptions={},a("default-files",{existingProject:!0})):RED.notify(RED._("user.errors.notAuthorized"),"error")},createDefaultPackageFile:function(){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(f.name);r({url:"projects/"+f.name,type:"PUT",requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){},400:{git_error:function(e){console.log("git error",e)},missing_flow_file:function(e){$(p).dialog("close")},"*":function(t){e(t),$(p).dialog("close")}}}},{initialise:!0}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})},refresh:function(e){$.getJSON("projects",function(t){t.active?$.getJSON("projects/"+t.active,function(t){f=t,RED.sidebar.versionControl.refresh(!0),e&&e(f)}):e&&e(null)})},editProject:function(){RED.projects.settings.show()},getActiveProject:function(){return f}}}(),RED.projects.settings=function(){function e(e){x.push(e)}function t(e){return $(e).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),e}function n(e,t){RED.editor.editMarkdown({title:RED._("sidebar.project.editDescription"),header:$('<span><i class="fa fa-book"></i> README.md</span>'),value:e.description,complete:function(a){t.empty();var i=w.addSpinnerOverlay(t),s=function(i,s){if(i)return n(e,t);e.description=a,o(e,t)};w.sendRequest({url:"projects/"+e.name,type:"PUT",responses:{0:function(e){s(e)},200:function(e){s(null),RED.sidebar.versionControl.refresh(!0)},400:{"*":function(e){w.reportUnexpectedError(e),s(e)}}}},{description:a}).always(function(){i.remove()})}})}function o(e,n){n.empty();var o;o=e.description?marked(e.description):'<span class="node-info-none">No description available</span>',t($('<span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(o)+'">'+o+"</span>")).appendTo(n).find(".bidiAware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>")}function a(e,t,n){var o=n.prev();o.hide(),n.empty();var s=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').appendTo(n),r=$('<input type="text" style="width: calc(100% - 150px); margin-right: 10px;">').val(t||"").appendTo(n);$('<button class="editor-button">Cancel</button>').appendTo(s).click(function(t){t.preventDefault(),i(e.summary,n),o.show()}),$('<button class="editor-button">Save</button>').appendTo(s).click(function(s){s.preventDefault();var d=r.val();i(d,n);var l=w.addSpinnerOverlay(n),c=function(s,r){if(s)return l.remove(),a(e,t,n);e.summary=d,l.remove(),i(e.summary,n),o.show()};w.sendRequest({url:"projects/"+e.name,type:"PUT",responses:{0:function(e){c(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),c(null)},400:{"*":function(e){w.reportUnexpectedError(e),c(e)}}}},{summary:d})})}function i(e,t){t.empty(),e?t.text(e).removeClass("node-info-node"):t.text("No summary available").addClass("node-info-none")}function s(e){var t=$('<div id="project-settings-tab-main" class="project-settings-tab-pane node-help"></div>');$("<h1>").text(e.name).appendTo(t);var s=$('<div style="position: relative">').appendTo(t),r=$("<div></div>",{style:"color: #999"}).appendTo(s);i(e.summary,r),RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="float: right;">edit description</button>').prependTo(s).click(function(t){t.preventDefault(),a(e,e.summary,r)}),$("<hr>").appendTo(t);var d=$('<div class="node-help" style="position: relative"></div>').appendTo(t),l=$("<div>",{style:"min-height: 200px"}).appendTo(d);return o(e,l),RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="float: right;">edit README.md</button>').prependTo(d).click(function(t){t.preventDefault(),n(e,l)}),t}function r(e,t){t.editableList("empty");var n=0,o=0,a=0,i=0;for(var s in R)R.hasOwnProperty(s)&&(t.editableList("addItem",{id:R[s].module,version:R[s].version,count:R[s].count,known:e.dependencies.hasOwnProperty(s),installed:!0}),n++,0===R[s].count&&a++,e.dependencies.hasOwnProperty(s)||o++);if(e.dependencies)for(var s in e.dependencies)if(e.dependencies.hasOwnProperty(s)&&!R.hasOwnProperty(s)){var r=!!RED.nodes.registry.getModule(s);t.editableList("addItem",{id:s,version:e.dependencies[s],count:0,known:!0,installed:r}),n++,r?a++:i++}0===n&&t.editableList("addItem",{index:0,label:"None"})}function d(e,t,n,o){var a=RED.projects.getActiveProject(),i=w.addSpinnerOverlay(t).addClass("projects-dialog-spinner-contain"),s=function(e,t){if(i.remove(),e)return o(e);a.dependencies=n,RED.sidebar.versionControl.refresh(!0),o()};w.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){s(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),s(null)},400:{"*":function(e){s(e)}}}},{dependencies:n})}function l(e,t,n,o){var a=t||JSON.stringify(e.dependencies||{},"",4);"{}"===a&&(a="{\n\n}"),RED.editor.editJSON({title:RED._("sidebar.project.editDependencies"),value:a,requireValid:!0,complete:function(t){try{var a=JSON.parse(t);d(o,n,a,function(i){if(i)return l(e,t,n,o);e.dependencies=a,r(e,o)})}catch(a){l(e,t,n,o)}}})}function c(e){var t=$('<div id="project-settings-tab-deps" class="project-settings-tab-pane node-help"></div>');RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="margin-top:10px;float: right;">edit</button>').appendTo(t).click(function(o){o.preventDefault(),l(e,null,t,n)});var n=$("<ol>",{style:"position: absolute;top: 60px;bottom: 20px;left: 20px;right: 20px;"}).appendTo(t);return n.editableList({addButton:!1,addItem:function(t,o,a){var i=$("<div>",{class:"palette-module-header"}).appendTo(t);if(a.label)0===a.index?i.addClass("red-ui-search-empty"):t.parent().addClass("palette-module-section"),i.text(a.label);else{i.addClass("palette-module-header"),a.installed?0===a.count?i.addClass("palette-module-unused"):a.known||i.addClass("palette-module-unknown"):i.addClass("palette-module-not-installed"),a.element=i;var s=$('<div class="palette-module-meta palette-module-name"></div>').appendTo(i),r="fa-cube";a.installed||(r="fa-warning");var l=$('<i class="fa '+r+'"></i>').appendTo(s);a.icon=l,$("<span>").text(a.id).appendTo(s);var c=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(i);$("<span>").text(a.version).appendTo(c);c=$('<div class="palette-module-meta"></div>').appendTo(i);var p=$('<div class="palette-module-button-group"></div>').appendTo(c);RED.user.hasPermission("projects.write")&&(a.installed||!1===RED.settings.theme("palette.editable")?a.known&&0===a.count?$('<a href="#" class="editor-button editor-button-small">remove from project</a>').appendTo(p).click(function(o){o.preventDefault();var i=$.extend(!0,{},e.dependencies);delete i[a.id],d(n,t,i,function(e){e?console.log(e):t.fadeOut(200,function(){n.editableList("removeItem",a)})})}):a.known||$('<a href="#" class="editor-button editor-button-small">add to project</a>').appendTo(p).click(function(o){o.preventDefault();var s=$.extend(!0,{},e.dependencies);s[a.id]=R[a.id].version,d(n,t,s,function(e){e?console.log(e):(p.remove(),i.removeClass("palette-module-unknown"))})}):$('<a href="#" class="editor-button editor-button-small">install</a>').appendTo(p).click(function(e){e.preventDefault(),RED.palette.editor.install(a,t,function(e){if(!e){a.installed=!0;RED.utils.addSpinnerOverlay(t,!0);setTimeout(function(){n.editableList("removeItem",a),m(),a.count=R[a.id].count,n.editableList("addItem",a)},500)}})}))}},sort:function(e,t){return e.id.localeCompare(t.id)}}),r(e,n),t}function p(e,t,n,o,a){var i=$('<div class="project-file-listing-container"></div>',{style:"position: relative; min-height: 175px; height: 175px;"}).hide().appendTo(e),s=w.addSpinnerOverlay(i);return $.getJSON("projects/"+t.name+"/files",function(e){var t=Object.keys(e),r={};(t=t.filter(function(t){return!e[t].status||!/D/.test(e[t].status)})).sort(),t.forEach(function(e){e.split("/").reduce(function(e,t,n,o){if(t)return n<o.length-1?e[t]=e[t]||{}:e[t]=!0,e[t]},r)});var d=function(e,t,n){var o={name:e||"/",path:n+(n?"/":"")+e};return!0===t?(o.type="f",o):(o.type="d",o.children=[],o.path=o.path,Object.keys(t).forEach(function(e){o.children.push(d(e,t[e],o.path))}),o.children.sort(function(e,t){return e.hasOwnProperty("children")&&!t.hasOwnProperty("children")?-1:!e.hasOwnProperty("children")&&t.hasOwnProperty("children")?1:e.name.localeCompare(t.name)}),o)},r=d("",r,"");u(i,r.children,n,o,a,"height: 175px"),s.remove()}),i}function u(e,t,n,o,a,i){i=i||"";var s=$("<ol>",{class:"projects-dialog-file-list",style:i}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,i){var s=$("<div></div>",{class:"projects-dialog-file-list-entry"}).appendTo(e);if(i.children){if($('<span class="projects-dialog-file-list-entry-folder"><i class="fa fa-angle-right"></i> <i class="fa fa-folder-o"></i></span>').appendTo(s),i.children.length>0){var r=$("<div></div>",{style:"padding-left: 20px;"}).appendTo(e);0===n.indexOf(i.path+"/")?s.addClass("expanded"):r.hide(),u(r,i.children,n,o,a),s.addClass("selectable"),s.click(function(e){$(this).hasClass("expanded")?($(this).removeClass("expanded"),r.slideUp(200)):($(this).addClass("expanded"),r.slideDown(200))})}}else{var d="fa-file-o";/\.json$/i.test(i.name)?d="fa-file-code-o":/\.md$/i.test(i.name)?d="fa-book":/^\.git/i.test(i.name)&&(d="fa-code-fork",s.addClass("projects-dialog-file-list-entry-file-type-git")),$('<span class="projects-dialog-file-list-entry-file"> <i class="fa '+d+'"></i></span>').appendTo(s),o.test(i.name)?(s.addClass("selectable"),i.path===n&&s.addClass("selected"),s.click(function(e){$(".projects-dialog-file-list-entry.selected").removeClass("selected"),$(this).addClass("selected"),a(i.path)}),s.dblclick(function(e){e.preventDefault(),a(i.path,!0)})):s.addClass("unselectable")}$('<span class="projects-dialog-file-list-entry-name" style=""></span>').text(i.name).appendTo(s)}});i||s.parent().css("overflow-y",""),t.forEach(function(e){s.editableList("addItem",e)})}function f(e,t){var n=$("<h3></h3>").text("Files").appendTo(t),o=$('<div class="user-settings-section"></div>').appendTo(t);if(RED.user.hasPermission("projects.write"))var a=$('<button class="editor-button editor-button-small" style="float: right;">edit</button>').appendTo(n).click(function(e){e.preventDefault(),S.show(),a.hide(),r.hide(),d.show(),l.show(),c.hide(),u.show(),d.focus(),h.addClass("uneditable-input"),$(".user-settings-row-credentials").show(),h.css("height","auto"),b.hide(),g.show()});var i;i=$('<div class="user-settings-row"></div>').appendTo(o),$('<label for=""></label>').text("Flow").appendTo(i);var s=$('<div class="uneditable-input" style="padding:0">').appendTo(i),r=$('<span style="display:inline-block; padding: 6px">').text(e.files.flow).appendTo(s),d=$('<input id="" type="text" style="margin-bottom: 0;width: 100%; border: none;">').val(e.files.flow).hide().appendTo(s),l=$('<button class="editor-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(s).click(function(t){if($(this).hasClass("selected"))$(this).removeClass("selected"),s.find(".project-file-listing-container").slideUp(200,function(){$(this).remove(),s.css("height","")}),s.css("color","");else{$(this).addClass("selected"),s.css("color","inherit");var n=p(s,e,d.val(),/.*\.json$/,function(e,t){e&&d.val(e),t&&$(l).click(),f()});s.css("height","auto"),setTimeout(function(){n.slideDown(200)},50)}});i=$('<div class="user-settings-row"></div>').appendTo(o),$('<label for=""></label>').text("Credentials").appendTo(i);var c=$('<div class="uneditable-input">').text(e.files.credentials).appendTo(i),u=$('<div class="uneditable-input">').text(e.files.credentials).hide().insertAfter(c),f=function(){var e,t=d.val(),n=/^(.+?)(\.[^.]*)?$/.exec(t);n?u.text(n[1]+"_cred"+(n[2]||".json")):""===t&&u.text("");var o=""===t||/\.\./.test(t)||/\/$/.test(t);e=o||""===u.text(),T.is(":visible")&&(T.toggleClass("input-error",""===T.val()),e=e||""===T.val()),_.is(":visible")&&(_.toggleClass("input-error",""===_.val()),e=e||""===_.val()),d.toggleClass("input-error",o),u.toggleClass("input-error",""===u.text()),O.toggleClass("disabled",e),O.prop("disabled",e)};d.on("change keyup paste",f),e.files.flow||$('<span class="form-warning"><i class="fa fa-warning"></i> Missing</span>').appendTo(r),e.files.credentials||$('<span class="form-warning"><i class="fa fa-warning"></i> Missing</span>').appendTo(c),i=$('<div class="user-settings-row"></div>').appendTo(o),$("<label></label>").appendTo(i);var h=$('<span><i class="user-settings-credentials-state-icon fa"></i> <span class="user-settings-credentials-state"></span></span>').appendTo(i),g=$('<span class="button-group" style="margin-left: -72px;">').hide().appendTo(i);h.css("color","#666"),g.css("vertical-align","top");var v=$('<button class="editor-button" style="vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-trash-o"></i></button>').appendTo(g).click(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),b.hide()):(_.val(""),R.hide(),k.show(),$(this).addClass("selected"),m.removeClass("selected"),x.show(),C.show(),D.hide(),E.hide(),b.show()),f()}),m=$('<button class="editor-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-pencil"></i></button>').appendTo(g).click(function(t){t.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),b.hide()):(T.val(""),_.val(""),e.settings.credentialSecretInvalid||!e.settings.credentialsEncrypted?(D.show(),E.hide(),R.hide()):(R.show(),D.hide(),E.show()),k.show(),m.addClass("selected"),v.removeClass("selected"),x.hide(),C.hide(),b.show()),f()});i=$('<div class="user-settings-row user-settings-row-credentials"></div>').hide().appendTo(o);var b=$("<div>",{style:"margin-top:10px"}).hide().appendTo(h),D=$('<div style="margin: 20px 0 10px 5px;">Set the encryption key:</div>').hide().appendTo(b),E=$('<div style="margin: 20px 0 10px 5px;">Change the encryption key:</div>').hide().appendTo(b),x=$('<div style="margin: 20px 0 10px 5px;">Reset the encryption key:</div>').hide().appendTo(b),R=$('<div class="user-settings-row user-settings-row-credentials"></div>').appendTo(b);$('<label for=""></label>').text("Current key").appendTo(R);var T=$('<input type="password">').appendTo(R).on("change keyup paste",function(){y&&(y.close(),y=null),f()}),k=$('<div class="user-settings-row user-settings-row-credentials"></div>').appendTo(b);$('<label for=""></label>').text("New key").appendTo(k);var _=$('<input type="password">').appendTo(k).on("change keyup paste",f),C=$('<div class="form-tips form-warning" style="margin: 10px;"><i class="fa fa-warning"></i> This will delete all existing credentials</div>').hide().appendTo(b),j=function(){a.show(),S.hide(),r.show(),d.hide(),l.hide(),c.show(),u.hide(),h.removeClass("uneditable-input"),h.css("height",""),l.removeClass("selected"),s.find(".project-file-listing-container").remove(),s.css("height",""),s.css("color",""),$(".user-settings-row-credentials").hide(),b.hide(),g.hide(),v.removeClass("selected"),m.removeClass("selected")},S=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').hide().appendTo(o);$('<button class="editor-button">Cancel</button>').appendTo(S).click(function(e){e.preventDefault(),j()});var O=$('<button class="editor-button">Save</button>').appendTo(S).click(function(t){t.preventDefault();var n=w.addSpinnerOverlay(o),a=function(e){n.remove(),e?w.reportUnexpectedError(e):(r.text(d.val()),c.text(u.text()),j())},i={files:{flow:d.val(),credentials:u.text()}};v.hasClass("selected")&&(i.resetCredentialSecret=!0),(v.hasClass("selected")||m.hasClass("selected"))&&(i.credentialSecret=_.val(),T.is(":visible")&&(i.currentCredentialSecret=T.val())),RED.deploy.setDeployInflight(!0),w.sendRequest({url:"projects/"+e.name,type:"PUT",responses:{0:function(e){a(e)},200:function(t){e=t,RED.sidebar.versionControl.refresh(!0),P(),a()},400:{credentials_load_failed:function(e){a(e)},missing_current_credential_key:function(e){T.addClass("input-error"),y=RED.popover.create({target:T,direction:"right",size:"small",content:"Incorrect key",autoClose:3e3}).open(),a(e)},"*":function(e){a(e)}}}},i).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),P=function(){e.settings.credentialSecretInvalid?(h.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-warning"),h.find(".user-settings-credentials-state").text("Invalid encryption key")):e.settings.credentialsEncrypted?(h.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-lock"),h.find(".user-settings-credentials-state").text("Encryption enabled")):(h.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-unlock"),h.find(".user-settings-credentials-state").text("Encryption disabled")),v.toggleClass("disabled",!e.settings.credentialSecretInvalid&&!e.settings.credentialsEncrypted),v.prop("disabled",!e.settings.credentialSecretInvalid&&!e.settings.credentialsEncrypted)};f(),P()}function h(e,t){var n=$('<div class="user-settings-section"></div>').appendTo(t);$("<h4></h4>").text("Branches").appendTo(n);var o=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(n),a=$("<ol>").appendTo(o).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(t,n,o){var i=$('<div class="projects-dialog-list-entry">').appendTo(t);if(o.empty)return i.addClass("red-ui-search-empty"),void i.text("No branches");o.current&&i.addClass("current"),$('<span class="entry-icon"><i class="fa fa-code-fork"></i></span>').appendTo(i);var s=$("<span>").appendTo(i),r=$("<div>").appendTo(s);if($('<span class="entry-name">').text(o.name).appendTo(r),o.commit&&$('<span class="entry-detail">').text(o.commit.sha).appendTo(r),o.remote){var d=$("<div>").appendTo(s);$('<span class="entry-detail entry-remote-name">').text(o.remote||"").appendTo(d),o.status.ahead+o.status.behind>0&&$('<span class="entry-detail"><i class="fa fa-long-arrow-up"></i> <span>'+o.status.ahead+'</span> <i class="fa fa-long-arrow-down"></i> <span>'+o.status.behind+"</span></span>").appendTo(d)}if(!o.current){var l=$('<span class="entry-tools">').appendTo(i);$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(l).click(function(n){n.preventDefault();var i=w.addSpinnerOverlay(t).addClass("projects-dialog-spinner-contain"),s=RED.notify("Are you sure you want to delete the local branch '"+o.name+"'? This cannot be undone.",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.remove(),s.close()}},{text:"Delete branch",click:function(){s.close();var n={url:"projects/"+e.name+"/branches/"+o.name,type:"DELETE",responses:{200:function(e){t.fadeOut(200,function(){a.editableList("removeItem",o),i.remove()})},400:{git_delete_branch_unmerged:function(e){s=RED.notify("The local branch '"+o.name+"' has unmerged changes that will be lost. Are you sure you want to delete it?",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.remove(),s.close()}},{text:"Delete unmerged branch",click:function(){n.url+="?force=true",s.close(),w.sendRequest(n)}}]})},"*":function(e){w.reportUnexpectedError(e),i.remove()}}}};w.sendRequest(n)}}]})})}}});$.getJSON("projects/"+e.name+"/branches",function(e){e.branches&&(e.branches.length>0?(e.branches.sort(function(e,t){return e.current?-1:t.current?1:e.name.localeCompare(t.name)}),e.branches.forEach(function(e){a.editableList("addItem",e)})):a.editableList("addItem",{empty:!0}))})}function g(e,t){$("<h3></h3>").text("Version Control").appendTo(t),h(e,t);var n=$('<div class="user-settings-section"></div>').appendTo(t),o=$("<h4></h4>").text("Git remotes").appendTo(n),a=$('<button class="editor-button editor-button-small" style="float: right; margin-right: 10px;">add remote</button>').appendTo(o).click(function(e){a.attr("disabled",!0),d.slideDown(200,function(){d[0].scrollIntoView(),s?(g.val("origin"),v.focus()):g.focus(),p()})}),i={empty:!0},s=!0,r=$('<div class="user-settings-row"></div>').appendTo(n),d=$('<div class="projects-dialog-list-dialog"></div>').hide().appendTo(r);r=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(n);var l=$("<ol>").appendTo(r);l.editableList({addButton:!1,height:"auto",addItem:function(t,n,o){var a=$('<div class="projects-dialog-list-entry">').appendTo(t);if(o.empty)return a.addClass("red-ui-search-empty"),void a.text("No remotes");$('<span class="entry-icon"><i class="fa fa-globe"></i></span>').appendTo(a);var r=$("<span>").appendTo(a);$('<div class="entry-name">').text(o.name).appendTo(r),o.urls.fetch===o.urls.push?$('<div class="entry-detail">').text(o.urls.fetch).appendTo(r):($('<div class="entry-detail">').text("fetch: "+o.urls.fetch).appendTo(r),$('<div class="entry-detail">').text("push: "+o.urls.push).appendTo(r));var d=$('<span class="entry-tools">').appendTo(a);$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(d).click(function(n){n.preventDefault();var a=w.addSpinnerOverlay(t).addClass("projects-dialog-spinner-contain"),r=RED.notify("Are you sure you want to delete the remote '"+o.name+"'?",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.remove(),r.close()}},{text:"Delete remote",click:function(){r.close(),e.git.branches.remote&&0===e.git.branches.remote.indexOf(o.name+"/")&&delete e.git.branches.remote,e.git.branches.remoteAlt&&0===e.git.branches.remoteAlt.indexOf(o.name+"/")&&delete e.git.branches.remoteAlt;var n={url:"projects/"+e.name+"/remotes/"+o.name,type:"DELETE",responses:{200:function(n){t.fadeOut(200,function(){l.editableList("removeItem",o),setTimeout(a.remove,100),0===n.remotes.length?(delete e.git.remotes,s=!0,l.editableList("addItem",i)):(e.git.remotes={},n.remotes.forEach(function(t){var n=t.name;delete t.name,e.git.remotes[n]=t})),delete e.git.branches.remoteAlt,RED.sidebar.versionControl.refresh()})},400:{"*":function(e){w.reportUnexpectedError(e),a.remove()}}}};w.sendRequest(n)}}]})})}});var c,p=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(g.val()),t=v.val(),n=t.length>0&&!/\s/.test(t);/^https?:\/\/[^/]+@/i.test(t)?(m.text("Do not include the username/password in the url"),n=!1):m.text("https://, ssh:// or file://"),D.attr("disabled",!e||!n),g.toggleClass("input-error",u&&!e),v.toggleClass("input-error",f&&!n),c&&(c.close(),c=null)},u=!1,f=!1;$('<div class="projects-dialog-list-dialog-header">').text("Add remote").appendTo(d),r=$('<div class="user-settings-row"></div>').appendTo(d),$('<label for=""></label>').text("Remote name").appendTo(r);var g=$('<input type="text">').appendTo(r).on("change keyup paste",function(){u=!0,p()});$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(r).find("small"),r=$('<div class="user-settings-row"></div>').appendTo(d),$('<label for=""></label>').text("URL").appendTo(r);var v=$('<input type="text">').appendTo(r).on("change keyup paste",function(){f=!0,p()}),m=$('<label class="projects-edit-form-sublabel"><small>https://, ssh:// or file://</small></label>').appendTo(r).find("small"),b=function(){a.attr("disabled",!1),d.hide(),g.val(""),v.val(""),c&&(c.close(),c=null)},y=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(d);$('<button class="editor-button">Cancel</button>').appendTo(y).click(function(e){e.preventDefault(),b()});var D=$('<button class="editor-button">Add remote</button>').appendTo(y).click(function(t){t.preventDefault();var n=w.addSpinnerOverlay(d).addClass("projects-dialog-spinner-contain"),o={name:g.val(),url:v.val()},a=function(e){n.remove(),e||b()};RED.deploy.setDeployInflight(!0),w.sendRequest({url:"projects/"+e.name+"/remotes",type:"POST",responses:{0:function(e){a(e)},200:function(t){e.git.remotes={},t.remotes.forEach(function(t){var n=t.name;delete t.name,e.git.remotes[n]=t}),E(),RED.sidebar.versionControl.refresh(),a()},400:{git_remote_already_exists:function(e){c=RED.popover.create({target:g,direction:"right",size:"small",content:"Remote already exists",autoClose:6e3}).open(),g.addClass("input-error"),a(e)},"*":function(e){w.reportUnexpectedError(e),a(e)}}}},o)}),E=function(){l.editableList("empty");var t=0;if(e.git.hasOwnProperty("remotes"))for(var n in e.git.remotes)e.git.remotes.hasOwnProperty(n)&&(t++,l.editableList("addItem",{name:n,urls:e.git.remotes[n]}));(s=0===t)&&l.editableList("addItem",i)};E()}function v(e){var t=$('<div id="project-settings-tab-settings" class="project-settings-tab-pane node-help"></div>');return f(e,t),g(e,t),t}function m(){R={},RED.nodes.eachNode(b),RED.nodes.eachConfig(b)}function b(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&(R.hasOwnProperty(t)||(R[t]={module:t,version:RED.nodes.registry.getModule(t).version,count:0,known:!1}),R[t].count++)}}var y,w,D=700,E=!1,x=[],R={};return{init:function(t){w=t,e({id:"main",title:"Project",get:s,close:function(){}}),e({id:"deps",title:"Dependencies",get:c,close:function(){}}),e({id:"settings",title:"Settings",get:v,close:function(){y&&(y.close(),y=null)}}),RED.events.on("nodes:add",b),RED.events.on("nodes:remove",function(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&R.hasOwnProperty(t)&&(R[t].count--,0===R[t].count&&(R[t].known||delete R[t]))}})},show:function(e){if(!E)if(RED.user.hasPermission("projects.write")){E=!0;var t={title:"Project Settings",buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){D=e.width},open:function(t){var n=RED.projects.getActiveProject(),o=t.find(".editor-tray-body"),a=$("<div></div>").appendTo(o),i=$("<div></div>",{id:"user-settings-tabs-container"}).appendTo(a);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(i);var s=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){$("#user-settings-tabs-content").children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),r=$("<div></div>",{id:"user-settings-tabs-content"}).appendTo(a);x.forEach(function(e){s.addTab({id:"project-settings-tab-"+e.id,label:e.title,pane:e}),e.get(n).hide().appendTo(r)}),a.i18n(),s.activateTab("project-settings-tab-"+(e||"main")),$("#sidebar-shade").show()},close:function(){E=!1,x.forEach(function(e){e.close&&e.close()}),$("#sidebar-shade").hide()},show:function(){}};null!==D&&(t.width=D),RED.tray.show(t)}else RED.notify(RED._("user.errors.notAuthorized"),"error")},switchProject:function(e){R={}}}}(),RED.projects.userSettings=function(){function e(e){var t=RED.settings.get("git")||{};t.user=t.user||{};$("<h3></h3>").text("Committer Details").appendTo(e);var n=$('<div class="user-settings-section"></div>').appendTo(e);$('<div style="color:#aaa;"></div>').appendTo(n).text("Leave blank to use system default");var i=$('<div class="user-settings-row"></div>').appendTo(n);$('<label for=""></label>').text("Username").appendTo(i),(o=$('<input type="text">').appendTo(i)).val(t.user.name||""),i=$('<div class="user-settings-row"></div>').appendTo(n),$('<label for=""></label>').text("Email").appendTo(i),(a=$('<input type="text">').appendTo(i)).val(t.user.email||"")}function t(e){var t,n=$('<div class="user-settings-section"></div>').appendTo(e),o=($("<h3></h3>").text("SSH Keys").appendTo(n),$('<div style="color:#aaa;"></div>').appendTo(n).text("Allows you to create secure connections to remote git repositories.")),s=$('<button id="user-settings-gitconfig-add-key" class="editor-button editor-button-small" style="float: right; margin-right: 10px;">add key</button>').appendTo(o).click(function(e){s.attr("disabled",!0),b.attr("disabled",!0),l.slideDown(200),u.focus()}),r=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(u.val());u.toggleClass("input-error",p&&!e);var n=h.val(),o=0===n.length||n.length>=8;h.toggleClass("input-error",!o),o?0===n.length?g.text("Optional"):g.text(""):g.text("Passphrase too short"),e=e&&o,b.attr("disabled",!e),t&&(t.close(),t=null)},d=$('<div class="user-settings-row"></div>').appendTo(n),l=$('<div class="projects-dialog-list-dialog"></div>').hide().appendTo(d);$('<div class="projects-dialog-list-dialog-header">').text("Add SSH Key").appendTo(l);var c=$("<div>").appendTo(l);d=$('<div class="user-settings-row"></div>').appendTo(c),$('<div style="color:#aaa;"></div>').appendTo(d).text("Generate a new public/private key pair"),d=$('<div class="user-settings-row"></div>').appendTo(c),$('<label for=""></label>').text("Name").appendTo(d);var p=!1,u=$('<input type="text">').appendTo(d).on("change keyup paste",function(){p=!0,r()});$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(d).find("small");var f=$("<div>").appendTo(c);d=$('<div class="user-settings-row"></div>').appendTo(f),$('<label for=""></label>').text("Passphrase").appendTo(d);var h=$('<input type="password">').appendTo(d).on("change keyup paste",r),g=$('<label class="projects-edit-form-sublabel"><small>Optional</small></label>').appendTo(d).find("small"),v=function(){s.attr("disabled",!1),l.hide(),u.val(""),p=!1,h.val(""),t&&(t.close(),t=null)},m=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(l);$('<button class="editor-button">Cancel</button>').appendTo(m).click(function(e){e.preventDefault(),v()});var b=$('<button class="editor-button">Generate key</button>').appendTo(m).click(function(e){e.preventDefault();var t=i.addSpinnerOverlay(l).addClass("projects-dialog-spinner-contain"),n={name:u.val()};n.type="generate",n.comment=a.val(),n.password=h.val(),n.size=4096;var o=function(e){t.remove(),e||v()};RED.deploy.setDeployInflight(!0),i.sendRequest({url:"settings/user/keys",type:"POST",responses:{0:function(e){o(e)},200:function(e){E(n.name),o()},400:{unexpected_error:function(e){console.log(e),o(e)}}}},n)});d=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(n);var y={empty:!0},w=function(e,t){var n=$('<div class="projects-dialog-ssh-public-key">',{style:"position:relative"}).appendTo(e),o=$("<pre>",{style:"min-height: 80px"}).appendTo(n),a=i.addSpinnerOverlay(o).addClass("projects-dialog-spinner-contain"),s={url:"settings/user/keys/"+t.name,type:"GET",responses:{200:function(e){o.text(e.publickey),a.remove()},400:{unexpected_error:function(e){console.log(e),a.remove()}}}};i.sendRequest(s);var r=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(n);return $('<button class="editor-button editor-button-small">Copy public key to clipboard</button>').appendTo(r).click(function(e){try{e.stopPropagation(),e.preventDefault(),document.getSelection().selectAllChildren(o[0]);document.execCommand("copy");document.getSelection().empty()}catch(e){}}),n},D=$('<ol class="projects-dialog-ssh-key-list">').appendTo(d).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){var o=$('<div class="projects-dialog-list-entry">').appendTo(e);if(n.empty)return o.addClass("red-ui-search-empty"),void o.text("No SSH keys");var a=$('<div class="projects-dialog-ssh-key-header">').appendTo(o);$('<span class="entry-icon"><i class="fa fa-key"></i></span>').appendTo(a),$('<span class="entry-name">').text(n.name).appendTo(a);var s,r=$('<span class="button-row entry-tools">').appendTo(a);a.click(function(e){s?s.slideUp(200,function(){s.remove(),s=null}):s=w(o,n)}),n.system||$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(r).click(function(t){t.stopPropagation();var o=i.addSpinnerOverlay(e).addClass("projects-dialog-spinner-contain"),a=RED.notify("Are you sure you want to delete the SSH key '"+n.name+"'? This cannot be undone.",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.remove(),a.close()}},{text:"Delete key",click:function(){a.close();var t={url:"settings/user/keys/"+n.name,type:"DELETE",responses:{200:function(t){e.fadeOut(200,function(){D.editableList("removeItem",n),setTimeout(o.remove,100),0===D.editableList("length")&&D.editableList("addItem",y)})},400:{unexpected_error:function(e){console.log(e),o.remove()}}}};i.sendRequest(t)}}]})}),n.expand&&(s=w(o,n))}}),E=function(e){$.getJSON("settings/user/keys",function(t){t.keys&&(t.keys.sort(function(e,t){return e.name.localeCompare(t.name)}),D.editableList("empty"),t.keys.forEach(function(t){t.name===e&&(t.expand=!0),D.editableList("addItem",t)}),0===D.editableList("length")&&D.editableList("addItem",y))})};E()}function n(n){var o=$('<div id="user-settings-tab-gitconfig" class="project-settings-tab-pane node-help"></div>');return e(o),t(o),o}var o,a,i;return{init:function(e){i=e,RED.userSettings.add({id:"gitconfig",title:"Git config",get:n,close:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=o.val(),e.user.email=a.val(),RED.settings.set("git",e)}})}}}(),RED.sidebar.versionControl=function(){function e(e,t){var n=RED.projects.getActiveProject(),o="staged"===t?"index":"tree";R.sendRequest({url:"projects/"+n.name+"/diff/"+o+"/"+encodeURIComponent(e.file),type:"GET",responses:{0:function(e){console.log(e)},200:function(o){var a;a="unstaged"===t?"Unstaged changes : "+e.file:"staged"===t?"Staged changes : "+e.file:"Resolve conflicts : "+e.file;var i={diff:o.diff,title:a,unmerged:"unmerged"===t,project:n};"unstaged"==t?(i.oldRevTitle=" "===e.indexStatus?"HEAD":"Staged",i.newRevTitle="Unstaged",i.oldRev=" "===e.indexStatus?"@":":0",i.newRev="_"):"staged"===t?(i.oldRevTitle="HEAD",i.newRevTitle="Staged",i.oldRev="@",i.newRev=":0"):(i.oldRevTitle="Local",i.newRevTitle="Remote",i.commonRev=":1",i.oldRev=":2",i.newRev=":3",i.onresolve=function(t){R.sendRequest({url:"projects/"+n.name+"/resolve/"+encodeURIComponent(e.file),type:"POST",responses:{0:function(e){console.log(e)},200:function(e){r(!0)},400:{unexpected_error:function(e){console.log(e)}}}},{resolutions:t.resolutions[e.file]})}),RED.diff.showUnifiedDiff(i)},400:{unexpected_error:function(e){console.log(e)}}}})}function t(t,n,o,a){t.addClass("sidebar-version-control-change-entry");var i=$("<div>").appendTo(t);if(n.label){if(t.addClass("node-info-none"),i.text(n.label),n.button){i.css({display:"inline-block",maxWidth:"300px",textAlign:"left"});var r=$('<div style="float: right; margin: 5px; height: 50px;"></div>').appendTo(i);$('<button class="editor-button editor-button-small"></button>').text(n.button.label).appendTo(r).click(n.button.click)}}else{var d,l,c=$('<i class=""></i>').appendTo(i),p=$('<a href="#">').appendTo(i).click(function(t){t.preventDefault(),e(n,a)}),u=$("<span>").appendTo(p),f=$('<div class="sidebar-version-control-change-entry-tools">').appendTo(t);"unstaged"===a&&(d=$('<span class="button-group" style="margin-right: 5px;"></span>').appendTo(f),l=$('<button class="editor-button editor-button-small"><i class="fa fa-reply"></i></button>').appendTo(d).click(function(e){e.preventDefault();var t=R.addSpinnerOverlay(i).addClass("projects-dialog-spinner-contain"),o=RED.notify("Are you sure you want to revert the changes to '"+n.file+"'? This cannot be undone.",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),o.close()}},{text:"Revert changes",click:function(){o.close();var e={url:"projects/"+RED.projects.getActiveProject().name+"/files/_/"+n.file,type:"DELETE",responses:{200:function(e){t.remove()},400:{unexpected_error:function(e){t.remove(),console.log(e)}}}};RED.deploy.setDeployInflight(!0),R.sendRequest(e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]})})),d=$('<span class="button-group"></span>').appendTo(f),"unmerged"!==a&&$('<button class="editor-button editor-button-small"><i class="fa fa-'+("unstaged"===a?"plus":"minus")+'"></i></button>').appendTo(d).click(function(e){e.preventDefault();var o=RED.projects.getActiveProject();n.spinner=R.addSpinnerOverlay(t).addClass("projects-version-control-spinner-sidebar"),R.sendRequest({url:"projects/"+o.name+"/stage/"+encodeURIComponent(n.file),type:"unstaged"===a?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){s(e)},400:{unexpected_error:function(e){console.log(e)}}}},{})}),n["update"+("unstaged"===a?"Unstaged":"Staged")]=function(e,t){i.removeClass();var n="";"A"===t?(i.addClass("node-diff-added"),n="fa-plus-square"):"?"===t?(i.addClass("node-diff-unchanged"),n="fa-question-circle-o"):"D"===t?(i.addClass("node-diff-deleted"),n="fa-minus-square"):"M"===t?(i.addClass("node-diff-changed"),n="fa-square"):"R"===t?(i.addClass("node-diff-changed"),n="fa-toggle-right"):"U"===t?(i.addClass("node-diff-conflicted"),n="fa-exclamation-triangle"):n="fa-exclamation-triangle",u.empty(),$("<span>").text(e.file.replace(/\\(.)/g,"$1")).appendTo(u),e.oldName&&($('<i class="fa fa-long-arrow-right"></i>').prependTo(u),$("<span>").text(e.oldName.replace(/\\(.)/g,"$1")).prependTo(u)),c.removeClass(),c.addClass("fa "+n),e.spinner&&(e.spinner.remove(),delete e.spinner),l&&l.toggle("?"!==t),p.toggleClass("disabled","D"===t||"?"===t)},n["update"+("unstaged"===a?"Unstaged":"Staged")](n,o)}}function n(e){var t=Date.now()/1e3-e,n=Math.floor(t/86400);if(n>30)return new Date(1e3*e).toLocaleDateString();if(n>0)return n+" day"+(n>1?"s":"")+" ago";var o=Math.floor(t/3600);if(o>0)return o+" hour"+(o>1?"s":"")+" ago";var a=Math.floor(t/60);return a>0?a+" minute"+(a>1?"s":"")+" ago":"Seconds ago"}function o(e,t){var n=RED.projects.getActiveProject();(v=t?R.addSpinnerOverlay(u.parent()):R.addSpinnerOverlay(h.parent())).addClass("projects-dialog-spinner-sidebar");var o=t?{files:e}:void 0;R.sendRequest({url:"projects/"+n.name+"/stage",type:t?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){s(e)},400:{unexpected_error:function(e){console.log(e)}}}},o)}function a(e,t,n,o,a){var i=R.addSpinnerOverlay(n),s=e+"?limit="+(o||20);a&&(s+="&before="+a),R.sendRequest({url:s,type:"GET",responses:{0:function(e){console.log(e)},200:function(n){var a;n.commits.forEach(function(e){t.editableList("addItem",e),a=e.sha}),t.loadMoreItem&&(t.editableList("removeItem",t.loadMoreItem),delete t.loadMoreItem);var s=t.editableList("length");s<n.total&&(t.loadMoreItem={totalKnown:s,total:n.total,url:e,before:a+"~1",limit:o},t.editableList("addItem",t.loadMoreItem)),i.remove()},400:{unexpected_error:function(e){console.log(e)}}}})}function i(){D.editableList("empty");var e=RED.projects.getActiveProject();e&&a("projects/"+e.name+"/commits",D,D.parent())}function s(e){var t=e.files;v&&(v.remove(),v=null),(x=!!e.merging)?(c.addClass("sidebar-version-control-merging"),m.show()):(c.removeClass("sidebar-version-control-merging"),m.hide()),u.editableList("removeItem",_),h.editableList("removeItem",_),b.editableList("removeItem",C);var n=Object.keys(t).filter(function(e){return"f"===t[e].type});n.sort();var o=Date.now()+Math.floor(100*Math.random());n.forEach(function(e){var n=t[e],a=!1;n.status&&(n.file=e,n.indexStatus=n.status[0],n.treeStatus=n.status[1],("A"===n.indexStatus&&/[AU]/.test(n.treeStatus)||"U"===n.indexStatus&&/[DAU]/.test(n.treeStatus)||"D"===n.indexStatus&&/[DU]/.test(n.treeStatus))&&(n.unmerged=!0),T[e]?(T[e].unmerged&&!n.unmerged?(b.editableList("removeItem",T[e]),a=!0):!T[e].unmerged&&n.unmerged&&(u.editableList("removeItem",T[e]),h.editableList("removeItem",T[e])),T[e].status!==n.status&&(" "!==T[e].treeStatus?" "===n.treeStatus?u.editableList("removeItem",T[e]):n.treeStatus!==T[e].treeStatus&&T[e].updateUnstaged(n,n.treeStatus):a=!0," "!==T[e].indexStatus&&"?"!==T[e].indexStatus?" "===n.indexStatus||"?"===n.indexStatus?h.editableList("removeItem",T[e]):n.indexStatus!==T[e].indexStatus&&T[e].updateStaged(n,n.indexStatus):a=!0),T[e].status=n.status,T[e].indexStatus=n.indexStatus,T[e].treeStatus=n.treeStatus,T[e].oldName=n.oldName,T[e].unmerged=n.unmerged):(a=!0,T[e]=n),T[e].updateIndex=o,a&&(n.unmerged?b.editableList("addItem",T[e]):(" "!==n.treeStatus&&u.editableList("addItem",T[e])," "!==n.indexStatus&&"?"!==n.indexStatus&&h.editableList("addItem",T[e]))))}),Object.keys(T).forEach(function(e){T[e].updateIndex!==o&&(u.editableList("removeItem",T[e]),h.editableList("removeItem",T[e]),delete T[e])});var a=h.editableList("length"),i=u.editableList("length"),s=b.editableList("length");y.attr("disabled",x&&s>0||!x&&0===a),f.attr("disabled",0===i),g.attr("disabled",0===a),0===a&&h.editableList("addItem",_),0===i&&u.editableList("addItem",_),0===s&&b.editableList("addItem",C)}function r(e,t){if(!k&&(e&&(T={},u.editableList("empty"),h.editableList("empty"),b.editableList("empty")),RED.user.hasPermission("projects.write"))){k=!0,i();var n=RED.projects.getActiveProject();if(n){var o="projects/"+n.name+"/status";t&&(o+="?remote=true"),$.getJSON(o,function(e){s(e),$("#sidebar-version-control-local-branch").text(e.branches.local),$("#sidebar-version-control-remote-branch").text(e.branches.remote||"none");var t=e.commits.ahead||0,o=e.commits.behind||0;n.git.hasOwnProperty("remotes")?e.branches.hasOwnProperty("remoteError")&&"git_remote_gone"!==e.branches.remoteError.code?($("#sidebar-version-control-repo-status-auth-issue").show(),$("#sidebar-version-control-repo-status-stats").hide(),$("#sidebar-version-control-repo-branch").attr("disabled",!0),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0),$("#sidebar-version-control-repo-toolbar-message").hide(),$("#sidebar-version-control-repo-toolbar-error-message").show()):($("#sidebar-version-control-repo-toolbar-message").show(),$("#sidebar-version-control-repo-toolbar-error-message").hide(),$("#sidebar-version-control-repo-status-auth-issue").hide(),$("#sidebar-version-control-repo-status-stats").show(),$("#sidebar-version-control-repo-branch").attr("disabled",!1),$("#sidebar-version-control-repo-status-button").show(),e.branches.hasOwnProperty("remote")?d(t,o):($("#sidebar-version-control-commits-ahead").text(""),$("#sidebar-version-control-commits-behind").text(""),$("#sidebar-version-control-repo-toolbar-message").text("Your local branch is not currently tracking a remote branch."),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0))):$("#sidebar-version-control-repo-status-button").hide(),k=!1,$(".sidebar-version-control-shade").hide()}).fail(function(){k=!1})}else $(".sidebar-version-control-shade").show(),u.editableList("empty"),h.editableList("empty"),b.editableList("empty")}}function d(e,t){$("#sidebar-version-control-commits-ahead").text(e),$("#sidebar-version-control-commits-behind").text(t),x?($("#sidebar-version-control-repo-toolbar-message").text("Your repository has unmerged changes. You need to fix the conflicts and commit the result."),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0)):e>0&&0===t?($("#sidebar-version-control-repo-toolbar-message").text("Your repository is "+e+" commit"+(1===e?"":"s")+" ahead of the remote. You can push "+(1===e?"this commit":"these commits")+" now."),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!1)):0===e&&t>0?($("#sidebar-version-control-repo-toolbar-message").text("Your repository is "+t+" commit"+(1===t?"":"s")+" behind of the remote. You can pull "+(1===t?"this commit":"these commits")+" now."),$("#sidebar-version-control-repo-pull").attr("disabled",!1),$("#sidebar-version-control-repo-push").attr("disabled",!0)):e>0&&t>0?($("#sidebar-version-control-repo-toolbar-message").text("Your repository is "+t+" commit"+(1===t?"":"s")+" behind and "+e+" commit"+(1===e?"":"s")+" ahead of the remote. You must pull the remote commit"+(1===t?"":"s")+" down before pushing."),$("#sidebar-version-control-repo-pull").attr("disabled",!1),$("#sidebar-version-control-repo-push").attr("disabled",!0)):0===e&&0===t&&($("#sidebar-version-control-repo-toolbar-message").text("Your repository is up to date."),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0))}function l(){r(),RED.sidebar.show("version-control")}var c,p,u,f,h,g,v,m,b,y,w,D,E,x,R,T={},k=!1,_={label:"None"},C={label:"All conflicts resolved. Commit the changes to complete the merge."};return{init:function(e){R=e,RED.actions.add("core:show-version-control-tab",l),RED.events.on("deploy",function(){var e=RED.projects.getActiveProject();e&&(T={},u.editableList("empty"),h.editableList("empty"),b.editableList("empty"),$.getJSON("projects/"+e.name+"/status",function(e){s(e)}))}),RED.events.on("login",function(){r(!0)}),c=$("<div>",{class:"sidebar-version-control"});var i=$("<div>",{class:"sidebar-version-control-stack"}).appendTo(c);p=RED.stack.create({container:i,fill:!0,singleExpanded:!0}),(w=p.add({title:"Local Changes",collapsible:!0})).expand(),w.content.css({height:"100%"});N=$('<div style="float: right"></div>').appendTo(w.header);$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(N).click(function(e){e.preventDefault(),r(!0)});var v=$('<div class="sidebar-version-control-change-container"></div>').appendTo(w.content),x=$('<div class="sidebar-version-control-change-header">Local files</div>').appendTo(v);f=$('<button class="editor-button editor-button-small" style="float: right"><i class="fa fa-plus"></i> all</button>').appendTo(x).click(function(e){e.preventDefault(),e.stopPropagation(),o(Object.keys(T).filter(function(e){return" "!==T[e].treeStatus}),!0)}),(u=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(v)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,n,o){t(e,o,o.treeStatus,"unstaged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}}),m=$('<div class="sidebar-version-control-change-container"></div>').appendTo(w.content),x=$('<div class="sidebar-version-control-change-header">Unmerged changes</div>').appendTo(m),N=$('<div style="float: right"></div>').appendTo(x);var k=$('<button class="editor-button editor-button-small" style="margin-right: 5px;">abort merge</button>').appendTo(N).click(function(e){e.preventDefault(),e.stopPropagation();var t=R.addSpinnerOverlay(m),n=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),R.sendRequest({url:"projects/"+n.name+"/merge",type:"DELETE",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),r(!0)},400:{unexpected_error:function(e){console.log(e)}}}}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})});(b=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(m)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,n,o){o===C&&(o.button={label:"commit",click:function(e){e.preventDefault(),e.stopPropagation(),j()}}),t(e,o,o.treeStatus,"unmerged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}});var _=$('<div class="sidebar-version-control-change-container"></div>').appendTo(w.content);x=$('<div class="sidebar-version-control-change-header">Changes to commit</div>').appendTo(_),N=$('<div style="float: right"></div>').appendTo(x);var j=function(){S.val(""),L.attr("disabled",!0),v.css("height","30px"),m.is(":visible")?(m.css("height","30px"),_.css("height","calc(100% - 60px - 175px)")):_.css("height","calc(100% - 30px - 175px)"),commitBox.show(),setTimeout(function(){commitBox.css("height","175px")},10),f.attr("disabled",!0),g.attr("disabled",!0),y.attr("disabled",!0),k.attr("disabled",!0),S.focus()};y=$('<button class="editor-button editor-button-small" style="margin-right: 5px;">commit</button>').appendTo(N).click(function(e){e.preventDefault(),e.stopPropagation(),j()}),g=$('<button class="editor-button editor-button-small"><i class="fa fa-minus"></i> all</button>').appendTo(N).click(function(e){e.preventDefault(),e.stopPropagation(),o(Object.keys(T).filter(function(e){return" "!==T[e].indexStatus&&"?"!==T[e].indexStatus}),!1)}),(h=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(_)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,n,o){t(e,o,o.indexStatus,"staged")},sort:function(e,t){return e.file.localeCompare(t.file)}}),commitBox=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-bottom"></div>').hide().appendTo(w.content);var S=$('<textarea placeholder="Enter your commit message"></textarea>').appendTo(commitBox).on("change keyup paste",function(){L.attr("disabled",""===$(this).val().trim())}),O=$('<div class="sidebar-version-control-slide-box-toolbar button-group">').appendTo(commitBox),P=$('<button class="editor-button">Cancel</button>').appendTo(O).click(function(e){e.preventDefault(),S.val(""),v.css("height",""),m.css("height",""),_.css("height",""),commitBox.css("height",0),setTimeout(function(){commitBox.hide()},200),f.attr("disabled",!1),g.attr("disabled",!1),y.attr("disabled",!1),k.attr("disabled",!1)}),L=$('<button class="editor-button">Commit</button>').appendTo(O).click(function(e){e.preventDefault();var t=R.addSpinnerOverlay(L).addClass("projects-dialog-spinner-sidebar"),n=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),R.sendRequest({url:"projects/"+n.name+"/commit",type:"POST",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),P.click(),r(!0)},400:{"*":function(e){R.reportUnexpectedError(e)}}}},{message:S.val()}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),I=p.add({title:"Commit History",collapsible:!0}),N=$('<div style="float: right"></div>').appendTo(I.header);$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(N).click(function(e){e.preventDefault(),r(!0,!0)});var A=$('<div class="sidebar-version-control-change-header" style="text-align: right;"></div>').appendTo(I.content),z=$('<button class="editor-button editor-button-small"><i class="fa fa-code-fork"></i> Branch: <span id="sidebar-version-control-local-branch"></span></button>').appendTo(A).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))B();else{V(),E.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();U.refresh("projects/"+t.name+"/branches"),J.show(),setTimeout(function(){J.css("height","215px"),U.focus()},100)}}),M=$('<button class="editor-button editor-button-small" style="margin-left: 10px;" id="sidebar-version-control-repo-status-button"><span id="sidebar-version-control-repo-status-stats"><i class="fa fa-long-arrow-up"></i> <span id="sidebar-version-control-commits-ahead"></span> <i class="fa fa-long-arrow-down"></i> <span id="sidebar-version-control-commits-behind"></span></span><span id="sidebar-version-control-repo-status-auth-issue"><i class="fa fa-warning"></i></span></button>').appendTo(A).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))V();else{B(),E.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();$("#sidebar-version-control-repo-toolbar-set-upstream-row").toggle(!!t.git.branches.remoteAlt),G.show(),setTimeout(function(){G.css("height","265px")},100)}});D=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0px; right:0; left:0;"}).appendTo(I.content),E=$('<div class="component-shade" style="z-Index: 3"></div>').css("top","30px").hide().appendTo(I.content),D.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){if(e.addClass("sidebar-version-control-commit-entry"),o.url)e.addClass("sidebar-version-control-commit-more"),e.text("+ "+(o.total-o.totalKnown)+" more commit(s)"),e.click(function(t){t.preventDefault(),a(o.url,D,e,o.limit,o.before)});else{e.click(function(e){var t=RED.projects.getActiveProject();t&&$.getJSON("projects/"+t.name+"/commits/"+o.sha,function(e){e.project=t,e.parents=o.parents,e.oldRev=o.sha+"~1",e.newRev=o.sha,e.oldRevTitle="Commit "+o.sha.substring(0,7)+"~1",e.newRevTitle="Commit "+o.sha.substring(0,7),e.date=n(parseInt(o.date)),RED.diff.showCommitDiff(e)})});var i=$("<div>").appendTo(e);if($('<div class="sidebar-version-control-commit-subject">').text(o.subject).appendTo(i),o.refs){var s=$('<div class="sidebar-version-control-commit-refs">').appendTo(i);o.refs.forEach(function(e){var t=e;/HEAD -> /.test(e)&&(t=e.substring(8)),$('<span class="sidebar-version-control-commit-ref">').text(t).appendTo(s)}),e.addClass("sidebar-version-control-commit-head")}$('<div class="sidebar-version-control-commit-sha">').text(o.sha.substring(0,7)).appendTo(i),$('<div class="sidebar-version-control-commit-date">').text(n(parseInt(o.date))).appendTo(i)}}});var B=function(e){z.removeClass("selected"),J.css("height","0"),E.hide(),setTimeout(function(){J.hide(),e&&e()},200)},J=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-top" style="top:30px;"></div>').hide().appendTo(I.content);$('<div class="sidebar-version-control-slide-box-header"></div>').text("Change local branch").appendTo(J);var U=R.createBranchList({placeholder:"Find or create a branch",container:J,onselect:function(e){if(e.current)return B();var t=R.addSpinnerOverlay(J),n=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),R.sendRequest({url:"projects/"+n.name+"/branches",type:"POST",requireCleanWorkspace:!0,cancel:function(){t.remove()},responses:{0:function(e){t.remove(),console.log(e)},200:function(e){B(function(){t.remove()})},400:{git_local_overwrite:function(e){t.remove(),RED.notify("You have local changes that would be overwritten by changing the branch. You must either commit or undo those changes first.",{type:"error",timeout:8e3})},unexpected_error:function(e){t.remove(),console.log(e)}}}},e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}),G=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-top" style="top:30px"></div>').hide().appendTo(I.content),V=function(){$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!1),M.removeClass("selected"),G.css("height","0"),E.hide(),setTimeout(function(){G.hide(),F()},200)},F=function(e){q.hasClass("selected")&&(q.removeClass("selected"),Y.height(0),G.css("height","265px"),setTimeout(function(){Y.hide(),e&&e()},200))};$('<div class="sidebar-version-control-slide-box-header"></div>').text("Manage remote branch").appendTo(G);var W=$('<div style="margin-bottom: 5px;"></div>').appendTo(G),q=$('<button id="sidebar-version-control-repo-branch" class="sidebar-version-control-repo-action editor-button"><i class="fa fa-code-fork"></i> Remote: <span id="sidebar-version-control-remote-branch"></span></button>').appendTo(W).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))F();else{$(this).addClass("selected");var t=RED.projects.getActiveProject();X.refresh("projects/"+t.name+"/branches/remote"),Y.show(),setTimeout(function(){Y.height(180),G.css("height","445px"),X.focus()},100)}});$('<div id="sidebar-version-control-repo-toolbar-message" class="sidebar-version-control-slide-box-header" style="min-height: 100px;"></div>').appendTo(G);var H=$('<div id="sidebar-version-control-repo-toolbar-error-message" class="sidebar-version-control-slide-box-header" style="min-height: 100px;"></div>').hide().appendTo(G);$('<div style="margin-top: 10px;"><i class="fa fa-warning"></i> Unable to access remote repository</div>').appendTo(H);var K=$('<div style="margin: 10px 30px; text-align: center"></div>').appendTo(H);$('<button class="editor-button" style="width: 80%;"><i class="fa fa-refresh"></i> Retry</button>').appendTo(K).click(function(e){e.preventDefault();var t=RED.projects.getActiveProject(),n=R.addSpinnerOverlay(G).addClass("projects-dialog-spinner-contain");R.sendRequest({url:"projects/"+t.name+"/branches/remote",type:"GET",responses:{0:function(e){console.log(e)},200:function(e){r(!0)},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){console.log(e)}}}}).always(function(){n.remove()})}),$('<div class="sidebar-version-control-slide-box-header" style="height: 20px;"><label id="sidebar-version-control-repo-toolbar-set-upstream-row" for="sidebar-version-control-repo-toolbar-set-upstream" class="hide"><input type="checkbox" id="sidebar-version-control-repo-toolbar-set-upstream"> Set as upstream branch</label></div>').appendTo(G);var Y=$('<div style="height: 0;overflow:hidden; transition: height 0.2s ease-in-out;"></div>').hide().appendTo(W),X=R.createBranchList({placeholder:"Find or create a remote branch",currentLabel:"upstream",remote:function(){var e=RED.projects.getActiveProject();return Object.keys(e.git.remotes)[0]},container:Y,onselect:function(e){$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!1),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("disabled",!1),$("#sidebar-version-control-remote-branch").text(e.name+(e.create?" *":""));var t=RED.projects.getActiveProject();t.git.branches.remote===e.name?delete t.git.branches.remoteAlt:t.git.branches.remoteAlt=e.name,$("#sidebar-version-control-repo-toolbar-set-upstream-row").toggle(!!t.git.branches.remoteAlt),F(function(){if(e.create)t.git.branches.remote?$("#sidebar-version-control-repo-toolbar-message").text("The branch will be created. Select below to set it as the tracked upstream branch."):($("#sidebar-version-control-repo-toolbar-message").text("The created branch will be set as the tracked upstream branch."),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!0),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("disabled",!0)),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!1);else{var n=Date.now(),o=R.addSpinnerOverlay($("#sidebar-version-control-repo-toolbar-message")).addClass("projects-dialog-spinner-contain");$.getJSON("projects/"+t.name+"/branches/remote/"+e.name+"/status",function(e){setTimeout(function(){d(e.commits.ahead,e.commits.behind),o.remove()},Math.max(400-(Date.now()-n),0))})}})}}),Z=$('<div style="margin-bottom: 5px;"></div>').appendTo(G);$('<button id="sidebar-version-control-repo-push" class="sidebar-version-control-repo-sub-action editor-button"><i class="fa fa-long-arrow-up"></i> <span>push</span></button>').appendTo(Z).click(function(e){e.preventDefault();var t=R.addSpinnerOverlay(G).addClass("projects-dialog-spinner-contain"),n=RED.projects.getActiveProject(),o="projects/"+n.name+"/push";n.git.branches.remoteAlt&&(o+="/"+n.git.branches.remoteAlt);var a=$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked");a&&(o+="?u=true"),R.sendRequest({url:o,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){a&&n.git.branches.remoteAlt&&(n.git.branches.remote=n.git.branches.remoteAlt,delete n.git.branches.remoteAlt),r(!0),V()},400:{git_push_failed:function(e){RED.notify("NLS: Push failed as the remote has more recent commits. Pull first and write a better error message!","error")},unexpected_error:function(e){console.log(e)}}}},{}).always(function(){t.remove()})});var Q=function(e){e=e||{};var t=R.addSpinnerOverlay(G).addClass("projects-dialog-spinner-contain"),n=RED.projects.getActiveProject(),o="projects/"+n.name+"/pull";n.git.branches.remoteAlt&&(o+="/"+n.git.branches.remoteAlt),(e.setUpstream||e.allowUnrelatedHistories)&&(o+="?"),e.setUpstream&&(o+="setUpstream=true",e.allowUnrelatedHistories&&(o+="&")),e.allowUnrelatedHistories&&(o+="allowUnrelatedHistories=true"),R.sendRequest({url:o,type:"POST",responses:{0:function(e){console.log(e)},200:function(t){e.setUpstream&&n.git.branches.remoteAlt&&(n.git.branches.remote=n.git.branches.remoteAlt,delete n.git.branches.remoteAlt),r(!0),V()},400:{git_local_overwrite:function(e){RED.notify('<p>Unable to pull remote changes; your unstaged local changes would be overwritten.</p><p>Commit your changes and try again.</p><p><a href="#" onclick="RED.sidebar.versionControl.showLocalChanges(); return false;">Show unstaged changes</a></p>',"error",!1,1e7)},git_pull_merge_conflict:function(e){r(!0),V()},git_connection_failed:function(e){RED.notify("Could not connect to remote repository: "+e.toString(),"warning")},git_pull_unrelated_history:function(t){var n=RED.notify("<p>The remote has an unrelated history of commits.</p><p>Are you sure you want to pull the changes into your local repository?</p>",{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){n.close()}},{text:"Pull changes",click:function(){n.close(),e.allowUnrelatedHistories=!0,Q(e)}}]})},"*":function(e){R.reportUnexpectedError(e)}}}},{}).always(function(){t.remove()})};$('<button id="sidebar-version-control-repo-pull" class="sidebar-version-control-repo-sub-action editor-button"><i class="fa fa-long-arrow-down"></i> <span>pull</span></button>').appendTo(Z).click(function(e){e.preventDefault(),Q({setUpstream:$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked")})}),$('<div class="component-shade sidebar-version-control-shade">').appendTo(c),RED.sidebar.addTab({id:"version-control",label:"history",name:"Project History",content:c,enableOnEdit:!1,onchange:function(){setTimeout(function(){p.resize()},10)}})},show:l,refresh:r,showLocalChanges:function(){RED.sidebar.show("version-control"),w.expand()}}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){var e=null,t=!1,n=!1,o=null;return{show:function(a,i,s){t=!0;try{$("body").width(),$("body").height();for(var r=(e=d3.select("body").append("div").style({position:"absolute",top:0,left:0,bottom:0,right:0,"z-index":1e3}).on("touchstart",function(){g(),d3.event.preventDefault()})).append("div").style({position:"absolute",top:i[1]-80+"px",left:i[0]-80+"px","border-radius":"80px",width:"160px",height:"160px",background:"rgba(255,255,255,0.6)",border:"1px solid #666"}),d=[],l=s.length,c=Math.max(Math.PI/(l-1),Math.PI/4),p=Math.PI,u=0;u<l;u++){var f=Math.floor(80*Math.cos(p)),h=Math.floor(80*Math.sin(p));s[u].name&&function(e,t,n){n.el=r.append("div").style({position:"absolute",top:t+80-25+"px",left:e+80-25+"px","border-radius":"20px",width:"50px",height:"50px",background:"#fff",border:"2px solid #666","text-align":"center","line-height":"50px"}),n.el.html(n.name),n.disabled&&n.el.style({"border-color":"#ccc",color:"#ccc"}),n.x=e,n.y=t,d.push(n),n.el.on("touchstart",function(){n.el.style("background","#999"),d3.event.preventDefault(),d3.event.stopPropagation()}),n.el.on("touchend",function(){g(),n.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()})}(f,h,s[u]),p+=c}var g=function(){t=!1,o=null,e.remove(),e=null};a.on("touchend.radial",function(){if(a.on("touchend.radial",null),a.on("touchmenu.radial",null),o){try{o.onselect()}catch(e){RED._debug(e)}g()}else n&&g()}),a.on("touchmove.radial",function(){try{for(var e=d3.event.touches.item(0),t=[e.pageX-i[0],e.pageY-i[1]],a=0;a<d.length;a++){var s=d[a];s.disabled||(t[0]>s.x-30&&t[0]<s.x+30&&t[1]>s.y-30&&t[1]<s.y+30?s!==o&&(s.el.style("background","#999"),o=s):s===o?(s.el.style("background","#fff"),o=null):s.el.style("background","#fff"))}if(!o){var r=Math.abs(t[0]*t[0]+t[1]*t[1]);n=r>6400}}catch(e){RED._debug(e)}})}catch(e){RED._debug(e)}},active:function(){return t}}}();