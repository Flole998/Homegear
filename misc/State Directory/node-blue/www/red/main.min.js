/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
!function(){function e(e){var t,i=/<!-- --- \[red-module:(\S+)\] --- -->/.exec(e.trim());t=i?i[1]:"unknown";try{$("body").append(e)}catch(e){RED.notify(RED._("notification.errors.failedToAppendNode",{module:t,error:e.toString()}),{type:"error",timeout:1e4}),console.log("["+t+"] "+e.toString())}}function t(){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"nodes",success:function(e){RED.nodes.setNodeList(e),RED.i18n.loadNodeCatalogs(function(){i(o)})}})}function i(e){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"icons",success:function(t){RED.nodes.setIconSets(t),e&&e()}})}function o(){$.ajax({headers:{Accept:"text/html"},cache:!1,url:"nodes",success:function(t){t.trim().split(/(?=<!-- --- \[red-module:\S+\] --- -->)/).forEach(function(t){e(t)}),$("body").i18n(),$("#palette > .palette-spinner").hide(),$(".palette-scroll").removeClass("hide"),$("#palette-search").removeClass("hide"),n(function(){RED.settings.theme("projects.enabled",!1)?RED.projects.refresh(function(e){RED.sidebar.info.refresh(),e||(RED.menu.setDisabled("menu-item-projects-open",!0),RED.menu.setDisabled("menu-item-projects-settings",!0),!1===e||RED.projects.showStartup()),s()}):(RED.sidebar.info.refresh(),s())})}})}function n(e){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(t){if(t){var i=window.location.hash;RED.nodes.version(t.rev),RED.nodes.import(t.flows),RED.nodes.dirty(!1),RED.view.redraw(!0),/^#flow\/.+$/.test(i)&&RED.workspaces.show(i.substring(6))}e()}})}function s(){var t={};RED.comms.subscribe("notification/#",function(e,i){var o=e.split("/")[1];if("runtime-deploy"!==o&&"node"!==o){if("project-update"===o)return RED.nodes.clear(),RED.history.clear(),RED.view.redraw(!0),void RED.projects.refresh(function(){n(function(){var e={"change-branch":"Change to local branch '"+RED.projects.getActiveProject().git.branches.local+"'","merge-abort":"Git merge aborted",loaded:"Project '"+i.project+"' loaded",updated:"Project '"+i.project+"' updated",pull:"Project '"+i.project+"' reloaded",revert:"Project '"+i.project+"' reloaded","merge-complete":"Git merge completed"}[i.action];RED.notify("<p>"+e+"</p>"),RED.sidebar.info.refresh()})});if(i.text){i.default=i.text;var s=RED._(i.text,i),l={type:i.type,fixed:void 0===i.timeout,timeout:i.timeout,id:o};"runtime-state"===o&&("missing-types"===i.error?(s+="<ul><li>"+i.types.join("</li><li>")+"</li></ul>",RED.projects.getActiveProject()?l.buttons=[{text:"Manage project dependencies",click:function(){t[o].hideNotification(),RED.projects.settings.show("deps")}}]:l.buttons=[{text:"Close",click:function(){t[o].hideNotification()}}]):"credentials_load_failed"===i.error?RED.settings.theme("projects.enabled",!1)?RED.user.hasPermission("projects.write")&&(l.buttons=[{text:"Setup credentials",click:function(){t[o].hideNotification(),RED.projects.showCredentialsPrompt()}}]):l.buttons=[{text:"Close",click:function(){t[o].hideNotification()}}]:"missing_flow_file"===i.error?RED.user.hasPermission("projects.write")&&(l.buttons=[{text:"Setup project files",click:function(){t[o].hideNotification(),RED.projects.showFilesPrompt()}}]):"missing_package_file"===i.error?RED.user.hasPermission("projects.write")&&(l.buttons=[{text:"Create default package file",click:function(){t[o].hideNotification(),RED.projects.createDefaultPackageFile()}}]):"project_empty"===i.error?RED.user.hasPermission("projects.write")&&(l.buttons=[{text:"No thanks",click:function(){t[o].hideNotification()}},{text:"Create default project files",click:function(){t[o].hideNotification(),RED.projects.createDefaultFileSet()}}]):"git_merge_conflict"===i.error&&(RED.nodes.clear(),RED.sidebar.versionControl.refresh(!0),RED.user.hasPermission("projects.write")&&(l.buttons=[{text:"Show merge conflicts",click:function(){t[o].hideNotification(),RED.sidebar.versionControl.showLocalChanges()}}]))),t.hasOwnProperty(o)?t[o].update(s,l):t[o]=RED.notify(s,l)}else t.hasOwnProperty(o)&&(t[o].close(),delete t[o])}}),RED.comms.subscribe("statusTop/#",function(e,t){var i=e.split("/"),o=RED.nodes.node(i[1]);o&&(t.hasOwnProperty("text")&&"."!==t.text[0]&&(t.text=o._(t.text.toString(),{defaultValue:t.text.toString()})),o.statusTop=t,o.dirty=!0,RED.view.redraw())}),RED.comms.subscribe("statusBottom/#",function(e,t){var i=e.split("/"),o=RED.nodes.node(i[1]);o&&(t.hasOwnProperty("text")&&"."!==t.text[0]&&(t.text=o._(t.text.toString(),{defaultValue:t.text.toString()})),o.statusBottom=t,o.dirty=!0,RED.view.redraw())}),RED.comms.subscribe("highlightLink/#",function(e,t){var i=e.split("/")[1];i.indexOf(":")>-1&&(i=i.split(":")[0]);var o=RED.nodes.node(i);if(o){var n=0;t.hasOwnProperty("index")&&(n=t.index),activeLinks=RED.nodes.filterLinks({source:o,sourcePort:n});for(var s=0;s<activeLinks.length;s++)activeLinks[s].working=!0;setTimeout(function(e){for(var t=0;t<e.length;t++)e[t].working=!1;o.dirty=!0,RED.view.redraw()},300,activeLinks),o.dirty=!0,RED.view.redraw()}}),RED.comms.subscribe("highlightNode/#",function(e,t){var i=e.split("/")[1];i.indexOf(":")>-1&&(i=i.split(":")[0]);var o=RED.nodes.node(i);if(o){var n=500;t.hasOwnProperty("timeout")&&(n=t.timeout),o.working=!0,setTimeout(function(e){e.working=!1,e.dirty=!0,RED.view.redraw()},n,o),o.dirty=!0,RED.view.redraw()}}),RED.comms.subscribe("notification/node/#",function(t,o){var n,s,l;if("notification/node/added"==t){var r=[];o.forEach(function(t){var i=t.id;RED.nodes.addNodeSet(t),r=r.concat(t.types),RED.i18n.loadCatalog(i,function(){$.get("nodes/"+i,function(t){e(t)})})}),r.length&&(l="<ul><li>"+r.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:r.length})+l,"success")),i()}else if("notification/node/removed"==t){for(n=0;n<o.length;n++)s=o[n],RED.nodes.removeNodeSet(s.id).added&&(l="<ul><li>"+s.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeRemoved",{count:s.types.length})+l,"success"));i()}else"notification/node/enabled"==t?o.types&&(RED.nodes.getNodeSet(o.id).added?(RED.nodes.enableNodeSet(o.id),l="<ul><li>"+o.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeEnabled",{count:o.types.length})+l,"success")):$.get("nodes/"+o.id,function(t){e(t),l="<ul><li>"+o.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:o.types.length})+l,"success")})):"notification/node/disabled"==t?o.types&&(RED.nodes.disableNodeSet(o.id),l="<ul><li>"+o.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeDisabled",{count:o.types.length})+l,"success")):"node/upgraded"==t&&(RED.notify(RED._("palette.event.nodeUpgraded",{module:o.module,version:o.version}),"success"),RED.nodes.registry.setModulePendingUpdated(o.module,o.version));RED.library.loadFlowLibrary()}),RED.comms.getEvents(),RED.comms.getFixedInputs()}function l(){$.get("red/about",function(e){RED.sidebar.info.set('<div style="text-align:center;"><img width="50px" src="red/images/node-red-icon.svg" /></div>'+marked(e)),RED.sidebar.info.show()})}function r(){c&&(c=!1,$("#main-container").show(),$(".header-toolbar").show(),t())}function a(){var e=[];RED.settings.theme("projects.enabled",!1)&&e.push({id:"menu-item-projects-menu",label:"Projects",options:[{id:"menu-item-projects-new",label:"New",disabled:!1,onselect:"core:new-project"},{id:"menu-item-projects-open",label:"Open",disabled:!1,onselect:"core:open-project"},{id:"menu-item-projects-settings",label:"Project Settings",disabled:!1,onselect:"core:show-project-settings"}]}),e.push({id:"menu-item-view-menu",label:RED._("menu.label.view.view"),options:[{id:"menu-item-sidebar",label:RED._("menu.label.sidebar.show"),toggle:!0,onselect:"core:toggle-sidebar",selected:!0},null]}),e.push(null),e.push({id:"menu-item-import",label:RED._("menu.label.import"),options:[{id:"menu-item-import-clipboard",label:RED._("menu.label.clipboard"),onselect:"core:show-import-dialog"}]}),e.push({id:"menu-item-export",label:RED._("menu.label.export"),disabled:!0,options:[{id:"menu-item-export-clipboard",label:RED._("menu.label.clipboard"),disabled:!0,onselect:"core:show-export-dialog"}]}),e.push(null),e.push({id:"menu-item-search",label:RED._("menu.label.search"),onselect:"core:search"}),e.push(null),e.push({id:"menu-item-config-nodes",label:RED._("menu.label.displayConfig"),onselect:"core:show-config-tab"}),e.push({id:"menu-item-workspace",label:RED._("menu.label.flows"),options:[{id:"menu-item-workspace-add",label:RED._("menu.label.add"),onselect:"core:add-flow"},{id:"menu-item-workspace-edit",label:RED._("menu.label.rename"),onselect:"core:edit-flow"},{id:"menu-item-workspace-delete",label:RED._("menu.label.delete"),onselect:"core:remove-flow"}]}),e.push({id:"menu-item-subflow",label:RED._("menu.label.subflows"),options:[{id:"menu-item-subflow-create",label:RED._("menu.label.createSubflow"),onselect:"core:create-subflow"}]}),e.push(null),!1!==RED.settings.theme("palette.editable")&&(e.push({id:"menu-item-edit-palette",label:RED._("menu.label.editPalette"),onselect:"core:manage-palette"}),e.push(null)),e.push({id:"menu-item-user-settings",label:RED._("menu.label.settings"),onselect:"core:show-user-settings"}),e.push(null),e.push({id:"menu-item-keyboard-shortcuts",label:RED._("menu.label.keyboardShortcuts"),onselect:"core:show-help"}),e.push({id:"menu-item-help",label:RED.settings.theme("menu.menu-item-help.label","Node-BLUE website"),href:RED.settings.theme("menu.menu-item-help.url","https://doc.homegear.eu/data/homegear-node-blue/")}),e.push(null),e.push({id:"menu-item-node-red-version",label:"v"+RED.settings.version,onselect:"core:show-about"}),e.push({id:"menu-item-node-red",label:RED.settings.theme("menu.menu-item-logout.label","Powered by Node-RED"),href:RED.settings.theme("menu.menu-item-logout.url","https://nodered.org/")}),e.push(null),e.push({id:"menu-item-logout",label:RED.settings.theme("menu.menu-item-logout.label","Logout"),hrefLocal:RED.settings.theme("menu.menu-item-logout.url","signin.php?logout=1")}),RED.view.init(),RED.userSettings.init(),RED.user.init(),RED.library.init(),RED.keyboard.init(),RED.palette.init(),!1!==RED.settings.theme("palette.editable")?RED.palette.editor.init():console.log("Palette editor disabled"),RED.sidebar.init(),RED.settings.theme("projects.enabled",!1)?RED.projects.init():console.log("Projects disabled"),RED.subflow.init(),RED.workspaces.init(),RED.clipboard.init(),RED.search.init(),RED.editor.init(),RED.diff.init(),RED.menu.init({id:"btn-sidemenu",options:e}),RED.deploy.init(RED.settings.theme("deployButton",null)),RED.notifications.init(),RED.actions.add("core:show-about",l),RED.nodes.init(),RED.comms.connect(),RED.comms.homegear().ready(r)}var c=!0;$(function(){"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(document.title=document.title+" : "+window.location.hostname),ace.require("ace/ext/language_tools"),RED.i18n.init(function(){RED.settings.init(a)})})}();